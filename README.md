# 1C HTTP Server

HTTP сервер для приема данных из 1С (константы и справочники) и сохранения их в SQLite базу данных.

## Возможности

- Прием данных из 1С через HTTP (XML формат)
- Сохранение данных в SQLite базу данных
- GUI интерфейс для мониторинга
- REST API для получения данных из базы
- Потоковая передача данных через Server-Sent Events
- Проверка целостности передачи данных

## Системные требования

- Windows 10/11
- Go 1.19 или выше
- C компилятор (MinGW-w64) для работы с SQLite через CGO
- SQLite драйвер (устанавливается автоматически через go.mod)

## Быстрый старт

### Способ 1: Запуск через bat файл (рекомендуется)

1. Дважды кликните на `start_server.bat`
2. Скрипт автоматически:
   - Проверит наличие Go и GCC
   - Попытается найти GCC в стандартных местах (C:\mingw64, C:\msys64)
   - Скомпилирует версию с GUI (если GCC найден) или без GUI
   - Запустит сервер

**Примечание:** SQLite требует CGO, поэтому нужен GCC. Если GCC не найден, скрипт попытается скомпилировать версию без GUI, но это может не сработать без CGO.

### Способ 2: Ручной запуск

**С GUI (требует GCC и CGO):**
```bash
set CGO_ENABLED=1
go build -o httpserver.exe .
.\httpserver.exe
```

**Без GUI (требует GCC для SQLite):**
```bash
set CGO_ENABLED=1
go build -o httpserver.exe main_no_gui.go
.\httpserver.exe
```

### Установка MinGW-w64 (если GCC не найден)

1. Скачайте MinGW-w64: https://www.mingw-w64.org/downloads/
2. Установите в `C:\mingw64\mingw64\bin\` (или другое место)
3. Скрипт `start_server.bat` автоматически найдет GCC в стандартных местах
4. Или добавьте путь к `gcc.exe` в переменную окружения PATH

## Использование

### 1. Запуск сервера

Запустите сервер через `start_server.bat` или вручную. Сервер будет доступен на `http://localhost:9999`

### 2. Выгрузка данных из 1С

1. Убедитесь, что сервер запущен
2. Откройте обработку 1С (файл `XMLExport_actual.txt`)
3. Нажмите кнопку "ВыгрузкаВсего"
4. Данные будут отправлены на сервер и сохранены в базу данных

### 3. Работа с API

См. подробную документацию в файле `API_DOCUMENTATION.md`

**Основные эндпоинты:**

- `GET /api/uploads` - список всех выгрузок
- `GET /api/uploads/{uuid}` - детали выгрузки
- `GET /api/uploads/{uuid}/data` - получение данных с фильтрацией
- `GET /api/uploads/{uuid}/stream` - потоковая передача данных
- `POST /api/uploads/{uuid}/verify` - проверка передачи
- `POST /api/uploads/{uuid}/export` - запуск обратной выгрузки данных в 1С
- `GET /api/uploads/{uuid}/exports` - активные и завершенные задачи экспорта
- `GET /api/exports` / `GET /api/exports/{id}` - глобальный список задач и статус конкретной задачи

**Примеры:**

```bash
# Список выгрузок
curl http://localhost:9999/api/uploads

# Детали выгрузки
curl http://localhost:9999/api/uploads/{uuid}

# Получить все константы
curl "http://localhost:9999/api/uploads/{uuid}/data?type=constants"

# Запустить обратный экспорт в 1С
curl -X POST http://localhost:9999/api/uploads/{uuid}/export ^
  -H "Content-Type: application/json" ^
  -d "{\"target_url\":\"http://remote-server/api/v1/upload\",\"include\":[\"metadata\",\"constants\",\"catalogs\"],\"batch_size\":500}"
```

## Структура проекта

```
HttpServer/
├── main.go                 # Точка входа
├── start_server.bat        # Скрипт запуска
├── README.md              # Эта инструкция
├── API_DOCUMENTATION.md   # Документация API
├── go.mod                 # Go модуль
├── go.sum                 # Зависимости
├── data.db                # База данных SQLite (создается автоматически)
├── database/              # Работа с БД
│   ├── db.go
│   └── schema.go
├── server/                # HTTP сервер
│   ├── server.go
│   └── models.go
├── gui/                    # GUI интерфейс
│   └── window.go
└── api_tests/              # Тесты API
    └── *.html
```

## Параметры сервера

- **Порт**: 9999 (можно изменить в `main.go`)
- **База данных**: `data.db` (создается автоматически в папке проекта)
- **Формат данных**: XML (для приема из 1С), JSON (для API)

## Эндпоинты для 1С

- `POST /handshake` - рукопожатие, создание новой выгрузки
- `POST /metadata` - прием метаинформации о выгрузке
- `POST /constant` - прием константы
- `POST /catalog/meta` - прием метаданных справочника
- `POST /catalog/item` - прием элемента справочника
- `POST /complete` - завершение выгрузки
- `GET /health` - проверка здоровья сервера
- `GET /stats` - получение статистики

## Остановка сервера

- Нажмите `Ctrl+C` в окне сервера
- Или закройте окно GUI

## Возможные проблемы

### Порт 9999 занят

Если порт уже занят другим процессом:
1. Остановите старый процесс сервера
2. Или измените порт в `main.go` (строка 26) и перекомпилируйте

### Ошибка компиляции CGO

Если возникают ошибки при компиляции SQLite:
1. Убедитесь, что установлен MinGW-w64
2. Добавьте путь к gcc в PATH: `C:\mingw64\mingw64\bin`
3. Установите переменную окружения: `set CGO_ENABLED=1`

### База данных не создается

- Убедитесь, что у вас есть права на запись в папку проекта
- Проверьте, что CGO компиляция прошла успешно

## Разработка

### Перекомпиляция после изменений

```bash
go build -o httpserver.exe .
```

### Запуск без GUI

Измените `main.go`, закомментировав строки с GUI и используя `select {}` вместо `window.ShowAndRun()`

## Лицензия

Проект для внутреннего использования.

