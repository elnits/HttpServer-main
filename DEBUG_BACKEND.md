# Отладка бэкенда

## Исправленные проблемы

### 1. Обработка ошибок в эндпоинтах

**Проблема:** Отсутствовала обработка ошибок при запросах к базе данных

**Исправление:**
- Добавлена проверка ошибок в `handleNormalizationStatus`
- Добавлена проверка ошибок в `handleNormalizationStats`
- Добавлено логирование ошибок для отладки

### 2. SSE соединение

**Проблема:** Отсутствовал heartbeat для поддержания соединения

**Исправление:**
- Добавлен ticker для отправки heartbeat каждые 30 секунд
- Добавлена обработка ошибок при отправке событий
- Добавлено логирование отключений клиентов

### 3. Логирование процесса нормализации

**Проблема:** Недостаточно логов для отладки

**Исправление:**
- Добавлены логи при запуске нормализации
- Добавлены логи при завершении нормализации
- Добавлены логи при сбросе флага isRunning

## Тестирование

### Запуск тестов

```powershell
.\test-backend.ps1
```

Этот скрипт проверит:
1. Health endpoint
2. Status endpoint
3. Stats endpoint
4. SSE endpoint
5. Start endpoint

### Ручное тестирование

```bash
# Health check
curl http://localhost:9999/health

# Status
curl http://localhost:9999/api/normalization/status

# Stats
curl http://localhost:9999/api/normalization/stats
```

## Логи для отладки

Бэкенд теперь логирует:
- Запуск процесса нормализации
- Завершение процесса нормализации
- Ошибки при запросах к БД
- Ошибки SSE соединений
- Отключения SSE клиентов

## Проверка работы

1. Запустите бэкенд: `go run main_no_gui.go`
2. Проверьте логи - должны быть сообщения о запуске сервера
3. Проверьте health: `curl http://localhost:9999/health`
4. Проверьте статус: `curl http://localhost:9999/api/normalization/status`

## Известные проблемы

- Если таблица `normalized_data` не существует, статус вернет 0 записей (это нормально)
- SSE соединение может разорваться при долгом простое (добавлен heartbeat для решения)

