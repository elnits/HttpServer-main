# Исправление системы категоризации

## Проблема

Категории в таблице `normalized_data` брались из простого `Categorizer` (ключевые слова), что давало общие и неточные категории:
- `другое` - 12322 записи (77.1%)
- `стройматериалы` - 1221 записей (7.6%)
- `сантехника` - 469 записей (2.9%)
- и т.д.

Эти категории слишком общие и не соответствуют классификатору КПВЭД.

## Решение

### 1. Обновлен процесс нормализации

**Файл**: `normalization/normalizer.go`

**Изменения**:
- Категории теперь берутся из классификатора КПВЭД через AI
- Используется `hierarchicalClassifier.Classify()` для определения категории
- Поле `category` заполняется `kpvedResult.FinalName` вместо результата простого `Categorizer`

**Код**:
```go
// Используем название из КПВЭД как категорию вместо простого Categorizer
if kpvedName != "" && kpvedConfidence >= 0.5 {
    category = kpvedName
}
```

### 2. Создан скрипт переклассификации

**Файл**: `cmd/reclassify_with_kpved/main.go`

**Функциональность**:
- Переклассифицирует существующие записи в `normalized_data`
- Использует AI и классификатор КПВЭД
- Обновляет поля `category`, `kpved_code`, `kpved_name`, `kpved_confidence`
- Поддерживает лимит для тестирования

**Использование**:
```bash
$env:ARLIAI_API_KEY = "597dbe7e-16ca-4803-ab17-5fa084909f37"
go run cmd/reclassify_with_kpved/main.go 1c_data.db 1 top_priority
```

### 3. Создана документация

**Файлы**:
- `RECLASSIFICATION_GUIDE.md` - Подробное руководство по переклассификации
- `NORMALIZATION_SUMMARY.md` - Обновлен с информацией об изменениях

## Результат

### До исправления:
- Категории: общие (другое, стройматериалы, сантехника)
- Источник: простой `Categorizer` с ключевыми словами
- Точность: низкая

### После исправления:
- Категории: из классификатора КПВЭД
- Источник: AI + КПВЭД через `hierarchicalClassifier`
- Точность: высокая (на основе официального классификатора)

## Следующие шаги

1. ✅ Процесс нормализации обновлен
2. ✅ Скрипт переклассификации создан
3. ✅ Документация создана
4. ⏳ Требуется запустить переклассификацию существующих данных

## Команды для запуска

### Тестовая переклассификация (100 записей):
```bash
$env:ARLIAI_API_KEY = "597dbe7e-16ca-4803-ab17-5fa084909f37"
go run cmd/reclassify_with_kpved/main.go 1c_data.db 1 top_priority 100
```

### Полная переклассификация (15973 записи):
```bash
$env:ARLIAI_API_KEY = "597dbe7e-16ca-4803-ab17-5fa084909f37"
go run cmd/reclassify_with_kpved/main.go 1c_data.db 1 top_priority
```

## Проверка результатов

После переклассификации проверьте результаты:
```bash
# Статистика
go run cmd/show_detailed_normalization/main.go 1c_data.db

# Примеры
go run cmd/show_normalized_results/main.go 1c_data.db 20

# HTML отчет
go run cmd/export_normalization_report/main.go 1c_data.db normalization_report.html
```

## Примечания

- Переклассификация может занять несколько часов для всех 15973 записей
- Рекомендуется начать с тестовой переклассификации (100 записей)
- Скрипт автоматически обрабатывает ошибки и продолжает работу
- Прогресс отображается каждые 10 записей

