# Массовая классификация номенклатуры по КПВЭД

## Описание

Скрипт `classify_nomenclature` выполняет массовую классификацию всех номенклатур в базе данных по классификатору КПВЭД с использованием AI.

## Требования

1. Классификатор КПВЭД должен быть загружен в базу данных
2. Установлена переменная окружения `ARLIAI_API_KEY`
3. Опционально: `ARLIAI_MODEL` (по умолчанию: `GLM-4.5-Air`)

## Использование

```bash
# Базовое использование
go run cmd/classify_nomenclature/main.go 1c_data.db <classifier_id>

# С указанием стратегии свертки
go run cmd/classify_nomenclature/main.go 1c_data.db 1 top_priority

# С указанием клиента и проекта
go run cmd/classify_nomenclature/main.go 1c_data.db 1 top_priority 1 1
```

### Параметры

- `путь_к_базе.db` - путь к базе данных SQLite
- `classifier_id` - ID классификатора КПВЭД в базе данных
- `strategy_id` (опционально) - ID стратегии свертки категорий (по умолчанию: `top_priority`)
- `client_id` (опционально) - ID клиента
- `project_id` (опционально) - ID проекта

## Процесс работы

1. **Загрузка классификатора** - загружает дерево категорий КПВЭД из базы
2. **Загрузка номенклатуры** - загружает все номенклатуры из таблицы `nomenclature_items`
3. **Классификация** - для каждой номенклатуры:
   - Проверяет, не классифицирована ли уже
   - Отправляет запрос к AI для определения категории
   - Сворачивает категорию до нужной глубины (по стратегии)
   - Сохраняет результат в базу данных
4. **Отчет** - выводит статистику по завершении

## Автоматическая миграция

Скрипт автоматически добавляет поля категорий в таблицу `nomenclature_items`, если их еще нет:
- `category_original` - полный путь категории (JSON)
- `category_level1` - уровень 1
- `category_level2` - уровень 2
- `category_level3` - уровень 3
- `category_level4` - уровень 4
- `category_level5` - уровень 5
- `classification_strategy` - использованная стратегия
- `classification_confidence` - уверенность классификации (0.0-1.0)

## Производительность

- Скрипт обрабатывает номенклатуры порциями по 1000 элементов
- Показывает прогресс каждые 100 элементов
- Пропускает уже классифицированные элементы
- Добавляет небольшие задержки для избежания rate limiting API

## Пример вывода

```
Классификация номенклатуры
База данных: 1c_data.db
Classifier ID: 1
Strategy ID: top_priority

Классификатор: КПВЭД
Максимальная глубина: 6

Загрузка номенклатуры из базы...
Найдено номенклатур: 15973

Начинаем классификацию...
Обработано: 100/15973 (успешно: 95, ошибок: 2, пропущено: 3) | Скорость: 2.3/сек | Осталось: ~6900 сек
...

=== Результаты классификации ===
Всего номенклатур: 15973
Успешно классифицировано: 15850
Ошибок: 50
Пропущено (уже классифицировано): 73
Время выполнения: 2h15m30s
Средняя скорость: 1.95 элементов/сек
```

## Примечания

- Процесс может занять длительное время для больших объемов данных
- Рекомендуется запускать в фоновом режиме или через screen/tmux
- При ошибках классификации скрипт продолжает работу и выводит статистику в конце
- Уже классифицированные элементы автоматически пропускаются

## Проверка результатов

После завершения классификации можно проверить результаты:

```sql
-- Количество классифицированных номенклатур
SELECT COUNT(*) FROM nomenclature_items 
WHERE category_level1 IS NOT NULL AND category_level1 != '';

-- Статистика по категориям уровня 1
SELECT category_level1, COUNT(*) as count 
FROM nomenclature_items 
WHERE category_level1 IS NOT NULL 
GROUP BY category_level1 
ORDER BY count DESC;

-- Средняя уверенность классификации
SELECT AVG(classification_confidence) as avg_confidence 
FROM nomenclature_items 
WHERE classification_confidence > 0;
```

