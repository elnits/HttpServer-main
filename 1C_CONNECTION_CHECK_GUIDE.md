# Руководство по проверке соединения между 1С и API

## Обзор

Данный документ описывает механизм проверки соединения между конфигурацией 1С и REST API сервером. Система поддерживает два способа проверки соединения: упрощенный (health check) и полный (handshake).

---

## 1. Проверка соединения (Health Check)

### 1.1. Назначение

Проверка доступности API сервера без создания выгрузки. Используется для быстрой диагностики сетевого соединения.

### 1.2. Реализация на стороне 1С

```bsl
&НаСервере
Функция ПроверитьСоединение()
	
	ОбновитьНастройкиИзФормы();
	
	Попытка
		// Пробуем новый API сначала
		URL = АдресСервера + "/api/v1/health";
		Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			Сообщить("✓ Соединение с сервером установлено (новый API)");
			Возврат Истина;
		КонецЕсли;
		
		// Если новый API не доступен, пробуем старый
		URL = АдресСервера + "/handshake";
		XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?><handshake><timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp></handshake>";
		Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			Сообщить("✓ Соединение с сервером установлено (старый API)");
			Возврат Истина;
		КонецЕсли;
		
		Сообщить("✗ Ошибка соединения с сервером");
		Возврат Ложь;
	Исключение
		Сообщить("✗ Ошибка соединения: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции
```

### 1.3. Алгоритм работы

1. **Приоритет 1: Новый API** (`GET /api/v1/health`)
   - Отправляется GET запрос без тела
   - Ожидается HTTP код 200
   - Ответ в формате JSON: `{"status": "healthy", "time": "2025-01-15T10:30:00Z"}`

2. **Приоритет 2: Старый API** (`POST /handshake`)
   - Используется, если новый API недоступен
   - Отправляется POST запрос с минимальным XML
   - Ожидается HTTP код 200

### 1.4. Реализация на стороне API

#### Endpoint: `GET /api/v1/health` или `GET /health`

```go
func (s *Server) handleHealth(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(map[string]interface{}{
		"status": "healthy",
		"time":   time.Now().Format(time.RFC3339),
	})
}
```

**Особенности:**
- Не требует аутентификации
- Не создает выгрузку
- Возвращает только статус доступности сервера
- Формат ответа: JSON

---

## 2. Полная проверка соединения (Handshake)

### 2.1. Назначение

Создание новой выгрузки и получение UUID для последующей работы. Используется перед началом экспорта данных.

### 2.2. Реализация на стороне 1С

```bsl
// Пример полного handshake запроса
URL = АдресСервера + "/api/v1/upload/handshake";

XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
	"<handshake>" +
	"<version_1c>" + Версия1С + "</version_1c>" +
	"<config_name>" + ИмяКонфигурации + "</config_name>" +
	"<database_id>" + ИдентификаторБазыДанных + "</database_id>" +
	"<computer_name>" + ИмяКомпьютера + "</computer_name>" +
	"<user_name>" + ИмяПользователя + "</user_name>" +
	"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
	"</handshake>";

Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
```

### 2.3. Структура запроса

#### Обязательные поля:
- `version_1c` - версия платформы 1С (например, "8.3.25")
- `config_name` - имя конфигурации (например, "УправлениеТорговлей")
- `timestamp` - временная метка в формате ISO 8601

#### Опциональные поля:
- `database_id` - идентификатор базы данных в системе API
- `config_version` - версия конфигурации
- `computer_name` - имя компьютера
- `user_name` - имя пользователя
- `iteration_number` - номер итерации
- `iteration_label` - метка итерации
- `programmer_name` - имя программиста
- `upload_purpose` - цель выгрузки
- `parent_upload_id` - UUID родительской выгрузки

### 2.4. Структура ответа

```xml
<?xml version="1.0" encoding="UTF-8"?>
<handshake_response>
  <success>true</success>
  <upload_uuid>550e8400-e29b-41d4-a716-446655440000</upload_uuid>
  <client_name>Имя клиента</client_name>
  <project_name>Имя проекта</project_name>
  <database_name>Имя базы данных</database_name>
  <message>Handshake successful</message>
  <timestamp>2025-01-15T10:30:00Z</timestamp>
</handshake_response>
```

### 2.5. Реализация на стороне API

#### Endpoint: `POST /handshake` или `POST /api/v1/upload/handshake`

**Обработка запроса:**

1. **Валидация обязательных полей:**
   - Проверяется наличие `version_1c`
   - Проверяется наличие `config_name`

2. **Определение database_id:**
   - Приоритет 1: Прямой `database_id` из запроса
   - Приоритет 2: Автоматический поиск по параметрам:
     - `computer_name`
     - `user_name`
     - `config_name`
     - `version_1c`
     - `config_version`

3. **Создание выгрузки:**
   - Генерируется UUID для новой выгрузки
   - Сохраняется информация о выгрузке в базе данных
   - Связывается с базой данных (если `database_id` определен)

4. **Формирование ответа:**
   - Возвращается `upload_uuid` для использования в последующих запросах
   - Возвращается информация о клиенте/проекте/базе (если найдена)

**Коды ответа:**
- `200 OK` - успешное создание выгрузки
- `400 Bad Request` - отсутствуют обязательные поля
- `500 Internal Server Error` - ошибка сервера

---

## 3. Проверка привязки базы данных

### 3.1. Назначение

Проверка существования и доступности конкретной базы данных в системе API.

### 3.2. Реализация на стороне 1С

```bsl
&НаСервере
Функция ПроверитьПривязкуБазыДанных()
	
	ОбновитьНастройкиИзФормы();
	
	Если ИдентификаторБазыДанных = "" Тогда
		Сообщить("✗ Не указан идентификатор базы данных");
		Возврат "Не указан идентификатор базы данных";
	КонецЕсли;
	
	Попытка
		URL = АдресСервера + "/api/v1/databases/" + ИдентификаторБазыДанных;
		Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			ТелоОтвета = ПолучитьТелоОтвета(Ответ);
			ИмяКлиента = ИзвлечьЗначениеИзXML(ТелоОтвета, "client_name");
			ИмяПроекта = ИзвлечьЗначениеИзXML(ТелоОтвета, "project_name");
			ИмяБазы = ИзвлечьЗначениеИзXML(ТелоОтвета, "database_name");
			
			Если ИмяКлиента <> "" Тогда
				ОбновитьИнформациюОБазе(ИмяКлиента, ИмяПроекта, ИмяБазы);
				Результат = "✓ Привязка успешна: " + ИмяКлиента + " / " + ИмяПроекта + " / " + ИмяБазы;
				Сообщить(Результат);
				Возврат Результат;
			Иначе
				Сообщить("✗ База данных найдена, но информация о клиенте/проекте отсутствует");
				Возврат "База данных найдена, но информация о клиенте/проекте отсутствует";
			КонецЕсли;
		Иначе
			ТелоОтвета = ПолучитьТелоОтвета(Ответ);
			Результат = "✗ Ошибка привязки: " + ТелоОтвета;
			Сообщить(Результат);
			Возврат Результат;
		КонецЕсли;
	Исключение
		Результат = "✗ Ошибка соединения с сервером: " + ОписаниеОшибки();
		Сообщить(Результат);
		Возврат Результат;
	КонецПопытки;
	
КонецФункции
```

### 3.3. Реализация на стороне API

#### Endpoint: `GET /api/v1/databases/{id}`

**Обработка запроса:**

1. **Парсинг database_id:**
   - Извлекается из пути URL
   - Преобразуется в целое число

2. **Поиск базы данных:**
   - Запрос к serviceDB для получения информации о базе
   - Получение связанной информации о проекте и клиенте

3. **Формирование ответа:**
   - XML с информацией о клиенте, проекте и базе данных

**Коды ответа:**
- `200 OK` - база данных найдена
- `400 Bad Request` - неверный формат ID
- `404 Not Found` - база данных не найдена

---

## 4. Вспомогательные функции

### 4.1. Отправка HTTP запроса

```bsl
Функция ОтправитьHTTPЗапрос(Метод, URL, ТелоЗапроса)
	
	Попытка
		// Парсинг URL
		ПозицияПротокола = СтрНайти(URL, "://");
		Если ПозицияПротокола > 0 Тогда
			URLБезПротокола = Прав(URL, СтрДлина(URL) - ПозицияПротокола - 2);
			ПозицияСлеша = СтрНайти(URLБезПротокола, "/");
			Если ПозицияСлеша > 0 Тогда
				БазовыйАдресСервера = Лев(URLБезПротокола, ПозицияСлеша - 1);
				ПутьЗапроса = Прав(URLБезПротокола, СтрДлина(URLБезПротокола) - ПозицияСлеша + 1);
			Иначе
				БазовыйАдресСервера = URLБезПротокола;
				ПутьЗапроса = "/";
			КонецЕсли;
		Иначе
			БазовыйАдресСервера = URL;
			ПутьЗапроса = "/";
		КонецЕсли;
		
		// Создание соединения (таймаут 30 секунд)
		Соединение = Новый HTTPСоединение(БазовыйАдресСервера, , , , , 30);
		Заголовки = СоздатьHTTPЗаголовки();
		
		// Создание запроса
		HTTPЗапрос = Новый HTTPЗапрос(ПутьЗапроса, Заголовки);
		
		// Установка тела запроса
		Если Не ПустаяСтрока(ТелоЗапроса) Тогда
			HTTPЗапрос.УстановитьТелоИзСтроки(ТелоЗапроса, КодировкаТекста.UTF8);
		КонецЕсли;
		
		// Отправка запроса
		МетодВерхний = ВРег(Метод);
		Если МетодВерхний = "GET" Тогда
			Ответ = Соединение.Получить(HTTPЗапрос);
		Иначе
			Ответ = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
		КонецЕсли;
		
		Возврат Ответ;
		
	Исключение
		Сообщить("Ошибка при отправке HTTP запроса: " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции
```

### 4.2. Создание HTTP заголовков

```bsl
Функция СоздатьHTTPЗаголовки()
	
	Заголовки = Новый Соответствие;
	Заголовки.Вставить("Content-Type", "application/xml; charset=utf-8");
	Заголовки.Вставить("Accept", "application/xml, application/json, */*");
	
	Возврат Заголовки;
	
КонецФункции
```

### 4.3. Получение кода состояния

```bsl
Функция ПолучитьКодСостояния(Ответ)
	
	КодСостояния = 0;
	Попытка
		КодСостояния = Ответ.КодСостояния;
	Исключение
		Попытка
			КодСостояния = Ответ.КодОтвета;
		Исключение
			КодСостояния = 0;
		КонецПопытки;
	КонецПопытки;
	
	Возврат КодСостояния;
	
КонецФункции
```

### 4.4. Получение тела ответа

```bsl
Функция ПолучитьТелоОтвета(Ответ)
	
	Попытка
		Возврат Ответ.ПолучитьТелоКакСтроку();
	Исключение
		Попытка
			Возврат Ответ.ТелоОтвета;
		Исключение
			Возврат "Не удалось получить тело ответа";
		КонецПопытки;
	КонецПопытки;
	
КонецФункции
```

---

## 5. Рекомендации по использованию

### 5.1. Порядок проверки соединения

1. **Перед началом работы:**
   - Вызвать `ПроверитьСоединение()` для проверки доступности API
   - Вызвать `ПроверитьПривязкуБазыДанных()` для проверки корректности `database_id`

2. **Перед началом выгрузки:**
   - Выполнить полный `handshake` для получения `upload_uuid`
   - Сохранить `upload_uuid` для использования в последующих запросах

### 5.2. Обработка ошибок

- Всегда оборачивайте вызовы в блок `Попытка...Исключение`
- Проверяйте HTTP коды ответа перед обработкой тела
- Логируйте все ошибки для диагностики

### 5.3. Таймауты

- Таймаут соединения: 30 секунд
- При необходимости можно увеличить для медленных сетей

### 5.4. Кодировка

- Всегда используйте UTF-8 для XML запросов
- Указывайте кодировку в XML декларации: `<?xml version="1.0" encoding="UTF-8"?>`

---

## 6. Примеры использования

### 6.1. Простая проверка соединения

```bsl
Если ПроверитьСоединение() Тогда
	Сообщить("Сервер доступен");
Иначе
	Сообщить("Сервер недоступен");
КонецЕсли;
```

### 6.2. Проверка с привязкой базы данных

```bsl
Если ПроверитьСоединение() Тогда
	Результат = ПроверитьПривязкуБазыДанных();
	Сообщить(Результат);
КонецЕсли;
```

### 6.3. Полный handshake перед выгрузкой

```bsl
// Выполняем handshake
URL = АдресСервера + "/api/v1/upload/handshake";
XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
	"<handshake>" +
	"<version_1c>8.3.25</version_1c>" +
	"<config_name>УправлениеТорговлей</config_name>" +
	"<database_id>1</database_id>" +
	"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
	"</handshake>";

Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);

Если ПолучитьКодСостояния(Ответ) = 200 Тогда
	ТелоОтвета = ПолучитьТелоОтвета(Ответ);
	ИдентификаторВыгрузки = ИзвлечьЗначениеИзXML(ТелоОтвета, "upload_uuid");
	Сообщить("Выгрузка создана: " + ИдентификаторВыгрузки);
КонецЕсли;
```

---

## 7. Отладка

### 7.1. Типичные проблемы

1. **Ошибка "Method not allowed"**
   - Проверьте правильность HTTP метода (GET для health, POST для handshake)

2. **Ошибка "Missing required field"**
   - Убедитесь, что все обязательные поля присутствуют в XML

3. **Ошибка соединения**
   - Проверьте доступность сервера
   - Проверьте правильность адреса сервера
   - Проверьте настройки файрвола

4. **Ошибка кодировки**
   - Убедитесь, что используется UTF-8
   - Проверьте экранирование XML символов

### 7.2. Логирование

Рекомендуется логировать:
- URL запроса
- Тело запроса (для отладки)
- Код состояния ответа
- Тело ответа (для отладки)
- Ошибки с полным описанием

---

## 8. Примеры тестовых запросов

### 8.1. Минимальный handshake запрос

```xml
<?xml version="1.0" encoding="UTF-8"?>
<handshake>
  <version_1c>8.3.25</version_1c>
  <config_name>УправлениеТорговлей</config_name>
  <timestamp>2025-01-16T12:00:00</timestamp>
</handshake>
```

### 8.2. Полный handshake запрос с database_id

```xml
<?xml version="1.0" encoding="UTF-8"?>
<handshake>
  <database_id>1</database_id>
  <version_1c>8.3.25</version_1c>
  <config_name>TestConfig</config_name>
  <config_version>1.0.0</config_version>
  <computer_name>TEST-PC</computer_name>
  <user_name>TestUser</user_name>
  <timestamp>2025-01-16T12:00:00</timestamp>
  <iteration_number>1</iteration_number>
  <iteration_label>test-iteration</iteration_label>
  <programmer_name>TestProgrammer</programmer_name>
  <upload_purpose>Testing connection</upload_purpose>
</handshake>
```

### 8.3. Тестирование через curl

#### Health check:
```bash
curl -X GET http://localhost:9999/api/v1/health
```

**Ожидаемый ответ:**
```json
{
  "status": "healthy",
  "time": "2025-01-16T12:00:00Z"
}
```

#### Handshake:
```bash
curl -X POST http://localhost:9999/handshake \
  -H "Content-Type: application/xml; charset=utf-8" \
  -d "<?xml version=\"1.0\" encoding=\"UTF-8\"?><handshake><version_1c>8.3.25</version_1c><config_name>TestConfig</config_name><timestamp>2025-01-16T12:00:00</timestamp></handshake>"
```

**Ожидаемый ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<handshake_response>
  <success>true</success>
  <upload_uuid>550e8400-e29b-41d4-a716-446655440000</upload_uuid>
  <message>Handshake successful</message>
  <timestamp>2025-01-16T12:00:00Z</timestamp>
</handshake_response>
```

#### Проверка базы данных:
```bash
curl -X GET http://localhost:9999/api/v1/databases/1
```

**Ожидаемый ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<database_info>
  <database_id>1</database_id>
  <client_name>Имя клиента</client_name>
  <project_name>Имя проекта</project_name>
  <database_name>Имя базы данных</database_name>
</database_info>
```

---

## 9. Заключение

Система проверки соединения обеспечивает:
- Быструю диагностику доступности API (health check)
- Создание выгрузки с получением UUID (handshake)
- Проверку корректности привязки базы данных

Используйте упрощенную проверку (`/api/v1/health`) для быстрой диагностики и полный `handshake` перед началом выгрузки данных.

