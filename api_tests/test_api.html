<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тесты API 1C HTTP Server</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        h2 {
            color: #666;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin-bottom: 30px;
        }
        .request-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .response-box {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error-box {
            background: #f8d7da;
            border: 1px solid #dc3545;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Тесты API 1C HTTP Server</h1>
        <p>Этот файл содержит тесты для проверки работы HTTP сервера, принимающего данные из 1С.</p>
        
        <div class="test-section">
            <h2>1. Проверка здоровья сервера</h2>
            <div class="request-box">
                <strong>GET /health</strong><br>
                Проверяет доступность сервера
            </div>
            <button onclick="testHealth()">Тестировать</button>
            <div id="health-result"></div>
        </div>

        <div class="test-section">
            <h2>2. Рукопожатие</h2>
            <div class="request-box">
                <strong>POST /handshake</strong><br>
                <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;handshake&gt;
  &lt;version_1c&gt;8.3.20&lt;/version_1c&gt;
  &lt;config_name&gt;TestConfig&lt;/config_name&gt;
  &lt;timestamp&gt;2025-10-29T11:00:00Z&lt;/timestamp&gt;
&lt;/handshake&gt;</pre>
            </div>
            <button onclick="testHandshake()">Тестировать</button>
            <div id="handshake-result"></div>
        </div>

        <div class="test-section">
            <h2>3. Отправка метаинформации</h2>
            <div class="request-box">
                <strong>POST /metadata</strong><br>
                <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;metadata&gt;
  &lt;upload_uuid&gt;[UUID_ИЗ_РУКОПОЖАТИЯ]&lt;/upload_uuid&gt;
  &lt;version_1c&gt;8.3.20&lt;/version_1c&gt;
  &lt;config_name&gt;TestConfig&lt;/config_name&gt;
  &lt;timestamp&gt;2025-10-29T11:00:00Z&lt;/timestamp&gt;
&lt;/metadata&gt;</pre>
            </div>
            <button onclick="testMetadata()">Тестировать</button>
            <div id="metadata-result"></div>
        </div>

        <div class="test-section">
            <h2>4. Отправка константы</h2>
            <div class="request-box">
                <strong>POST /constant</strong><br>
                <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;constant&gt;
  &lt;upload_uuid&gt;[UUID_ИЗ_РУКОПОЖАТИЯ]&lt;/upload_uuid&gt;
  &lt;name&gt;TestConstant&lt;/name&gt;
  &lt;synonym&gt;TestConst&lt;/synonym&gt;
  &lt;type&gt;String&lt;/type&gt;
  &lt;value&gt;TestValue&lt;/value&gt;
  &lt;timestamp&gt;2025-10-29T11:00:00Z&lt;/timestamp&gt;
&lt;/constant&gt;</pre>
            </div>
            <button onclick="testConstant()">Тестировать</button>
            <div id="constant-result"></div>
        </div>

        <div class="test-section">
            <h2>5. Отправка метаданных справочника</h2>
            <div class="request-box">
                <strong>POST /catalog/meta</strong><br>
                <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;catalog_meta&gt;
  &lt;upload_uuid&gt;[UUID_ИЗ_РУКОПОЖАТИЯ]&lt;/upload_uuid&gt;
  &lt;name&gt;Номенклатура&lt;/name&gt;
  &lt;synonym&gt;Номенклатура&lt;/synonym&gt;
  &lt;timestamp&gt;2025-10-29T11:00:00Z&lt;/timestamp&gt;
&lt;/catalog_meta&gt;</pre>
            </div>
            <button onclick="testCatalogMeta()">Тестировать</button>
            <div id="catalog-meta-result"></div>
        </div>

        <div class="test-section">
            <h2>6. Отправка элемента справочника</h2>
            <div class="request-box">
                <strong>POST /catalog/item</strong><br>
                <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;catalog_item&gt;
  &lt;upload_uuid&gt;[UUID_ИЗ_РУКОПОЖАТИЯ]&lt;/upload_uuid&gt;
  &lt;catalog_name&gt;Номенклатура&lt;/catalog_name&gt;
  &lt;reference&gt;00000001-0000-0000-0000-000000000000&lt;/reference&gt;
  &lt;code&gt;TEST001&lt;/code&gt;
  &lt;name&gt;Тестовый элемент&lt;/name&gt;
  &lt;attributes&gt;{"Артикул": "TEST001", "ПолноеНаименование": "Тестовый элемент"}&lt;/attributes&gt;
  &lt;table_parts&gt;{}&lt;/table_parts&gt;
  &lt;timestamp&gt;2025-10-29T11:00:00Z&lt;/timestamp&gt;
&lt;/catalog_item&gt;</pre>
            </div>
            <button onclick="testCatalogItem()">Тестировать</button>
            <div id="catalog-item-result"></div>
        </div>

        <div class="test-section">
            <h2>7. Завершение выгрузки</h2>
            <div class="request-box">
                <strong>POST /complete</strong><br>
                <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;complete&gt;
  &lt;upload_uuid&gt;[UUID_ИЗ_РУКОПОЖАТИЯ]&lt;/upload_uuid&gt;
  &lt;timestamp&gt;2025-10-29T11:00:00Z&lt;/timestamp&gt;
&lt;/complete&gt;</pre>
            </div>
            <button onclick="testComplete()">Тестировать</button>
            <div id="complete-result"></div>
        </div>

        <div class="test-section">
            <h2>8. Получение статистики</h2>
            <div class="request-box">
                <strong>GET /stats</strong><br>
                Получает статистику по выгрузкам
            </div>
            <button onclick="testStats()">Тестировать</button>
            <div id="stats-result"></div>
        </div>

        <div class="test-section">
            <h2>9. Полный тест интеграции</h2>
            <p>Выполняет все тесты последовательно</p>
            <button onclick="runFullTest()">Запустить полный тест</button>
            <div id="full-test-result"></div>
        </div>
    </div>

    <script>
        let currentUploadUUID = '';
        const serverUrl = 'http://localhost:9999';

        async function makeRequest(url, method = 'GET', body = null, contentType = 'application/xml') {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': contentType
                    }
                };
                
                if (body) {
                    options.body = body;
                }

                const response = await fetch(url, options);
                const responseText = await response.text();
                
                return {
                    status: response.status,
                    statusText: response.statusText,
                    body: responseText
                };
            } catch (error) {
                return {
                    status: 0,
                    statusText: 'Network Error',
                    body: error.message
                };
            }
        }

        function displayResult(elementId, result) {
            const element = document.getElementById(elementId);
            
            if (result.status >= 200 && result.status < 300) {
                element.innerHTML = `
                    <div class="status success">✓ Успешно (${result.status})</div>
                    <div class="response-box">${result.body}</div>
                `;
            } else {
                element.innerHTML = `
                    <div class="status error">✗ Ошибка (${result.status})</div>
                    <div class="error-box">${result.body}</div>
                `;
            }
        }

        async function testHealth() {
            const result = await makeRequest(`${serverUrl}/health`);
            displayResult('health-result', result);
        }

        async function testHandshake() {
            const body = `<?xml version="1.0" encoding="UTF-8"?>
<handshake>
  <version_1c>8.3.20</version_1c>
  <config_name>TestConfig</config_name>
  <timestamp>${new Date().toISOString()}</timestamp>
</handshake>`;

            const result = await makeRequest(`${serverUrl}/handshake`, 'POST', body);
            
            if (result.status === 200) {
                // Извлекаем UUID из ответа
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(result.body, 'text/xml');
                const uuidElement = xmlDoc.querySelector('upload_uuid');
                if (uuidElement) {
                    currentUploadUUID = uuidElement.textContent;
                }
            }
            
            displayResult('handshake-result', result);
        }

        async function testMetadata() {
            if (!currentUploadUUID) {
                document.getElementById('metadata-result').innerHTML = 
                    '<div class="status error">✗ Сначала выполните рукопожатие</div>';
                return;
            }

            const body = `<?xml version="1.0" encoding="UTF-8"?>
<metadata>
  <upload_uuid>${currentUploadUUID}</upload_uuid>
  <version_1c>8.3.20</version_1c>
  <config_name>TestConfig</config_name>
  <timestamp>${new Date().toISOString()}</timestamp>
</metadata>`;

            const result = await makeRequest(`${serverUrl}/metadata`, 'POST', body);
            displayResult('metadata-result', result);
        }

        async function testConstant() {
            if (!currentUploadUUID) {
                document.getElementById('constant-result').innerHTML = 
                    '<div class="status error">✗ Сначала выполните рукопожатие</div>';
                return;
            }

            const body = `<?xml version="1.0" encoding="UTF-8"?>
<constant>
  <upload_uuid>${currentUploadUUID}</upload_uuid>
  <name>TestConstant</name>
  <synonym>TestConst</synonym>
  <type>String</type>
  <value>TestValue</value>
  <timestamp>${new Date().toISOString()}</timestamp>
</constant>`;

            const result = await makeRequest(`${serverUrl}/constant`, 'POST', body);
            displayResult('constant-result', result);
        }

        async function testCatalogMeta() {
            if (!currentUploadUUID) {
                document.getElementById('catalog-meta-result').innerHTML = 
                    '<div class="status error">✗ Сначала выполните рукопожатие</div>';
                return;
            }

            const body = `<?xml version="1.0" encoding="UTF-8"?>
<catalog_meta>
  <upload_uuid>${currentUploadUUID}</upload_uuid>
  <name>Номенклатура</name>
  <synonym>Номенклатура</synonym>
  <timestamp>${new Date().toISOString()}</timestamp>
</catalog_meta>`;

            const result = await makeRequest(`${serverUrl}/catalog/meta`, 'POST', body);
            displayResult('catalog-meta-result', result);
        }

        async function testCatalogItem() {
            if (!currentUploadUUID) {
                document.getElementById('catalog-item-result').innerHTML = 
                    '<div class="status error">✗ Сначала выполните рукопожатие</div>';
                return;
            }

            const body = `<?xml version="1.0" encoding="UTF-8"?>
<catalog_item>
  <upload_uuid>${currentUploadUUID}</upload_uuid>
  <catalog_name>Номенклатура</catalog_name>
  <reference>00000001-0000-0000-0000-000000000000</reference>
  <code>TEST001</code>
  <name>Тестовый элемент</name>
  <attributes>{"Артикул": "TEST001", "ПолноеНаименование": "Тестовый элемент"}</attributes>
  <table_parts>{}</table_parts>
  <timestamp>${new Date().toISOString()}</timestamp>
</catalog_item>`;

            const result = await makeRequest(`${serverUrl}/catalog/item`, 'POST', body);
            displayResult('catalog-item-result', result);
        }

        async function testComplete() {
            if (!currentUploadUUID) {
                document.getElementById('complete-result').innerHTML = 
                    '<div class="status error">✗ Сначала выполните рукопожатие</div>';
                return;
            }

            const body = `<?xml version="1.0" encoding="UTF-8"?>
<complete>
  <upload_uuid>${currentUploadUUID}</upload_uuid>
  <timestamp>${new Date().toISOString()}</timestamp>
</complete>`;

            const result = await makeRequest(`${serverUrl}/complete`, 'POST', body);
            displayResult('complete-result', result);
        }

        async function testStats() {
            const result = await makeRequest(`${serverUrl}/stats`, 'GET', null, 'application/json');
            displayResult('stats-result', result);
        }

        async function runFullTest() {
            const resultElement = document.getElementById('full-test-result');
            resultElement.innerHTML = '<div class="status info">Запуск полного теста...</div>';
            
            const tests = [
                { name: 'Проверка здоровья', fn: testHealth },
                { name: 'Рукопожатие', fn: testHandshake },
                { name: 'Метаинформация', fn: testMetadata },
                { name: 'Константа', fn: testConstant },
                { name: 'Метаданные справочника', fn: testCatalogMeta },
                { name: 'Элемент справочника', fn: testCatalogItem },
                { name: 'Завершение выгрузки', fn: testComplete },
                { name: 'Статистика', fn: testStats }
            ];

            let results = [];
            
            for (const test of tests) {
                try {
                    await test.fn();
                    results.push(`✓ ${test.name}`);
                } catch (error) {
                    results.push(`✗ ${test.name}: ${error.message}`);
                }
                
                // Небольшая задержка между тестами
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            resultElement.innerHTML = `
                <div class="status info">Полный тест завершен</div>
                <div class="response-box">${results.join('\n')}</div>
            `;
        }

        // Автоматически проверяем доступность сервера при загрузке страницы
        window.onload = function() {
            testHealth();
        };
    </script>
</body>
</html>


