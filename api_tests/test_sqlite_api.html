<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç SQLite HTTP —Å–µ—Ä–≤–µ—Ä–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .test-section {
            margin-bottom: 30px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .response {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        .xml-input {
            width: 100%;
            height: 150px;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        .db-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è –¢–µ—Å—Ç SQLite HTTP —Å–µ—Ä–≤–µ—Ä–∞</h1>
        <p><strong>–°–µ—Ä–≤–µ—Ä:</strong> http://localhost:9998</p>
        <p><strong>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> SQLite (1c_data.db)</p>
        <p><strong>–§–æ—Ä–º–∞—Ç:</strong> XML –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤</p>
        <div class="db-info">
            <strong>‚úÖ SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç!</strong><br>
            –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª <code>1c_data.db</code> –∏ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞.
        </div>
    </div>

    <div class="container">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</h2>
        <button onclick="getStats()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <div id="stats" class="stats"></div>
    </div>

    <div class="container">
        <h2>ü§ù –¢–µ—Å—Ç —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è</h2>
        <p>–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –≤—ã–≥—Ä—É–∑–∫—É –∏ –ø–æ–ª—É—á–∞–µ—Ç UUID</p>
        <button onclick="testHandshake()">–í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ</button>
        <div id="handshake-response" class="response"></div>
    </div>

    <div class="container">
        <h2>üìã –¢–µ—Å—Ç –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</h2>
        <p>–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–≥—Ä—É–∑–∫–µ</p>
        <button onclick="testMetadata()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
        <div id="metadata-response" class="response"></div>
    </div>

    <div class="container">
        <h2>üîß –¢–µ—Å—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã</h2>
        <p>–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SQLite)</p>
        <button onclick="testConstant()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É</button>
        <div id="constant-response" class="response"></div>
    </div>

    <div class="container">
        <h2>üìÅ –¢–µ—Å—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</h2>
        <p>–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SQLite)</p>
        <button onclick="testCatalogMeta()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</button>
        <div id="catalog-meta-response" class="response"></div>
    </div>

    <div class="container">
        <h2>üìÑ –¢–µ—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</h2>
        <p>–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å XML –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –∏ —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ —á–∞—Å—Ç—è–º–∏ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ SQLite)</p>
        <button onclick="testCatalogItem()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</button>
        <div id="catalog-item-response" class="response"></div>
    </div>

    <div class="container">
        <h2>‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–≥—Ä—É–∑–∫–∏</h2>
        <p>–ó–∞–≤–µ—Ä—à–∞–µ—Ç –≤—ã–≥—Ä—É–∑–∫—É (–æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ SQLite)</p>
        <button onclick="testComplete()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–≥—Ä—É–∑–∫—É</button>
        <div id="complete-response" class="response"></div>
    </div>

    <div class="container">
        <h2>üîç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π XML –∑–∞–ø—Ä–æ—Å</h2>
        <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–π XML –∑–∞–ø—Ä–æ—Å –Ω–∞ –ª—é–±–æ–π endpoint</p>
        <select id="endpoint-select">
            <option value="/handshake">POST /handshake</option>
            <option value="/metadata">POST /metadata</option>
            <option value="/constant">POST /constant</option>
            <option value="/catalog/meta">POST /catalog/meta</option>
            <option value="/catalog/item">POST /catalog/item</option>
            <option value="/complete">POST /complete</option>
            <option value="/stats">GET /stats</option>
            <option value="/health">GET /health</option>
        </select>
        <textarea id="xml-input" class="xml-input" placeholder="–í–≤–µ–¥–∏—Ç–µ XML..."></textarea>
        <button onclick="sendCustomRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        <div id="custom-response" class="response"></div>
    </div>

    <script>
        let currentUploadUUID = '';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ XML –∑–∞–ø—Ä–æ—Å–∞
        async function sendXMLRequest(endpoint, xmlData, method = 'POST') {
            try {
                const response = await fetch(`http://localhost:9998${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/xml; charset=utf-8',
                        'Accept': 'application/xml'
                    },
                    body: xmlData
                });

                const responseText = await response.text();
                
                return {
                    status: response.status,
                    statusText: response.statusText,
                    body: responseText,
                    success: response.ok
                };
            } catch (error) {
                return {
                    status: 0,
                    statusText: 'Network Error',
                    body: error.message,
                    success: false
                };
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
        function displayResponse(elementId, result) {
            const element = document.getElementById(elementId);
            const statusClass = result.success ? 'success' : 'error';
            
            element.innerHTML = `<div class="${statusClass}">
                <strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.status} ${result.statusText}
                <strong>–û—Ç–≤–µ—Ç:</strong>
                ${result.body}
            </div>`;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function getStats() {
            const result = await sendXMLRequest('/stats', '', 'GET');
            
            if (result.success) {
                try {
                    const stats = JSON.parse(result.body);
                    const statsDiv = document.getElementById('stats');
                    
                    statsDiv.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_uploads || 0}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –≤—ã–≥—Ä—É–∑–æ–∫</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.active_uploads || 0}</div>
                            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–≥—Ä—É–∑–æ–∫</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_constants || 0}</div>
                            <div class="stat-label">–ö–æ–Ω—Å—Ç–∞–Ω—Ç</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_catalogs || 0}</div>
                            <div class="stat-label">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_items || 0}</div>
                            <div class="stat-label">–≠–ª–µ–º–µ–Ω—Ç–æ–≤</div>
                        </div>
                    `;
                } catch (e) {
                    displayResponse('stats', { success: false, status: 200, statusText: 'OK', body: result.body });
                }
            } else {
                displayResponse('stats', result);
            }
        }

        // –¢–µ—Å—Ç —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è
        async function testHandshake() {
            const xmlData = `<?xml version="1.0" encoding="UTF-8"?>
<handshake>
    <version_1c>8.3.25</version_1c>
    <config_name>TestConfig</config_name>
    <timestamp>${new Date().toISOString()}</timestamp>
</handshake>`;

            const result = await sendXMLRequest('/handshake', xmlData);
            
            if (result.success) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –∏–∑ XML –æ—Ç–≤–µ—Ç–∞
                const uuidMatch = result.body.match(/<upload_uuid>(.*?)<\/upload_uuid>/);
                if (uuidMatch) {
                    currentUploadUUID = uuidMatch[1];
                    console.log('–ü–æ–ª—É—á–µ–Ω UUID –≤—ã–≥—Ä—É–∑–∫–∏:', currentUploadUUID);
                }
            }
            
            displayResponse('handshake-response', result);
        }

        // –¢–µ—Å—Ç –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        async function testMetadata() {
            if (!currentUploadUUID) {
                displayResponse('metadata-response', { 
                    success: false, 
                    status: 400, 
                    statusText: 'Bad Request', 
                    body: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ!' 
                });
                return;
            }

            const xmlData = `<?xml version="1.0" encoding="UTF-8"?>
<metadata>
    <upload_uuid>${currentUploadUUID}</upload_uuid>
    <version_1c>8.3.25</version_1c>
    <config_name>TestConfig</config_name>
    <timestamp>${new Date().toISOString()}</timestamp>
</metadata>`;

            const result = await sendXMLRequest('/metadata', xmlData);
            displayResponse('metadata-response', result);
        }

        // –¢–µ—Å—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        async function testConstant() {
            if (!currentUploadUUID) {
                displayResponse('constant-response', { 
                    success: false, 
                    status: 400, 
                    statusText: 'Bad Request', 
                    body: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ!' 
                });
                return;
            }

            const xmlData = `<?xml version="1.0" encoding="UTF-8"?>
<constant>
    <upload_uuid>${currentUploadUUID}</upload_uuid>
    <name>–¢–µ—Å—Ç–æ–≤–∞—è–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞</name>
    <synonym>–¢–µ—Å—Ç–æ–≤–∞—è–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞</synonym>
    <type>–°—Ç—Ä–æ–∫–∞</type>
    <value>–¢–µ—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</value>
    <timestamp>${new Date().toISOString()}</timestamp>
</constant>`;

            const result = await sendXMLRequest('/constant', xmlData);
            displayResponse('constant-response', result);
        }

        // –¢–µ—Å—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        async function testCatalogMeta() {
            if (!currentUploadUUID) {
                displayResponse('catalog-meta-response', { 
                    success: false, 
                    status: 400, 
                    statusText: 'Bad Request', 
                    body: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ!' 
                });
                return;
            }

            const xmlData = `<?xml version="1.0" encoding="UTF-8"?>
<catalog_meta>
    <upload_uuid>${currentUploadUUID}</upload_uuid>
    <name>–¢–µ—Å—Ç–æ–≤—ã–π–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</name>
    <synonym>–¢–µ—Å—Ç–æ–≤—ã–π–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</synonym>
    <timestamp>${new Date().toISOString()}</timestamp>
</catalog_meta>`;

            const result = await sendXMLRequest('/catalog/meta', xmlData);
            displayResponse('catalog-meta-response', result);
        }

        // –¢–µ—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        async function testCatalogItem() {
            if (!currentUploadUUID) {
                displayResponse('catalog-item-response', { 
                    success: false, 
                    status: 400, 
                    statusText: 'Bad Request', 
                    body: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ!' 
                });
                return;
            }

            const xmlData = `<?xml version="1.0" encoding="UTF-8"?>
<catalog_item>
    <upload_uuid>${currentUploadUUID}</upload_uuid>
    <catalog_name>–¢–µ—Å—Ç–æ–≤—ã–π–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</catalog_name>
    <reference>000000001</reference>
    <code>001</code>
    <name>–¢–µ—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</name>
    <attributes>
        <attributes>
            <–û–ø–∏—Å–∞–Ω–∏–µ>–¢–µ—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</–û–ø–∏—Å–∞–Ω–∏–µ>
            <–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å>true</–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å>
        </attributes>
    </attributes>
    <table_parts>
        <table_parts>
            <–¢–∞–±–ª–∏—á–Ω–∞—è–ß–∞—Å—Ç—å>
                <row>
                    <–ö–æ–ª–æ–Ω–∫–∞1>–ó–Ω–∞—á–µ–Ω–∏–µ1</–ö–æ–ª–æ–Ω–∫–∞1>
                    <–ö–æ–ª–æ–Ω–∫–∞2>–ó–Ω–∞—á–µ–Ω–∏–µ2</–ö–æ–ª–æ–Ω–∫–∞2>
                </row>
                <row>
                    <–ö–æ–ª–æ–Ω–∫–∞1>–ó–Ω–∞—á–µ–Ω–∏–µ3</–ö–æ–ª–æ–Ω–∫–∞1>
                    <–ö–æ–ª–æ–Ω–∫–∞2>–ó–Ω–∞—á–µ–Ω–∏–µ4</–ö–æ–ª–æ–Ω–∫–∞2>
                </row>
            </–¢–∞–±–ª–∏—á–Ω–∞—è–ß–∞—Å—Ç—å>
        </table_parts>
    </table_parts>
    <timestamp>${new Date().toISOString()}</timestamp>
</catalog_item>`;

            const result = await sendXMLRequest('/catalog/item', xmlData);
            displayResponse('catalog-item-response', result);
        }

        // –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–≥—Ä—É–∑–∫–∏
        async function testComplete() {
            if (!currentUploadUUID) {
                displayResponse('complete-response', { 
                    success: false, 
                    status: 400, 
                    statusText: 'Bad Request', 
                    body: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ!' 
                });
                return;
            }

            const xmlData = `<?xml version="1.0" encoding="UTF-8"?>
<complete>
    <upload_uuid>${currentUploadUUID}</upload_uuid>
    <timestamp>${new Date().toISOString()}</timestamp>
</complete>`;

            const result = await sendXMLRequest('/complete', xmlData);
            displayResponse('complete-response', result);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        async function sendCustomRequest() {
            const endpoint = document.getElementById('endpoint-select').value;
            const xmlData = document.getElementById('xml-input').value;
            
            if (!xmlData.trim()) {
                displayResponse('custom-response', { 
                    success: false, 
                    status: 400, 
                    statusText: 'Bad Request', 
                    body: '–í–≤–µ–¥–∏—Ç–µ XML –¥–∞–Ω–Ω—ã–µ!' 
                });
                return;
            }

            const method = endpoint === '/stats' || endpoint === '/health' ? 'GET' : 'POST';
            const result = await sendXMLRequest(endpoint, xmlData, method);
            displayResponse('custom-response', result);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(getStats, 5000);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            getStats();
        };
    </script>
</body>
</html>

