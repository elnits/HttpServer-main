# Руководство по импорту данных из сервера в 1С

## Содержание

1. [Введение](#введение)
2. [Подготовка](#подготовка)
3. [Получение списка баз](#получение-списка-баз)
4. [Импорт данных](#импорт-данных)
5. [Обработка ошибок](#обработка-ошибок)
6. [FAQ](#faq)
7. [Примеры использования](#примеры-использования)

---

## Введение

Данное руководство описывает процесс загрузки данных из SQLite баз данных, хранящихся на сервере, обратно в 1С:Предприятие. Эта функция позволяет:

- Восстановить данные из предыдущих выгрузок
- Загрузить обработанные/нормализованные данные
- Синхронизировать данные между базами 1С
- Импортировать справочные данные из централизованного хранилища

**Основные возможности:**
- Просмотр списка доступных баз данных на сервере
- Выбор конкретной базы для импорта
- Загрузка констант
- Загрузка справочников с пагинацией (порциями)
- Автоматическое создание/обновление элементов в 1С

---

## Подготовка

### Требования

1. **Сервер:**
   - HTTP Server должен быть запущен и доступен
   - На сервере должны быть файлы баз данных (`.db` файлы)
   - Порт сервера должен быть доступен из сети 1С

2. **1С:Предприятие:**
   - Внешняя обработка `БитЭкспортер.epf` должна быть загружена
   - У пользователя должны быть права на запись в справочники
   - Справочники в 1С должны существовать (с такими же именами, как в базе)

3. **Настройки подключения:**
   - Адрес сервера (например: `http://localhost:9999`)
   - Сетевое соединение между 1С и сервером

### Проверка доступности сервера

Перед началом работы убедитесь, что сервер доступен:

```bash
# Windows PowerShell
Test-NetConnection -ComputerName localhost -Port 9999

# Linux/Mac
curl http://localhost:9999/health
```

Ожидаемый ответ от `/health`:
```json
{
  "status": "ok",
  "database": "connected"
}
```

---

## Получение списка баз

### Шаг 1: Запрос списка баз

В обработке `БитЭкспортер` выполните процедуру `ПолучитьСписокБаз()`:

1. Откройте обработку в 1С
2. В поле "Адрес сервера" укажите адрес (например: `http://192.168.1.100:9999`)
3. Нажмите кнопку **"Получить список баз с сервера"**

**Или вызовите функцию программно:**

```bsl
СписокБаз = ПолучитьСписокБазССервера();

Для Каждого База Из СписокБаз Цикл
    Сообщить("База: " + База.ИмяФайла);
    Сообщить("  Конфигурация: " + База.ИмяКонфигурации);
    Сообщить("  Дата: " + База.ДатаНачала);
    Сообщить("  Справочников: " + Строка(База.КоличествоСправочников));
    Сообщить("  Констант: " + Строка(База.КоличествоКонстант));
    Сообщить("  Элементов: " + Строка(База.КоличествоЭлементов));
КонецЦикла;
```

### Пример вывода

```
========================================
СПИСОК ДОСТУПНЫХ БАЗ НА СЕРВЕРЕ:
========================================

1. Выгрузка_Номенклатура_ERPWE_mpf_Unknown_2025-11-25_00-16-03.db
   Конфигурация: ERPWE
   Дата создания: 2025-11-25T00:16:03Z
   Справочников: 5
   Констант: 15
   Элементов: 1250

2. Выгрузка_Контрагенты_ERP_2025-11-26_10-30-00.db
   Конфигурация: ERP
   Дата создания: 2025-11-26T10:30:00Z
   Справочников: 2
   Констант: 8
   Элементов: 350

========================================
```

### Шаг 2: Выбор базы для импорта

Из списка выберите нужную базу и установите переменную:

```bsl
ВыбраннаяБазаДляИмпорта = "Выгрузка_Номенклатура_ERPWE_mpf_Unknown_2025-11-25_00-16-03.db";
```

---

## Импорт данных

### Автоматический импорт (рекомендуется)

Самый простой способ - использовать функцию `ИмпортироватьДанныеИзБазы()`, которая выполняет весь процесс автоматически:

```bsl
// Установите имя базы для импорта
ВыбраннаяБазаДляИмпорта = "Выгрузка_Номенклатура_ERPWE_mpf_Unknown_2025-11-25_00-16-03.db";

// Параметры импорта
ЗагружатьКонстанты = Истина;  // Загружать ли константы
МассивСправочников = Неопределено;  // Неопределено = загрузить все справочники

// Или выбрать конкретные справочники:
// МассивСправочников = Новый Массив();
// МассивСправочников.Добавить("Номенклатура");
// МассивСправочников.Добавить("Контрагенты");

// Запускаем импорт
Результат = ИмпортироватьДанныеИзБазы(
    ВыбраннаяБазаДляИмпорта,
    ЗагружатьКонстанты,
    МассивСправочников
);

Если Результат Тогда
    Сообщить("✓ Импорт завершен успешно!");
Иначе
    Сообщить("✗ Импорт завершен с ошибками!");
КонецЕсли;
```

### Пример вывода автоматического импорта

```
========================================
НАЧАЛО ИМПОРТА ДАННЫХ ИЗ БАЗЫ
========================================
База данных: Выгрузка_Номенклатура_ERPWE_mpf_Unknown_2025-11-25_00-16-03.db

Шаг 1: Handshake...
✓ Handshake успешен. UUID: 550e8400-e29b-41d4-a716-446655440000
Справочников: 5, Констант: 15

Шаг 2: Загрузка констант (15 шт.)...
✓ Получено констант: 15 из 15
  Константа: ОсновнаяВалюта = 643
  Константа: ИспользоватьСкладскойУчет = true
  ...

Шаг 3: Загрузка справочников (5 шт.)...

  Справочник: Номенклатура (1000 элементов)
✓ Получено элементов: 500 из 1000
  Загружено: 500 / 1000
✓ Получено элементов: 500 из 1000
  Загружено: 1000 / 1000
  ✓ Справочник 'Номенклатура' загружен: 1000 элементов

  Справочник: Контрагенты (250 элементов)
✓ Получено элементов: 250 из 250
  Загружено: 250 / 250
  ✓ Справочник 'Контрагенты' загружен: 250 элементов

...

Шаг 4: Завершение импорта...
✓ Импорт успешно завершен

========================================
ИМПОРТ ЗАВЕРШЕН УСПЕШНО
========================================
```

---

### Ручной импорт (пошаговый)

Для более тонкого контроля можно выполнить импорт вручную:

#### Шаг 1: Handshake

```bsl
ИмяБазы = "Выгрузка_Номенклатура_ERPWE_mpf_Unknown_2025-11-25_00-16-03.db";
РезультатHandshake = НачатьИмпортИзБазы(ИмяБазы);

Если РезультатHandshake = Неопределено ИЛИ НЕ РезультатHandshake.Success Тогда
    Сообщить("✗ Не удалось начать импорт!");
    Возврат;
КонецЕсли;

Сообщить("✓ Handshake успешен. UUID: " + РезультатHandshake.UploadUUID);
Сообщить("Справочников: " + Строка(РезультатHandshake.Справочники.Количество()));
Сообщить("Констант: " + Строка(РезультатHandshake.КоличествоКонстант));
```

#### Шаг 2: Загрузка констант

```bsl
Если РезультатHandshake.КоличествоКонстант > 0 Тогда
    Offset = 0;
    Limit = 1000;
    
    РезультатКонстант = ЗагрузитьКонстантыИзБазы(ИмяБазы, Offset, Limit);
    
    Если РезультатКонстант <> Неопределено И РезультатКонстант.Success Тогда
        Сообщить("✓ Получено констант: " + Строка(РезультатКонстант.Константы.Количество()));
        
        // Обработка констант (запись в 1С)
        Для Каждого Константа Из РезультатКонстант.Константы Цикл
            // Здесь можно записать значения констант в 1С
            Сообщить("Константа: " + Константа.Name + " = " + Константа.Value);
        КонецЦикла;
    КонецЕсли;
КонецЕсли;
```

#### Шаг 3: Загрузка справочников

```bsl
Для Каждого ИнфоСправочника Из РезультатHandshake.Справочники Цикл
    
    ИмяСправочника = ИнфоСправочника.Имя;
    КоличествоЭлементов = ИнфоСправочника.КоличествоЭлементов;
    
    Сообщить("Загружаем справочник: " + ИмяСправочника + " (" + Строка(КоличествоЭлементов) + " элементов)");
    
    Offset = 0;
    Limit = 500;
    ЗагруженоЭлементов = 0;
    
    Пока Offset < КоличествоЭлементов Цикл
        
        РезультатСправочника = ЗагрузитьСправочникИзБазы(ИмяБазы, ИмяСправочника, Offset, Limit);
        
        Если РезультатСправочника = Неопределено ИЛИ НЕ РезультатСправочника.Success Тогда
            Сообщить("✗ Ошибка загрузки справочника!");
            Прервать;
        КонецЕсли;
        
        // Записываем элементы в базу 1С
        Для Каждого Элемент Из РезультатСправочника.Элементы Цикл
            Если ЗаписатьЭлементСправочника(Элемент, ИмяСправочника) Тогда
                ЗагруженоЭлементов = ЗагруженоЭлементов + 1;
            КонецЕсли;
        КонецЦикла;
        
        Сообщить("Загружено: " + Строка(ЗагруженоЭлементов) + " / " + Строка(КоличествоЭлементов));
        
        Offset = Offset + Limit;
        
        Если РезультатСправочника.Элементы.Количество() < Limit Тогда
            Прервать;
        КонецЕсли;
        
    КонецЦикла;
    
    Сообщить("✓ Справочник '" + ИмяСправочника + "' загружен: " + Строка(ЗагруженоЭлементов) + " элементов");
    
КонецЦикла;
```

#### Шаг 4: Завершение импорта

```bsl
ЗавершитьИмпортИзБазы(ИмяБазы);
Сообщить("✓ Импорт завершен");
```

---

## Обработка ошибок

### Типичные ошибки и их решения

#### 1. Ошибка подключения к серверу

**Ошибка:** `✗ Ошибка при получении списка баз: Не удалось установить соединение`

**Решения:**
- Проверьте, что сервер запущен
- Проверьте правильность адреса сервера
- Проверьте доступность порта (firewall)
- Проверьте сетевое соединение

```bsl
// Проверка доступности сервера
АдресСервера = "http://192.168.1.100:9999";
URL = АдресСервера + "/health";

Попытка
    Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
    КодСостояния = ПолучитьКодСостояния(Ответ);
    
    Если КодСостояния = 200 Тогда
        Сообщить("✓ Сервер доступен");
    Иначе
        Сообщить("✗ Сервер вернул код: " + Строка(КодСостояния));
    КонецЕсли;
Исключение
    Сообщить("✗ Сервер недоступен: " + ОписаниеОшибки());
КонецПопытки;
```

#### 2. База данных не найдена

**Ошибка:** `✗ Ошибка handshake: database file not found`

**Решения:**
- Проверьте, что имя базы указано правильно (с учетом регистра)
- Получите актуальный список баз с сервера
- Убедитесь, что файл базы существует на сервере

#### 3. Справочник не найден в 1С

**Ошибка:** `✗ Справочник 'Номенклатура' не найден в метаданных!`

**Решения:**
- Убедитесь, что справочник с таким именем существует в конфигурации 1С
- Проверьте имя справочника (должно совпадать с метаданными)
- Создайте недостающий справочник в конфигурации

#### 4. Ошибка записи элемента

**Ошибка:** `✗ Ошибка при записи элемента справочника`

**Решения:**
- Проверьте права пользователя на запись
- Проверьте, что обязательные реквизиты заполнены
- Проверьте уникальность кода (если код должен быть уникальным)
- Используйте транзакции для группировки операций

```bsl
// Пример с транзакцией
НачатьТранзакцию();

Попытка
    Для Каждого Элемент Из РезультатСправочника.Элементы Цикл
        ЗаписатьЭлементСправочника(Элемент, ИмяСправочника);
    КонецЦикла;
    
    ЗафиксироватьТранзакцию();
    Сообщить("✓ Пакет элементов записан успешно");
Исключение
    ОтменитьТранзакцию();
    Сообщить("✗ Ошибка при записи пакета: " + ОписаниеОшибки());
КонецПопытки;
```

#### 5. Тайм-аут при загрузке больших справочников

**Ошибка:** `✗ Превышено время ожидания ответа от сервера`

**Решения:**
- Уменьшите размер порции (параметр `Limit`)
- Увеличьте тайм-аут HTTP соединения
- Проверьте производительность сервера

```bsl
// Уменьшение размера порции
Limit = 100;  // Вместо 500

РезультатСправочника = ЗагрузитьСправочникИзБазы(ИмяБазы, ИмяСправочника, Offset, Limit);
```

---

## FAQ

### Вопрос 1: Можно ли загружать только конкретные справочники?

**Ответ:** Да, передайте массив имен справочников в функцию импорта:

```bsl
МассивСправочников = Новый Массив();
МассивСправочников.Добавить("Номенклатура");
МассивСправочников.Добавить("Контрагенты");

Результат = ИмпортироватьДанныеИзБазы(
    ИмяБазы,
    Ложь,  // Не загружать константы
    МассивСправочников
);
```

### Вопрос 2: Что произойдет, если элемент с таким кодом уже существует?

**Ответ:** Функция `ЗаписатьЭлементСправочника` сначала пытается найти элемент по коду. Если элемент найден, он будет обновлен. Если нет - будет создан новый элемент.

### Вопрос 3: Как узнать, сколько элементов было успешно загружено?

**Ответ:** Функция `ИмпортироватьДанныеИзБазы` выводит подробные логи в окно сообщений. Также вы можете подсчитать успешно записанные элементы вручную:

```bsl
УспешноЗаписано = 0;
СОшибками = 0;

Для Каждого Элемент Из РезультатСправочника.Элементы Цикл
    Если ЗаписатьЭлементСправочника(Элемент, ИмяСправочника) Тогда
        УспешноЗаписано = УспешноЗаписано + 1;
    Иначе
        СОшибками = СОшибками + 1;
    КонецЕсли;
КонецЦикла;

Сообщить("Успешно: " + Строка(УспешноЗаписано) + ", С ошибками: " + Строка(СОшибками));
```

### Вопрос 4: Поддерживается ли загрузка табличных частей?

**Ответ:** Да, данные табличных частей хранятся в поле `TablePartsXML` каждого элемента. Однако в текущей версии функция `ЗаписатьЭлементСправочника` записывает только основные реквизиты. Для записи табличных частей необходимо доработать эту функцию с учетом структуры ваших справочников.

### Вопрос 5: Можно ли импортировать данные в фоновом режиме?

**Ответ:** Да, для длительных операций импорта рекомендуется использовать фоновые задания:

```bsl
ПараметрыФоновогоЗадания = Новый Структура();
ПараметрыФоновогоЗадания.Вставить("ИмяБазы", ВыбраннаяБазаДляИмпорта);
ПараметрыФоновогоЗадания.Вставить("ЗагружатьКонстанты", Истина);
ПараметрыФоновогоЗадания.Вставить("МассивСправочников", Неопределено);

ФоновоеЗадание = ФоновыеЗадания.Выполнить(
    "ИмпортироватьДанныеИзБазыНаСервере",
    ПараметрыФоновогоЗадания,
    ,
    "Импорт данных из базы " + ВыбраннаяБазаДляИмпорта
);

Сообщить("Фоновое задание запущено: " + Строка(ФоновоеЗадание.УникальныйИдентификатор));
```

### Вопрос 6: Как часто можно выполнять импорт?

**Ответ:** Ограничений по частоте импорта нет. Однако учитывайте:
- Нагрузку на сервер
- Нагрузку на базу 1С (блокировки при записи)
- Время выполнения операции

Для регулярного импорта рекомендуется использовать регламентные задания.

---

## Примеры использования

### Пример 1: Импорт всех данных из базы

```bsl
// Получаем список баз
СписокБаз = ПолучитьСписокБазССервера();

Если СписокБаз.Количество() = 0 Тогда
    Сообщить("Нет доступных баз для импорта");
    Возврат;
КонецЕсли;

// Выбираем первую базу
ВыбраннаяБаза = СписокБаз[0].ИмяФайла;

// Импортируем все данные
Результат = ИмпортироватьДанныеИзБазы(
    ВыбраннаяБаза,
    Истина,  // Загружать константы
    Неопределено  // Загружать все справочники
);
```

### Пример 2: Импорт только номенклатуры

```bsl
ВыбраннаяБаза = "Выгрузка_Номенклатура_ERPWE_mpf_Unknown_2025-11-25_00-16-03.db";

МассивСправочников = Новый Массив();
МассивСправочников.Добавить("Номенклатура");

Результат = ИмпортироватьДанныеИзБазы(
    ВыбраннаяБаза,
    Ложь,  // Не загружать константы
    МассивСправочников
);
```

### Пример 3: Импорт с проверкой наличия справочников

```bsl
// Получаем информацию о базе
РезультатHandshake = НачатьИмпортИзБазы(ВыбраннаяБаза);

Если РезультатHandshake = Неопределено ИЛИ НЕ РезультатHandshake.Success Тогда
    Сообщить("Не удалось получить информацию о базе");
    Возврат;
КонецЕсли;

// Проверяем наличие каждого справочника в 1С
СправочникиДляЗагрузки = Новый Массив();

Для Каждого Справочник Из РезультатHandshake.Справочники Цикл
    
    ИмяСправочника = Справочник.Имя;
    
    // Проверяем наличие в метаданных
    МетаданныеСправочника = Метаданные.Справочники.Найти(ИмяСправочника);
    
    Если МетаданныеСправочника <> Неопределено Тогда
        СправочникиДляЗагрузки.Добавить(ИмяСправочника);
        Сообщить("✓ Справочник '" + ИмяСправочника + "' будет загружен");
    Иначе
        Сообщить("⚠ Справочник '" + ИмяСправочника + "' не найден в конфигурации, пропускаем");
    КонецЕсли;
    
КонецЦикла;

// Импортируем только те справочники, которые есть в конфигурации
Если СправочникиДляЗагрузки.Количество() > 0 Тогда
    Результат = ИмпортироватьДанныеИзБазы(
        ВыбраннаяБаза,
        Истина,
        СправочникиДляЗагрузки
    );
Иначе
    Сообщить("Нет справочников для загрузки");
КонецЕсли;
```

### Пример 4: Импорт с обработкой ошибок и повторными попытками

```bsl
МаксимумПопыток = 3;
ТекущаяПопытка = 1;
Успешно = Ложь;

Пока ТекущаяПопытка <= МаксимумПопыток И НЕ Успешно Цикл
    
    Сообщить("Попытка импорта " + Строка(ТекущаяПопытка) + " из " + Строка(МаксимумПопыток));
    
    Попытка
        Результат = ИмпортироватьДанныеИзБазы(
            ВыбраннаяБаза,
            Истина,
            Неопределено
        );
        
        Если Результат Тогда
            Успешно = Истина;
            Сообщить("✓ Импорт завершен успешно!");
        Иначе
            Сообщить("✗ Импорт завершился с ошибками");
            ТекущаяПопытка = ТекущаяПопытка + 1;
        КонецЕсли;
        
    Исключение
        Сообщить("✗ Исключение при импорте: " + ОписаниеОшибки());
        ТекущаяПопытка = ТекущаяПопытка + 1;
        
        Если ТекущаяПопытка <= МаксимумПопыток Тогда
            Сообщить("Ожидание 5 секунд перед повторной попыткой...");
            // В 1С нет встроенной функции ожидания, используйте внешний компонент или переходите к следующей попытке
        КонецЕсли;
    КонецПопытки;
    
КонецЦикла;

Если НЕ Успешно Тогда
    Сообщить("✗ Не удалось выполнить импорт после " + Строка(МаксимумПопыток) + " попыток");
КонецЕсли;
```

---

## Заключение

Импорт данных из сервера в 1С - это мощный инструмент для синхронизации и обмена данными. Следуйте рекомендациям из этого руководства для обеспечения надежной и эффективной загрузки данных.

**Важные рекомендации:**

1. Всегда проверяйте доступность сервера перед импортом
2. Используйте пагинацию для больших справочников
3. Обрабатывайте ошибки и логируйте операции
4. Для длительных операций используйте фоновые задания
5. Регулярно создавайте резервные копии базы 1С перед массовым импортом

При возникновении проблем обращайтесь к разделу [Обработка ошибок](#обработка-ошибок) или консультируйтесь с администратором сервера.

**Контакты поддержки:**
- Email: support@example.com
- Telegram: @support_bot
- Документация API: `API_DOCUMENTATION.md`

---

© 2025 HTTP Server для работы с выгрузками из 1С



