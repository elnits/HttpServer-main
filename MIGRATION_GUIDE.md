# Руководство по миграции к единой БД справочников

## Описание изменений

Проект был рефакторирован для использования **единой базы данных** вместо создания отдельных файлов БД для каждой выгрузки.

### Ключевые изменения:

1. **Единая БД справочников** (`unified_catalogs.db`) - все выгрузки хранятся в одной базе данных
2. **Динамические таблицы** - для каждого типа справочника создаётся отдельная таблица
3. **Автоматическая транслитерация** - названия справочников преобразуются в имена таблиц (например, "Номенклатура" → "nomenclature_items")
4. **Обратная совместимость** - старые API продолжают работать, поддержка старых файлов БД сохранена

## Новая структура БД

### Единая БД (unified_catalogs.db)

**Базовые таблицы:**
- `uploads` - все выгрузки
- `constants` - все константы из всех выгрузок
- `catalog_mappings` - маппинг справочников на таблицы

**Динамические таблицы справочников:**
- `nomenclature_items` - элементы справочника "Номенклатура"
- `contragents_items` - элементы справочника "Контрагенты"
- `physical_persons_items` - элементы справочника "ФизическиеЛица"
- И т.д. - создаются автоматически при первой выгрузке

## Миграция существующих данных

### Шаг 1: Резервное копирование

Перед миграцией создайте резервные копии всех файлов БД:

```bash
# Windows PowerShell
mkdir backup
copy *.db backup/

# Linux/Mac
mkdir backup
cp *.db backup/
```

### Шаг 2: Запуск утилиты миграции

Утилита миграции автоматически:
- Найдёт все файлы `Выгрузка_*.db`
- Создаст резервные копии
- Перенесёт данные в `unified_catalogs.db`
- Создаст динамические таблицы для каждого справочника

**Запуск:**

```bash
# Windows
go run cmd/migrate_to_unified/main.go

# С параметрами
go run cmd/migrate_to_unified/main.go -source=. -target=unified_catalogs.db -backup=true

# Dry-run (только показать что будет сделано)
go run cmd/migrate_to_unified/main.go -dry-run

# Linux/Mac
go run cmd/migrate_to_unified/main.go
```

**Параметры:**
- `-source` - директория с исходными файлами БД (по умолчанию: `.`)
- `-target` - путь к целевой единой БД (по умолчанию: `unified_catalogs.db`)
- `-backup` - создать резервную копию (по умолчанию: `true`)
- `-dry-run` - показать что будет сделано без изменений (по умолчанию: `false`)

### Шаг 3: Проверка миграции

После миграции проверьте:

1. **Файл unified_catalogs.db создан:**
   ```bash
   ls -lh unified_catalogs.db
   ```

2. **Данные перенесены:**
   ```bash
   sqlite3 unified_catalogs.db "SELECT COUNT(*) FROM uploads;"
   sqlite3 unified_catalogs.db "SELECT * FROM catalog_mappings;"
   ```

3. **Динамические таблицы созданы:**
   ```bash
   sqlite3 unified_catalogs.db ".tables"
   ```

### Шаг 4: Запуск сервера

Запустите сервер - он автоматически будет использовать единую БД:

```bash
# Windows
.\httpserver.exe

# Linux/Mac
./httpserver

# Из исходников
go run main.go
```

## Работа с новой архитектурой

### Выгрузка данных из 1С

**Ничего не изменилось!** Используйте те же API:

```xml
<!-- Handshake - теперь создаёт запись в единой БД -->
POST /handshake
<?xml version="1.0" encoding="UTF-8"?>
<handshake>
  <version_1c>8.3.25.1257</version_1c>
  <config_name>ERPWE</config_name>
  <timestamp>2025-11-30T12:00:00Z</timestamp>
</handshake>

<!-- Регистрация справочника - создаёт динамическую таблицу -->
POST /catalog/meta
<?xml version="1.0" encoding="UTF-8"?>
<catalog_meta>
  <upload_uuid>UUID</upload_uuid>
  <name>Номенклатура</name>
  <synonym>Номенклатура</synonym>
</catalog_meta>

<!-- Добавление элемента - сохраняет в динамическую таблицу -->
POST /catalog/item
...
```

### Импорт данных в 1С

API импорта обновлён для поддержки обоих форматов:

```xml
<!-- Получение списка БД - возвращает выгрузки из единой БД + старые файлы -->
GET /api/1c/databases

<!-- Handshake для импорта - поддерживает UUID и имена файлов -->
POST /api/1c/import/handshake
<?xml version="1.0" encoding="UTF-8"?>
<import_handshake>
  <!-- Новый формат: upload_UUID -->
  <db_name>upload_550e8400-e29b-41d4-a716-446655440000</db_name>
  
  <!-- ИЛИ старый формат (обратная совместимость) -->
  <db_name>Выгрузка_Номенклатура_ERPWE_2025-11-30.db</db_name>
  
  <client_info>
    <version_1c>8.3.25.1257</version_1c>
    <computer_name>PC001</computer_name>
    <user_name>User1</user_name>
  </client_info>
</import_handshake>
```

## Преимущества новой архитектуры

✅ **Производительность:**
- Нет накладных расходов на создание/открытие множества файлов
- Один connection pool для всех выгрузок
- Эффективные индексы на всех таблицах

✅ **Управление:**
- Один файл вместо десятков
- Простое резервное копирование
- Легко перенести между серверами

✅ **Масштабируемость:**
- Неограниченное количество выгрузок
- Неограниченное количество справочников
- Автоматическое создание таблиц

✅ **Целостность:**
- Транзакционность на уровне БД
- Внешние ключи между таблицами
- Автоматическое каскадное удаление

## Откат на старую версию

Если нужно вернуться к старой архитектуре:

1. Остановите сервер
2. Восстановите старую версию кода из git
3. Используйте резервные копии файлов БД
4. Запустите сервер

**Важно:** Данные, добавленные после миграции в единую БД, будут недоступны в старой версии.

## Устранение проблем

### Ошибка: "unified catalogs database not initialized"

**Решение:** Проверьте конфигурацию `unified_catalogs_db_path` в настройках или переменных окружения:

```bash
export UNIFIED_CATALOGS_DB_PATH="unified_catalogs.db"
```

### Ошибка: "catalog mapping not found"

**Решение:** Таблица для справочника не создана. Отправьте запрос `/catalog/meta` для создания таблицы.

### Ошибка: "database file not found"

**Решение:** При импорте используйте новый формат с `upload_UUID` вместо имени файла.

## Мониторинг

Проверка состояния единой БД:

```bash
# Количество выгрузок
sqlite3 unified_catalogs.db "SELECT COUNT(*) as uploads FROM uploads;"

# Список справочников
sqlite3 unified_catalogs.db "SELECT catalog_name, table_name FROM catalog_mappings;"

# Список динамических таблиц
sqlite3 unified_catalogs.db ".tables" | grep "_items"

# Размер БД
ls -lh unified_catalogs.db

# Статистика по таблице
sqlite3 unified_catalogs.db "SELECT COUNT(*) FROM nomenclature_items;"
```

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Убедитесь что миграция завершена успешно
3. Проверьте что файл `unified_catalogs.db` создан и доступен
4. Проверьте права доступа к файлу БД

---

© 2025 HTTP Server для работы с выгрузками из 1С

