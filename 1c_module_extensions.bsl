#Область СлужебныеПеременные

// Переменные для работы модуля расширений
// Эти переменные должны быть доступны в контексте, где используется этот модуль
Перем АдресСервера;
Перем ИдентификаторВыгрузки;
Перем ИспользоватьПакетнуюВыгрузку;
Перем РазмерПакета;
Перем ИдентификаторБазыДанных;
Перем ОбщееКоличествоОбъектов;
Перем ТекущаяПозиция;
Перем ВыполняетсяВыгрузка;
Перем ТребуетсяПрервать;
Перем ТекущийЭтап;
Перем ТекущийОбъект;

#КонецОбласти

#Область НовыеПроцедурыИФункции

#Область ФункцииИдентификацииБазыДанных

// Определение database_id с приоритетами (без использования глобальных переменных)
&НаСервере
Функция ОпределитьDatabaseID(АдресСервераПараметр, ИдентификаторБазыДанныхПараметр, ClientIDПараметр, ProjectIDПараметр) Экспорт
    
    // Приоритет 1: прямой database_id
    Если Не ПустаяСтрока(ИдентификаторБазыДанныхПараметр) Тогда
        // Проверяем существование
        Если ПроверитьСуществованиеDatabaseID(АдресСервераПараметр, ИдентификаторБазыДанныхПараметр) Тогда
            Возврат ИдентификаторБазыДанныхПараметр;
        КонецЕсли;
    КонецЕсли;
    
    // Приоритет 2: поиск по client_id и project_id (если указаны)
    Если Не ПустаяСтрока(ClientIDПараметр) И Не ПустаяСтрока(ProjectIDПараметр) Тогда
        DatabaseID = НайтиDatabaseПоКлиентуИПроекту(АдресСервераПараметр, ClientIDПараметр, ProjectIDПараметр);
        Если Не ПустаяСтрока(DatabaseID) Тогда
            Возврат DatabaseID;
        КонецЕсли;
        
        // Если не найдено, создаем новую
        DatabaseID = СоздатьDatabaseПоКлиентуИПроекту(АдресСервераПараметр, ClientIDПараметр, ProjectIDПараметр);
        Если Не ПустаяСтрока(DatabaseID) Тогда
            Возврат DatabaseID;
        КонецЕсли;
    КонецЕсли;
    
    // Если ничего не найдено
    ВызватьИсключение "Не указан database_id или client_id/project_id";
    
КонецФункции

// Поиск database_id по client_id и project_id (без использования глобальных переменных)
&НаСервере
Функция НайтиDatabaseПоКлиентуИПроекту(АдресСервераПараметр, ClientID, ProjectID)
    
    URL = АдресСервераПараметр + "/api/databases/find?client_id=" + ClientID + "&project_id=" + ProjectID;
    
    Попытка
        // Парсим URL для получения базового адреса и пути
        ПозицияПротокола = СтрНайти(URL, "://");
        Если ПозицияПротокола > 0 Тогда
            URLБезПротокола = Прав(URL, СтрДлина(URL) - ПозицияПротокола - 2);
            ПозицияСлеша = СтрНайти(URLБезПротокола, "/");
            Если ПозицияСлеша > 0 Тогда
                БазовыйАдресСервера = Лев(URLБезПротокола, ПозицияСлеша - 1);
                ПутьЗапроса = Прав(URLБезПротокола, СтрДлина(URLБезПротокола) - ПозицияСлеша + 1);
            Иначе
                БазовыйАдресСервера = URLБезПротокола;
                ПутьЗапроса = "/";
            КонецЕсли;
        Иначе
            БазовыйАдресСервера = URL;
            ПутьЗапроса = "/";
        КонецЕсли;
        
        Заголовки = Новый Соответствие;
        Заголовки.Вставить("Accept", "application/json");
        
        HTTPЗапрос = Новый HTTPЗапрос(ПутьЗапроса, Заголовки);
        HTTPСоединение = Новый HTTPСоединение(БазовыйАдресСервера, , , , , 30);
        Ответ = HTTPСоединение.Получить(HTTPЗапрос);
        
        КодСостояния = ПолучитьКодСостояния(Ответ);
        
        Если КодСостояния = 200 Тогда
            Тело = ПолучитьТелоОтвета(Ответ);
            // Парсим JSON ответ
            DatabaseID = ИзвлечьЗначениеИзJSON(Тело, "database_id");
            Возврат DatabaseID;
        ИначеЕсли КодСостояния = 404 Тогда
            // База не найдена
            Возврат "";
        Иначе
            ВызватьИсключение "Ошибка при поиске базы данных: " + Строка(КодСостояния);
        КонецЕсли;
        
    Исключение
        Сообщить("Ошибка при поиске database_id: " + ОписаниеОшибки());
        Возврат "";
    КонецПопытки;
    
КонецФункции

// Создание новой базы данных (без использования глобальных переменных)
&НаСервере
Функция СоздатьDatabaseПоКлиентуИПроекту(АдресСервераПараметр, ClientID, ProjectID)
    
    URL = АдресСервераПараметр + "/api/clients/" + ClientID + "/projects/" + ProjectID + "/databases";
    
    ИмяБазы = "База из 1С от " + Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy HH:mm:ss");
    
    JSONТело = "{""name"": """ + ЭкранироватьJSON(ИмяБазы) + """, ""file_path"": """", ""description"": ""Автоматически создана из обработки 1С""}";
    
    Попытка
        // Парсим URL для получения базового адреса и пути
        ПозицияПротокола = СтрНайти(URL, "://");
        Если ПозицияПротокола > 0 Тогда
            URLБезПротокола = Прав(URL, СтрДлина(URL) - ПозицияПротокола - 2);
            ПозицияСлеша = СтрНайти(URLБезПротокола, "/");
            Если ПозицияСлеша > 0 Тогда
                БазовыйАдресСервера = Лев(URLБезПротокола, ПозицияСлеша - 1);
                ПутьЗапроса = Прав(URLБезПротокола, СтрДлина(URLБезПротокола) - ПозицияСлеша + 1);
            Иначе
                БазовыйАдресСервера = URLБезПротокола;
                ПутьЗапроса = "/";
            КонецЕсли;
        Иначе
            БазовыйАдресСервера = URL;
            ПутьЗапроса = "/";
        КонецЕсли;
        
        Заголовки = Новый Соответствие;
        Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Заголовки.Вставить("Accept", "application/json");
        
        HTTPЗапрос = Новый HTTPЗапрос(ПутьЗапроса, Заголовки);
        HTTPЗапрос.УстановитьТелоИзСтроки(JSONТело, КодировкаТекста.UTF8);
        HTTPСоединение = Новый HTTPСоединение(БазовыйАдресСервера, , , , , 30);
        Ответ = HTTPСоединение.ОтправитьДляОбработки(HTTPЗапрос);
        
        КодСостояния = ПолучитьКодСостояния(Ответ);
        
        Если КодСостояния = 201 Или КодСостояния = 200 Тогда
            Тело = ПолучитьТелоОтвета(Ответ);
            DatabaseID = ИзвлечьЗначениеИзJSON(Тело, "id");
            Возврат Строка(DatabaseID);
        Иначе
            ВызватьИсключение "Ошибка при создании базы данных: " + Строка(КодСостояния);
        КонецЕсли;
        
    Исключение
        Сообщить("Ошибка при создании database: " + ОписаниеОшибки());
        Возврат "";
    КонецПопытки;
    
КонецФункции

// Проверка существования database_id (без использования глобальных переменных)
&НаСервере
Функция ПроверитьСуществованиеDatabaseID(АдресСервераПараметр, DatabaseID)
    
    URL = АдресСервераПараметр + "/api/v1/databases/" + DatabaseID;
    
    Попытка
        // Парсим URL для получения базового адреса и пути
        ПозицияПротокола = СтрНайти(URL, "://");
        Если ПозицияПротокола > 0 Тогда
            URLБезПротокола = Прав(URL, СтрДлина(URL) - ПозицияПротокола - 2);
            ПозицияСлеша = СтрНайти(URLБезПротокола, "/");
            Если ПозицияСлеша > 0 Тогда
                БазовыйАдресСервера = Лев(URLБезПротокола, ПозицияСлеша - 1);
                ПутьЗапроса = Прав(URLБезПротокола, СтрДлина(URLБезПротокола) - ПозицияСлеша + 1);
            Иначе
                БазовыйАдресСервера = URLБезПротокола;
                ПутьЗапроса = "/";
            КонецЕсли;
        Иначе
            БазовыйАдресСервера = URL;
            ПутьЗапроса = "/";
        КонецЕсли;
        
        Заголовки = Новый Соответствие;
        Заголовки.Вставить("Accept", "application/json");
        
        HTTPЗапрос = Новый HTTPЗапрос(ПутьЗапроса, Заголовки);
        HTTPСоединение = Новый HTTPСоединение(БазовыйАдресСервера, , , , , 30);
        Ответ = HTTPСоединение.Получить(HTTPЗапрос);
        
        КодСостояния = ПолучитьКодСостояния(Ответ);
        Возврат КодСостояния = 200;
        
    Исключение
        Возврат Ложь;
    КонецПопытки;
    
КонецФункции

// Извлечение значения из JSON
&НаСервере
Функция ИзвлечьЗначениеИзJSON(JSONСтрока, ИмяПоля)
    
    // Простой парсинг JSON (можно улучшить)
    ПозицияНачала = СтрНайти(JSONСтрока, """" + ИмяПоля + """:");
    Если ПозицияНачала = 0 Тогда
        Возврат "";
    КонецЕсли;
    
    ПозицияНачала = ПозицияНачала + СтрДлина("""" + ИмяПоля + """:");
    // Пропускаем пробелы
    Пока ПозицияНачала <= СтрДлина(JSONСтрока) И Сред(JSONСтрока, ПозицияНачала, 1) = " " Цикл
        ПозицияНачала = ПозицияНачала + 1;
    КонецЦикла;
    
    Если ПозицияНачала > СтрДлина(JSONСтрока) Тогда
        Возврат "";
    КонецЕсли;
    
    // Извлекаем значение (может быть число или строка)
    Если Сред(JSONСтрока, ПозицияНачала, 1) = """" Тогда
        // Строка
        ПозицияНачала = ПозицияНачала + 1;
        ПозицияКонца = СтрНайти(JSONСтрока, """", , ПозицияНачала);
        Если ПозицияКонца > 0 Тогда
            Возврат Сред(JSONСтрока, ПозицияНачала, ПозицияКонца - ПозицияНачала);
        КонецЕсли;
    Иначе
        // Число
        ПозицияКонца = ПозицияНачала;
        Пока ПозицияКонца <= СтрДлина(JSONСтрока) И (Сред(JSONСтрока, ПозицияКонца, 1) >= "0" И Сред(JSONСтрока, ПозицияКонца, 1) <= "9") Цикл
            ПозицияКонца = ПозицияКонца + 1;
        КонецЦикла;
        Если ПозицияКонца > ПозицияНачала Тогда
            Возврат Сред(JSONСтрока, ПозицияНачала, ПозицияКонца - ПозицияНачала);
        КонецЕсли;
    КонецЕсли;
    
    Возврат "";
    
КонецФункции

// Экранирование JSON
&НаСервере
Функция ЭкранироватьJSON(Строка)
    
    Результат = Строка;
    Результат = СтрЗаменить(Результат, "\", "\\");
    Результат = СтрЗаменить(Результат, """", "\""");
    Результат = СтрЗаменить(Результат, Символы.ПС, "\n");
    Результат = СтрЗаменить(Результат, Символы.ВК, "\r");
    Результат = СтрЗаменить(Результат, Символы.Таб, "\t");
    
    Возврат Результат;
    
КонецФункции

#КонецОбласти

#Область ВспомогательныеФункцииHTTP

// Универсальная функция для отправки HTTP запросов (без использования глобальных переменных)
&НаСервере
Функция ОтправитьHTTPЗапрос(Метод, URL, ТелоЗапроса)
	
	Попытка
		// Парсим URL для получения базового адреса и пути
		ПозицияПротокола = СтрНайти(URL, "://");
		Если ПозицияПротокола > 0 Тогда
			URLБезПротокола = Прав(URL, СтрДлина(URL) - ПозицияПротокола - 2);
			ПозицияСлеша = СтрНайти(URLБезПротокола, "/");
			Если ПозицияСлеша > 0 Тогда
				// Для HTTPСоединение нужен адрес без протокола, только хост:порт
				БазовыйАдресСервера = Лев(URLБезПротокола, ПозицияСлеша - 1);
				ПутьЗапроса = Прав(URLБезПротокола, СтрДлина(URLБезПротокола) - ПозицияСлеша + 1);
			Иначе
				БазовыйАдресСервера = URLБезПротокола;
				ПутьЗапроса = "/";
			КонецЕсли;
		Иначе
			БазовыйАдресСервера = URL;
			ПутьЗапроса = "/";
		КонецЕсли;
		
		Соединение = Новый HTTPСоединение(БазовыйАдресСервера, , , , , 30);
		Заголовки = СоздатьHTTPЗаголовки();
		
		// Создаем HTTPЗапрос с путем (не полным URL!)
		HTTPЗапрос = Новый HTTPЗапрос(ПутьЗапроса, Заголовки);
		
		// Устанавливаем тело запроса из строки, если оно есть
		Если Не ПустаяСтрока(ТелоЗапроса) Тогда
			HTTPЗапрос.УстановитьТелоИзСтроки(ТелоЗапроса, КодировкаТекста.UTF8);
		КонецЕсли;
		
		// Отправляем запрос в зависимости от метода
		МетодВерхний = ВРег(Метод);
		Если МетодВерхний = "GET" Тогда
			Ответ = Соединение.Получить(HTTPЗапрос);
		ИначеЕсли МетодВерхний = "POST" Тогда
			Ответ = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
		Иначе
			Ответ = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
		КонецЕсли;
		
		Возврат Ответ;
		
	Исключение
		Сообщить("Ошибка при отправке HTTP запроса: " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// Создание HTTP заголовков
&НаСервере
Функция СоздатьHTTPЗаголовки()
	
	Заголовки = Новый Соответствие;
	Заголовки.Вставить("Content-Type", "application/xml; charset=utf-8");
	Заголовки.Вставить("Accept", "application/xml, application/json, */*");
	
	Возврат Заголовки;
	
КонецФункции

// Вспомогательная функция для экранирования специальных символов в XML
&НаСервере
Функция ЭкранироватьXML(Строка)
	
	Результат = Строка;
	Результат = СтрЗаменить(Результат, "&", "&amp;");
	Результат = СтрЗаменить(Результат, "<", "&lt;");
	Результат = СтрЗаменить(Результат, ">", "&gt;");
	Результат = СтрЗаменить(Результат, """", "&quot;");
	Результат = СтрЗаменить(Результат, "'", "&apos;");
	
	Возврат Результат;
	
КонецФункции

// Получение тела ответа HTTP (универсальное)
&НаСервере
Функция ПолучитьТелоОтвета(Ответ)
	
	Попытка
		Возврат Ответ.ПолучитьТелоКакСтроку();
	Исключение
		Попытка
			Возврат Ответ.ТелоОтвета;
		Исключение
			Возврат "Не удалось получить тело ответа";
		КонецПопытки;
	КонецПопытки;
	
КонецФункции

// Безопасное получение кода состояния из HTTP ответа
&НаСервере
Функция ПолучитьКодСостояния(Ответ)
	
	КодСостояния = 0;
	Попытка
		КодСостояния = Число(Ответ.КодСостояния);
	Исключение
		Попытка
			КодСостояния = Ответ.КодСостояния;
		Исключение
			КодСостояния = 0;
		КонецПопытки;
	КонецПопытки;
	
	Возврат КодСостояния;
	
КонецФункции

// Извлечение значения из XML по тегу
&НаСервере
Функция ИзвлечьЗначениеИзXML(XMLСтрока, ИмяТега)
	
	ПозицияНачала = СтрНайти(XMLСтрока, "<" + ИмяТега + ">");
	ПозицияКонца = СтрНайти(XMLСтрока, "</" + ИмяТега + ">");
	
	Если ПозицияНачала > 0 И ПозицияКонца > 0 Тогда
		ДлинаТега = СтрДлина("<" + ИмяТега + ">");
		Возврат Сред(XMLСтрока, ПозицияНачала + ДлинаТега, ПозицияКонца - ПозицияНачала - ДлинаТега);
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

// Получение версии 1С
&НаСервере
Функция Версия1С()
	
	Попытка
		// Используем СистемнаяИнформация для получения версии платформы
		СистемнаяИнформация = Новый СистемнаяИнформация;
		Возврат Строка(СистемнаяИнформация.ВерсияПриложения);
	Исключение
		// Если не удалось получить версию, возвращаем базовую
		Возврат "8.3";
	КонецПопытки;
	
КонецФункции

// Получение имени конфигурации
&НаСервере
Функция ИмяКонфигурации()
	
	Попытка
		// Правильный способ получения имени конфигурации
		Возврат Строка(Метаданные.Имя);
	Исключение
		// Если не удалось получить имя, возвращаем пустую строку
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Получение версии конфигурации
&НаСервере
Функция ПолучитьВерсиюКонфигурации()
	
	Попытка
		Возврат Строка(Метаданные.Версия);
	Исключение
		Возврат "";
	КонецПопытки;
	
КонецФункции

#КонецОбласти

// Обновление настроек из формы
&НаСервере
Процедура ОбновитьНастройкиИзФормы()
	
	// Получаем значения из реквизитов формы
	Попытка
		АдресСервера = Объект.АдресСервера;
		ИспользоватьПакетнуюВыгрузку = Объект.ИспользоватьПакетнуюВыгрузку;
		РазмерПакета = Объект.РазмерПакета;
		ИдентификаторБазыДанных = Объект.ИдентификаторБазыДанных;
		// Новые реквизиты для идентификации через client_id и project_id
		Попытка
			Объект.ClientID = Объект.ClientID;
			Объект.ProjectID = Объект.ProjectID;
		Исключение
			// Реквизиты могут отсутствовать в старых версиях формы
		КонецПопытки;
	Исключение
		// Если реквизиты не найдены, используем значения по умолчанию
		АдресСервера = "http://localhost:9999";
		ИспользоватьПакетнуюВыгрузку = Истина;
		РазмерПакета = 50;
		ИдентификаторБазыДанных = "";
	КонецПопытки;
	
	// Устанавливаем значения по умолчанию, если они не заданы
	Если АдресСервера = "" Тогда
		АдресСервера = "http://localhost:9999";
	КонецЕсли;
	
	Если РазмерПакета = 0 Тогда
		РазмерПакета = 50;
	КонецЕсли;
	
	Если ИспользоватьПакетнуюВыгрузку = Неопределено Тогда
		ИспользоватьПакетнуюВыгрузку = Истина;
	КонецЕсли;
	
	Если ИдентификаторБазыДанных = Неопределено Тогда
		ИдентификаторБазыДанных = "";
	КонецЕсли;
	
	// Новые реквизиты для идентификации через client_id и project_id
	Попытка
		Если Объект.ClientID = Неопределено Тогда
			Объект.ClientID = "";
		КонецЕсли;
		Если Объект.ProjectID = Неопределено Тогда
			Объект.ProjectID = "";
		КонецЕсли;
	Исключение
		// Реквизиты могут отсутствовать в старых версиях формы
	КонецПопытки;
	
КонецПроцедуры

// Улучшенное рукопожатие с передачей database_id и расширенной информации (с поддержкой fallback на старый API)
&НаСервере
Функция ВыполнитьРукопожатиеСПривязкой()
	
	ОбновитьНастройкиИзФормы();
	
	// Автоматически определяем database_id на сервере с приоритетами:
	// 1. Прямой database_id (если указан в форме)
	// 2. Поиск по client_id/project_id (если указаны в форме)
	// 3. Автоматическое создание новой базы данных
	// Вся идентификация происходит автоматически на сервере, без участия клиента
	Попытка
		// Получаем значения из формы (без использования глобальных переменных)
		ClientIDЗначение = "";
		ProjectIDЗначение = "";
		Попытка
			ClientIDЗначение = Объект.ClientID;
			ProjectIDЗначение = Объект.ProjectID;
		Исключение
			// Реквизиты могут отсутствовать в старых версиях формы
		КонецПопытки;
		
		ИдентификаторБазыДанных = ОпределитьDatabaseID(АдресСервера, ИдентификаторБазыДанных, ClientIDЗначение, ProjectIDЗначение);
		Если Не ПустаяСтрока(ИдентификаторБазыДанных) Тогда
			Сообщить("  → Database ID определен автоматически на сервере: " + ИдентификаторБазыДанных);
		КонецЕсли;
	Исключение
		Сообщить("  → Ошибка при автоматическом определении database_id: " + ОписаниеОшибки());
		// Продолжаем со старым способом, если новый не сработал
		// Если ИдентификаторБазыДанных пустой, будет использован старый API без database_id
	КонецПопытки;
	
	// Пробуем новый API сначала, если указан database_id
	Если ИдентификаторБазыДанных <> "" Тогда
		URL = АдресСервера + "/api/v1/upload/handshake";
		Сообщить("  → Попытка нового API: " + URL);
		
		// Получаем информацию о системе
		Попытка
			ИмяКомпьютераЗначение = Строка(ИнформацияОКомпьютере().ИмяКомпьютера);
		Исключение
			ИмяКомпьютераЗначение = "";
		КонецПопытки;
		
		Попытка
			ИмяПользователяЗначение = Строка(ИнформацияОПользователе().Имя);
		Исключение
			ИмяПользователяЗначение = "";
		КонецПопытки;
		
		ВерсияКонфигурацииЗначение = ПолучитьВерсиюКонфигурации();
		
		// Создаем XML для рукопожатия с расширенной информацией
		XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
			"<handshake>" +
			"<database_id>" + ЭкранироватьXML(ИдентификаторБазыДанных) + "</database_id>" +
			"<version_1c>" + ЭкранироватьXML(Строка(Версия1С())) + "</version_1c>" +
			"<config_name>" + ЭкранироватьXML(Строка(ИмяКонфигурации())) + "</config_name>";
		
		Если ВерсияКонфигурацииЗначение <> "" Тогда
			XMLСтрока = XMLСтрока + "<config_version>" + ЭкранироватьXML(ВерсияКонфигурацииЗначение) + "</config_version>";
		КонецЕсли;
		
		Если ИмяКомпьютераЗначение <> "" Тогда
			XMLСтрока = XMLСтрока + "<computer_name>" + ЭкранироватьXML(ИмяКомпьютераЗначение) + "</computer_name>";
		КонецЕсли;
		
		Если ИмяПользователяЗначение <> "" Тогда
			XMLСтрока = XMLСтрока + "<user_name>" + ЭкранироватьXML(ИмяПользователяЗначение) + "</user_name>";
		КонецЕсли;
		
		// Получаем поля итераций из формы (если они есть)
		НомерИтерации = 1;
		МеткаИтерации = "";
		Программист = "";
		ЦельВыгрузки = "";
		ParentUploadID = "";
		
		Попытка
			Если Объект.НомерИтерации <> Неопределено Тогда
				НомерИтерации = Объект.НомерИтерации;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если Объект.МеткаИтерации <> Неопределено Тогда
				МеткаИтерации = Объект.МеткаИтерации;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если Объект.Программист <> Неопределено Тогда
				Программист = Объект.Программист;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если Объект.ЦельВыгрузки <> Неопределено Тогда
				ЦельВыгрузки = Объект.ЦельВыгрузки;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если Объект.ParentUploadID <> Неопределено Тогда
				ParentUploadID = Объект.ParentUploadID;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		XMLСтрока = XMLСтрока +
			"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>";
		
		// Добавляем поля итераций, если они указаны
		Если НомерИтерации > 0 Тогда
			XMLСтрока = XMLСтрока + "<iteration_number>" + Строка(НомерИтерации) + "</iteration_number>";
		КонецЕсли;
		
		Если Не ПустаяСтрока(МеткаИтерации) Тогда
			XMLСтрока = XMLСтрока + "<iteration_label>" + ЭкранироватьXML(МеткаИтерации) + "</iteration_label>";
		КонецЕсли;
		
		Если Не ПустаяСтрока(Программист) Тогда
			XMLСтрока = XMLСтрока + "<programmer_name>" + ЭкранироватьXML(Программист) + "</programmer_name>";
		КонецЕсли;
		
		Если Не ПустаяСтрока(ЦельВыгрузки) Тогда
			XMLСтрока = XMLСтрока + "<upload_purpose>" + ЭкранироватьXML(ЦельВыгрузки) + "</upload_purpose>";
		КонецЕсли;
		
		Если Не ПустаяСтрока(ParentUploadID) Тогда
			XMLСтрока = XMLСтрока + "<parent_upload_id>" + ЭкранироватьXML(ParentUploadID) + "</parent_upload_id>";
		КонецЕсли;
		
		XMLСтрока = XMLСтрока + "</handshake>";
		
		Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
		
		КодСостояния = ПолучитьКодСостояния(Ответ);
		
		// Если новый API работает, используем его
		Если КодСостояния = 200 Тогда
			Сообщить("  → Новый API успешно ответил");
			Возврат ОбработатьОтветРукопожатия(Ответ);
		Иначе
			Сообщить("  → Новый API недоступен (код " + Строка(КодСостояния) + "), пробуем старый...");
		КонецЕсли;
	КонецЕсли;
	
	// Если новый API не доступен или database_id не указан, пробуем старый
	URL = АдресСервера + "/handshake";
	Сообщить("  → Использование старого API: " + URL);
	
	// Упрощенный XML для старого API
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<handshake>" +
		"<version_1c>" + ЭкранироватьXML(Строка(Версия1С())) + "</version_1c>" +
		"<config_name>" + ЭкранироватьXML(Строка(ИмяКонфигурации())) + "</config_name>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</handshake>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("  → Старый API успешно ответил");
		Возврат ОбработатьОтветРукопожатия(Ответ);
	Иначе
		Сообщить("  → ОШИБКА: Оба API недоступны (код " + Строка(КодСостояния) + ")");
		ТелоОтвета = ПолучитьТелоОтвета(Ответ);
		Если ТелоОтвета <> "" Тогда
			Сообщить("  → Тело ответа: " + ТелоОтвета);
		КонецЕсли;
		Возврат "";
	КонецЕсли;
	
КонецФункции

// Обработка ответа рукопожатия (общая для старого и нового API)
&НаСервере
Функция ОбработатьОтветРукопожатия(Ответ)
	
	ТелоОтвета = ПолучитьТелоОтвета(Ответ);
	
	// Извлекаем UUID из XML ответа
	UUIDВыгрузки = ИзвлечьЗначениеИзXML(ТелоОтвета, "upload_uuid");
	
	Если UUIDВыгрузки = "" Тогда
		Сообщить("  → ОШИБКА: UUID не найден в ответе сервера");
		Возврат "";
	КонецЕсли;
	
	Сообщить("  → UUID получен: " + UUIDВыгрузки);
	
	// Пробуем получить расширенную информацию (только для нового API)
	ИмяКлиента = ИзвлечьЗначениеИзXML(ТелоОтвета, "client_name");
	ИмяПроекта = ИзвлечьЗначениеИзXML(ТелоОтвета, "project_name");
	ИмяБазы = ИзвлечьЗначениеИзXML(ТелоОтвета, "database_name");
	
	Если ИмяКлиента <> "" Тогда
		ОбновитьИнформациюОБазе(ИмяКлиента, ИмяПроекта, ИмяБазы);
		Сообщить("  → Привязка: " + ИмяКлиента + " / " + ИмяПроекта + " / " + ИмяБазы);
	КонецЕсли;
	
	Возврат UUIDВыгрузки;
	
КонецФункции

// Обновление информации о базе данных на форме
&НаСервере
Процедура ОбновитьИнформациюОБазе(ИмяКлиента, ИмяПроекта, ИмяБазы)
	
	Попытка
		Объект.ИмяКлиента = ИмяКлиента;
		Объект.ИмяПроекта = ИмяПроекта;
		Объект.ИмяБазыДанных = ИмяБазы;
	Исключение
		// Если реквизиты формы не найдены, просто логируем
		Сообщить("  → Информация о базе: " + ИмяКлиента + " / " + ИмяПроекта + " / " + ИмяБазы);
	КонецПопытки;
	
КонецПроцедуры

// Отправка пакета элементов справочника
&НаСервере
Процедура ОтправитьПакетЭлементовСправочника(ИмяСправочника, МассивЭлементов)
	
	URL = АдресСервера + "/catalog/items";
	
	// Создаем XML для пакета элементов
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<catalog_items>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<catalog_name>" + ЭкранироватьXML(ИмяСправочника) + "</catalog_name>" +
		"<items>";
	
	Для Каждого Элемент Из МассивЭлементов Цикл
		XMLСтрока = XMLСтрока + 
			"<item>" +
			"<reference>" + ЭкранироватьXML(Элемент.Ссылка) + "</reference>" +
			"<code>" + ЭкранироватьXML(Элемент.Код) + "</code>" +
			"<name>" + ЭкранироватьXML(Элемент.Наименование) + "</name>" +
			"<attributes>" + Элемент.РеквизитыXML + "</attributes>" +
			"<table_parts>" + Элемент.ТабличныеЧастиXML + "</table_parts>" +
			"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
			"</item>";
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</items></catalog_items>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("      ✓ Пакет элементов справочника '" + ИмяСправочника + "' отправлен. Количество: " + Строка(МассивЭлементов.Количество()));
	Иначе
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("      → ОШИБКА отправки пакета элементов справочника '" + ИмяСправочника + "': " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Выгрузка справочника контрагентов с пакетной отправкой
&НаСервере
Процедура ВыгрузитьСправочникКонтрагентовПакетами()
	
	Сообщить("  → Начинаем пакетную выгрузку контрагентов...");
	
	// Находим справочник контрагентов
	Попытка
		СправочникМетаданных = Метаданные.Справочники["Контрагенты"];
	Исключение
		СправочникМетаданных = Неопределено;
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("  → Справочник 'Контрагенты' не найден!");
		Возврат;
	КонецЕсли;
	
	// Отправляем метаданные
	ОтправитьМетаСправочника(СправочникМетаданных);
	
	// Получаем все элементы контрагентов
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Контрагенты.Ссылка,
		|	Контрагенты.Код,
		|	Контрагенты.Наименование
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|ГДЕ
		|	НЕ Контрагенты.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса для справочника 'Контрагенты': " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	МассивЭлементов = Новый Массив;
	Счетчик = 0;
	ВсегоВыгружено = 0;
	
	Пока Выборка.Следующий() Цикл
		
		// Получаем реквизиты и табличные части
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, "Контрагенты");
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, "Контрагенты");
		
		// Создаем структуру элемента
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", Строка(Выборка.Ссылка));
		Элемент.Вставить("Код", Строка(Выборка.Код));
		Элемент.Вставить("Наименование", Строка(Выборка.Наименование));
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", ТабличныеЧастиXML);
		
		МассивЭлементов.Добавить(Элемент);
		Счетчик = Счетчик + 1;
		
		// Отправляем пакет при достижении размера
		Если ИспользоватьПакетнуюВыгрузку И Счетчик >= РазмерПакета Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
			ВсегоВыгружено = ВсегоВыгружено + МассивЭлементов.Количество();
			Сообщить("  → Отправлен пакет: " + Строка(МассивЭлементов.Количество()) + " элементов");
			МассивЭлементов = Новый Массив;
			Счетчик = 0;
		КонецЕсли;
		
	КонецЦикла;
	
	// Отправляем оставшиеся элементы
	Если МассивЭлементов.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
			ВсегоВыгружено = ВсегоВыгружено + МассивЭлементов.Количество();
			Сообщить("  → Отправлен последний пакет: " + Строка(МассивЭлементов.Количество()) + " элементов");
		Иначе
			// Поштучная отправка
			Для Каждого Элемент Из МассивЭлементов Цикл
				ОтправитьЭлементСправочника(
					СправочникМетаданных.Имя,
					Элемент.Ссылка,
					Элемент.Код,
					Элемент.Наименование,
					Элемент.РеквизитыXML,
					Элемент.ТабличныеЧастиXML
				);
				ВсегоВыгружено = ВсегоВыгружено + 1;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Сообщить("  ✓ Выгрузка контрагентов завершена: " + Строка(ВсегоВыгружено) + " элементов");
	
КонецПроцедуры

// Выгрузка номенклатуры с характеристиками в JSON файл
&НаСервере
Процедура ВыгрузитьНоменклатуруСХарактеристикамиВФайлНаСервере()
	
	Если Объект.ПутьКФайлу = "" Тогда
		ВызватьИсключение "Не выбран каталог для сохранения файла";
	КонецЕсли;
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.ПроверятьСтруктуру = Ложь;
	ЗаписьJSON.ОткрытьФайл(Объект.ПутьКФайлу);
	
	ЗаписьJSON.ЗаписатьНачалоМассива();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТоварыНаСкладах.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладах.Характеристика КАК Характеристика
		|ПОМЕСТИТЬ ВТ_Товары
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах КАК ТоварыНаСкладах
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЕСТЬNULL(ВТ_Товары.Номенклатура.Код, """") КАК НоменклатураКод,
		|	ЕСТЬNULL(ВТ_Товары.Номенклатура.Наименование, """") КАК НоменклатураНаименование,
		|	ЕСТЬNULL(ВТ_Товары.Характеристика.Наименование, """") КАК НаименованиеХарактеристики
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Исключение
		ЗаписьJSON.Закрыть();
		ВызватьИсключение "Ошибка выполнения запроса: " + ОписаниеОшибки();
	КонецПопытки;
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("НоменклатураКод");
		ЗаписьJSON.ЗаписатьЗначение(ВыборкаДетальныеЗаписи.НоменклатураКод);              
		ЗаписьJSON.ЗаписатьИмяСвойства("НоменклатураНаименование");
		ЗаписьJSON.ЗаписатьЗначение(ВыборкаДетальныеЗаписи.НоменклатураНаименование);              
		ЗаписьJSON.ЗаписатьИмяСвойства("НаименованиеХарактеристики");
		ЗаписьJSON.ЗаписатьЗначение(ВыборкаДетальныеЗаписи.НаименованиеХарактеристики);              
		
		ЗаписьJSON.ЗаписатьКонецОбъекта();	
	КонецЦикла;
	
	ЗаписьJSON.ЗаписатьКонецМассива();
	ЗаписьJSON.Закрыть();
	
КонецПроцедуры

// Клиентские процедуры для работы с формой
&НаКлиенте
Процедура ВыбратьКаталог(Команда)
	
	ДиалогОткрытия = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога); 
	Если ДиалогОткрытия.Выбрать() Тогда
		Попытка
			ИмяКомпьютераЗначение = Строка(ИнформацияОКомпьютере().ИмяКомпьютера);
		Исключение
			ИмяКомпьютераЗначение = "Unknown";
		КонецПопытки;
		Объект.ПутьКФайлу = ДиалогОткрытия.Каталог + "\ВыгрузкаНоменклатурыСХарактеристиками_" + ИмяКомпьютераЗначение + ".json";
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыгрузитьНоменклатуруВJSON(Команда)
	
	Если Объект.ПутьКФайлу = "" Тогда
		Сообщить("Выберите каталог для файла");
		Возврат;
	КонецЕсли;
	
	ВыгрузитьНоменклатуруСХарактеристикамиВФайлНаСервере();
	Сообщить("Выгрузка в JSON завершена: " + Объект.ПутьКФайлу);
	
КонецПроцедуры

// Модифицированная процедура выгрузки контрагентов
&НаСервере
Процедура ВыполнитьВыгрузкуКонтрагентовНаСервере()
	
	ОбновитьНастройкиИзФормы();
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки контрагентов");
	Сообщить("============================================");
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем константы (опционально, можно пропустить)
	Сообщить("Этап 3: Выгрузка констант...");
	ВыгрузитьКонстантыЧерезHTTP();
	
	// Выгружаем только контрагентов пакетами
	Сообщить("Этап 4: Выгрузка справочника контрагентов...");
	ВыгрузитьСправочникКонтрагентовПакетами();
	
	// Завершаем выгрузку
	Сообщить("Этап 5: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка контрагентов завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Модифицированная процедура выгрузки номенклатуры с характеристиками через HTTP
&НаСервере
Процедура ВыполнитьВыгрузкуНоменклатурыНаСервере()
	
	ОбновитьНастройкиИзФормы();
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки номенклатуры с характеристиками");
	Сообщить("============================================");
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Отправляем метаданные справочника Номенклатура
	Сообщить("Этап 3: Отправка метаданных справочника 'Номенклатура'...");
	Попытка
		СправочникМетаданных = Метаданные.Справочники["Номенклатура"];
		Если СправочникМетаданных <> Неопределено Тогда
			ОтправитьМетаСправочника(СправочникМетаданных);
		КонецЕсли;
	Исключение
		Сообщить("  → ОШИБКА: Справочник 'Номенклатура' не найден!");
	КонецПопытки;
	
	// Выгружаем номенклатуру с характеристиками
	Сообщить("Этап 4: Выгрузка номенклатуры с характеристиками...");
	ВыгрузитьНоменклатуруСХарактеристикамиЧерезHTTP();
	
	// Завершаем выгрузку
	Сообщить("Этап 5: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка номенклатуры завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Модифицированная процедура выгрузки номенклатуры с характеристиками с поддержкой пакетной отправки
Процедура ВыгрузитьНоменклатуруСХарактеристикамиЧерезHTTP()
	
	Сообщить("      → Выгружаем номенклатуру с характеристиками...");
	
	// Используем запрос для получения комбинаций номенклатура+характеристика из регистра
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТоварыНаСкладах.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладах.Характеристика КАК Характеристика
		|ПОМЕСТИТЬ ВТ_Товары
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах КАК ТоварыНаСкладах
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Товары.Номенклатура КАК Номенклатура,
		|	ВТ_Товары.Характеристика КАК Характеристика,
		|	ВТ_Товары.Номенклатура.Код КАК КодНоменклатуры,
		|	ВТ_Товары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
		|	ВТ_Товары.Характеристика.Наименование КАК НаименованиеХарактеристики
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Счетчик = 0;
	МассивЭлементов = Новый Массив;
	
	Пока Выборка.Следующий() Цикл
		
		Счетчик = Счетчик + 1;
		
		// Формируем уникальный код для комбинации номенклатура+характеристика
		УникальныйКод = Выборка.КодНоменклатуры + "_" + Строка(Счетчик);
		УникальноеНаименование = Выборка.НаименованиеНоменклатуры;
		Если Выборка.Характеристика <> Неопределено Тогда
			УникальноеНаименование = УникальноеНаименование + " " + Выборка.НаименованиеХарактеристики;
		КонецЕсли;
		
		// Получаем реквизиты номенклатуры
		РеквизитыXML = "";
		Если Выборка.Номенклатура <> Неопределено Тогда
			РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Номенклатура, "Номенклатура");
		КонецЕсли;
		
		// Добавляем характеристику в реквизиты
		Если Выборка.Характеристика <> Неопределено Тогда
			РеквизитыXML = РеквизитыXML + "<Характеристика>" + ЭкранироватьXML(Выборка.НаименованиеХарактеристики) + "</Характеристика>";
			РеквизитыXML = РеквизитыXML + "<СсылкаХарактеристика>" + ЭкранироватьXML(Строка(Выборка.Характеристика)) + "</СсылкаХарактеристика>";
		КонецЕсли;
		
		// Создаем элемент для отправки
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", УникальныйКод);
		Элемент.Вставить("Код", УникальныйКод);
		Элемент.Вставить("Наименование", УникальноеНаименование);
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", "");
		
		МассивЭлементов.Добавить(Элемент);
		
		// Отправляем пакет при достижении размера
		Если ИспользоватьПакетнуюВыгрузку И МассивЭлементов.Количество() >= РазмерПакета Тогда
			ОтправитьПакетЭлементовСправочника("НоменклатураСХарактеристиками", МассивЭлементов);
			Сообщить("  → Отправлен пакет номенклатуры: " + Строка(МассивЭлементов.Количество()) + " элементов");
			МассивЭлементов = Новый Массив;
		КонецЕсли;
		
	КонецЦикла;
	
	// Отправляем оставшиеся элементы
	Если МассивЭлементов.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетЭлементовСправочника("НоменклатураСХарактеристиками", МассивЭлементов);
			Сообщить("  → Отправлен последний пакет номенклатуры: " + Строка(МассивЭлементов.Количество()) + " элементов");
		Иначе
			// Поштучная отправка
			Для Каждого Элемент Из МассивЭлементов Цикл
				ОтправитьЭлементСправочника(
					"НоменклатураСХарактеристиками",
					Элемент.Ссылка,
					Элемент.Код,
					Элемент.Наименование,
					Элемент.РеквизитыXML,
					Элемент.ТабличныеЧастиXML
				);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Сообщить("  ✓ Выгружено комбинаций номенклатура+характеристика: " + Строка(Счетчик));
	
КонецПроцедуры

// Получение универсального запроса номенклатуры (встроенная версия для совместимости)
&НаСервере
Функция ПолучитьУниверсальныйЗапросНоменклатуры()
	
	Возврат 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ХарактеристикиНоменклатуры.Ссылка КАК СсылкаХарактеристики,
	|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
	|			И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ХарактеристикиНоменклатуры.Ссылка КАК СсылкаХарактеристики,
	|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО Номенклатура.ВидНоменклатуры = ХарактеристикиНоменклатуры.Владелец
	|			И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК СсылкаХарактеристики,
	|	ВЫРАЗИТЬ(NULL КАК СТРОКА(1)) КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
	|				И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
	|			ИЛИ Номенклатура.ВидНоменклатуры = ХарактеристикиНоменклатуры.Владелец
	|				И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|
	|УПОРЯДОЧИТЬ ПО
	|	НаименованиеНоменклатуры,
	|	НаименованиеХарактеристики";
	
КонецФункции

// Универсальная выгрузка номенклатуры с характеристиками (использует универсальный запрос)
&НаСервере
Процедура ВыгрузитьНоменклатуруУниверсально()
	
	Сообщить("=== УНИВЕРСАЛЬНАЯ ВЫГРУЗКА НОМЕНКЛАТУРЫ С ХАРАКТЕРИСТИКАМИ ===");
	
	ОбновитьНастройкиИзФормы();
	
	// Используем универсальный запрос
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьУниверсальныйЗапросНоменклатуры();
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	МассивПакета = Новый Массив;
	Счетчик = 0;
	ВсегоВыгружено = 0;
	
	Пока Выборка.Следующий() Цикл
		
		Счетчик = Счетчик + 1;
		
		// Формируем уникальный идентификатор для комбинации
		УникальныйИдентификатор = Строка(Выборка.СсылкаНоменклатуры);
		Если ЗначениеЗаполнено(Выборка.СсылкаХарактеристики) Тогда
			УникальныйИдентификатор = УникальныйИдентификатор + "|" + Строка(Выборка.СсылкаХарактеристики);
		КонецЕсли;
		
		// Получаем все реквизиты номенклатуры
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.СсылкаНоменклатуры, "Номенклатура");
		
		// Добавляем информацию о характеристике
		Если ЗначениеЗаполнено(Выборка.СсылкаХарактеристики) Тогда
			РеквизитыXML = РеквизитыXML + "<Характеристика_Код>" + ЭкранироватьXML(Строка(Выборка.СсылкаХарактеристики.Код)) + "</Характеристика_Код>";
			РеквизитыXML = РеквизитыXML + "<Характеристика_Наименование>" + ЭкранироватьXML(Выборка.НаименованиеХарактеристики) + "</Характеристика_Наименование>";
			РеквизитыXML = РеквизитыXML + "<Характеристика_Ссылка>" + ЭкранироватьXML(Строка(Выборка.СсылкаХарактеристики)) + "</Характеристика_Ссылка>";
		КонецЕсли;
		
		// Формируем составное наименование
		СоставноеНаименование = Выборка.НаименованиеНоменклатуры;
		Если ЗначениеЗаполнено(Выборка.НаименованиеХарактеристики) Тогда
			СоставноеНаименование = СоставноеНаименование + " " + Выборка.НаименованиеХарактеристики;
		КонецЕсли;
		
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", УникальныйИдентификатор);
		Элемент.Вставить("Код", Выборка.КодНоменклатуры);
		Элемент.Вставить("Наименование", СоставноеНаименование);
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", "");
		Элемент.Вставить("НоменклатураСсылка", Строка(Выборка.СсылкаНоменклатуры));
		Элемент.Вставить("НоменклатураКод", Выборка.КодНоменклатуры);
		Элемент.Вставить("НоменклатураНаименование", Выборка.НаименованиеНоменклатуры);
		Если ЗначениеЗаполнено(Выборка.СсылкаХарактеристики) Тогда
			Элемент.Вставить("ХарактеристикаСсылка", Строка(Выборка.СсылкаХарактеристики));
			Элемент.Вставить("ХарактеристикаНаименование", Выборка.НаименованиеХарактеристики);
		Иначе
			Элемент.Вставить("ХарактеристикаСсылка", "");
			Элемент.Вставить("ХарактеристикаНаименование", "");
		КонецЕсли;
		
		МассивПакета.Добавить(Элемент);
		
		// Отправляем пакет при достижении лимита
		Если ИспользоватьПакетнуюВыгрузку И МассивПакета.Количество() >= РазмерПакета Тогда
			ОтправитьПакетНоменклатуры(МассивПакета);
			ВсегоВыгружено = ВсегоВыгружено + МассивПакета.Количество();
			Сообщить("  → Отправлен пакет: " + Строка(МассивПакета.Количество()) + " элементов");
			МассивПакета = Новый Массив;
		КонецЕсли;
		
	КонецЦикла;
	
	// Отправляем оставшиеся элементы
	Если МассивПакета.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетНоменклатуры(МассивПакета);
			ВсегоВыгружено = ВсегоВыгружено + МассивПакета.Количество();
			Сообщить("  → Отправлен последний пакет: " + Строка(МассивПакета.Количество()) + " элементов");
		Иначе
			// Поштучная отправка
			Для Каждого Элемент Из МассивПакета Цикл
				ОтправитьЭлементНоменклатуры(Элемент);
				ВсегоВыгружено = ВсегоВыгружено + 1;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Сообщить("  ✓ Выгружено комбинаций номенклатура+характеристика: " + Строка(ВсегоВыгружено));
	
КонецПроцедуры

// Пакетная отправка номенклатуры
&НаСервере
Процедура ОтправитьПакетНоменклатуры(МассивЭлементов)
	
	URL = АдресСервера + "/api/v1/upload/nomenclature/batch";
	
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<nomenclature_batch>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>";
	
	// Добавляем database_id, если он указан
	Попытка
		Если Объект.ИдентификаторБазыДанных <> "" Тогда
			XMLСтрока = XMLСтрока + "<database_id>" + ЭкранироватьXML(Объект.ИдентификаторБазыДанных) + "</database_id>";
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	XMLСтрока = XMLСтрока + "<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>";
	
	Для Каждого Элемент Из МассивЭлементов Цикл
		XMLСтрока = XMLСтрока + 
			"<item>" +
			"<nomenclature_reference>" + ЭкранироватьXML(Элемент.НоменклатураСсылка) + "</nomenclature_reference>" +
			"<nomenclature_code>" + ЭкранироватьXML(Элемент.НоменклатураКод) + "</nomenclature_code>" +
			"<nomenclature_name>" + ЭкранироватьXML(Элемент.НоменклатураНаименование) + "</nomenclature_name>";
		
		Если Элемент.ХарактеристикаСсылка <> "" Тогда
			XMLСтрока = XMLСтрока + 
				"<characteristic_reference>" + ЭкранироватьXML(Элемент.ХарактеристикаСсылка) + "</characteristic_reference>" +
				"<characteristic_name>" + ЭкранироватьXML(Элемент.ХарактеристикаНаименование) + "</characteristic_name>";
		КонецЕсли;
		
		XMLСтрока = XMLСтрока + 
			"<attributes>" + Элемент.РеквизитыXML + "</attributes>" +
			"<table_parts>" + Элемент.ТабличныеЧастиXML + "</table_parts>" +
			"</item>";
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</nomenclature_batch>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Ответ.КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			ТелоОтветаОшибка = "Не удалось получить тело ответа";
		КонецПопытки;
		Сообщить("ОШИБКА отправки пакета номенклатуры: " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Отправка одного элемента номенклатуры
&НаСервере
Процедура ОтправитьЭлементНоменклатуры(Элемент)
	
	URL = АдресСервера + "/api/v1/upload/nomenclature/batch";
	
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<nomenclature_batch>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"<item>" +
		"<nomenclature_reference>" + ЭкранироватьXML(Элемент.НоменклатураСсылка) + "</nomenclature_reference>" +
		"<nomenclature_code>" + ЭкранироватьXML(Элемент.НоменклатураКод) + "</nomenclature_code>" +
		"<nomenclature_name>" + ЭкранироватьXML(Элемент.НоменклатураНаименование) + "</nomenclature_name>";
	
	Если Элемент.ХарактеристикаСсылка <> "" Тогда
		XMLСтрока = XMLСтрока + 
			"<characteristic_reference>" + ЭкранироватьXML(Элемент.ХарактеристикаСсылка) + "</characteristic_reference>" +
			"<characteristic_name>" + ЭкранироватьXML(Элемент.ХарактеристикаНаименование) + "</characteristic_name>";
	КонецЕсли;
	
	XMLСтрока = XMLСтрока + 
		"<attributes>" + Элемент.РеквизитыXML + "</attributes>" +
		"<table_parts>" + Элемент.ТабличныеЧастиXML + "</table_parts>" +
		"</item>" +
		"</nomenclature_batch>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Ответ.КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			ТелоОтветаОшибка = "Не удалось получить тело ответа";
		КонецПопытки;
		Сообщить("ОШИБКА отправки элемента номенклатуры: " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Получение статистики по номенклатуре (использует универсальный запрос)
&НаСервере
Функция ПолучитьСтатистикуНоменклатуры()
	
	Сообщить("=== ПОЛУЧЕНИЕ СТАТИСТИКИ НОМЕНКЛАТУРЫ ===");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК ВсегоКомбинаций,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СсылкаНоменклатуры) КАК ВсегоНоменклатур,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СсылкаХарактеристики) КАК ВсегоХарактеристик
	|ИЗ
	|	(" + ПолучитьУниверсальныйЗапросНоменклатуры() + ")";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
		
		Если Выборка.Следующий() Тогда
			Статистика = Новый Структура;
			Статистика.Вставить("ВсегоКомбинаций", Выборка.ВсегоКомбинаций);
			Статистика.Вставить("ВсегоНоменклатур", Выборка.ВсегоНоменклатур);
			Статистика.Вставить("ВсегоХарактеристик", Выборка.ВсегоХарактеристик);
			
			Сообщить("  Всего комбинаций: " + Строка(Выборка.ВсегоКомбинаций));
			Сообщить("  Всего номенклатур: " + Строка(Выборка.ВсегоНоменклатур));
			Сообщить("  Всего характеристик: " + Строка(Выборка.ВсегоХарактеристик));
			
			Возврат Статистика;
		КонецЕсли;
	Исключение
		Сообщить("ОШИБКА получения статистики: " + ОписаниеОшибки());
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Проверка соединения с сервером
&НаСервере
Функция ПроверитьСоединение()
	
	ОбновитьНастройкиИзФормы();
	
	Попытка
		// Пробуем новый API сначала
		URL = АдресСервера + "/api/v1/health";
		Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			Сообщить("✓ Соединение с сервером установлено (новый API)");
			Возврат Истина;
		КонецЕсли;
		
		// Если новый API не доступен, пробуем старый
		URL = АдресСервера + "/handshake";
		XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?><handshake><timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp></handshake>";
		Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			Сообщить("✓ Соединение с сервером установлено (старый API)");
			Возврат Истина;
		КонецЕсли;
		
		Сообщить("✗ Ошибка соединения с сервером");
		Возврат Ложь;
	Исключение
		Сообщить("✗ Ошибка соединения: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Проверка привязки базы данных
&НаСервере
Функция ПроверитьПривязкуБазыДанных()
	
	ОбновитьНастройкиИзФормы();
	
	Если ИдентификаторБазыДанных = "" Тогда
		Сообщить("✗ Не указан идентификатор базы данных");
		Возврат "Не указан идентификатор базы данных";
	КонецЕсли;
	
	Попытка
		URL = АдресСервера + "/api/v1/databases/" + ИдентификаторБазыДанных;
		Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			ТелоОтвета = ПолучитьТелоОтвета(Ответ);
			ИмяКлиента = ИзвлечьЗначениеИзXML(ТелоОтвета, "client_name");
			ИмяПроекта = ИзвлечьЗначениеИзXML(ТелоОтвета, "project_name");
			ИмяБазы = ИзвлечьЗначениеИзXML(ТелоОтвета, "database_name");
			
			Если ИмяКлиента <> "" Тогда
				ОбновитьИнформациюОБазе(ИмяКлиента, ИмяПроекта, ИмяБазы);
				Результат = "✓ Привязка успешна: " + ИмяКлиента + " / " + ИмяПроекта + " / " + ИмяБазы;
				Сообщить(Результат);
				Возврат Результат;
			Иначе
				Сообщить("✗ База данных найдена, но информация о клиенте/проекте отсутствует");
				Возврат "База данных найдена, но информация о клиенте/проекте отсутствует";
			КонецЕсли;
		Иначе
			ТелоОтвета = ПолучитьТелоОтвета(Ответ);
			Результат = "✗ Ошибка привязки: " + ТелоОтвета;
			Сообщить(Результат);
			Возврат Результат;
		КонецЕсли;
	Исключение
		Результат = "✗ Ошибка соединения с сервером: " + ОписаниеОшибки();
		Сообщить(Результат);
		Возврат Результат;
	КонецПопытки;
	
КонецФункции

// Получение статуса выгрузки с сервера
&НаСервере
Функция ПолучитьСтатусВыгрузки()
	
	ОбновитьНастройкиИзФормы();
	
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("Выгрузка не начата");
		Возврат "Выгрузка не начата";
	КонецЕсли;
	
	Попытка
		URL = АдресСервера + "/api/v1/upload/" + ИдентификаторВыгрузки + "/status";
		Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			ТелоОтвета = ПолучитьТелоОтвета(Ответ);
			Статус = ИзвлечьЗначениеИзXML(ТелоОтвета, "status");
			Прогресс = ИзвлечьЗначениеИзXML(ТелоОтвета, "progress");
			Результат = "Статус: " + Статус + ", Прогресс: " + Прогресс + "%";
			Сообщить(Результат);
			Возврат Результат;
		Иначе
			Результат = "Не удалось получить статус (код " + Строка(ПолучитьКодСостояния(Ответ)) + ")";
			Сообщить(Результат);
			Возврат Результат;
		КонецЕсли;
	Исключение
		Результат = "Ошибка получения статуса: " + ОписаниеОшибки();
		Сообщить(Результат);
		Возврат Результат;
	КонецПопытки;
	
КонецФункции

// Клиентские процедуры для новых кнопок

// Серверная процедура для универсальной выгрузки номенклатуры
&НаСервере
Процедура ВыполнитьВыгрузкуНоменклатурыУниверсальноНаСервере()
	
	Сообщить("============================================");
	Сообщить("Начало универсальной выгрузки номенклатуры с характеристиками");
	Сообщить("============================================");
	
	ОбновитьНастройкиИзФормы();
	
	// Выполняем рукопожатие с привязкой к базе данных
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатиеСПривязкой();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем номенклатуру универсальным методом
	Сообщить("Этап 3: Выгрузка номенклатуры с характеристиками...");
	ВыгрузитьНоменклатуруУниверсально();
	
	// Завершаем выгрузку
	Сообщить("Этап 4: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Универсальная выгрузка номенклатуры завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Получение статистики по номенклатуре
&НаКлиенте
Процедура ПолучитьСтатистику(Команда)
	
	Статистика = ПолучитьСтатистикуНоменклатурыНаСервере();
	
	Если Статистика = Неопределено Тогда
		Сообщить("Не удалось получить статистику по номенклатуре");
		Возврат;
	КонецЕсли;
	
	Сообщить("============================================");
	Сообщить("СТАТИСТИКА ПО НОМЕНКЛАТУРЕ");
	Сообщить("============================================");
	Сообщить("Всего комбинаций номенклатура+характеристика: " + Строка(Статистика.ВсегоКомбинаций));
	Сообщить("Всего номенклатур: " + Строка(Статистика.ВсегоНоменклатур));
	Сообщить("Всего характеристик: " + Строка(Статистика.ВсегоХарактеристик));
	Сообщить("============================================");
	
КонецПроцедуры

// Серверная процедура для получения статистики
&НаСервере
Функция ПолучитьСтатистикуНоменклатурыНаСервере()
	
	Возврат ПолучитьСтатистикуНоменклатуры();
	
КонецФункции

// Проверка привязки
&НаКлиенте
Процедура ПроверитьПривязку(Команда)
	
	Результат = ПроверитьПривязкуНаСервере();
	Сообщить(Результат);
	
КонецПроцедуры

&НаСервере
Функция ПроверитьПривязкуНаСервере()
	
	Возврат ПроверитьПривязкуБазыДанных();
	
КонецФункции

#КонецОбласти

#Область РаботаСПрогрессом

// Получение общего количества объектов для выгрузки
&НаСервере
Функция ПолучитьОбщееКоличествоОбъектов(ТипВыгрузки) Экспорт
	
	ОбщееКоличество = 0;
	
	Если ТипВыгрузки = "Все" Тогда
		// Подсчитываем константы
		КоллекцияКонстант = Метаданные.Константы;
		ОбщееКоличество = ОбщееКоличество + КоллекцияКонстант.Количество();
		
		// Подсчитываем справочники
		КоллекцияСправочников = Метаданные.Справочники;
		Для Каждого СправочникМетаданных Из КоллекцияСправочников Цикл
			Попытка
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоЭлементов ИЗ Справочник." + СправочникМетаданных.Имя + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
				Результат = Запрос.Выполнить();
				Выборка = Результат.Выбрать();
				Если Выборка.Следующий() Тогда
					ОбщееКоличество = ОбщееКоличество + Выборка.ВсегоЭлементов;
				КонецЕсли;
			Исключение
				// Пропускаем справочники, для которых не удалось выполнить запрос
			КонецПопытки;
		КонецЦикла;
		
	ИначеЕсли ТипВыгрузки = "Контрагенты" Тогда
		Попытка
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоЭлементов ИЗ Справочник.Контрагенты КАК Контрагенты ГДЕ НЕ Контрагенты.ПометкаУдаления";
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				ОбщееКоличество = Выборка.ВсегоЭлементов;
			КонецЕсли;
		Исключение
			ОбщееКоличество = 0;
		КонецПопытки;
		
	ИначеЕсли ТипВыгрузки = "Номенклатура" Тогда
		Попытка
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоКомбинаций ИЗ (" + ПолучитьУниверсальныйЗапросНоменклатуры() + ")";
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				ОбщееКоличество = Выборка.ВсегоКомбинаций;
			КонецЕсли;
		Исключение
			ОбщееКоличество = 0;
		КонецПопытки;
		
	ИначеЕсли ТипВыгрузки = "Справочники" Тогда
		КоллекцияСправочников = Метаданные.Справочники;
		Для Каждого СправочникМетаданных Из КоллекцияСправочников Цикл
			Попытка
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоЭлементов ИЗ Справочник." + СправочникМетаданных.Имя + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
				Результат = Запрос.Выполнить();
				Выборка = Результат.Выбрать();
				Если Выборка.Следующий() Тогда
					ОбщееКоличество = ОбщееКоличество + Выборка.ВсегоЭлементов;
				КонецЕсли;
			Исключение
				// Пропускаем справочники, для которых не удалось выполнить запрос
			КонецПопытки;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ОбщееКоличество;
	
КонецФункции

// Обработка пакета выгрузки
&НаСервере
Процедура ОбработатьПакетВыгрузки(Параметры, Результат) Экспорт
	
	ТипВыгрузки = Параметры.ТипВыгрузки;
	НачальнаяПозиция = Параметры.НачальнаяПозиция;
	РазмерПакета = Параметры.РазмерПакета;
	Этап = Параметры.Этап;
	
	ОбновитьНастройкиИзФормы();
	
	Результат.НоваяПозиция = НачальнаяПозиция;
	Результат.Обработано = 0;
	Результат.Завершено = Ложь;
	Результат.СледующийЭтап = Этап;
	Результат.ТекущийОбъект = "";
	
	Попытка
		Если Этап = "Рукопожатие" Тогда
			// Рукопожатие выполняется синхронно, не в пакетах
			Результат.Завершено = Истина;
			Результат.СледующийЭтап = "Метаинформация";
			
		ИначеЕсли Этап = "Метаинформация" Тогда
			// Метаинформация выполняется синхронно, не в пакетах
			Результат.Завершено = Истина;
			Результат.СледующийЭтап = "Константы";
			
		ИначеЕсли Этап = "Константы" Тогда
			Результат = ОбработатьПакетКонстант(НачальнаяПозиция, РазмерПакета);
			
		ИначеЕсли Этап = "Справочники" Тогда
			Результат = ОбработатьПакетСправочников(НачальнаяПозиция, РазмерПакета);
			
		ИначеЕсли Этап = "Завершение" Тогда
			// Завершение выполняется синхронно, не в пакетах
			ЗавершитьВыгрузку();
			Результат.Завершено = Истина;
			Результат.СледующийЭтап = "";
			Результат.ТекущийОбъект = "Завершено";
		КонецЕсли;
		
	Исключение
		Результат.Завершено = Истина;
		Результат.СледующийЭтап = "";
		Результат.ТекущийОбъект = "Ошибка: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецПроцедуры

// Обработка пакета констант
&НаСервере
Функция ОбработатьПакетКонстант(НачальнаяПозиция, РазмерПакета)
	
	Результат = Новый Структура;
	Результат.Вставить("НоваяПозиция", НачальнаяПозиция);
	Результат.Вставить("Обработано", 0);
	Результат.Вставить("Завершено", Ложь);
	Результат.Вставить("СледующийЭтап", "Константы");
	Результат.Вставить("ТекущийОбъект", "");
	
	КоллекцияКонстант = Метаданные.Константы;
	ВсегоКонстант = КоллекцияКонстант.Количество();
	
	Если НачальнаяПозиция >= ВсегоКонстант Тогда
		Результат.Завершено = Истина;
		Результат.СледующийЭтап = "Справочники";
		Возврат Результат;
	КонецЕсли;
	
	КонечнаяПозиция = НачальнаяПозиция + РазмерПакета;
	Если КонечнаяПозиция > ВсегоКонстант Тогда
		КонечнаяПозиция = ВсегоКонстант;
	КонецЕсли;
	
	Индекс = 0;
	Для Каждого КонстантаМетаданных Из КоллекцияКонстант Цикл
		Если Индекс >= НачальнаяПозиция И Индекс < КонечнаяПозиция Тогда
			Попытка
				ЗначениеКонстанты = Константы[КонстантаМетаданных.Имя].Получить();
				ТипЗначения = ТипЗнч(ЗначениеКонстанты);
				XMLЗначения = ПолучитьXMLПредставлениеЗначения(ЗначениеКонстанты, Строка(ТипЗначения));
				ОтправитьКонстанту(КонстантаМетаданных.Имя, КонстантаМетаданных.Синоним, Строка(ТипЗначения), XMLЗначения);
				Результат.Обработано = Результат.Обработано + 1;
				Результат.ТекущийОбъект = "Константа: " + КонстантаМетаданных.Имя;
			Исключение
				// Пропускаем константы, которые не удалось обработать
			КонецПопытки;
		КонецЕсли;
		Индекс = Индекс + 1;
	КонецЦикла;
	
	Результат.НоваяПозиция = КонечнаяПозиция;
	Результат.Завершено = (КонечнаяПозиция >= ВсегоКонстант);
	Если Результат.Завершено Тогда
		Результат.СледующийЭтап = "Справочники";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Обработка пакета справочников
&НаСервере
Функция ОбработатьПакетСправочников(НачальнаяПозиция, РазмерПакета)
	
	Результат = Новый Структура;
	Результат.Вставить("НоваяПозиция", НачальнаяПозиция);
	Результат.Вставить("Обработано", 0);
	Результат.Вставить("Завершено", Ложь);
	Результат.Вставить("СледующийЭтап", "Справочники");
	Результат.Вставить("ТекущийОбъект", "");
	
	КоллекцияСправочников = Метаданные.Справочники;
	ВсегоСправочников = КоллекцияСправочников.Количество();
	
	// НачальнаяПозиция здесь - это позиция в общем списке элементов (константы + элементы справочников)
	// Нужно определить, сколько констант уже обработано, чтобы понять, с какого элемента справочников начинать
	КоллекцияКонстант = Метаданные.Константы;
	ВсегоКонстант = КоллекцияКонстант.Количество();
	
	// Если начальная позиция меньше количества констант, значит мы еще обрабатываем константы
	// Это не должно происходить, так как константы обрабатываются отдельно
	// Но на всякий случай проверяем
	Если НачальнаяПозиция < ВсегоКонстант Тогда
		// Это ошибка в логике, но обработаем
		Результат.Завершено = Истина;
		Результат.СледующийЭтап = "Завершение";
		Возврат Результат;
	КонецЕсли;
	
	// Позиция в списке элементов справочников (начинаем с 0)
	ПозицияВЭлементахСправочников = НачальнаяПозиция - ВсегоКонстант;
	
	// Упрощенная логика: обрабатываем справочники по одному
	// НачальнаяПозиция указывает на позицию в общем списке элементов (константы + элементы справочников)
	// Для упрощения обрабатываем один справочник за раз, начиная с нужной позиции
	
	// Находим справочник, с которого нужно начать обработку
	ТекущаяПозицияВЭлементах = 0;
	Обработано = 0;
	НайденНачальныйСправочник = Ложь;
	
	Для Каждого СправочникМетаданных Из КоллекцияСправочников Цикл
		Если Обработано >= РазмерПакета Тогда
			Прервать;
		КонецЕсли;
		
		Попытка
			// Подсчитываем количество элементов в текущем справочнике
			ЗапросПодсчета = Новый Запрос;
			ЗапросПодсчета.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоЭлементов ИЗ Справочник." + СправочникМетаданных.Имя + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
			РезультатПодсчета = ЗапросПодсчета.Выполнить();
			ВыборкаПодсчета = РезультатПодсчета.Выбрать();
			КоличествоЭлементов = 0;
			Если ВыборкаПодсчета.Следующий() Тогда
				КоличествоЭлементов = ВыборкаПодсчета.ВсегоЭлементов;
			КонецЕсли;
			
			// Если текущая позиция в элементах меньше позиции начала обработки, пропускаем этот справочник
			Если ТекущаяПозицияВЭлементах + КоличествоЭлементов <= ПозицияВЭлементахСправочников Тогда
				ТекущаяПозицияВЭлементах = ТекущаяПозицияВЭлементах + КоличествоЭлементов;
				Продолжить;
			КонецЕсли;
			
			// Если мы дошли до нужной позиции, начинаем обработку
			Если ТекущаяПозицияВЭлементах <= ПозицияВЭлементахСправочников И ТекущаяПозицияВЭлементах + КоличествоЭлементов > ПозицияВЭлементахСправочников Тогда
				// Отправляем метаданные справочника (только один раз для каждого справочника)
				Если Не НайденНачальныйСправочник Тогда
					ОтправитьМетаСправочника(СправочникМетаданных);
					НайденНачальныйСправочник = Истина;
				КонецЕсли;
				
				Результат.ТекущийОбъект = "Справочник: " + СправочникМетаданных.Имя;
				
				// Обрабатываем элементы справочника, начиная с нужной позиции
				СмещениеВСправочнике = ПозицияВЭлементахСправочников - ТекущаяПозицияВЭлементах;
				ОсталосьОбработать = РазмерПакета - Обработано;
				
				КоличествоОбработанныхВСправочнике = ОбработатьЭлементыСправочникаСоСмещением(СправочникМетаданных, СмещениеВСправочнике, ОсталосьОбработать);
				
				Обработано = Обработано + КоличествоОбработанныхВСправочнике;
				
				// Обновляем позицию: если обработали все элементы справочника, переходим к следующему
				Если КоличествоОбработанныхВСправочнике >= КоличествоЭлементов - СмещениеВСправочнике Тогда
					ТекущаяПозицияВЭлементах = ТекущаяПозицияВЭлементах + КоличествоЭлементов;
				Иначе
					ТекущаяПозицияВЭлементах = ТекущаяПозицияВЭлементах + КоличествоОбработанныхВСправочнике;
				КонецЕсли;
				
				// Если обработали достаточно элементов, выходим
				Если Обработано >= РазмерПакета Тогда
					Прервать;
				КонецЕсли;
				
				// Если обработали все элементы справочника, переходим к следующему
				Если КоличествоОбработанныхВСправочнике >= КоличествоЭлементов - СмещениеВСправочнике Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			
		Исключение
			// Пропускаем справочники, которые не удалось обработать
			ТекущаяПозицияВЭлементах = ТекущаяПозицияВЭлементах + 1;
		КонецПопытки;
	КонецЦикла;
	
	Результат.Обработано = Обработано;
	Результат.НоваяПозиция = НачальнаяПозиция + Обработано;
	
	// Проверяем, обработаны ли все справочники
	// Для этого нужно подсчитать общее количество элементов во всех справочниках
	ОбщееКоличествоЭлементовСправочников = ПолучитьОбщееКоличествоОбъектов("Справочники");
	Если Результат.НоваяПозиция - ВсегоКонстант >= ОбщееКоличествоЭлементовСправочников Тогда
		Результат.Завершено = Истина;
		Результат.СледующийЭтап = "Завершение";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Обработка элементов справочника с указанным смещением
&НаСервере
Функция ОбработатьЭлементыСправочникаСоСмещением(СправочникМетаданных, Смещение, МаксимальноеКоличество)
	
	ИмяСправочникаВЗапросе = СправочникМетаданных.Имя;
	КоличествоОбработанных = 0;
	
	ОбновитьНастройкиИзФормы();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ Ссылка, Код, Наименование ИЗ Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Возврат 0;
	КонецПопытки;
	
	МассивЭлементов = Новый Массив;
	ТекущийИндекс = 0;
	
	Пока Выборка.Следующий() Цикл
		// Пропускаем элементы до смещения
		Если ТекущийИндекс < Смещение Тогда
			ТекущийИндекс = ТекущийИндекс + 1;
			Продолжить;
		КонецЕсли;
		
		// Если обработали максимальное количество, выходим
		Если КоличествоОбработанных >= МаксимальноеКоличество Тогда
			Прервать;
		КонецЕсли;
		
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, ИмяСправочникаВЗапросе);
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, ИмяСправочникаВЗапросе);
		
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", Строка(Выборка.Ссылка));
		Элемент.Вставить("Код", Строка(Выборка.Код));
		Элемент.Вставить("Наименование", Строка(Выборка.Наименование));
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", ТабличныеЧастиXML);
		
		МассивЭлементов.Добавить(Элемент);
		КоличествоОбработанных = КоличествоОбработанных + 1;
		ТекущийИндекс = ТекущийИндекс + 1;
		
		// Получаем размер пакета из настроек
		Попытка
			ТекущийРазмерПакета = Объект.РазмерПакета;
			Если ТекущийРазмерПакета = 0 Тогда
				ТекущийРазмерПакета = 50;
			КонецЕсли;
		Исключение
			ТекущийРазмерПакета = 50;
		КонецПопытки;
		
		Если ИспользоватьПакетнуюВыгрузку И МассивЭлементов.Количество() >= ТекущийРазмерПакета Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
			МассивЭлементов = Новый Массив;
		КонецЕсли;
	КонецЦикла;
	
	Если МассивЭлементов.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
		Иначе
			Для Каждого Элемент Из МассивЭлементов Цикл
				ОтправитьЭлементСправочника(
					СправочникМетаданных.Имя,
					Элемент.Ссылка,
					Элемент.Код,
					Элемент.Наименование,
					Элемент.РеквизитыXML,
					Элемент.ТабличныеЧастиXML
				);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат КоличествоОбработанных;
	
КонецФункции

// Обработка элементов справочника пакетами (вспомогательная функция)
// Возвращает количество обработанных элементов
&НаСервере
Функция ОбработатьЭлементыСправочникаПакетами(СправочникМетаданных)
	
	ИмяСправочникаВЗапросе = СправочникМетаданных.Имя;
	КоличествоОбработанных = 0;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ Ссылка, Код, Наименование ИЗ Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Возврат 0;
	КонецПопытки;
	
	МассивЭлементов = Новый Массив;
	Счетчик = 0;
	
	Пока Выборка.Следующий() Цикл
		// Проверка прерывания (через глобальную переменную, которая передается через параметры)
		// В данном случае прерывание проверяется на клиенте, поэтому здесь просто обрабатываем
		
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, ИмяСправочникаВЗапросе);
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, ИмяСправочникаВЗапросе);
		
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", Строка(Выборка.Ссылка));
		Элемент.Вставить("Код", Строка(Выборка.Код));
		Элемент.Вставить("Наименование", Строка(Выборка.Наименование));
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", ТабличныеЧастиXML);
		
		МассивЭлементов.Добавить(Элемент);
		Счетчик = Счетчик + 1;
		КоличествоОбработанных = КоличествоОбработанных + 1;
		
		// Получаем размер пакета из настроек
		Попытка
			ТекущийРазмерПакета = Объект.РазмерПакета;
			Если ТекущийРазмерПакета = 0 Тогда
				ТекущийРазмерПакета = 50;
			КонецЕсли;
		Исключение
			ТекущийРазмерПакета = 50;
		КонецПопытки;
		
		Если ИспользоватьПакетнуюВыгрузку И МассивЭлементов.Количество() >= ТекущийРазмерПакета Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
			МассивЭлементов = Новый Массив;
		КонецЕсли;
	КонецЦикла;
	
	Если МассивЭлементов.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
		Иначе
			Для Каждого Элемент Из МассивЭлементов Цикл
				ОтправитьЭлементСправочника(
					СправочникМетаданных.Имя,
					Элемент.Ссылка,
					Элемент.Код,
					Элемент.Наименование,
					Элемент.РеквизитыXML,
					Элемент.ТабличныеЧастиXML
				);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат КоличествоОбработанных;
	
КонецФункции

// Обновление прогресса на форме
&НаКлиенте
Процедура ОбновитьПрогрессНаФорме()
	
	Если ОбщееКоличествоОбъектов > 0 Тогда
		Процент = ТекущаяПозиция / ОбщееКоличествоОбъектов * 100;
		Если Процент > 100 Тогда
			Процент = 100;
		КонецЕсли;
		
		Попытка
			Элементы.ИндикаторПрогресса.Значение = Процент;
		Исключение
			// Элемент формы может отсутствовать
		КонецПопытки;
		
		Попытка
			Элементы.ПолеСтатуса.Значение = "Обработано " + ТекущаяПозиция + " из " + ОбщееКоличествоОбъектов;
		Исключение
			// Элемент формы может отсутствовать
		КонецПопытки;
	Иначе
		Попытка
			Элементы.ИндикаторПрогресса.Значение = 0;
			Элементы.ПолеСтатуса.Значение = "";
		Исключение
			// Элемент формы может отсутствовать
		КонецПопытки;
	КонецЕсли;
	
	Попытка
		Если Объект.ТекущийЭтап <> "" Тогда
			Элементы.ПолеЭтапа.Значение = Объект.ТекущийЭтап;
		КонецЕсли;
	Исключение
		// Элемент формы может отсутствовать
	КонецПопытки;
	
	Попытка
		Если Объект.ТекущийОбъект <> "" Тогда
			Элементы.ПолеТекущегоОбъекта.Значение = Объект.ТекущийОбъект;
		КонецЕсли;
	Исключение
		// Элемент формы может отсутствовать
	КонецПопытки;
	
КонецПроцедуры

// Обработчик события таймера
&НаКлиенте
Процедура ТаймерОбновленияТик(Таймер)
	
	Если ВыполняетсяВыгрузка Тогда
		ОбновитьПрогрессНаФорме();
	КонецЕсли;
	
КонецПроцедуры

// Прерывание выгрузки
&НаКлиенте
Процедура ПрерватьВыгрузку(Команда)
	
	ТребуетсяПрервать = Истина;
	ВыполняетсяВыгрузка = Ложь;
	
	Попытка
		Элементы.КнопкаПрервать.Доступность = Ложь;
		Элементы.КнопкаВыгрузкаВсего.Доступность = Истина;
	Исключение
		// Элементы формы могут отсутствовать
	КонецПопытки;
	
	Попытка
		Элементы.ТаймерОбновления.Enabled = Ложь;
	Исключение
		// Элемент формы может отсутствовать
	КонецПопытки;
	
	Сообщить("Выгрузка прервана пользователем");
	
КонецПроцедуры

// Обработка результата пакета (колбэк)
&НаКлиенте
Процедура ПослеОбработкиПакета(Результат, ДополнительныеПараметры) Экспорт
	
	Если ДополнительныеПараметры.ЕстьОшибка Тогда
		Сообщить("Ошибка при обработке пакета: " + ДополнительныеПараметры.ТекстОшибки);
		ЗавершитьВыгрузкуСОшибкой();
		Возврат;
	КонецЕсли;
	
	ТекущаяПозиция = Результат.НоваяПозиция;
	Объект.ТекущийЭтап = Результат.СледующийЭтап;
	Объект.ТекущийОбъект = Результат.ТекущийОбъект;
	
	ОбновитьПрогрессНаФорме();
	
	Если Не Результат.Завершено И Не ТребуетсяПрервать Тогда
		// Запускаем следующий пакет
		// Получаем размер пакета из формы
		Попытка
			РазмерПакета = Объект.РазмерПакета;
			Если РазмерПакета = 0 Тогда
				РазмерПакета = 50;
			КонецЕсли;
		Исключение
			РазмерПакета = 50;
		КонецПопытки;
		
		Параметры = Новый Структура;
		Параметры.Вставить("ТипВыгрузки", "Все");
		Параметры.Вставить("НачальнаяПозиция", ТекущаяПозиция);
		Параметры.Вставить("РазмерПакета", РазмерПакета);
		Параметры.Вставить("Этап", Результат.СледующийЭтап);
		
		ВыполнитьОбработкуНаСервереАсинхронно("ОбработатьПакетВыгрузки", Параметры, "ПослеОбработкиПакета");
	Иначе
		ЗавершитьВыгрузку();
	КонецЕсли;
	
КонецПроцедуры

// Завершение выгрузки
&НаКлиенте
Процедура ЗавершитьВыгрузку()
	
	ВыполняетсяВыгрузка = Ложь;
	ТребуетсяПрервать = Ложь;
	
	Попытка
		Элементы.КнопкаПрервать.Доступность = Ложь;
		Элементы.КнопкаВыгрузкаВсего.Доступность = Истина;
		Элементы.ТаймерОбновления.Enabled = Ложь;
	Исключение
		// Элементы формы могут отсутствовать
	КонецПопытки;
	
	Если ТекущаяПозиция >= ОбщееКоличествоОбъектов Тогда
		Сообщить("Выгрузка завершена успешно");
		Объект.ТекущийЭтап = "Завершено";
		Объект.ТекущийОбъект = "";
	Иначе
		Сообщить("Выгрузка прервана");
		Объект.ТекущийЭтап = "Прервано";
		Объект.ТекущийОбъект = "";
	КонецЕсли;
	
	ОбновитьПрогрессНаФорме();
	
КонецПроцедуры

// Завершение выгрузки с ошибкой
&НаКлиенте
Процедура ЗавершитьВыгрузкуСОшибкой()
	
	ВыполняетсяВыгрузка = Ложь;
	ТребуетсяПрервать = Ложь;
	
	Попытка
		Элементы.КнопкаПрервать.Доступность = Ложь;
		Элементы.КнопкаВыгрузкаВсего.Доступность = Истина;
		Элементы.ТаймерОбновления.Enabled = Ложь;
	Исключение
		// Элементы формы могут отсутствовать
	КонецПопытки;
	
	Объект.ТекущийЭтап = "Ошибка";
	Объект.ТекущийОбъект = "";
	
	ОбновитьПрогрессНаФорме();
	
КонецПроцедуры

#КонецОбласти

#Область ОсновныеФункцииВыгрузки

// Вспомогательная функция для проверки HTTP ответа
&НаСервере
Функция ПроверитьHTTPОтвет(Ответ, ОписаниеОперации = "") Экспорт
	
	Если Ответ = Неопределено Тогда
		Сообщить("  → ОШИБКА: Не удалось получить ответ от сервера" + ?(ПустаяСтрока(ОписаниеОперации), "", " (" + ОписаниеОперации + ")"));
		Возврат Ложь;
	КонецЕсли;
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = ПолучитьТелоОтвета(Ответ);
		Сообщить("  → ОШИБКА" + ?(ПустаяСтрока(ОписаниеОперации), "", " " + ОписаниеОперации) + ": код " + Строка(КодСостояния) + ", " + ТелоОтветаОшибка);
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// Вспомогательная функция для проверки готовности к отправке
&НаСервере
Функция ПроверитьГотовностьКОтправке() Экспорт
	
	Если ПустаяСтрока(АдресСервера) Тогда
		Сообщить("  → ОШИБКА: Адрес сервера не указан");
		Возврат Ложь;
	КонецЕсли;
	
	Если ПустаяСтрока(ИдентификаторВыгрузки) Тогда
		Сообщить("  → ОШИБКА: Идентификатор выгрузки не установлен");
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// Выполнение рукопожатия с сервером (базовая версия без привязки)
&НаСервере
Функция ВыполнитьРукопожатие()
	
	Если ПустаяСтрока(АдресСервера) Тогда
		Сообщить("  → ОШИБКА: Адрес сервера не указан");
		Возврат "";
	КонецЕсли;
	
	URL = АдресСервера + "/handshake";
	Сообщить("  → Отправка запроса на " + URL);
	
	// Создаем XML для рукопожатия
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<handshake>" +
		"<version_1c>" + ЭкранироватьXML(Строка(Версия1С())) + "</version_1c>" +
		"<config_name>" + ЭкранироватьXML(Строка(ИмяКонфигурации())) + "</config_name>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</handshake>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Не ПроверитьHTTPОтвет(Ответ, "рукопожатие") Тогда
		Возврат "";
	КонецЕсли;
	
	// Извлекаем UUID из XML ответа используя существующую функцию
	ТелоОтвета = ПолучитьТелоОтвета(Ответ);
	UUIDВыгрузки = ИзвлечьЗначениеИзXML(ТелоОтвета, "upload_uuid");
	
	Если ПустаяСтрока(UUIDВыгрузки) Тогда
		Сообщить("  → ОШИБКА: UUID не найден в ответе сервера");
		Возврат "";
	КонецЕсли;
	
	Сообщить("  → UUID получен: " + UUIDВыгрузки);
	Возврат UUIDВыгрузки;
	
КонецФункции

// Отправка метаинформации
&НаСервере
Процедура ОтправитьМетаИнформацию()
	
	Если Не ПроверитьГотовностьКОтправке() Тогда
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Отправка метаинформации...");
	URL = АдресСервера + "/metadata";
	
	// Создаем XML для метаинформации
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<metadata>" +
		"<upload_uuid>" + ЭкранироватьXML(ИдентификаторВыгрузки) + "</upload_uuid>" +
		"<version_1c>" + ЭкранироватьXML(Строка(Версия1С())) + "</version_1c>" +
		"<config_name>" + ЭкранироватьXML(Строка(ИмяКонфигурации())) + "</config_name>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</metadata>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Не ПроверитьHTTPОтвет(Ответ, "отправка метаинформации") Тогда
		Возврат;
	КонецЕсли;
	
	Сообщить("  ✓ Метаинформация отправлена успешно");
	
КонецПроцедуры

// Выгрузка констант через HTTP
&НаСервере
Процедура ВыгрузитьКонстантыЧерезHTTP()
	
	Сообщить("  → Начинаем выгрузку констант...");
	
	// Получаем все константы (метаданные)
	КоллекцияКонстант = Метаданные.Константы;
	ВсегоКонстант = КоллекцияКонстант.Количество();
	
	Если ВсегоКонстант = 0 Тогда
		Сообщить("  → Константы не найдены. Пропускаем этап.");
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Найдено констант: " + Строка(ВсегоКонстант));
	ТекущаяКонстанта = 0;
	
	Для Каждого КонстантаМетаданных Из КоллекцияКонстант Цикл
		ТекущаяКонстанта = ТекущаяКонстанта + 1;
		
		// Получаем значение константы
		ЗначениеКонстанты = Неопределено;
		Попытка
			ЗначениеКонстанты = Константы[КонстантаМетаданных.Имя].Получить();
		Исключение
			Попытка
				ЗначениеКонстанты = Константы[КонстантаМетаданных.Имя];
			Исключение
				ЗначениеКонстанты = Неопределено;
				Сообщить("      → Предупреждение: Не удалось получить значение константы '" + КонстантаМетаданных.Имя + "'");
			КонецПопытки;
		КонецПопытки;
		
		// Определяем тип значения
		ТипЗначения = "";
		Если ЗначениеКонстанты = Неопределено Тогда
			ТипЗначения = "Неопределено";
		Иначе
			ТипЗначенияОбъекта = ТипЗнч(ЗначениеКонстанты);
			СтрокаТипа = Строка(ТипЗначенияОбъекта);
			Если ТипЗначенияОбъекта = Тип("Строка") Тогда
				ТипЗначения = "Строка";
			ИначеЕсли ТипЗначенияОбъекта = Тип("Число") Тогда
				ТипЗначения = "Число";
			ИначеЕсли ТипЗначенияОбъекта = Тип("Булево") Тогда
				ТипЗначения = "Булево";
			ИначеЕсли ТипЗначенияОбъекта = Тип("Дата") Тогда
				ТипЗначения = "Дата";
			ИначеЕсли СтрНайти(СтрокаТипа, "Ссылка") > 0 Тогда
				ТипЗначения = "Ссылка";
			Иначе
				ТипЗначения = "Объект";
			КонецЕсли;
		КонецЕсли;
		
		// Получаем XML представление значения
		XMLЗначения = ПолучитьXMLПредставлениеЗначения(ЗначениеКонстанты, ТипЗначения);
		
		// Отправляем константу
		Попытка
			ОтправитьКонстанту(КонстантаМетаданных.Имя, КонстантаМетаданных.Синоним, ТипЗначения, XMLЗначения);
		Исключение
			Сообщить("      → ОШИБКА отправки константы '" + КонстантаМетаданных.Имя + "': " + ОписаниеОшибки());
		КонецПопытки;
		
	КонецЦикла;
	
	Сообщить("  ✓ Выгрузка констант завершена: отправлено " + Строка(ВсегоКонстант) + " констант");
	
КонецПроцедуры

// Отправка константы на сервер
&НаСервере
Процедура ОтправитьКонстанту(Имя, Синоним, Тип, XMLЗначение)
	
	Если Не ПроверитьГотовностьКОтправке() Тогда
		Возврат;
	КонецЕсли;
	
	URL = АдресСервера + "/constant";
	
	// Экранируем специальные символы в XML
	ИмяЭкранированное = ЭкранироватьXML(Имя);
	СинонимЭкранированный = ЭкранироватьXML(Синоним);
	ТипЭкранированный = ЭкранироватьXML(Тип);
	
	// Создаем XML для константы
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<constant>" +
		"<upload_uuid>" + ЭкранироватьXML(ИдентификаторВыгрузки) + "</upload_uuid>" +
		"<name>" + ИмяЭкранированное + "</name>" +
		"<synonym>" + СинонимЭкранированный + "</synonym>" +
		"<type>" + ТипЭкранированный + "</type>" +
		"<value>" + XMLЗначение + "</value>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</constant>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Не ПроверитьHTTPОтвет(Ответ, "отправка константы '" + Имя + "'") Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

// Получение XML представления значения константы
&НаСервере
Функция ПолучитьXMLПредставлениеЗначения(Значение, ТипЗначения)
	
	Если Значение = Неопределено Тогда
		Возврат "<undefined/>";
	КонецЕсли;
	
	ТипЗначенияОбъекта = ТипЗнч(Значение);
	СтрокаТипа = Строка(ТипЗначенияОбъекта);
	
	// Обработка строк
	Если ТипЗначенияОбъекта = Тип("Строка") Тогда
		Возврат "<string>" + ЭкранироватьXML(Значение) + "</string>";
	КонецЕсли;
	
	// Обработка чисел
	Если ТипЗначенияОбъекта = Тип("Число") Тогда
		Возврат "<number>" + ЭкранироватьXML(Строка(Значение)) + "</number>";
	КонецЕсли;
	
	// Обработка булевых значений
	Если ТипЗначенияОбъекта = Тип("Булево") Тогда
		Если Значение Тогда
			Возврат "<boolean>true</boolean>";
		Иначе
			Возврат "<boolean>false</boolean>";
		КонецЕсли;
	КонецЕсли;
	
	// Обработка дат
	Если ТипЗначенияОбъекта = Тип("Дата") Тогда
		СтрокаЗначения = Формат(Значение, "ДФ=yyyy-MM-ddTHH:mm:ss");
		Возврат "<date>" + ЭкранироватьXML(СтрокаЗначения) + "</date>";
	КонецЕсли;
	
	// Обработка уникальных идентификаторов
	Если ТипЗначенияОбъекта = Тип("УникальныйИдентификатор") Тогда
		Возврат "<uuid>" + ЭкранироватьXML(Строка(Значение)) + "</uuid>";
	КонецЕсли;
	
	// Обработка ссылочных типов
	Если СтрНайти(СтрокаТипа, "Ссылка") > 0 Тогда
		СтрокаЗначения = Формат(Значение, "ДЛФ=DT");
		Возврат "<reference>" + ЭкранироватьXML(СтрокаЗначения) + "</reference>";
	КонецЕсли;
	
	// Для неподдерживаемых типов - преобразование в строку с предупреждением
	// ВНИМАНИЕ: Эта функция не обрабатывает все типы данных, такие как ТаблицаЗначений, Структура, Массив, ХранилищеЗначения и другие.
	// Для сложных типов необходимо добавить соответствующую обработку.
	Сообщить("      → Предупреждение: Неподдерживаемый тип данных: " + СтрокаТипа);
	Возврат "<string>" + ЭкранироватьXML(Строка(Значение)) + "</string>";
	
КонецФункции

// Отправка метаданных справочника
&НаСервере
Процедура ОтправитьМетаСправочника(СправочникМетаданных)
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("  → ОШИБКА: Метаданные справочника не переданы");
		Возврат;
	КонецЕсли;
	
	Если Не ПроверитьГотовностьКОтправке() Тогда
		Возврат;
	КонецЕсли;
	
	URL = АдресСервера + "/catalog/meta";
	
	// Экранируем специальные символы
	ИмяСправочника = ЭкранироватьXML(СправочникМетаданных.Имя);
	СинонимСправочника = ЭкранироватьXML(СправочникМетаданных.Синоним);
	
	// Создаем XML для метаданных справочника
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<catalog_meta>" +
		"<upload_uuid>" + ЭкранироватьXML(ИдентификаторВыгрузки) + "</upload_uuid>" +
		"<name>" + ИмяСправочника + "</name>" +
		"<synonym>" + СинонимСправочника + "</synonym>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</catalog_meta>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Не ПроверитьHTTPОтвет(Ответ, "отправка метаданных справочника '" + СправочникМетаданных.Имя + "'") Тогда
		Возврат;
	КонецЕсли;
	
	Сообщить("      ✓ Метаданные справочника '" + СправочникМетаданных.Имя + "' отправлены успешно");
	
КонецПроцедуры

// Получение реквизитов элемента в XML формате
&НаСервере
Функция ПолучитьРеквизитыЭлементаXML(СсылкаЭлемента, ИмяСправочника)
	
	Если СсылкаЭлемента = Неопределено Тогда
		Сообщить("      → ОШИБКА: Ссылка элемента не передана");
		Возврат "";
	КонецЕсли;
	
	Если ПустаяСтрока(ИмяСправочника) Тогда
		Сообщить("      → ОШИБКА: Имя справочника не указано");
		Возврат "";
	КонецЕсли;
	
	// Получаем метаданные справочника через индексатор
	Попытка
		СправочникМетаданных = Метаданные.Справочники[ИмяСправочника];
	Исключение
		Сообщить("      → ОШИБКА: Не удалось получить метаданные справочника '" + ИмяСправочника + "': " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("      → ОШИБКА: Метаданные справочника '" + ИмяСправочника + "' не найдены");
		Возврат "";
	КонецЕсли;
	
	МассивСтрок = Новый Массив;
	
	// Обрабатываем реквизиты
	Для Каждого РеквизитМетаданных Из СправочникМетаданных.Реквизиты Цикл
		
		// Получаем значение реквизита
		ЗначениеРеквизита = Неопределено;
		Попытка
			ЗначениеРеквизита = СсылкаЭлемента[РеквизитМетаданных.Имя];
		Исключение
			// Если не удалось получить значение реквизита, пропускаем его
			Продолжить;
		КонецПопытки;
		
		// Преобразуем в строку
		СтрокаЗначения = "";
		Если ЗначениеРеквизита <> Неопределено Тогда
			СтрокаЗначения = Строка(ЗначениеРеквизита);
			// Экранируем специальные символы
			СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
		КонецЕсли;
		
		// Добавляем в массив для эффективной конкатенации
		МассивСтрок.Добавить("<" + РеквизитМетаданных.Имя + ">" + СтрокаЗначения + "</" + РеквизитМетаданных.Имя + ">");
		
	КонецЦикла;
	
	Возврат СтрСоединить(МассивСтрок, "");
	
КонецФункции

// Получение табличных частей элемента в XML формате
&НаСервере
Функция ПолучитьТабличныеЧастиЭлементаXML(СсылкаЭлемента, ИмяСправочника)
	
	Если СсылкаЭлемента = Неопределено Тогда
		Сообщить("      → ОШИБКА: Ссылка элемента не передана");
		Возврат "";
	КонецЕсли;
	
	Если ПустаяСтрока(ИмяСправочника) Тогда
		Сообщить("      → ОШИБКА: Имя справочника не указано");
		Возврат "";
	КонецЕсли;
	
	// Получаем метаданные справочника через индексатор
	Попытка
		СправочникМетаданных = Метаданные.Справочники[ИмяСправочника];
	Исключение
		Сообщить("      → ОШИБКА: Не удалось получить метаданные справочника '" + ИмяСправочника + "': " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("      → ОШИБКА: Метаданные справочника '" + ИмяСправочника + "' не найдены");
		Возврат "";
	КонецЕсли;
	
	МассивСтрок = Новый Массив;
	
	// Обрабатываем табличные части
	Для Каждого ТабличнаяЧастьМетаданных Из СправочникМетаданных.ТабличныеЧасти Цикл
		
		// Получаем табличную часть
		ТабличнаяЧасть = Неопределено;
		Попытка
			ТабличнаяЧасть = СсылкаЭлемента[ТабличнаяЧастьМетаданных.Имя];
		Исключение
			// Если не удалось получить табличную часть, пропускаем её
			Продолжить;
		КонецПопытки;
		
		Если ТабличнаяЧасть = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если ТабличнаяЧасть.Количество() = 0 Тогда
			// Пропускаем пустые табличные части
			Продолжить;
		КонецЕсли;
		
		МассивСтрокТабличнойЧасти = Новый Массив;
		
		// Обрабатываем строки табличной части
		Для Каждого СтрокаТабличнойЧасти Из ТабличнаяЧасть Цикл
			
			МассивСтрокСтроки = Новый Массив;
			МассивСтрокСтроки.Добавить("<row>");
			
			// Обрабатываем реквизиты (колонки) строки табличной части
			Для Каждого РеквизитТабличнойЧасти Из ТабличнаяЧастьМетаданных.Реквизиты Цикл
				
				ЗначениеКолонки = Неопределено;
				Попытка
					ЗначениеКолонки = СтрокаТабличнойЧасти[РеквизитТабличнойЧасти.Имя];
				Исключение
					// Если не удалось получить значение, пропускаем
					Продолжить;
				КонецПопытки;
				
				СтрокаЗначенияКолонки = "";
				Если ЗначениеКолонки <> Неопределено Тогда
					СтрокаЗначенияКолонки = Строка(ЗначениеКолонки);
					// Экранируем специальные символы
					СтрокаЗначенияКолонки = ЭкранироватьXML(СтрокаЗначенияКолонки);
				КонецЕсли;
				
				МассивСтрокСтроки.Добавить("<" + РеквизитТабличнойЧасти.Имя + ">" + СтрокаЗначенияКолонки + "</" + РеквизитТабличнойЧасти.Имя + ">");
				
			КонецЦикла;
			
			МассивСтрокСтроки.Добавить("</row>");
			МассивСтрокТабличнойЧасти.Добавить(СтрСоединить(МассивСтрокСтроки, ""));
			
		КонецЦикла;
		
		МассивСтрок.Добавить("<" + ТабличнаяЧастьМетаданных.Имя + ">" + СтрСоединить(МассивСтрокТабличнойЧасти, "") + "</" + ТабличнаяЧастьМетаданных.Имя + ">");
		
	КонецЦикла;
	
	Возврат СтрСоединить(МассивСтрок, "");
	
КонецФункции

// Отправка элемента справочника на сервер
&НаСервере
Процедура ОтправитьЭлементСправочника(ИмяСправочника, Ссылка, Код, Наименование, РеквизитыXML, ТабличныеЧастиXML)
	
	Если ПустаяСтрока(ИмяСправочника) Тогда
		Сообщить("ОШИБКА: Имя справочника не указано");
		Возврат;
	КонецЕсли;
	
	Если Не ПроверитьГотовностьКОтправке() Тогда
		Возврат;
	КонецЕсли;
	
	URL = АдресСервера + "/catalog/item";
	
	// Экранируем специальные символы
	ИмяСправочникаЭкранированное = ЭкранироватьXML(ИмяСправочника);
	СсылкаЭкранированная = ЭкранироватьXML(Ссылка);
	КодЭкранированный = ЭкранироватьXML(Код);
	НаименованиеЭкранированное = ЭкранироватьXML(Наименование);
	
	// Создаем XML для элемента справочника
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<catalog_item>" +
		"<upload_uuid>" + ЭкранироватьXML(ИдентификаторВыгрузки) + "</upload_uuid>" +
		"<catalog_name>" + ИмяСправочникаЭкранированное + "</catalog_name>" +
		"<reference>" + СсылкаЭкранированная + "</reference>" +
		"<code>" + КодЭкранированный + "</code>" +
		"<name>" + НаименованиеЭкранированное + "</name>" +
		"<attributes>" + РеквизитыXML + "</attributes>" +
		"<table_parts>" + ТабличныеЧастиXML + "</table_parts>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</catalog_item>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Не ПроверитьHTTPОтвет(Ответ, "отправка элемента справочника '" + Наименование + "'") Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

// Завершение выгрузки
&НаСервере
Процедура ЗавершитьВыгрузку()
	
	Если Не ПроверитьГотовностьКОтправке() Тогда
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Отправка запроса на завершение выгрузки...");
	URL = АдресСервера + "/complete";
	
	// Создаем XML для завершения выгрузки
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<complete>" +
		"<upload_uuid>" + ЭкранироватьXML(ИдентификаторВыгрузки) + "</upload_uuid>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</complete>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Не ПроверитьHTTPОтвет(Ответ, "завершение выгрузки") Тогда
		Возврат;
	КонецЕсли;
	
	Сообщить("  ✓ Выгрузка завершена успешно на сервере");
	
КонецПроцедуры

#КонецОбласти

