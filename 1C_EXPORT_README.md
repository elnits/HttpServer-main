# Расширение обработки выгрузки данных из 1С

## Описание

Этот набор файлов содержит расширения для обработки выгрузки данных из 1С в сервис нормализации и анализа. Реализованы следующие функции:

1. **Пакетная выгрузка справочников** - оптимизация для работы через интернет
2. **Выгрузка контрагентов** - всегда и полностью, с поддержкой пакетной отправки
3. **Выгрузка номенклатуры с характеристиками** - через HTTP и в JSON файл
4. **Настройки выгрузки** - адрес сервера, размер пакета, включение/выключение пакетной выгрузки

## Структура файлов

### Серверная часть

- `server/models.go` - добавлены модели `CatalogItem`, `CatalogItemsRequest`, `CatalogItemsResponse` для пакетной выгрузки
- `server/server.go` - добавлен обработчик `handleCatalogItems` и зарегистрирован эндпоинт `/catalog/items`

### Файлы для 1С

1. **`1c_form_instructions.md`** - подробная инструкция по настройке формы обработки
   - Описание всех реквизитов формы
   - Описание всех элементов формы (группы, поля, кнопки)
   - Привязки команд к процедурам
   - Рекомендации по размещению элементов

2. **`1c_module_extensions.bsl`** - новые процедуры и функции для модуля обработки
   - Процедуры пакетной выгрузки
   - Процедуры выгрузки контрагентов
   - Процедуры выгрузки номенклатуры с характеристиками
   - Процедуры выгрузки в JSON файл
   - Клиентские процедуры для работы с формой

3. **`1c_integration_guide.md`** - инструкция по интеграции новых функций в существующий модуль
   - Пошаговые инструкции
   - Примеры модификации существующих процедур
   - Проверка корректности интеграции

## Быстрый старт

### 1. Серверная часть

Серверная часть уже обновлена. Убедитесь, что сервер перезапущен после изменений.

### 2. Настройка формы обработки 1С

1. Откройте обработку в конфигураторе 1С
2. Следуйте инструкциям из файла `1c_form_instructions.md`
3. Добавьте реквизиты формы:
   - `АдресСервера` (Строка)
   - `ИспользоватьПакетнуюВыгрузку` (Булево)
   - `РазмерПакета` (Число)
   - `ПутьКФайлу` (Строка)
4. Создайте элементы формы согласно инструкции

### 3. Интеграция кода модуля

1. Откройте модуль обработки
2. Добавьте новые переменные в область `СлужебныеПеременные`:
   ```bsl
   Перем ИспользоватьПакетнуюВыгрузку;
   Перем РазмерПакета;
   ```
3. Скопируйте все процедуры из `1c_module_extensions.bsl` в модуль
4. Модифицируйте существующие процедуры согласно `1c_integration_guide.md`

## Использование

### Выгрузка всего

Нажмите кнопку "ВыгрузкаВсего" - выполнится полная выгрузка всех констант и справочников с использованием пакетной выгрузки (если включена).

### Выгрузка контрагентов

Нажмите кнопку "ВыгрузкаКонтрагентов" - выполнится выгрузка только справочника "Контрагенты" с использованием пакетной выгрузки.

### Выгрузка номенклатуры

Нажмите кнопку "ВыгрузкаНоменклатуры" - выполнится выгрузка номенклатуры с характеристиками через HTTP.

### Выгрузка в JSON файл

1. Нажмите кнопку "ВыбратьКаталог" для выбора каталога сохранения
2. Нажмите кнопку "ВыгрузитьНоменклатуруВJSON" для выгрузки в файл

## Настройки

### Адрес сервера

По умолчанию: `http://localhost:9999`

Можно изменить в поле формы "АдресСервера".

### Пакетная выгрузка

- **Включение/выключение**: флажок "ИспользоватьПакетнуюВыгрузку"
- **Размер пакета**: поле "РазмерПакета" (рекомендуется: 50-100 элементов)

При включенной пакетной выгрузке элементы справочников собираются в пакеты и отправляются одним HTTP-запросом, что значительно ускоряет выгрузку через интернет.

## API сервера

### Новый эндпоинт: `/catalog/items`

Принимает пакет элементов справочника в формате XML:

```xml
<catalog_items>
  <upload_uuid>...</upload_uuid>
  <catalog_name>...</catalog_name>
  <items>
    <item>
      <reference>...</reference>
      <code>...</code>
      <name>...</name>
      <attributes>...</attributes>
      <table_parts>...</table_parts>
      <timestamp>...</timestamp>
    </item>
    ...
  </items>
</catalog_items>
```

Ответ:

```xml
<catalog_items_response>
  <success>true</success>
  <processed_count>50</processed_count>
  <failed_count>0</failed_count>
  <message>Processed 50 items, 0 failed</message>
  <timestamp>...</timestamp>
</catalog_items_response>
```

## Примечания

- Пакетная выгрузка работает только для справочников
- Константы выгружаются по одной (как и раньше)
- При отключенной пакетной выгрузке элементы отправляются по одному (как в оригинальной версии)
- Выгрузка контрагентов всегда выполняется полностью, без ограничений
- Выгрузка номенклатуры с характеристиками использует данные из регистра "ТоварыНаСкладах"

## Поддержка

При возникновении проблем:

1. Проверьте логи сервера
2. Проверьте сообщения в окне сообщений 1С
3. Убедитесь, что все процедуры правильно интегрированы
4. Проверьте настройки формы обработки

