# Инструкция по нормализации и классификации номенклатуры

## Быстрый старт

### 1. Нормализация с КПВЭД классификацией

```powershell
# Использование готового скрипта
.\normalize_with_kpved.ps1 1c_data.db
```

Или напрямую:

```powershell
# Установить API ключ
$env:ARLIAI_API_KEY = "597dbe7e-16ca-4803-ab17-5fa084909f37"
$env:ARLIAI_MODEL = "GLM-4.5-Air"

# Запустить нормализацию
.\normalize.exe -db 1c_data.db -ai
```

### 2. Нормализация без AI (только базовая)

```powershell
.\normalize.exe -db 1c_data.db
```

## Что делает процесс

1. **Очистка старых данных** - удаляет записи из `catalog_items`
2. **Загрузка данных** - получает все элементы из таблицы `catalog_items`
3. **Группировка** - группирует элементы по `(category, normalized_name)`
4. **КПВЭД классификация** - для каждой новой группы выполняется иерархическая классификация:
   - Уровень 1: Секции (A-U)
   - Уровень 2: Подклассы
   - Уровень 3: Группы
   - Уровень 4: Элементы
5. **Сохранение** - все данные сохраняются в таблицу `normalized_data`

## Результаты

После завершения проверьте результаты:

```sql
-- Общее количество нормализованных записей
SELECT COUNT(*) FROM normalized_data;

-- Количество классифицированных по КПВЭД
SELECT COUNT(*) FROM normalized_data 
WHERE kpved_code IS NOT NULL AND kpved_code != '';

-- Статистика по уровням КПВЭД
SELECT 
    SUBSTR(kpved_code, 1, 1) as section,
    COUNT(*) as count
FROM normalized_data
WHERE kpved_code IS NOT NULL AND kpved_code != ''
GROUP BY section
ORDER BY section;
```

## Важные замечания

1. **КПВЭД классификация требует AI** - нужен установленный `ARLIAI_API_KEY`
2. **Производительность** - процесс может занять время в зависимости от количества элементов
3. **Дубликаты кодов** - используется `INSERT OR REPLACE` для обработки дубликатов
4. **Группировка** - элементы с одинаковым `normalizedName` и `category` попадают в одну группу
5. **КПВЭД коды** - все элементы одной группы получают одинаковый КПВЭД код

## Устранение проблем

### API недоступен
Если API возвращает ошибку 500, подождите несколько минут и повторите попытку.

### Дубликаты кодов
Если возникают ошибки UNIQUE constraint, проверьте, что используется `INSERT OR REPLACE`.

### Медленная работа
- Увеличьте `RateLimitDelay` в конфигурации AI
- Обрабатывайте данные пакетами
- Используйте кэширование

