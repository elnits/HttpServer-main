# Инструкция по использованию обработки выгрузки данных из 1С

## Описание полей формы

### Обязательные поля

1. **АдресСервера** (строка)
   - Адрес HTTP сервера для выгрузки данных
   - Формат: `http://localhost:9999` или `http://192.168.1.100:9999`
   - По умолчанию: `http://localhost:9999`
   - **Обязательно заполнить перед выгрузкой!**

2. **ТипВыгрузки** (строка) - **НОВОЕ ПОЛЕ**
   - Тип выгружаемых данных для формирования имени БД
   - Возможные значения:
     - `Номенклатура` - выгрузка только номенклатуры
     - `Контрагенты` - выгрузка только контрагентов
     - `ПолнаяВыгрузка` - выгрузка всех данных (константы, контрагенты, номенклатура)
   - По умолчанию: `ПолнаяВыгрузка`
   - **Важно:** Это поле определяет имя создаваемой БД на сервере

### Поля для идентификации базы данных (выберите один из вариантов)

#### Вариант 1: Прямая идентификация через database_id

3. **ИдентификаторБазыДанных** (строка)
   - ID существующей базы данных на сервере
   - Если указан, данные будут выгружены в эту БД
   - Если не указан, сервер создаст новую БД автоматически

#### Вариант 2: Идентификация через клиента и проект

4. **ClientID** (строка)
   - ID клиента в системе управления сервера
   - Используется вместе с ProjectID для автоматического поиска или создания БД

5. **ProjectID** (строка)
   - ID проекта в системе управления сервера
   - Используется вместе с ClientID для автоматического поиска или создания БД

**Примечание:** Если указаны ClientID и ProjectID, но не указан ИдентификаторБазыДанных, сервер автоматически найдет или создаст БД для этого проекта.

### Настройки выгрузки

6. **ИспользоватьПакетнуюВыгрузку** (булево)
   - Использовать ли пакетную отправку данных
   - `Истина` - данные отправляются пакетами (рекомендуется)
   - `Ложь` - данные отправляются по одному элементу
   - По умолчанию: `Истина`

7. **РазмерПакета** (число)
   - Количество элементов в одном пакете
   - Рекомендуемое значение: 50-100
   - По умолчанию: 50
   - **Важно:** Большие пакеты могут привести к таймауту

### Дополнительные поля (опционально)

8. **НомерИтерации** (число)
   - Номер итерации выгрузки (для версионирования)
   - По умолчанию: 1

9. **МеткаИтерации** (строка)
   - Текстовая метка итерации (например, "Версия 1.0", "Тестовая выгрузка")
   - По умолчанию: пусто

10. **Программист** (строка)
    - Имя программиста, выполняющего выгрузку
    - По умолчанию: пусто

11. **ЦельВыгрузки** (строка)
    - Описание цели выгрузки (например, "Миграция данных", "Резервное копирование")
    - По умолчанию: пусто

12. **ParentUploadID** (строка)
    - UUID родительской выгрузки (для связи выгрузок)
    - По умолчанию: пусто

## Как выполнить выгрузку

### Шаг 1: Настройка полей

1. Откройте обработку в 1С
2. Заполните обязательные поля:
   - **АдресСервера** - адрес вашего сервера
   - **ТипВыгрузки** - выберите тип выгрузки:
     - `Номенклатура` - для выгрузки только номенклатуры
     - `Контрагенты` - для выгрузки только контрагентов
     - `ПолнаяВыгрузка` - для выгрузки всех данных

3. (Опционально) Заполните поля для идентификации БД:
   - Либо укажите **ИдентификаторБазыДанных**
   - Либо укажите **ClientID** и **ProjectID**

4. Проверьте настройки выгрузки:
   - **ИспользоватьПакетнуюВыгрузку** = `Истина` (рекомендуется)
   - **РазмерПакета** = 50 (или другое значение)

### Шаг 2: Проверка соединения

1. Нажмите кнопку **"Проверить соединение"** (если есть)
2. Убедитесь, что сервер доступен
3. В сообщениях должно появиться: `✓ Соединение с сервером установлено`

### Шаг 3: Выполнение выгрузки

Выберите нужную кнопку в зависимости от типа выгрузки:

#### Выгрузка всех данных (полная выгрузка)
- Нажмите кнопку **"Выгрузка всего"** или **"ВыполнитьВыгрузкуВсегоНаСервере"**
- Будет выполнена выгрузка:
  1. Констант
  2. Контрагентов
  3. Номенклатуры с характеристиками

#### Выгрузка только контрагентов
- Нажмите кнопку **"Выгрузка контрагентов"** или **"ВыполнитьВыгрузкуКонтрагентовНаСервере"**
- Будет выполнена выгрузка только справочника контрагентов

#### Выгрузка только номенклатуры
- Нажмите кнопку **"Выгрузка номенклатуры"** или **"ВыполнитьВыгрузкуНоменклатурыНаСервере"**
- Будет выполнена выгрузка только номенклатуры с характеристиками

#### Универсальная выгрузка номенклатуры
- Нажмите кнопку **"Выгрузить номенклатуру универсально"** или **"ВыполнитьВыгрузкуНоменклатурыУниверсальноНаСервере"**
- Будет выполнена выгрузка номенклатуры с использованием универсального запроса

### Шаг 4: Мониторинг процесса

Во время выгрузки в окне сообщений будут отображаться:
- Этапы выполнения выгрузки
- Количество отправленных элементов
- Ошибки (если есть)

### Шаг 5: Завершение

После завершения выгрузки:
- В сообщениях появится: `✓ Выгрузка завершена успешно!`
- На сервере будет создана новая БД с именем вида:
  `Выгрузка_<ТипВыгрузки>_<Конфигурация>_<Компьютер>_<Пользователь>_<ДатаВремя>.db`
- БД будет автоматически зарегистрирована в `service.db` (если указаны ClientID/ProjectID)

## Примеры использования

### Пример 1: Простая выгрузка номенклатуры

```
АдресСервера: http://localhost:9999
ТипВыгрузки: Номенклатура
ИспользоватьПакетнуюВыгрузку: Истина
РазмерПакета: 50
```

Нажать кнопку: **"Выгрузка номенклатуры"**

### Пример 2: Полная выгрузка с привязкой к проекту

```
АдресСервера: http://192.168.1.100:9999
ТипВыгрузки: ПолнаяВыгрузка
ClientID: 1
ProjectID: 5
ИспользоватьПакетнуюВыгрузку: Истина
РазмерПакета: 100
```

Нажать кнопку: **"Выгрузка всего"**

### Пример 3: Выгрузка контрагентов в существующую БД

```
АдресСервера: http://localhost:9999
ТипВыгрузки: Контрагенты
ИдентификаторБазыДанных: 42
ИспользоватьПакетнуюВыгрузку: Истина
РазмерПакета: 50
```

Нажать кнопку: **"Выгрузка контрагентов"**

## Решение проблем

### Проблема: "ОШИБКА: Рукопожатие с сервером не выполнено!"

**Причины:**
1. Сервер не запущен
2. Неверный адрес сервера
3. Проблемы с сетью

**Решение:**
1. Проверьте, что сервер запущен
2. Проверьте адрес сервера (попробуйте открыть в браузере: `http://localhost:9999/api/v1/health`)
3. Проверьте настройки firewall

### Проблема: "ОШИБКА: UUID не найден в ответе сервера"

**Причины:**
1. Сервер вернул неожиданный формат ответа
2. Проблемы с парсингом XML

**Решение:**
1. Проверьте логи сервера
2. Убедитесь, что используется правильная версия сервера

### Проблема: Выгрузка не начинается при нажатии кнопки

**Причины:**
1. Не заполнено поле `АдресСервера`
2. Не заполнено поле `ТипВыгрузки` (если добавлено)
3. Ошибка в коде обработки

**Решение:**
1. Убедитесь, что все обязательные поля заполнены
2. Проверьте сообщения об ошибках в окне сообщений 1С
3. Убедитесь, что используется обновленная версия обработки с поддержкой `upload_type`

### Проблема: Данные не отправляются

**Причины:**
1. Не выполнен handshake (рукопожатие)
2. Неверный `upload_uuid`
3. Проблемы с сетью во время отправки

**Решение:**
1. Проверьте, что рукопожатие выполнено успешно (должен быть получен UUID)
2. Проверьте логи сервера
3. Уменьшите размер пакета, если проблема в таймауте

## Важные замечания

1. **Новая БД создается автоматически** - при каждой новой выгрузке сервер создает отдельную БД с уникальным именем
2. **Текущая БД не меняется** - после выгрузки активная БД на сервере остается прежней
3. **Переключение БД** - для работы с новой БД используйте UI сервера для переключения
4. **Тип выгрузки важен** - он определяет имя создаваемой БД и помогает организовать данные

## Технические детали

- Протокол: HTTP/XML
- Кодировка: UTF-8
- Формат данных: XML
- Пакетная отправка: поддерживается для справочников и номенклатуры
- Таймаут соединения: 30 секунд




