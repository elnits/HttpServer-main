# Руководство по переклассификации данных с использованием КПВЭД

## Обзор

После обновления процесса нормализации категории теперь берутся из классификатора КПВЭД через AI, а не из простого `Categorizer` с ключевыми словами. Это означает, что существующие данные в таблице `normalized_data` имеют категории типа "другое", "стройматериалы" и т.д., которые нужно переклассифицировать.

## Предварительные требования

1. **База данных**: `1c_data.db` с нормализованными данными
2. **Классификатор КПВЭД**: Должен быть загружен в базу (ID: 1)
3. **API ключ**: `ARLIAI_API_KEY` должен быть установлен

## Проверка наличия классификатора

```bash
go run cmd/check_classifiers/main.go 1c_data.db
```

Должен показать классификатор КПВЭД с ID: 1.

## Запуск переклассификации

### Полная переклассификация (все 15973 записи)

```bash
$env:ARLIAI_API_KEY = "597dbe7e-16ca-4803-ab17-5fa084909f37"
go run cmd/reclassify_with_kpved/main.go 1c_data.db 1 top_priority
```

**Время выполнения**: Несколько часов (зависит от скорости API)

### Тестовая переклассификация (100 записей)

```bash
$env:ARLIAI_API_KEY = "597dbe7e-16ca-4803-ab17-5fa084909f37"
go run cmd/reclassify_with_kpved/main.go 1c_data.db 1 top_priority 100
```

**Время выполнения**: ~5-10 минут

## Параметры скрипта

```
reclassify_with_kpved <путь_к_базе.db> <classifier_id> [strategy_id] [limit]
```

- `путь_к_базе.db` - путь к базе данных (обязательно)
- `classifier_id` - ID классификатора в базе (обычно 1 для КПВЭД)
- `strategy_id` - стратегия свертки категорий (по умолчанию: `top_priority`)
- `limit` - лимит записей для обработки (0 = без лимита)

## Стратегии свертки

- `top_priority` - сохраняет верхние уровни, объединяет нижние (рекомендуется)
- `bottom_priority` - сохраняет нижние уровни, объединяет верхние
- `mixed_priority` - смешанная стратегия

## Что делает скрипт

1. **Загружает классификатор** из базы данных
2. **Парсит дерево категорий** КПВЭД
3. **Для каждой записи** в `normalized_data`:
   - Классифицирует товар с помощью AI и КПВЭД
   - Сворачивает категорию до 2 уровней
   - Обновляет поле `category` в `normalized_data`
   - Сохраняет код КПВЭД и уверенность

## Результат

После выполнения скрипта:
- Поле `category` в `normalized_data` будет содержать категории из КПВЭД
- Поле `kpved_code` будет содержать код КПВЭД
- Поле `kpved_name` будет содержать название из КПВЭД
- Поле `kpved_confidence` будет содержать уверенность классификации

## Проверка результатов

### Просмотр статистики

```bash
go run cmd/show_detailed_normalization/main.go 1c_data.db
```

### Просмотр примеров

```bash
go run cmd/show_normalized_results/main.go 1c_data.db 20
```

### Экспорт отчета

```bash
go run cmd/export_normalization_report/main.go 1c_data.db normalization_report.html
```

## Примеры категорий до и после

### До переклассификации:
- `другое` (12322 записи)
- `стройматериалы` (1221 записей)
- `сантехника` (469 записей)

### После переклассификации:
- `C / ПРОДУКЦИЯ ОБРАБАТЫВАЮЩЕЙ ПРОМЫШЛЕННОСТИ` (для строительных материалов)
- `C / ПРОДУКЦИЯ ОБРАБАТЫВАЮЩЕЙ ПРОМЫШЛЕННОСТИ / Инструменты` (для инструментов)
- `F / СТРОИТЕЛЬСТВО` (для строительных услуг)

## Рекомендации

1. **Начните с тестовой переклассификации** (100 записей) для проверки
2. **Запускайте полную переклассификацию в фоновом режиме** или на сервере
3. **Мониторьте прогресс** - скрипт выводит статистику каждые 10 записей
4. **Сохраните резервную копию** базы данных перед полной переклассификацией

## Устранение проблем

### Ошибка: "ARLIAI_API_KEY не установлен"
```bash
$env:ARLIAI_API_KEY = "ваш_ключ"
```

### Ошибка: "Классификатор с ID X не найден"
Проверьте наличие классификатора:
```bash
go run cmd/check_classifiers/main.go 1c_data.db
```

### Таймауты API
Скрипт автоматически обрабатывает ошибки и продолжает работу. При большом количестве таймаутов:
- Увеличьте задержку между запросами (измените `time.Sleep` в коде)
- Используйте лимит для обработки порциями

## Производительность

- **Скорость**: ~1-2 записи/сек (зависит от API)
- **Время для 15973 записей**: ~2-4 часа
- **Рекомендуется**: Запускать в фоновом режиме или порциями по 1000 записей

