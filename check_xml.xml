<?xml version="1.0" encoding="UTF-8"?>
<Configuration xmlns="http://v8.1c.ru/8.1/data/enterprise/current-config" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="Configuration">
  <MetaDataObject xmlns="http://v8.1c.ru/8.1/data/enterprise" xsi:type="DataProcessor">
    <uuid>516DEC71BD0B4D2387A7F16298A4A42C</uuid>
    <name>ВыгрузкаДанныхВСервис</name>
    <synonym>
      <key>ru</key>
      <value>Выгрузка данных в сервис нормализации</value>
    </synonym>
    <comment>Обработка для выгрузки данных из 1С в сервис нормализации и анализа через HTTP</comment>
    <module>
      <text><![CDATA[#Область СлужебныеПеременные

Перем АдресСервера;

Перем ИдентификаторВыгрузки;

// Добавляем новые переменные для пакетной выгрузки
Перем ИспользоватьПакетнуюВыгрузку;
Перем РазмерПакета;

// Переменная для хранения идентификатора базы данных
Перем ИдентификаторБазыДанных;

// Переменные для отслеживания прогресса выгрузки (на клиенте)
Перем ОбщееКоличествоОбъектов;
Перем ТекущаяПозиция;
Перем ВыполняетсяВыгрузка;
Перем ТребуетсяПрервать;
Перем ТекущийЭтап;
Перем ТекущийОбъект;

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Вспомогательная функция для экранирования специальных символов в XML
Функция ЭкранироватьXML(Строка)
	
	Результат = Строка;
	Результат = СтрЗаменить(Результат, "&", "&amp;");
	Результат = СтрЗаменить(Результат, "<", "&lt;");
	Результат = СтрЗаменить(Результат, ">", "&gt;");
	Результат = СтрЗаменить(Результат, """", "&quot;");
	Результат = СтрЗаменить(Результат, "'", "&apos;");
	
	Возврат Результат;
	
КонецФункции

// Получение версии 1С
Функция Версия1С()
	
	Попытка
		// Используем СистемнаяИнформация для получения версии платформы
		СистемнаяИнформация = Новый СистемнаяИнформация;
		Возврат Строка(СистемнаяИнформация.ВерсияПриложения);
	Исключение
		// Если не удалось получить версию, возвращаем базовую
		Возврат "8.3";
	КонецПопытки;
	
КонецФункции

// Получение имени конфигурации
Функция ИмяКонфигурации()
	
	Попытка
		// Правильный способ получения имени конфигурации
		Возврат Строка(Метаданные.Имя);
	Исключение
		// Если не удалось получить имя, возвращаем пустую строку
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Получение подстроки из середины строки
Функция Средняя(Строка, НачальнаяПозиция, Длина)
	
	Возврат Сред(Строка, НачальнаяПозиция, Длина);
	
КонецФункции

// Получение версии конфигурации
Функция ПолучитьВерсиюКонфигурации()
	
	Попытка
		Возврат Строка(Метаданные.Версия);
	Исключение
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Извлечение значения из XML по тегу
Функция ИзвлечьЗначениеИзXML(XMLСтрока, ИмяТега)
	
	ПозицияНачала = СтрНайти(XMLСтрока, "<" + ИмяТега + ">");
	ПозицияКонца = СтрНайти(XMLСтрока, "</" + ИмяТега + ">");
	
	Если ПозицияНачала > 0 И ПозицияКонца > 0 Тогда
		Возврат Средняя(XMLСтрока, ПозицияНачала + СтрДлина("<" + ИмяТега + ">"), ПозицияКонца - ПозицияНачала - СтрДлина("<" + ИмяТега + ">"));
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

// Получение тела ответа HTTP (универсальное)
Функция ПолучитьТелоОтвета(Ответ)
	
	Попытка
		Возврат Ответ.ПолучитьТелоКакСтроку();
	Исключение
		Попытка
			Возврат Ответ.ТелоОтвета;
		Исключение
			Возврат "Не удалось получить тело ответа";
		КонецПопытки;
	КонецПопытки;
	
КонецФункции

// Получение XML представления значения константы
Функция ПолучитьXMLПредставлениеЗначения(Значение, ТипЗначения)
	
	Если Значение = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	ТипЗначенияОбъекта = ТипЗнч(Значение);
	СтрокаТипа = Строка(ТипЗначенияОбъекта);
	
	// Для ссылок используем полное представление в XML формате
	Если СтрНайти(СтрокаТипа, "Ссылка") > 0 Тогда
		СтрокаЗначения = Формат(Значение, "ДЛФ=DT");
		Возврат "<reference>" + ЭкранироватьXML(СтрокаЗначения) + "</reference>";
	КонецЕсли;
	
	// Для таблиц значений - сериализация в XML
	Если ТипЗначенияОбъекта = Тип("ТаблицаЗначений") Тогда
		Возврат СериализоватьТаблицуЗначенийВXML(Значение);
	КонецЕсли;
	
	// Для структур - сериализация в XML
	Если ТипЗначенияОбъекта = Тип("Структура") Тогда
		Возврат СериализоватьСтруктуруВXML(Значение);
	КонецЕсли;
	
	// Для массивов - сериализация в XML
	Если ТипЗначенияОбъекта = Тип("Массив") Тогда
		Возврат СериализоватьМассивВXML(Значение);
	КонецЕсли;
	
	// Для дат используем правильный формат в XML
	Если ТипЗначенияОбъекта = Тип("Дата") Тогда
		СтрокаЗначения = Формат(Значение, "ДФ=yyyy-MM-ddTHH:mm:ss");
		Возврат "<date>" + ЭкранироватьXML(СтрокаЗначения) + "</date>";
	КонецЕсли;
	
	// Для чисел - в XML теге
	Если ТипЗначенияОбъекта = Тип("Число") Тогда
		СтрокаЗначения = Строка(Значение);
		Возврат "<number>" + ЭкранироватьXML(СтрокаЗначения) + "</number>";
	КонецЕсли;
	
	// Для булевых - в XML теге
	Если ТипЗначенияОбъекта = Тип("Булево") Тогда
		СтрокаЗначения = Строка(Значение);
		Возврат "<boolean>" + ЭкранироватьXML(СтрокаЗначения) + "</boolean>";
	КонецЕсли;
	
	// Для строк - в XML теге
	Если ТипЗначенияОбъекта = Тип("Строка") Тогда
		Возврат "<string>" + ЭкранироватьXML(Значение) + "</string>";
	КонецЕсли;
	
	// Для остальных типов - стандартное преобразование в XML теге
	СтрокаЗначения = Строка(Значение);
	Возврат "<value>" + ЭкранироватьXML(СтрокаЗначения) + "</value>";
	
КонецФункции

// Сериализация таблицы значений в XML
Функция СериализоватьТаблицуЗначенийВXML(ТаблицаЗначений)
	
	XMLСтрока = "<table>";
	
	Для Каждого СтрокаТаблицы Из ТаблицаЗначений Цикл
		
		XMLСтрока = XMLСтрока + "<row>";
		
		Для Каждого Колонка Из ТаблицаЗначений.Колонки Цикл
			
			ЗначениеКолонки = СтрокаТаблицы[Колонка.Имя];
			СтрокаЗначения = "";
			
			Если ЗначениеКолонки <> Неопределено Тогда
				СтрокаЗначения = Строка(ЗначениеКолонки);
				СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
			КонецЕсли;
			
			XMLСтрока = XMLСтрока + "<" + Колонка.Имя + ">" + СтрокаЗначения + "</" + Колонка.Имя + ">";
			
		КонецЦикла;
		
		XMLСтрока = XMLСтрока + "</row>";
		
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</table>";
	
	Возврат XMLСтрока;
	
КонецФункции

// Сериализация структуры в XML
Функция СериализоватьСтруктуруВXML(Структура)
	
	XMLСтрока = "<structure>";
	
	Для Каждого КлючЗначение Из Структура Цикл
		
		Значение = КлючЗначение.Значение;
		СтрокаЗначения = "";
		
		Если Значение <> Неопределено Тогда
			СтрокаЗначения = Строка(Значение);
			СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
		КонецЕсли;
		
		XMLСтрока = XMLСтрока + "<" + КлючЗначение.Ключ + ">" + СтрокаЗначения + "</" + КлючЗначение.Ключ + ">";
		
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</structure>";
	
	Возврат XMLСтрока;
	
КонецФункции

// Сериализация массива в XML
Функция СериализоватьМассивВXML(Массив)
	
	XMLСтрока = "<array>";
	
	Для Индекс = 0 По Массив.ВГраница() Цикл
		
		Значение = Массив[Индекс];
		СтрокаЗначения = "";
		
		Если Значение <> Неопределено Тогда
			СтрокаЗначения = Строка(Значение);
			СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
		КонецЕсли;
		
		XMLСтрока = XMLСтрока + "<item>" + СтрокаЗначения + "</item>";
		
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</array>";
	
	Возврат XMLСтрока;
	
КонецФункции

#КонецОбласти



#Область ПрограммныйИнтерфейс

// Процедура на клиенте для привязки к кнопке "ВыгрузкаВсего"
&НаКлиенте
Процедура ВыгрузкаВсего(Команда)
	
	// Инициализация переменных прогресса
	ОбщееКоличествоОбъектов = 0;
	ТекущаяПозиция = 0;
	ВыполняетсяВыгрузка = Истина;
	ТребуетсяПрервать = Ложь;
	ТекущийЭтап = "Инициализация";
	ТекущийОбъект = "";
	
	// Блокируем кнопку "Выполнить", разблокируем кнопку "Прервать"
	Попытка
		ЭлементыФормы.КнопкаВыгрузкаВсего.Доступность = Ложь;
		ЭлементыФормы.КнопкаПрервать.Доступность = Истина;
	Исключение
		// Элементы формы могут отсутствовать
	КонецПопытки;
	
	// Получаем общее количество объектов
	ОбщееКоличествоОбъектов = ПолучитьОбщееКоличествоОбъектовНаСервере("Все");
	
	Если ОбщееКоличествоОбъектов = 0 Тогда
		Сообщить("Нет данных для выгрузки");
		ВыполняетсяВыгрузка = Ложь;
		Попытка
			ЭлементыФормы.КнопкаВыгрузкаВсего.Доступность = Истина;
			ЭлементыФормы.КнопкаПрервать.Доступность = Ложь;
		Исключение
		КонецПопытки;
		Возврат;
	КонецЕсли;
	
	// Запускаем таймер обновления прогресса
	Попытка
		ЭлементыФормы.ТаймерОбновления.Enabled = Истина;
	Исключение
		// Элемент формы может отсутствовать
	КонецПопытки;
	
	// Инициализируем прогресс
	ОбновитьПрогрессНаФорме();
	
	// Выполняем рукопожатие и отправку метаинформации синхронно (быстрые операции)
	ТекущийЭтап = "Рукопожатие";
	Объект.ТекущийЭтап = ТекущийЭтап;
	ОбновитьПрогрессНаФорме();
	
	ИдентификаторВыгрузки = ВыполнитьРукопожатиеИМетаинформациюНаСервере();
	
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		ЗавершитьВыгрузкуСОшибкой();
		Возврат;
	КонецЕсли;
	
	// Запускаем первый пакет выгрузки асинхронно
	ТекущийЭтап = "Константы";
	Объект.ТекущийЭтап = ТекущийЭтап;
	ТекущаяПозиция = 0;
	
	// Получаем размер пакета из формы
	Попытка
		РазмерПакета = Объект.РазмерПакета;
		Если РазмерПакета = 0 Тогда
			РазмерПакета = 50;
		КонецЕсли;
	Исключение
		РазмерПакета = 50;
	КонецПопытки;
	
	Параметры = Новый Структура;
	Параметры.Вставить("ТипВыгрузки", "Все");
	Параметры.Вставить("НачальнаяПозиция", 0);
	Параметры.Вставить("РазмерПакета", РазмерПакета);
	Параметры.Вставить("Этап", "Константы");
	
	ВыполнитьОбработкуНаСервереАсинхронно("ОбработатьПакетВыгрузки", Параметры, "ПослеОбработкиПакета");
	
КонецПроцедуры

// Серверная процедура для выполнения рукопожатия и отправки метаинформации
&НаСервере
Функция ВыполнитьРукопожатиеИМетаинформациюНаСервере()
	
	ОбновитьНастройкиИзФормы();
	
	// Выполняем рукопожатие
	Если ИдентификаторБазыДанных <> "" Тогда
		ИдентификаторВыгрузки = ВыполнитьРукопожатиеСПривязкой();
	Иначе
		ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	КонецЕсли;
	
	Если ИдентификаторВыгрузки = "" Тогда
		Возврат "";
	КонецЕсли;
	
	// Отправляем метаинформацию
	ОтправитьМетаИнформацию();
	
	Возврат ИдентификаторВыгрузки;
	
КонецФункции

// Серверная процедура для получения общего количества объектов
&НаСервере
Функция ПолучитьОбщееКоличествоОбъектовНаСервере(ТипВыгрузки)
	
	Возврат ПолучитьОбщееКоличествоОбъектов(ТипВыгрузки);
	
КонецФункции

// Основная процедура для запуска выгрузки через HTTP
Процедура ВыполнитьВыгрузкуЧерезHTTP() Экспорт
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки данных через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера
	АдресСервера = "http://localhost:9999";
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем константы
	Сообщить("Этап 3: Выгрузка констант...");
	ВыгрузитьКонстантыЧерезHTTP();
	
	// Выгружаем справочники
	Сообщить("Этап 4: Выгрузка справочников...");
	ВыгрузитьСправочникиЧерезHTTP();
	
	// Завершаем выгрузку
	Сообщить("Этап 5: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Выполнение рукопожатия с сервером
Функция ВыполнитьРукопожатие()
	
	URL = АдресСервера + "/handshake";
	Сообщить("  → Отправка запроса на " + URL);
	
	// Создаем XML для рукопожатия
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<handshake>" +
		"<version_1c>" + Строка(Версия1С()) + "</version_1c>" +
		"<config_name>" + Строка(ИмяКонфигурации()) + "</config_name>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</handshake>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("  → Ответ от сервера: код " + Строка(КодСостояния));
		
		// Извлекаем UUID из XML ответа
		Попытка
			ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтвета = Ответ.ТелоОтвета;
			Исключение
				ТелоОтвета = "";
			КонецПопытки;
		КонецПопытки;
		
		// Ищем UUID в ответе
		ПозицияНачала = СтрНайти(ТелоОтвета, "<upload_uuid>");
		ПозицияКонца = СтрНайти(ТелоОтвета, "</upload_uuid>");
		
		Если ПозицияНачала > 0 И ПозицияКонца > 0 Тогда
			UUIDВыгрузки = Средняя(ТелоОтвета, ПозицияНачала + СтрДлина("<upload_uuid>"), ПозицияКонца - ПозицияНачала - СтрДлина("<upload_uuid>"));
			Сообщить("  → UUID получен: " + UUIDВыгрузки);
			Возврат UUIDВыгрузки;
		Иначе
			Сообщить("  → ОШИБКА: UUID не найден в ответе сервера");
		КонецЕсли;
	Иначе
		Сообщить("  → ОШИБКА: Код ответа " + Строка(КодСостояния));
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

// Отправка метаинформации
Процедура ОтправитьМетаИнформацию()
	
	Сообщить("  → Отправка метаинформации...");
	URL = АдресСервера + "/metadata";
	
	// Создаем XML для метаинформации
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<metadata>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<version_1c>" + Строка(Версия1С()) + "</version_1c>" +
		"<config_name>" + Строка(ИмяКонфигурации()) + "</config_name>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</metadata>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("  ✓ Метаинформация отправлена успешно");
	Иначе
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("  → ОШИБКА отправки метаинформации: " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Выгрузка констант через HTTP
Процедура ВыгрузитьКонстантыЧерезHTTP()
	
	Сообщить("  → Начинаем выгрузку констант...");
	
	// Получаем все константы (метаданные)
	КоллекцияКонстант = Метаданные.Константы;
	ВсегоКонстант = КоллекцияКонстант.Количество();
	
	Если ВсегоКонстант = 0 Тогда
		Сообщить("  → Константы не найдены. Пропускаем этап.");
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Найдено констант: " + Строка(ВсегоКонстант));
	ТекущаяКонстанта = 0;
	
	Для Каждого КонстантаМетаданных Из КоллекцияКонстант Цикл
		ТекущаяКонстанта = ТекущаяКонстанта + 1;
		
		// Получаем значение константы через глобальный объект Константы
		// Используем метод Получить() для получения реального значения константы
		ЗначениеКонстанты = Неопределено;
		Попытка
			// Сначала пробуем получить через метод Получить()
			ЗначениеКонстанты = Константы[КонстантаМетаданных.Имя].Получить();
			Сообщить("      → Значение константы '" + КонстантаМетаданных.Имя + "' получено через Получить()");
		Исключение
			// Если метод Получить() не работает, пробуем получить напрямую
			Попытка
				ЗначениеКонстанты = Константы[КонстантаМетаданных.Имя];
				Сообщить("      → Значение константы '" + КонстантаМетаданных.Имя + "' получено напрямую");
				
				// Проверяем, что это не строка-ссылка на константу
				Если ТипЗнч(ЗначениеКонстанты) = Тип("Строка") Тогда
					СтрокаЗначения = Строка(ЗначениеКонстанты);
					// Если строка содержит точку и начинается с "Константа", это скорее всего ссылка, а не значение
					Если СтрНайти(СтрокаЗначения, ".") > 0 И (СтрНачинаетсяС(СтрокаЗначения, "Константа") Или СтрНачинаетсяС(СтрокаЗначения, "Constants")) Тогда
						Сообщить("      → ОШИБКА: получена ссылка на константу вместо значения '" + КонстантаМетаданных.Имя + "': " + СтрокаЗначения);
						Сообщить("      → Пробуем альтернативные способы получения значения...");
						
						// Пробуем альтернативный способ - через запрос к константам
						Попытка
							Запрос = Новый Запрос;
							Запрос.Текст = "ВЫБРАТЬ
							|	Константы." + КонстантаМетаданных.Имя + " КАК Значение";
							РезультатЗапроса = Запрос.Выполнить();
							Выборка = РезультатЗапроса.Выбрать();
							Если Выборка.Следующий() Тогда
								ЗначениеКонстанты = Выборка.Значение;
								Сообщить("      → Значение получено через запрос");
							КонецЕсли;
						Исключение
							Сообщить("      → Не удалось получить значение через запрос: " + ОписаниеОшибки());
						КонецПопытки;
						
						// Если все еще ссылка, обнуляем
						Если ТипЗнч(ЗначениеКонстанты) = Тип("Строка") Тогда
							СтрокаЗначения = Строка(ЗначениеКонстанты);
							Если СтрНайти(СтрокаЗначения, ".") > 0 И (СтрНачинаетсяС(СтрокаЗначения, "Константа") Или СтрНачинаетсяС(СтрокаЗначения, "Constants")) Тогда
								ЗначениеКонстанты = Неопределено;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			Исключение
				ЗначениеКонстанты = Неопределено;
				Сообщить("      → ОШИБКА: не удалось получить значение константы '" + КонстантаМетаданных.Имя + "': " + ОписаниеОшибки());
			КонецПопытки;
		КонецПопытки;
		
		// Определяем тип значения
		ТипЗначения = "";
		ТипЗначенияОбъекта = ТипЗнч(ЗначениеКонстанты);
		СтрокаТипа = Строка(ТипЗначенияОбъекта);
		
		Если ЗначениеКонстанты = Неопределено Тогда
			ТипЗначения = "Неопределено";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Строка") Тогда
			ТипЗначения = "Строка";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Число") Тогда
			ТипЗначения = "Число";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Булево") Тогда
			ТипЗначения = "Булево";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Дата") Тогда
			ТипЗначения = "Дата";
		ИначеЕсли СтрНайти(СтрокаТипа, "Ссылка") > 0 Тогда
			ТипЗначения = "Ссылка";
		ИначеЕсли ТипЗначенияОбъекта = Тип("ТаблицаЗначений") Тогда
			ТипЗначения = "ТаблицаЗначений";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Структура") Тогда
			ТипЗначения = "Структура";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Массив") Тогда
			ТипЗначения = "Массив";
		Иначе
			ТипЗначения = "Объект";
		КонецЕсли;
		
		// Получаем XML представление значения
		XMLЗначения = "";
		Если ЗначениеКонстанты <> Неопределено Тогда
			XMLЗначения = ПолучитьXMLПредставлениеЗначения(ЗначениеКонстанты, ТипЗначения);
		Иначе
			// Для неопределенного значения создаем пустой тег
			XMLЗначения = "<undefined></undefined>";
		КонецЕсли;
		
		// Логирование для отладки - показываем что получили
		Если ЗначениеКонстанты <> Неопределено Тогда
			КраткоеЗначение = "";
			ПолноеЗначение = "";
			Попытка
				ПолноеЗначение = Строка(ЗначениеКонстанты);
				Если ТипЗначения = "Строка" Тогда
					КраткоеЗначение = Лев(ПолноеЗначение, 100);
					Если СтрДлина(ПолноеЗначение) > 100 Тогда
						КраткоеЗначение = КраткоеЗначение + "...";
					КонецЕсли;
				Иначе
					КраткоеЗначение = ПолноеЗначение;
				КонецЕсли;
			Исключение
				КраткоеЗначение = "[не удалось преобразовать]";
				ПолноеЗначение = "[не удалось преобразовать]";
			КонецПопытки;
			Сообщить("    [" + Строка(ТекущаяКонстанта) + "/" + Строка(ВсегоКонстант) + "] Константа: " + КонстантаМетаданных.Имя);
			Сообщить("      → Тип: " + ТипЗначения + " (" + Строка(ТипЗначенияОбъекта) + ")");
			Сообщить("      → Значение (полное): " + ПолноеЗначение);
			Сообщить("      → Значение (краткое): " + КраткоеЗначение);
		Иначе
			Сообщить("    [" + Строка(ТекущаяКонстанта) + "/" + Строка(ВсегоКонстант) + "] Константа: " + КонстантаМетаданных.Имя + ", значение: Неопределено");
		КонецЕсли;
		
		// Отправляем константу
		ОтправитьКонстанту(КонстантаМетаданных.Имя, КонстантаМетаданных.Синоним, ТипЗначения, XMLЗначения);
		
	КонецЦикла;
	
	Сообщить("  ✓ Выгрузка констант завершена: отправлено " + Строка(ВсегоКонстант) + " констант");
	
КонецПроцедуры

// Отправка константы на сервер
Процедура ОтправитьКонстанту(Имя, Синоним, Тип, XMLЗначение)
	
	URL = АдресСервера + "/constant";
	
	// Экранируем специальные символы в XML для имени, синонима и типа (используем локальные переменные)
	ИмяЭкранированное = ЭкранироватьXML(Имя);
	СинонимЭкранированный = ЭкранироватьXML(Синоним);
	ТипЭкранированный = ЭкранироватьXML(Тип);
	
	// XMLЗначение уже содержит XML структуру (например, <string>...</string> или <number>...</number>)
	// Если значение пустое (не должно быть, но на всякий случай), создаем пустой тег
	Если XMLЗначение = "" Тогда
		XMLЗначение = "<undefined></undefined>";
	КонецЕсли;
	
	// Создаем XML для константы
	// Значение уже в XML формате, поэтому просто вставляем его в тег <value>
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<constant>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<name>" + ИмяЭкранированное + "</name>" +
		"<synonym>" + СинонимЭкранированный + "</synonym>" +
		"<type>" + ТипЭкранированный + "</type>" +
		"<value>" + XMLЗначение + "</value>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</constant>";
	
	// Отладочное сообщение - показываем что отправляем на сервер
	Если СтрДлина(XMLСтрока) > 500 Тогда
		Сообщить("      → Отправка XML (первые 500 символов): " + Лев(XMLСтрока, 500) + "...");
		Сообщить("      → Длина XML: " + Строка(СтрДлина(XMLСтрока)) + " символов");
	Иначе
		Сообщить("      → Отправка XML: " + XMLСтрока);
	КонецЕсли;
	Сообщить("      → XML значение (длина " + Строка(СтрДлина(XMLЗначение)) + "): " + XMLЗначение);
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("Ошибка отправки константы '" + Имя + "': " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Выгрузка справочников через HTTP
Процедура ВыгрузитьСправочникиЧерезHTTP()
	
	Сообщить("  → Начинаем выгрузку справочников...");
	
	// Получаем все справочники (метаданные)
	КоллекцияСправочников = Метаданные.Справочники;
	ВсегоСправочников = КоллекцияСправочников.Количество();
	
	Если ВсегоСправочников = 0 Тогда
		Сообщить("  → Справочники не найдены. Пропускаем этап.");
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Найдено справочников: " + Строка(ВсегоСправочников));
	ТекущийСправочник = 0;
	
	Для Каждого СправочникМетаданных Из КоллекцияСправочников Цикл
		ТекущийСправочник = ТекущийСправочник + 1;
		Сообщить("    [" + Строка(ТекущийСправочник) + "/" + Строка(ВсегоСправочников) + "] Обработка справочника: " + СправочникМетаданных.Имя);
		
		// Отправляем метаданные справочника
		ОтправитьМетаСправочника(СправочникМетаданных);
		
		// Если это справочник "Номенклатура", выгружаем с характеристиками
		Если СправочникМетаданных.Имя = "Номенклатура" Тогда
			ВыгрузитьНоменклатуруСХарактеристиками();
		Иначе
			// Выгружаем элементы справочника стандартным способом
			ВыгрузитьЭлементыСправочникаЧерезHTTP(СправочникМетаданных);
		КонецЕсли;
		
	КонецЦикла;
	
	Сообщить("  ✓ Выгрузка справочников завершена: обработано " + Строка(ВсегоСправочников) + " справочников");
	
КонецПроцедуры

// Отправка метаданных справочника
Процедура ОтправитьМетаСправочника(СправочникМетаданных)
	
	URL = АдресСервера + "/catalog/meta";
	
	// Экранируем специальные символы
	ИмяСправочника = ЭкранироватьXML(СправочникМетаданных.Имя);
	СинонимСправочника = ЭкранироватьXML(СправочникМетаданных.Синоним);
	
	// Создаем XML для метаданных справочника
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<catalog_meta>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<name>" + ИмяСправочника + "</name>" +
		"<synonym>" + СинонимСправочника + "</synonym>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</catalog_meta>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("      ✓ Метаданные справочника '" + СправочникМетаданных.Имя + "' отправлены успешно");
	Иначе
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("      → ОШИБКА отправки метаданных справочника '" + СправочникМетаданных.Имя + "': " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Выгрузка элементов справочника через HTTP (стандартная версия без характеристик)
Процедура ВыгрузитьЭлементыСправочникаЧерезHTTP(СправочникМетаданных)
	
	Сообщить("      → Выгружаем элементы справочника: " + СправочникМетаданных.Имя);
	
	ИмяСправочникаВЗапросе = СправочникМетаданных.Имя;
	
	// Сначала подсчитываем количество элементов
	ЗапросПодсчета = Новый Запрос;
	ЗапросПодсчета.Текст = "ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК ВсегоЭлементов
	|ИЗ
	|	Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий
	|ГДЕ
	|	НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатПодсчета = ЗапросПодсчета.Выполнить();
		ВыборкаПодсчета = РезультатПодсчета.Выбрать();
		ВсегоЭлементов = 0;
		Если ВыборкаПодсчета.Следующий() Тогда
			ВсегоЭлементов = ВыборкаПодсчета.ВсегоЭлементов;
		КонецЕсли;
	Исключение
		Сообщить("      → ОШИБКА подсчета элементов: " + ОписаниеОшибки());
		ВсегоЭлементов = 0;
	КонецПопытки;
	
	// Показываем сообщение о количестве элементов
	Если ВсегоЭлементов > 0 Тогда
		Сообщить("      → Найдено элементов справочника '" + СправочникМетаданных.Имя + "': " + Строка(ВсегоЭлементов));
		Сообщить("      → Начинаем выгрузку " + Строка(ВсегоЭлементов) + " элементов...");
	Иначе
		Сообщить("      → Элементы справочника '" + СправочникМетаданных.Имя + "' не найдены. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	// Стандартная обработка для всех справочников (включая номенклатуру без характеристик)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|	Ссылка,
	|	Код,
	|	Наименование
	|ИЗ
	|	Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий
	|ГДЕ
	|	НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса для справочника '" + СправочникМетаданных.Имя + "': " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	// Обрабатываем элементы
	КоличествоЭлементов = 0;
	
	Пока Выборка.Следующий() Цикл
		
		КоличествоЭлементов = КоличествоЭлементов + 1;
		
		// Выводим прогресс каждые 10 элементов
		Если КоличествоЭлементов % 10 = 0 Тогда
			Сообщить("        → [" + Строка(КоличествоЭлементов) + "] Отправка элементов...");
		КонецЕсли;
		
		// Получаем реквизиты элемента (передаем имя справочника)
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, СправочникМетаданных.Имя);
		
		// Получаем табличные части элемента (передаем имя справочника)
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, СправочникМетаданных.Имя);
		
		// Отправляем элемент справочника
		ОтправитьЭлементСправочника(
			СправочникМетаданных.Имя,
			Строка(Выборка.Ссылка),
			Строка(Выборка.Код),
			Строка(Выборка.Наименование),
			РеквизитыXML,
			ТабличныеЧастиXML
		);
		
	КонецЦикла;
	
	Если КоличествоЭлементов = 0 Тогда
		Сообщить("      → Элементы справочника не найдены. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	Сообщить("      ✓ Выгружено элементов справочника '" + СправочникМетаданных.Имя + "': " + Строка(КоличествоЭлементов));
	
КонецПроцедуры

// Выгрузка номенклатуры с характеристиками (оптимизированная версия с UNION ALL)
Процедура ВыгрузитьНоменклатуруСХарактеристиками()
	
	Сообщить("      → Выгружаем номенклатуру с характеристиками...");
	
	// Используем подход с циклами для надежности и производительности
	// Получаем все номенклатуры, затем для каждой получаем характеристики двумя запросами
	ЗапросНоменклатуры = Новый Запрос;
	ЗапросНоменклатуры.Текст = "ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка,
	|	Номенклатура.Код КАК Код,
	|	Номенклатура.Наименование КАК Наименование,
	|	Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	Номенклатура.Наименование";
	
	Попытка
		РезультатНоменклатуры = ЗапросНоменклатуры.Выполнить();
		ВыборкаНоменклатуры = РезультатНоменклатуры.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА получения номенклатуры: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	// Подсчитываем общее количество записей
	ВсегоЗаписей = 0;
	ВыборкаДляПодсчета = РезультатНоменклатуры.Выбрать();
	Пока ВыборкаДляПодсчета.Следующий() Цикл
		ВсегоЗаписей = ВсегоЗаписей + 1; // Считаем саму номенклатуру
		
		// Подсчитываем индивидуальные характеристики
		ЗапросПодсчета1 = Новый Запрос;
		ЗапросПодсчета1.Текст = "ВЫБРАТЬ
		|	КОЛИЧЕСТВО(*) КАК Количество
		|ИЗ
		|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|ГДЕ
		|	ХарактеристикиНоменклатуры.Владелец = &Владелец
		|	И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
		|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления";
		ЗапросПодсчета1.УстановитьПараметр("Владелец", ВыборкаДляПодсчета.Ссылка);
		
		Попытка
			РезультатПодсчета1 = ЗапросПодсчета1.Выполнить();
			ВыборкаПодсчета1 = РезультатПодсчета1.Выбрать();
			Если ВыборкаПодсчета1.Следующий() Тогда
				КоличествоИндивидуальных = ВыборкаПодсчета1.Количество;
				Если КоличествоИндивидуальных > 0 Тогда
					ВсегоЗаписей = ВсегоЗаписей - 1 + КоличествоИндивидуальных;
					Продолжить; // Если есть индивидуальные, пропускаем подсчет общих
				КонецЕсли;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		// Подсчитываем общие для вида характеристики
		Если ЗначениеЗаполнено(ВыборкаДляПодсчета.ВидНоменклатуры) Тогда
			ЗапросПодсчета2 = Новый Запрос;
			ЗапросПодсчета2.Текст = "ВЫБРАТЬ
			|	КОЛИЧЕСТВО(*) КАК Количество
			|ИЗ
			|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
			|ГДЕ
			|	ХарактеристикиНоменклатуры.Владелец = &ВидНоменклатуры
			|	И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры
			|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления";
			ЗапросПодсчета2.УстановитьПараметр("ВидНоменклатуры", ВыборкаДляПодсчета.ВидНоменклатуры);
			
			Попытка
				РезультатПодсчета2 = ЗапросПодсчета2.Выполнить();
				ВыборкаПодсчета2 = РезультатПодсчета2.Выбрать();
				Если ВыборкаПодсчета2.Следующий() Тогда
					КоличествоОбщих = ВыборкаПодсчета2.Количество;
					Если КоличествоОбщих > 0 Тогда
						ВсегоЗаписей = ВсегоЗаписей - 1 + КоличествоОбщих;
					КонецЕсли;
				КонецЕсли;
			Исключение
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Сообщить("      → Найдено " + Строка(ВсегоЗаписей) + " комбинаций номенклатуры + характеристик для выгрузки");
	Если ВсегоЗаписей > 0 Тогда
		Сообщить("      → Начинаем выгрузку " + Строка(ВсегоЗаписей) + " комбинаций...");
	Иначе
		Сообщить("      → Номенклатура не найдена. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	// Основной цикл выгрузки
	КоличествоОбработано = 0;
	ВыборкаНоменклатуры = РезультатНоменклатуры.Выбрать();
	
	Пока ВыборкаНоменклатуры.Следующий() Цикл
		
		СсылкаНоменклатуры = ВыборкаНоменклатуры.Ссылка;
		КодНоменклатуры = Строка(ВыборкаНоменклатуры.Код);
		НаименованиеНоменклатуры = Строка(ВыборкаНоменклатуры.Наименование);
		ВидНоменклатуры = ВыборкаНоменклатуры.ВидНоменклатуры;
		
		// Получаем реквизиты и табличные части номенклатуры один раз
		РеквизитыXMLНоменклатуры = ПолучитьРеквизитыЭлементаXML(СсылкаНоменклатуры, "Номенклатура");
		ТабличныеЧастиXMLНоменклатуры = ПолучитьТабличныеЧастиЭлементаXML(СсылкаНоменклатуры, "Номенклатура");
		
		ЕстьХарактеристики = Ложь;
		
		// Сначала получаем индивидуальные характеристики
		ЗапросХарактеристик1 = Новый Запрос;
		ЗапросХарактеристик1.Текст = "ВЫБРАТЬ
		|	ХарактеристикиНоменклатуры.Ссылка КАК Ссылка,
		|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеПолное
		|ИЗ
		|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|ГДЕ
		|	ХарактеристикиНоменклатуры.Владелец = &Владелец
		|	И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
		|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|УПОРЯДОЧИТЬ ПО
		|	ХарактеристикиНоменклатуры.НаименованиеПолное";
		ЗапросХарактеристик1.УстановитьПараметр("Владелец", СсылкаНоменклатуры);
		
		Попытка
			РезультатХарактеристик1 = ЗапросХарактеристик1.Выполнить();
			ВыборкаХарактеристик1 = РезультатХарактеристик1.Выбрать();
			
			Пока ВыборкаХарактеристик1.Следующий() Цикл
				ЕстьХарактеристики = Истина;
				КоличествоОбработано = КоличествоОбработано + 1;
				
				// Выводим прогресс каждые 50 элементов
				Если КоличествоОбработано % 50 = 0 Тогда
					Сообщить("        → [" + Строка(КоличествоОбработано) + "/" + Строка(ВсегоЗаписей) + "] Отправка элементов...");
				КонецЕсли;
				
				НаименованиеХарактеристики = Строка(ВыборкаХарактеристик1.НаименованиеПолное);
				СсылкаХарактеристики = ВыборкаХарактеристик1.Ссылка;
				СоставноеНаименование = НаименованиеНоменклатуры + " " + НаименованиеХарактеристики;
				СоставнаяСсылка = Строка(СсылкаНоменклатуры) + "|" + Строка(СсылкаХарактеристики);
				
				РеквизитыXML = РеквизитыXMLНоменклатуры;
				РеквизитыXML = РеквизитыXML + "<Характеристика>" + ЭкранироватьXML(НаименованиеХарактеристики) + "</Характеристика>";
				РеквизитыXML = РеквизитыXML + "<ХарактеристикаСсылка>" + ЭкранироватьXML(Строка(СсылкаХарактеристики)) + "</ХарактеристикаСсылка>";
				
				ОтправитьЭлементСправочника(
					"Номенклатура",
					СоставнаяСсылка,
					КодНоменклатуры,
					СоставноеНаименование,
					РеквизитыXML,
					ТабличныеЧастиXMLНоменклатуры
				);
			КонецЦикла;
		Исключение
			Сообщить("      → ОШИБКА получения индивидуальных характеристик для номенклатуры '" + НаименованиеНоменклатуры + "': " + ОписаниеОшибки());
		КонецПопытки;
		
		// Если нет индивидуальных, получаем общие для вида
		Если НЕ ЕстьХарактеристики И ЗначениеЗаполнено(ВидНоменклатуры) Тогда
			ЗапросХарактеристик2 = Новый Запрос;
			ЗапросХарактеристик2.Текст = "ВЫБРАТЬ
			|	ХарактеристикиНоменклатуры.Ссылка КАК Ссылка,
			|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеПолное
			|ИЗ
			|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
			|ГДЕ
			|	ХарактеристикиНоменклатуры.Владелец = &ВидНоменклатуры
			|	И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры
			|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
			|УПОРЯДОЧИТЬ ПО
			|	ХарактеристикиНоменклатуры.НаименованиеПолное";
			ЗапросХарактеристик2.УстановитьПараметр("ВидНоменклатуры", ВидНоменклатуры);
			
			Попытка
				РезультатХарактеристик2 = ЗапросХарактеристик2.Выполнить();
				ВыборкаХарактеристик2 = РезультатХарактеристик2.Выбрать();
				
				Пока ВыборкаХарактеристик2.Следующий() Цикл
					ЕстьХарактеристики = Истина;
					КоличествоОбработано = КоличествоОбработано + 1;
					
					// Выводим прогресс каждые 50 элементов
					Если КоличествоОбработано % 50 = 0 Тогда
						Сообщить("        → [" + Строка(КоличествоОбработано) + "/" + Строка(ВсегоЗаписей) + "] Отправка элементов...");
					КонецЕсли;
					
					НаименованиеХарактеристики = Строка(ВыборкаХарактеристик2.НаименованиеПолное);
					СсылкаХарактеристики = ВыборкаХарактеристик2.Ссылка;
					СоставноеНаименование = НаименованиеНоменклатуры + " " + НаименованиеХарактеристики;
					СоставнаяСсылка = Строка(СсылкаНоменклатуры) + "|" + Строка(СсылкаХарактеристики);
					
					РеквизитыXML = РеквизитыXMLНоменклатуры;
					РеквизитыXML = РеквизитыXML + "<Характеристика>" + ЭкранироватьXML(НаименованиеХарактеристики) + "</Характеристика>";
					РеквизитыXML = РеквизитыXML + "<ХарактеристикаСсылка>" + ЭкранироватьXML(Строка(СсылкаХарактеристики)) + "</ХарактеристикаСсылка>";
					
					ОтправитьЭлементСправочника(
						"Номенклатура",
						СоставнаяСсылка,
						КодНоменклатуры,
						СоставноеНаименование,
						РеквизитыXML,
						ТабличныеЧастиXMLНоменклатуры
					);
				КонецЦикла;
			Исключение
				Сообщить("      → ОШИБКА получения общих характеристик для номенклатуры '" + НаименованиеНоменклатуры + "': " + ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
		
		// Если нет характеристик вообще, выгружаем номенклатуру один раз
		Если НЕ ЕстьХарактеристики Тогда
			КоличествоОбработано = КоличествоОбработано + 1;
			
			// Выводим прогресс каждые 50 элементов
			Если КоличествоОбработано % 50 = 0 Тогда
				Сообщить("        → [" + Строка(КоличествоОбработано) + "/" + Строка(ВсегоЗаписей) + "] Отправка элементов...");
			КонецЕсли;
			
			ОтправитьЭлементСправочника(
				"Номенклатура",
				Строка(СсылкаНоменклатуры),
				КодНоменклатуры,
				НаименованиеНоменклатуры,
				РеквизитыXMLНоменклатуры,
				ТабличныеЧастиXMLНоменклатуры
			);
		КонецЕсли;
		
	КонецЦикла;
	
	Если КоличествоОбработано = 0 Тогда
		Сообщить("      → Элементы номенклатуры не найдены. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	Сообщить("      ✓ Выгружено элементов номенклатуры (с характеристиками): " + Строка(КоличествоОбработано));
	
КонецПроцедуры

// Получение реквизитов элемента в XML формате (исправленная версия)
// ИмяСправочника передается как параметр, чтобы не извлекать его из ссылки
Функция ПолучитьРеквизитыЭлементаXML(СсылкаЭлемента, ИмяСправочника)
	
	// Получаем метаданные справочника через индексатор
	Попытка
		СправочникМетаданных = Метаданные.Справочники[ИмяСправочника];
	Исключение
		Сообщить("      → ОШИБКА: Не удалось получить метаданные справочника '" + ИмяСправочника + "': " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("      → ОШИБКА: Метаданные справочника '" + ИмяСправочника + "' не найдены");
		Возврат "";
	КонецЕсли;
	
	XMLСтрока = "";
	
	// Обрабатываем реквизиты
	Для Каждого РеквизитМетаданных Из СправочникМетаданных.Реквизиты Цикл
		
		// Получаем значение реквизита
		ЗначениеРеквизита = Неопределено;
		Попытка
			ЗначениеРеквизита = СсылкаЭлемента[РеквизитМетаданных.Имя];
		Исключение
			// Если не удалось получить значение реквизита, пропускаем его
			Продолжить;
		КонецПопытки;
		
		// Преобразуем в строку
		СтрокаЗначения = "";
		Если ЗначениеРеквизита <> Неопределено Тогда
			СтрокаЗначения = Строка(ЗначениеРеквизита);
			// Экранируем специальные символы
			СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
		КонецЕсли;
		
		// Добавляем в XML
		XMLСтрока = XMLСтрока + "<" + РеквизитМетаданных.Имя + ">" + СтрокаЗначения + "</" + РеквизитМетаданных.Имя + ">";
		
	КонецЦикла;
	
	Возврат XMLСтрока;
	
КонецФункции

// Получение табличных частей элемента в XML формате (исправленная версия)
// ИмяСправочника передается как параметр, чтобы не извлекать его из ссылки
Функция ПолучитьТабличныеЧастиЭлементаXML(СсылкаЭлемента, ИмяСправочника)
	
	// Получаем метаданные справочника через индексатор
	Попытка
		СправочникМетаданных = Метаданные.Справочники[ИмяСправочника];
	Исключение
		Сообщить("      → ОШИБКА: Не удалось получить метаданные справочника '" + ИмяСправочника + "': " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("      → ОШИБКА: Метаданные справочника '" + ИмяСправочника + "' не найдены");
		Возврат "";
	КонецЕсли;
	
	XMLСтрока = "";
	
	// Обрабатываем табличные части
	Для Каждого ТабличнаяЧастьМетаданных Из СправочникМетаданных.ТабличныеЧасти Цикл
		
		// Получаем табличную часть
		ТабличнаяЧасть = Неопределено;
		Попытка
			ТабличнаяЧасть = СсылкаЭлемента[ТабличнаяЧастьМетаданных.Имя];
		Исключение
			// Если не удалось получить табличную часть, пропускаем её
			Продолжить;
		КонецПопытки;
		
		Если ТабличнаяЧасть = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		XMLСтрокаТабличнойЧасти = "";
		
		// Обрабатываем строки табличной части
		Для Каждого СтрокаТабличнойЧасти Из ТабличнаяЧасть Цикл
			
			XMLСтрокаСтроки = "<row>";
			
			// Обрабатываем реквизиты (колонки) строки табличной части
			Для Каждого РеквизитТабличнойЧасти Из ТабличнаяЧастьМетаданных.Реквизиты Цикл
				
				ЗначениеКолонки = Неопределено;
				Попытка
					ЗначениеКолонки = СтрокаТабличнойЧасти[РеквизитТабличнойЧасти.Имя];
				Исключение
					// Если не удалось получить значение, пропускаем
					Продолжить;
				КонецПопытки;
				
				СтрокаЗначенияКолонки = "";
				Если ЗначениеКолонки <> Неопределено Тогда
					СтрокаЗначенияКолонки = Строка(ЗначениеКолонки);
					// Экранируем специальные символы
					СтрокаЗначенияКолонки = ЭкранироватьXML(СтрокаЗначенияКолонки);
				КонецЕсли;
				
				XMLСтрокаСтроки = XMLСтрокаСтроки + "<" + РеквизитТабличнойЧасти.Имя + ">" + СтрокаЗначенияКолонки + "</" + РеквизитТабличнойЧасти.Имя + ">";
				
			КонецЦикла;
			
			XMLСтрокаСтроки = XMLСтрокаСтроки + "</row>";
			XMLСтрокаТабличнойЧасти = XMLСтрокаТабличнойЧасти + XMLСтрокаСтроки;
			
		КонецЦикла;
		
		XMLСтрока = XMLСтрока + "<" + ТабличнаяЧастьМетаданных.Имя + ">" + XMLСтрокаТабличнойЧасти + "</" + ТабличнаяЧастьМетаданных.Имя + ">";
		
	КонецЦикла;
	
	Возврат XMLСтрока;
	
КонецФункции

// Отправка элемента справочника на сервер
Процедура ОтправитьЭлементСправочника(ИмяСправочника, Ссылка, Код, Наименование, РеквизитыXML, ТабличныеЧастиXML)
	
	URL = АдресСервера + "/catalog/item";
	
	// Экранируем специальные символы (используем локальные переменные)
	ИмяСправочникаЭкранированное = ЭкранироватьXML(ИмяСправочника);
	СсылкаЭкранированная = ЭкранироватьXML(Ссылка);
	КодЭкранированный = ЭкранироватьXML(Код);
	НаименованиеЭкранированное = ЭкранироватьXML(Наименование);
	
	// Создаем XML для элемента справочника
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<catalog_item>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<catalog_name>" + ИмяСправочникаЭкранированное + "</catalog_name>" +
		"<reference>" + СсылкаЭкранированная + "</reference>" +
		"<code>" + КодЭкранированный + "</code>" +
		"<name>" + НаименованиеЭкранированное + "</name>" +
		"<attributes>" + РеквизитыXML + "</attributes>" +
		"<table_parts>" + ТабличныеЧастиXML + "</table_parts>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</catalog_item>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("Ошибка отправки элемента справочника '" + Наименование + "': " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Завершение выгрузки
Процедура ЗавершитьВыгрузку()
	
	Сообщить("  → Отправка запроса на завершение выгрузки...");
	URL = АдресСервера + "/complete";
	
	// Создаем XML для завершения выгрузки
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<complete>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</complete>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("  ✓ Выгрузка завершена успешно на сервере");
	Иначе
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("  → ОШИБКА завершения выгрузки: " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Универсальная функция для отправки HTTP запросов
Функция ОтправитьHTTPЗапрос(Метод, URL, ТелоЗапроса)
	
	Попытка
		
		// Парсим URL для получения базового адреса и пути
		ПозицияПротокола = СтрНайти(URL, "://");
		Если ПозицияПротокола > 0 Тогда
			URLБезПротокола = Прав(URL, СтрДлина(URL) - ПозицияПротокола - 2);
			ПозицияСлеша = СтрНайти(URLБезПротокола, "/");
			Если ПозицияСлеша > 0 Тогда
				// Для HTTPСоединение нужен адрес без протокола, только хост:порт
				БазовыйАдресСервера = Лев(URLБезПротокола, ПозицияСлеша - 1);
				ПутьЗапроса = Прав(URLБезПротокола, СтрДлина(URLБезПротокола) - ПозицияСлеша + 1);
			Иначе
				БазовыйАдресСервера = URLБезПротокола;
				ПутьЗапроса = "/";
			КонецЕсли;
		Иначе
			БазовыйАдресСервера = URL;
			ПутьЗапроса = "/";
		КонецЕсли;
		
		Соединение = Новый HTTPСоединение(БазовыйАдресСервера);
		Заголовки = СоздатьHTTPЗаголовки();
		
		// Создаем HTTPЗапрос с путем (не полным URL!)
		HTTPЗапрос = Новый HTTPЗапрос(ПутьЗапроса, Заголовки);
		
		// Устанавливаем тело запроса из строки
		HTTPЗапрос.УстановитьТелоИзСтроки(ТелоЗапроса, КодировкаТекста.UTF8);
		
		// Отправляем запрос - метод POST определяется автоматически при наличии тела
		Ответ = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
		
		Возврат Ответ;
		
	Исключение
		
		Сообщить("  → КРИТИЧЕСКАЯ ОШИБКА HTTP запроса [" + Метод + " " + URL + "]: " + ОписаниеОшибки());
		Возврат СоздатьПустойHTTPОтвет();
		
	КонецПопытки;
	
КонецФункции

// Создание HTTP соединения
Функция СоздатьHTTPСоединение(URL)
	
	// Эта функция больше не используется напрямую, но оставлена для совместимости
	Возврат Новый HTTPСоединение(URL);
	
КонецФункции

// Создание заголовков HTTP
Функция СоздатьHTTPЗаголовки()
	
	Заголовки = Новый Соответствие;
	Заголовки.Вставить("Content-Type", "application/xml; charset=utf-8");
	Заголовки.Вставить("Accept", "application/xml");
	
	Возврат Заголовки;
	
КонецФункции

// Создание пустого HTTP ответа
Функция СоздатьПустойHTTPОтвет()
	
	// Возвращаем структуру, которая имитирует HTTPОтвет
	Ответ = Новый Структура;
	Ответ.Вставить("КодСостояния", 0);
	Ответ.Вставить("ТелоОтвета", "Пустой ответ");
	
	Возврат Ответ;
	
КонецФункции

// Безопасное получение кода состояния из HTTP ответа
Функция ПолучитьКодСостояния(Ответ)
	
	КодСостояния = 0;
	Попытка
		КодСостояния = Число(Ответ.КодСостояния);
	Исключение
		Попытка
			КодСостояния = Ответ.КодСостояния;
		Исключение
			КодСостояния = 0;
		КонецПопытки;
	КонецПопытки;
	
	Возврат КодСостояния;
	
КонецФункции

// Процедура на клиенте для привязки к кнопке "ВыгрузкаНоменклатуры"
&НаКлиенте
Процедура ВыгрузкаНоменклатуры(Команда)
	
	ВыполнитьВыгрузкуНоменклатурыНаСервере();
	
КонецПроцедуры

// Процедура на клиенте для привязки к кнопке "ВыгрзукаНоменклатурыСХарактеристиками"
&НаКлиенте
Процедура ВыгрзукаНоменклатурыСХарактеристиками(Команда)
	
	ВыполнитьВыгрузкуНоменклатурыСХарактеристикамиНаСервере();
	
КонецПроцедуры

// Серверная процедура для вызова из клиента
&НаСервере
Процедура ВыполнитьВыгрузкуНоменклатурыСХарактеристикамиНаСервере()
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки номенклатуры с характеристиками через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера
	АдресСервера = "http://localhost:9999";
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Отправляем метаданные справочника Номенклатура
	Сообщить("Этап 3: Отправка метаданных справочника 'Номенклатура'...");
	Попытка
		СправочникМетаданных = Метаданные.Справочники["Номенклатура"];
		Если СправочникМетаданных <> Неопределено Тогда
			ОтправитьМетаСправочника(СправочникМетаданных);
		КонецЕсли;
	Исключение
		Сообщить("  → ОШИБКА: Справочник 'Номенклатура' не найден!");
	КонецПопытки;
	
	// Выгружаем номенклатуру с характеристиками
	Сообщить("Этап 4: Выгрузка номенклатуры с характеристиками...");
	ВыгрузитьНоменклатуруСХарактеристиками();
	
	// Завершаем выгрузку
	Сообщить("Этап 5: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка номенклатуры с характеристиками завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Серверная процедура для вызова из клиента
&НаСервере
Процедура ВыполнитьВыгрузкуНоменклатурыНаСервере()
	
	ВыполнитьВыгрузкуНоменклатурыЧерезHTTP();
	
КонецПроцедуры

// Основная процедура для выгрузки номенклатуры через HTTP
Процедура ВыполнитьВыгрузкуНоменклатурыЧерезHTTP() Экспорт
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки номенклатуры через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера
	АдресСервера = "http://localhost:9999";
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем справочник Номенклатура
	Сообщить("Этап 3: Выгрузка справочника 'Номенклатура'...");
	ВыгрузитьСправочникПоИмениЧерезHTTP("Номенклатура");
	
	// Завершаем выгрузку
	Сообщить("Этап 4: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка номенклатуры завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Процедура на клиенте для привязки к кнопке "ВыгрузкаКонтрагентов"
&НаКлиенте
Процедура ВыгрузкаКонтрагентов(Команда)
	
	ВыполнитьВыгрузкуКонтрагентовНаСервере();
	
КонецПроцедуры

// Серверная процедура для вызова из клиента
&НаСервере
Процедура ВыполнитьВыгрузкуКонтрагентовНаСервере()
	
	ВыполнитьВыгрузкуКонтрагентовЧерезHTTP();
	
КонецПроцедуры

// Основная процедура для выгрузки контрагентов через HTTP
Процедура ВыполнитьВыгрузкуКонтрагентовЧерезHTTP() Экспорт
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки контрагентов через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера
	АдресСервера = "http://localhost:9999";
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем справочник Контрагенты
	Сообщить("Этап 3: Выгрузка справочника 'Контрагенты'...");
	ВыгрузитьСправочникПоИмениЧерезHTTP("Контрагенты");
	
	// Завершаем выгрузку
	Сообщить("Этап 4: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка контрагентов завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Выгрузка справочника по имени через HTTP
Процедура ВыгрузитьСправочникПоИмениЧерезHTTP(ИмяСправочника)
	
	Сообщить("  → Начинаем выгрузку справочника: " + ИмяСправочника);
	
	// Получаем метаданные справочника
	Попытка
		СправочникМетаданных = Метаданные.Справочники[ИмяСправочника];
	Исключение
		Сообщить("  → ОШИБКА: Справочник '" + ИмяСправочника + "' не найден в метаданных!");
		Возврат;
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("  → ОШИБКА: Справочник '" + ИмяСправочника + "' не найден!");
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Справочник '" + ИмяСправочника + "' найден. Начинаем выгрузку...");
	
	// Отправляем метаданные справочника
	ОтправитьМетаСправочника(СправочникМетаданных);
	
	// Выгружаем элементы справочника
	ВыгрузитьЭлементыСправочникаЧерезHTTP(СправочникМетаданных);
	
	Сообщить("  ✓ Выгрузка справочника '" + ИмяСправочника + "' завершена");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПеременные

// Добавляем новые переменные для пакетной выгрузки
Перем ИспользоватьПакетнуюВыгрузку;
Перем РазмерПакета;

// Переменная для хранения идентификатора базы данных
Перем ИдентификаторБазыДанных;

// Переменные для отслеживания прогресса выгрузки (на клиенте)
Перем ОбщееКоличествоОбъектов;
Перем ТекущаяПозиция;
Перем ВыполняетсяВыгрузка;
Перем ТребуетсяПрервать;
Перем ТекущийЭтап;
Перем ТекущийОбъект;

#КонецОбласти

#Область НовыеПроцедурыИФункции

// Обновление настроек из формы
&НаСервере
Процедура ОбновитьНастройкиИзФормы()
	
	// Получаем значения из реквизитов формы
	Попытка
		АдресСервера = Объект.АдресСервера;
		ИспользоватьПакетнуюВыгрузку = Объект.ИспользоватьПакетнуюВыгрузку;
		РазмерПакета = Объект.РазмерПакета;
		ИдентификаторБазыДанных = Объект.ИдентификаторБазыДанных;
	Исключение
		// Если реквизиты не найдены, используем значения по умолчанию
		АдресСервера = "http://localhost:9999";
		ИспользоватьПакетнуюВыгрузку = Истина;
		РазмерПакета = 50;
		ИдентификаторБазыДанных = "";
	КонецПопытки;
	
	// Устанавливаем значения по умолчанию, если они не заданы
	Если АдресСервера = "" Тогда
		АдресСервера = "http://localhost:9999";
	КонецЕсли;
	
	Если РазмерПакета = 0 Тогда
		РазмерПакета = 50;
	КонецЕсли;
	
	Если ИспользоватьПакетнуюВыгрузку = Неопределено Тогда
		ИспользоватьПакетнуюВыгрузку = Истина;
	КонецЕсли;
	
	Если ИдентификаторБазыДанных = Неопределено Тогда
		ИдентификаторБазыДанных = "";
	КонецЕсли;
	
КонецПроцедуры

// Улучшенное рукопожатие с передачей database_id и расширенной информации (с поддержкой fallback на старый API)
&НаСервере
Функция ВыполнитьРукопожатиеСПривязкой()
	
	ОбновитьНастройкиИзФормы();
	
	// Пробуем новый API сначала, если указан database_id
	Если ИдентификаторБазыДанных <> "" Тогда
		URL = АдресСервера + "/api/v1/upload/handshake";
		Сообщить("  → Попытка нового API: " + URL);
		
		// Получаем информацию о системе
		Попытка
			ИмяКомпьютераЗначение = Строка(ИнформацияОКомпьютере().ИмяКомпьютера);
		Исключение
			ИмяКомпьютераЗначение = "";
		КонецПопытки;
		
		Попытка
			ИмяПользователяЗначение = Строка(ИнформацияОПользователе().Имя);
		Исключение
			ИмяПользователяЗначение = "";
		КонецПопытки;
		
		ВерсияКонфигурацииЗначение = ПолучитьВерсиюКонфигурации();
		
		// Создаем XML для рукопожатия с расширенной информацией
		XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
			"<handshake>" +
			"<database_id>" + ЭкранироватьXML(ИдентификаторБазыДанных) + "</database_id>" +
			"<version_1c>" + ЭкранироватьXML(Строка(Версия1С())) + "</version_1c>" +
			"<config_name>" + ЭкранироватьXML(Строка(ИмяКонфигурации())) + "</config_name>";
		
		Если ВерсияКонфигурацииЗначение <> "" Тогда
			XMLСтрока = XMLСтрока + "<config_version>" + ЭкранироватьXML(ВерсияКонфигурацииЗначение) + "</config_version>";
		КонецЕсли;
		
		Если ИмяКомпьютераЗначение <> "" Тогда
			XMLСтрока = XMLСтрока + "<computer_name>" + ЭкранироватьXML(ИмяКомпьютераЗначение) + "</computer_name>";
		КонецЕсли;
		
		Если ИмяПользователяЗначение <> "" Тогда
			XMLСтрока = XMLСтрока + "<user_name>" + ЭкранироватьXML(ИмяПользователяЗначение) + "</user_name>";
		КонецЕсли;
		
		XMLСтрока = XMLСтрока +
			"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
			"</handshake>";
		
		Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
		
		КодСостояния = ПолучитьКодСостояния(Ответ);
		
		// Если новый API работает, используем его
		Если КодСостояния = 200 Тогда
			Сообщить("  → Новый API успешно ответил");
			Возврат ОбработатьОтветРукопожатия(Ответ);
		Иначе
			Сообщить("  → Новый API недоступен (код " + Строка(КодСостояния) + "), пробуем старый...");
		КонецЕсли;
	КонецЕсли;
	
	// Если новый API не доступен или database_id не указан, пробуем старый
	URL = АдресСервера + "/handshake";
	Сообщить("  → Использование старого API: " + URL);
	
	// Упрощенный XML для старого API
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<handshake>" +
		"<version_1c>" + ЭкранироватьXML(Строка(Версия1С())) + "</version_1c>" +
		"<config_name>" + ЭкранироватьXML(Строка(ИмяКонфигурации())) + "</config_name>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</handshake>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("  → Старый API успешно ответил");
		Возврат ОбработатьОтветРукопожатия(Ответ);
	Иначе
		Сообщить("  → ОШИБКА: Оба API недоступны (код " + Строка(КодСостояния) + ")");
		ТелоОтвета = ПолучитьТелоОтвета(Ответ);
		Если ТелоОтвета <> "" Тогда
			Сообщить("  → Тело ответа: " + ТелоОтвета);
		КонецЕсли;
		Возврат "";
	КонецЕсли;
	
КонецФункции

// Обработка ответа рукопожатия (общая для старого и нового API)
&НаСервере
Функция ОбработатьОтветРукопожатия(Ответ)
	
	ТелоОтвета = ПолучитьТелоОтвета(Ответ);
	
	// Извлекаем UUID из XML ответа
	UUIDВыгрузки = ИзвлечьЗначениеИзXML(ТелоОтвета, "upload_uuid");
	
	Если UUIDВыгрузки = "" Тогда
		Сообщить("  → ОШИБКА: UUID не найден в ответе сервера");
		Возврат "";
	КонецЕсли;
	
	Сообщить("  → UUID получен: " + UUIDВыгрузки);
	
	// Пробуем получить расширенную информацию (только для нового API)
	ИмяКлиента = ИзвлечьЗначениеИзXML(ТелоОтвета, "client_name");
	ИмяПроекта = ИзвлечьЗначениеИзXML(ТелоОтвета, "project_name");
	ИмяБазы = ИзвлечьЗначениеИзXML(ТелоОтвета, "database_name");
	
	Если ИмяКлиента <> "" Тогда
		ОбновитьИнформациюОБазе(ИмяКлиента, ИмяПроекта, ИмяБазы);
		Сообщить("  → Привязка: " + ИмяКлиента + " / " + ИмяПроекта + " / " + ИмяБазы);
	КонецЕсли;
	
	Возврат UUIDВыгрузки;
	
КонецФункции

// Обновление информации о базе данных на форме
&НаСервере
Процедура ОбновитьИнформациюОБазе(ИмяКлиента, ИмяПроекта, ИмяБазы)
	
	Попытка
		Объект.ИмяКлиента = ИмяКлиента;
		Объект.ИмяПроекта = ИмяПроекта;
		Объект.ИмяБазыДанных = ИмяБазы;
	Исключение
		// Если реквизиты формы не найдены, просто логируем
		Сообщить("  → Информация о базе: " + ИмяКлиента + " / " + ИмяПроекта + " / " + ИмяБазы);
	КонецПопытки;
	
КонецПроцедуры

// Отправка пакета элементов справочника
&НаСервере
Процедура ОтправитьПакетЭлементовСправочника(ИмяСправочника, МассивЭлементов)
	
	URL = АдресСервера + "/catalog/items";
	
	// Создаем XML для пакета элементов
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<catalog_items>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<catalog_name>" + ЭкранироватьXML(ИмяСправочника) + "</catalog_name>" +
		"<items>";
	
	Для Каждого Элемент Из МассивЭлементов Цикл
		XMLСтрока = XMLСтрока + 
			"<item>" +
			"<reference>" + ЭкранироватьXML(Элемент.Ссылка) + "</reference>" +
			"<code>" + ЭкранироватьXML(Элемент.Код) + "</code>" +
			"<name>" + ЭкранироватьXML(Элемент.Наименование) + "</name>" +
			"<attributes>" + Элемент.РеквизитыXML + "</attributes>" +
			"<table_parts>" + Элемент.ТабличныеЧастиXML + "</table_parts>" +
			"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
			"</item>";
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</items></catalog_items>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("      ✓ Пакет элементов справочника '" + ИмяСправочника + "' отправлен. Количество: " + Строка(МассивЭлементов.Количество()));
	Иначе
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("      → ОШИБКА отправки пакета элементов справочника '" + ИмяСправочника + "': " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Выгрузка справочника контрагентов с пакетной отправкой
&НаСервере
Процедура ВыгрузитьСправочникКонтрагентовПакетами()
	
	Сообщить("  → Начинаем пакетную выгрузку контрагентов...");
	
	// Находим справочник контрагентов
	Попытка
		СправочникМетаданных = Метаданные.Справочники["Контрагенты"];
	Исключение
		СправочникМетаданных = Неопределено;
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("  → Справочник 'Контрагенты' не найден!");
		Возврат;
	КонецЕсли;
	
	// Отправляем метаданные
	ОтправитьМетаСправочника(СправочникМетаданных);
	
	// Получаем все элементы контрагентов
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Контрагенты.Ссылка,
		|	Контрагенты.Код,
		|	Контрагенты.Наименование
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|ГДЕ
		|	НЕ Контрагенты.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса для справочника 'Контрагенты': " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	МассивЭлементов = Новый Массив;
	Счетчик = 0;
	ВсегоВыгружено = 0;
	
	Пока Выборка.Следующий() Цикл
		
		// Получаем реквизиты и табличные части
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, "Контрагенты");
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, "Контрагенты");
		
		// Создаем структуру элемента
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", Строка(Выборка.Ссылка));
		Элемент.Вставить("Код", Строка(Выборка.Код));
		Элемент.Вставить("Наименование", Строка(Выборка.Наименование));
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", ТабличныеЧастиXML);
		
		МассивЭлементов.Добавить(Элемент);
		Счетчик = Счетчик + 1;
		
		// Отправляем пакет при достижении размера
		Если ИспользоватьПакетнуюВыгрузку И Счетчик >= РазмерПакета Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
			ВсегоВыгружено = ВсегоВыгружено + МассивЭлементов.Количество();
			Сообщить("  → Отправлен пакет: " + Строка(МассивЭлементов.Количество()) + " элементов");
			МассивЭлементов = Новый Массив;
			Счетчик = 0;
		КонецЕсли;
		
	КонецЦикла;
	
	// Отправляем оставшиеся элементы
	Если МассивЭлементов.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
			ВсегоВыгружено = ВсегоВыгружено + МассивЭлементов.Количество();
			Сообщить("  → Отправлен последний пакет: " + Строка(МассивЭлементов.Количество()) + " элементов");
		Иначе
			// Поштучная отправка
			Для Каждого Элемент Из МассивЭлементов Цикл
				ОтправитьЭлементСправочника(
					СправочникМетаданных.Имя,
					Элемент.Ссылка,
					Элемент.Код,
					Элемент.Наименование,
					Элемент.РеквизитыXML,
					Элемент.ТабличныеЧастиXML
				);
				ВсегоВыгружено = ВсегоВыгружено + 1;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Сообщить("  ✓ Выгрузка контрагентов завершена: " + Строка(ВсегоВыгружено) + " элементов");
	
КонецПроцедуры

// Выгрузка номенклатуры с характеристиками в JSON файл
&НаСервере
Процедура ВыгрузитьНоменклатуруСХарактеристикамиВФайлНаСервере()
	
	Если Объект.ПутьКФайлу = "" Тогда
		ВызватьИсключение "Не выбран каталог для сохранения файла";
	КонецЕсли;
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.ПроверятьСтруктуру = Ложь;
	ЗаписьJSON.ОткрытьФайл(Объект.ПутьКФайлу);
	
	ЗаписьJSON.ЗаписатьНачалоМассива();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТоварыНаСкладах.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладах.Характеристика КАК Характеристика
		|ПОМЕСТИТЬ ВТ_Товары
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах КАК ТоварыНаСкладах
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЕСТЬNULL(ВТ_Товары.Номенклатура.Код, """") КАК НоменклатураКод,
		|	ЕСТЬNULL(ВТ_Товары.Номенклатура.Наименование, """") КАК НоменклатураНаименование,
		|	ЕСТЬNULL(ВТ_Товары.Характеристика.Наименование, """") КАК НаименованиеХарактеристики
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Исключение
		ЗаписьJSON.Закрыть();
		ВызватьИсключение "Ошибка выполнения запроса: " + ОписаниеОшибки();
	КонецПопытки;
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		
		ЗаписьJSON.ЗаписатьИмяСвойства("НоменклатураКод");
		ЗаписьJSON.ЗаписатьЗначение(ВыборкаДетальныеЗаписи.НоменклатураКод);              
		ЗаписьJSON.ЗаписатьИмяСвойства("НоменклатураНаименование");
		ЗаписьJSON.ЗаписатьЗначение(ВыборкаДетальныеЗаписи.НоменклатураНаименование);              
		ЗаписьJSON.ЗаписатьИмяСвойства("НаименованиеХарактеристики");
		ЗаписьJSON.ЗаписатьЗначение(ВыборкаДетальныеЗаписи.НаименованиеХарактеристики);              
		
		ЗаписьJSON.ЗаписатьКонецОбъекта();	
	КонецЦикла;
	
	ЗаписьJSON.ЗаписатьКонецМассива();
	ЗаписьJSON.Закрыть();
	
КонецПроцедуры

// Вспомогательная функция для получения имени компьютера
&НаСервере
Функция ИмяКомпьютера()
	
	Попытка
		Возврат Строка(ИнформацияОКомпьютере().ИмяКомпьютера);
	Исключение
		Возврат "Unknown";
	КонецПопытки;
	
КонецФункции

// Клиентские процедуры для работы с формой
&НаКлиенте
Процедура ВыбратьКаталог(Команда)
	
	ДиалогОткрытия = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога); 
	Если ДиалогОткрытия.Выбрать() Тогда
		Объект.ПутьКФайлу = ДиалогОткрытия.Каталог + "\ВыгрузкаНоменклатурыСХарактеристиками_" + ИмяКомпьютера() + ".json";
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыгрузитьНоменклатуруВJSON(Команда)
	
	Если Объект.ПутьКФайлу = "" Тогда
		Сообщить("Выберите каталог для файла");
		Возврат;
	КонецЕсли;
	
	ВыгрузитьНоменклатуруСХарактеристикамиВФайлНаСервере();
	Сообщить("Выгрузка в JSON завершена: " + Объект.ПутьКФайлу);
	
КонецПроцедуры

// Модифицированная процедура выгрузки контрагентов
&НаСервере
Процедура ВыполнитьВыгрузкуКонтрагентовНаСервере()
	
	ОбновитьНастройкиИзФормы();
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки контрагентов");
	Сообщить("============================================");
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем константы (опционально, можно пропустить)
	Сообщить("Этап 3: Выгрузка констант...");
	ВыгрузитьКонстантыЧерезHTTP();
	
	// Выгружаем только контрагентов пакетами
	Сообщить("Этап 4: Выгрузка справочника контрагентов...");
	ВыгрузитьСправочникКонтрагентовПакетами();
	
	// Завершаем выгрузку
	Сообщить("Этап 5: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка контрагентов завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Модифицированная процедура выгрузки номенклатуры с характеристиками через HTTP
&НаСервере
Процедура ВыполнитьВыгрузкуНоменклатурыНаСервере()
	
	ОбновитьНастройкиИзФормы();
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки номенклатуры с характеристиками");
	Сообщить("============================================");
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Отправляем метаданные справочника Номенклатура
	Сообщить("Этап 3: Отправка метаданных справочника 'Номенклатура'...");
	Попытка
		СправочникМетаданных = Метаданные.Справочники["Номенклатура"];
		Если СправочникМетаданных <> Неопределено Тогда
			ОтправитьМетаСправочника(СправочникМетаданных);
		КонецЕсли;
	Исключение
		Сообщить("  → ОШИБКА: Справочник 'Номенклатура' не найден!");
	КонецПопытки;
	
	// Выгружаем номенклатуру с характеристиками
	Сообщить("Этап 4: Выгрузка номенклатуры с характеристиками...");
	ВыгрузитьНоменклатуруСХарактеристикамиЧерезHTTP();
	
	// Завершаем выгрузку
	Сообщить("Этап 5: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка номенклатуры завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Модифицированная процедура выгрузки номенклатуры с характеристиками с поддержкой пакетной отправки
Процедура ВыгрузитьНоменклатуруСХарактеристикамиЧерезHTTP()
	
	Сообщить("      → Выгружаем номенклатуру с характеристиками...");
	
	// Используем запрос для получения комбинаций номенклатура+характеристика из регистра
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТоварыНаСкладах.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладах.Характеристика КАК Характеристика
		|ПОМЕСТИТЬ ВТ_Товары
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах КАК ТоварыНаСкладах
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Товары.Номенклатура КАК Номенклатура,
		|	ВТ_Товары.Характеристика КАК Характеристика,
		|	ВТ_Товары.Номенклатура.Код КАК КодНоменклатуры,
		|	ВТ_Товары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
		|	ВТ_Товары.Характеристика.Наименование КАК НаименованиеХарактеристики
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Счетчик = 0;
	МассивЭлементов = Новый Массив;
	
	Пока Выборка.Следующий() Цикл
		
		Счетчик = Счетчик + 1;
		
		// Формируем уникальный код для комбинации номенклатура+характеристика
		УникальныйКод = Выборка.КодНоменклатуры + "_" + Строка(Счетчик);
		УникальноеНаименование = Выборка.НаименованиеНоменклатуры;
		Если Выборка.Характеристика <> Неопределено Тогда
			УникальноеНаименование = УникальноеНаименование + " " + Выборка.НаименованиеХарактеристики;
		КонецЕсли;
		
		// Получаем реквизиты номенклатуры
		РеквизитыXML = "";
		Если Выборка.Номенклатура <> Неопределено Тогда
			РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Номенклатура, "Номенклатура");
		КонецЕсли;
		
		// Добавляем характеристику в реквизиты
		Если Выборка.Характеристика <> Неопределено Тогда
			РеквизитыXML = РеквизитыXML + "<Характеристика>" + ЭкранироватьXML(Выборка.НаименованиеХарактеристики) + "</Характеристика>";
			РеквизитыXML = РеквизитыXML + "<СсылкаХарактеристика>" + ЭкранироватьXML(Строка(Выборка.Характеристика)) + "</СсылкаХарактеристика>";
		КонецЕсли;
		
		// Создаем элемент для отправки
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", УникальныйКод);
		Элемент.Вставить("Код", УникальныйКод);
		Элемент.Вставить("Наименование", УникальноеНаименование);
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", "");
		
		МассивЭлементов.Добавить(Элемент);
		
		// Отправляем пакет при достижении размера
		Если ИспользоватьПакетнуюВыгрузку И МассивЭлементов.Количество() >= РазмерПакета Тогда
			ОтправитьПакетЭлементовСправочника("НоменклатураСХарактеристиками", МассивЭлементов);
			Сообщить("  → Отправлен пакет номенклатуры: " + Строка(МассивЭлементов.Количество()) + " элементов");
			МассивЭлементов = Новый Массив;
		КонецЕсли;
		
	КонецЦикла;
	
	// Отправляем оставшиеся элементы
	Если МассивЭлементов.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетЭлементовСправочника("НоменклатураСХарактеристиками", МассивЭлементов);
			Сообщить("  → Отправлен последний пакет номенклатуры: " + Строка(МассивЭлементов.Количество()) + " элементов");
		Иначе
			// Поштучная отправка
			Для Каждого Элемент Из МассивЭлементов Цикл
				ОтправитьЭлементСправочника(
					"НоменклатураСХарактеристиками",
					Элемент.Ссылка,
					Элемент.Код,
					Элемент.Наименование,
					Элемент.РеквизитыXML,
					Элемент.ТабличныеЧастиXML
				);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Сообщить("  ✓ Выгружено комбинаций номенклатура+характеристика: " + Строка(Счетчик));
	
КонецПроцедуры

// Получение универсального запроса номенклатуры (встроенная версия для совместимости)
&НаСервере
Функция ПолучитьУниверсальныйЗапросНоменклатуры()
	
	Возврат 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ХарактеристикиНоменклатуры.Ссылка КАК СсылкаХарактеристики,
	|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
	|			И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ХарактеристикиНоменклатуры.Ссылка КАК СсылкаХарактеристики,
	|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО Номенклатура.ВидНоменклатуры = ХарактеристикиНоменклатуры.Владелец
	|			И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК СсылкаХарактеристики,
	|	ВЫРАЗИТЬ(NULL КАК СТРОКА(1)) КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
	|				И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
	|			ИЛИ Номенклатура.ВидНоменклатуры = ХарактеристикиНоменклатуры.Владелец
	|				И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|
	|УПОРЯДОЧИТЬ ПО
	|	НаименованиеНоменклатуры,
	|	НаименованиеХарактеристики";
	
КонецФункции

// Универсальная выгрузка номенклатуры с характеристиками (использует универсальный запрос)
&НаСервере
Процедура ВыгрузитьНоменклатуруУниверсально()
	
	Сообщить("=== УНИВЕРСАЛЬНАЯ ВЫГРУЗКА НОМЕНКЛАТУРЫ С ХАРАКТЕРИСТИКАМИ ===");
	
	ОбновитьНастройкиИзФормы();
	
	// Используем универсальный запрос
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьУниверсальныйЗапросНоменклатуры();
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	МассивПакета = Новый Массив;
	Счетчик = 0;
	ВсегоВыгружено = 0;
	
	Пока Выборка.Следующий() Цикл
		
		Счетчик = Счетчик + 1;
		
		// Формируем уникальный идентификатор для комбинации
		УникальныйИдентификатор = Строка(Выборка.СсылкаНоменклатуры);
		Если ЗначениеЗаполнено(Выборка.СсылкаХарактеристики) Тогда
			УникальныйИдентификатор = УникальныйИдентификатор + "|" + Строка(Выборка.СсылкаХарактеристики);
		КонецЕсли;
		
		// Получаем все реквизиты номенклатуры
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.СсылкаНоменклатуры, "Номенклатура");
		
		// Добавляем информацию о характеристике
		Если ЗначениеЗаполнено(Выборка.СсылкаХарактеристики) Тогда
			РеквизитыXML = РеквизитыXML + "<Характеристика_Код>" + ЭкранироватьXML(Строка(Выборка.СсылкаХарактеристики.Код)) + "</Характеристика_Код>";
			РеквизитыXML = РеквизитыXML + "<Характеристика_Наименование>" + ЭкранироватьXML(Выборка.НаименованиеХарактеристики) + "</Характеристика_Наименование>";
			РеквизитыXML = РеквизитыXML + "<Характеристика_Ссылка>" + ЭкранироватьXML(Строка(Выборка.СсылкаХарактеристики)) + "</Характеристика_Ссылка>";
		КонецЕсли;
		
		// Формируем составное наименование
		СоставноеНаименование = Выборка.НаименованиеНоменклатуры;
		Если ЗначениеЗаполнено(Выборка.НаименованиеХарактеристики) Тогда
			СоставноеНаименование = СоставноеНаименование + " " + Выборка.НаименованиеХарактеристики;
		КонецЕсли;
		
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", УникальныйИдентификатор);
		Элемент.Вставить("Код", Выборка.КодНоменклатуры);
		Элемент.Вставить("Наименование", СоставноеНаименование);
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", "");
		Элемент.Вставить("НоменклатураСсылка", Строка(Выборка.СсылкаНоменклатуры));
		Элемент.Вставить("НоменклатураКод", Выборка.КодНоменклатуры);
		Элемент.Вставить("НоменклатураНаименование", Выборка.НаименованиеНоменклатуры);
		Если ЗначениеЗаполнено(Выборка.СсылкаХарактеристики) Тогда
			Элемент.Вставить("ХарактеристикаСсылка", Строка(Выборка.СсылкаХарактеристики));
			Элемент.Вставить("ХарактеристикаНаименование", Выборка.НаименованиеХарактеристики);
		Иначе
			Элемент.Вставить("ХарактеристикаСсылка", "");
			Элемент.Вставить("ХарактеристикаНаименование", "");
		КонецЕсли;
		
		МассивПакета.Добавить(Элемент);
		
		// Отправляем пакет при достижении лимита
		Если ИспользоватьПакетнуюВыгрузку И МассивПакета.Количество() >= РазмерПакета Тогда
			ОтправитьПакетНоменклатуры(МассивПакета);
			ВсегоВыгружено = ВсегоВыгружено + МассивПакета.Количество();
			Сообщить("  → Отправлен пакет: " + Строка(МассивПакета.Количество()) + " элементов");
			МассивПакета = Новый Массив;
		КонецЕсли;
		
	КонецЦикла;
	
	// Отправляем оставшиеся элементы
	Если МассивПакета.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетНоменклатуры(МассивПакета);
			ВсегоВыгружено = ВсегоВыгружено + МассивПакета.Количество();
			Сообщить("  → Отправлен последний пакет: " + Строка(МассивПакета.Количество()) + " элементов");
		Иначе
			// Поштучная отправка
			Для Каждого Элемент Из МассивПакета Цикл
				ОтправитьЭлементНоменклатуры(Элемент);
				ВсегоВыгружено = ВсегоВыгружено + 1;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Сообщить("  ✓ Выгружено комбинаций номенклатура+характеристика: " + Строка(ВсегоВыгружено));
	
КонецПроцедуры

// Пакетная отправка номенклатуры
&НаСервере
Процедура ОтправитьПакетНоменклатуры(МассивЭлементов)
	
	URL = АдресСервера + "/api/v1/upload/nomenclature/batch";
	
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<nomenclature_batch>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>";
	
	// Добавляем database_id, если он указан
	Попытка
		Если Объект.ИдентификаторБазыДанных <> "" Тогда
			XMLСтрока = XMLСтрока + "<database_id>" + ЭкранироватьXML(Объект.ИдентификаторБазыДанных) + "</database_id>";
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	XMLСтрока = XMLСтрока + "<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>";
	
	Для Каждого Элемент Из МассивЭлементов Цикл
		XMLСтрока = XMLСтрока + 
			"<item>" +
			"<nomenclature_reference>" + ЭкранироватьXML(Элемент.НоменклатураСсылка) + "</nomenclature_reference>" +
			"<nomenclature_code>" + ЭкранироватьXML(Элемент.НоменклатураКод) + "</nomenclature_code>" +
			"<nomenclature_name>" + ЭкранироватьXML(Элемент.НоменклатураНаименование) + "</nomenclature_name>";
		
		Если Элемент.ХарактеристикаСсылка <> "" Тогда
			XMLСтрока = XMLСтрока + 
				"<characteristic_reference>" + ЭкранироватьXML(Элемент.ХарактеристикаСсылка) + "</characteristic_reference>" +
				"<characteristic_name>" + ЭкранироватьXML(Элемент.ХарактеристикаНаименование) + "</characteristic_name>";
		КонецЕсли;
		
		XMLСтрока = XMLСтрока + 
			"<attributes>" + Элемент.РеквизитыXML + "</attributes>" +
			"<table_parts>" + Элемент.ТабличныеЧастиXML + "</table_parts>" +
			"</item>";
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</nomenclature_batch>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Ответ.КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			ТелоОтветаОшибка = "Не удалось получить тело ответа";
		КонецПопытки;
		Сообщить("ОШИБКА отправки пакета номенклатуры: " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Отправка одного элемента номенклатуры
&НаСервере
Процедура ОтправитьЭлементНоменклатуры(Элемент)
	
	URL = АдресСервера + "/api/v1/upload/nomenclature/batch";
	
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<nomenclature_batch>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"<item>" +
		"<nomenclature_reference>" + ЭкранироватьXML(Элемент.НоменклатураСсылка) + "</nomenclature_reference>" +
		"<nomenclature_code>" + ЭкранироватьXML(Элемент.НоменклатураКод) + "</nomenclature_code>" +
		"<nomenclature_name>" + ЭкранироватьXML(Элемент.НоменклатураНаименование) + "</nomenclature_name>";
	
	Если Элемент.ХарактеристикаСсылка <> "" Тогда
		XMLСтрока = XMLСтрока + 
			"<characteristic_reference>" + ЭкранироватьXML(Элемент.ХарактеристикаСсылка) + "</characteristic_reference>" +
			"<characteristic_name>" + ЭкранироватьXML(Элемент.ХарактеристикаНаименование) + "</characteristic_name>";
	КонецЕсли;
	
	XMLСтрока = XMLСтрока + 
		"<attributes>" + Элемент.РеквизитыXML + "</attributes>" +
		"<table_parts>" + Элемент.ТабличныеЧастиXML + "</table_parts>" +
		"</item>" +
		"</nomenclature_batch>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	Если Ответ.КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			ТелоОтветаОшибка = "Не удалось получить тело ответа";
		КонецПопытки;
		Сообщить("ОШИБКА отправки элемента номенклатуры: " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Получение статистики по номенклатуре (использует универсальный запрос)
&НаСервере
Функция ПолучитьСтатистикуНоменклатуры()
	
	Сообщить("=== ПОЛУЧЕНИЕ СТАТИСТИКИ НОМЕНКЛАТУРЫ ===");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК ВсегоКомбинаций,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СсылкаНоменклатуры) КАК ВсегоНоменклатур,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СсылкаХарактеристики) КАК ВсегоХарактеристик
	|ИЗ
	|	(" + ПолучитьУниверсальныйЗапросНоменклатуры() + ")";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
		
		Если Выборка.Следующий() Тогда
			Статистика = Новый Структура;
			Статистика.Вставить("ВсегоКомбинаций", Выборка.ВсегоКомбинаций);
			Статистика.Вставить("ВсегоНоменклатур", Выборка.ВсегоНоменклатур);
			Статистика.Вставить("ВсегоХарактеристик", Выборка.ВсегоХарактеристик);
			
			Сообщить("  Всего комбинаций: " + Строка(Выборка.ВсегоКомбинаций));
			Сообщить("  Всего номенклатур: " + Строка(Выборка.ВсегоНоменклатур));
			Сообщить("  Всего характеристик: " + Строка(Выборка.ВсегоХарактеристик));
			
			Возврат Статистика;
		КонецЕсли;
	Исключение
		Сообщить("ОШИБКА получения статистики: " + ОписаниеОшибки());
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Проверка соединения с сервером
&НаСервере
Функция ПроверитьСоединение()
	
	ОбновитьНастройкиИзФормы();
	
	Попытка
		// Пробуем новый API сначала
		URL = АдресСервера + "/api/v1/health";
		Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			Сообщить("✓ Соединение с сервером установлено (новый API)");
			Возврат Истина;
		КонецЕсли;
		
		// Если новый API не доступен, пробуем старый
		URL = АдресСервера + "/handshake";
		XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?><handshake><timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp></handshake>";
		Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			Сообщить("✓ Соединение с сервером установлено (старый API)");
			Возврат Истина;
		КонецЕсли;
		
		Сообщить("✗ Ошибка соединения с сервером");
		Возврат Ложь;
	Исключение
		Сообщить("✗ Ошибка соединения: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Проверка привязки базы данных
&НаСервере
Функция ПроверитьПривязкуБазыДанных()
	
	ОбновитьНастройкиИзФормы();
	
	Если ИдентификаторБазыДанных = "" Тогда
		Сообщить("✗ Не указан идентификатор базы данных");
		Возврат "Не указан идентификатор базы данных";
	КонецЕсли;
	
	Попытка
		URL = АдресСервера + "/api/v1/databases/" + ИдентификаторБазыДанных;
		Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			ТелоОтвета = ПолучитьТелоОтвета(Ответ);
			ИмяКлиента = ИзвлечьЗначениеИзXML(ТелоОтвета, "client_name");
			ИмяПроекта = ИзвлечьЗначениеИзXML(ТелоОтвета, "project_name");
			ИмяБазы = ИзвлечьЗначениеИзXML(ТелоОтвета, "database_name");
			
			Если ИмяКлиента <> "" Тогда
				ОбновитьИнформациюОБазе(ИмяКлиента, ИмяПроекта, ИмяБазы);
				Результат = "✓ Привязка успешна: " + ИмяКлиента + " / " + ИмяПроекта + " / " + ИмяБазы;
				Сообщить(Результат);
				Возврат Результат;
			Иначе
				Сообщить("✗ База данных найдена, но информация о клиенте/проекте отсутствует");
				Возврат "База данных найдена, но информация о клиенте/проекте отсутствует";
			КонецЕсли;
		Иначе
			ТелоОтвета = ПолучитьТелоОтвета(Ответ);
			Результат = "✗ Ошибка привязки: " + ТелоОтвета;
			Сообщить(Результат);
			Возврат Результат;
		КонецЕсли;
	Исключение
		Результат = "✗ Ошибка соединения с сервером: " + ОписаниеОшибки();
		Сообщить(Результат);
		Возврат Результат;
	КонецПопытки;
	
КонецФункции

// Получение статуса выгрузки с сервера
&НаСервере
Функция ПолучитьСтатусВыгрузки()
	
	ОбновитьНастройкиИзФормы();
	
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("Выгрузка не начата");
		Возврат "Выгрузка не начата";
	КонецЕсли;
	
	Попытка
		URL = АдресСервера + "/api/v1/upload/" + ИдентификаторВыгрузки + "/status";
		Ответ = ОтправитьHTTPЗапрос("GET", URL, "");
		
		Если ПолучитьКодСостояния(Ответ) = 200 Тогда
			ТелоОтвета = ПолучитьТелоОтвета(Ответ);
			Статус = ИзвлечьЗначениеИзXML(ТелоОтвета, "status");
			Прогресс = ИзвлечьЗначениеИзXML(ТелоОтвета, "progress");
			Результат = "Статус: " + Статус + ", Прогресс: " + Прогресс + "%";
			Сообщить(Результат);
			Возврат Результат;
		Иначе
			Результат = "Не удалось получить статус (код " + Строка(ПолучитьКодСостояния(Ответ)) + ")";
			Сообщить(Результат);
			Возврат Результат;
		КонецЕсли;
	Исключение
		Результат = "Ошибка получения статуса: " + ОписаниеОшибки();
		Сообщить(Результат);
		Возврат Результат;
	КонецПопытки;
	
КонецФункции

// Клиентские процедуры для новых кнопок

// Выгрузка номенклатуры универсальным методом
&НаКлиенте
Процедура ВыгрузитьНоменклатуруУниверсально(Команда)
	
	ВыполнитьВыгрузкуНоменклатурыУниверсальноНаСервере();
	
КонецПроцедуры

// Серверная процедура для универсальной выгрузки номенклатуры
&НаСервере
Процедура ВыполнитьВыгрузкуНоменклатурыУниверсальноНаСервере()
	
	Сообщить("============================================");
	Сообщить("Начало универсальной выгрузки номенклатуры с характеристиками");
	Сообщить("============================================");
	
	ОбновитьНастройкиИзФормы();
	
	// Выполняем рукопожатие с привязкой к базе данных
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатиеСПривязкой();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем номенклатуру универсальным методом
	Сообщить("Этап 3: Выгрузка номенклатуры с характеристиками...");
	ВыгрузитьНоменклатуруУниверсально();
	
	// Завершаем выгрузку
	Сообщить("Этап 4: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Универсальная выгрузка номенклатуры завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Получение статистики по номенклатуре
&НаКлиенте
Процедура ПолучитьСтатистику(Команда)
	
	Статистика = ПолучитьСтатистикуНоменклатурыНаСервере();
	
	Если Статистика = Неопределено Тогда
		Сообщить("Не удалось получить статистику по номенклатуре");
		Возврат;
	КонецЕсли;
	
	Сообщить("============================================");
	Сообщить("СТАТИСТИКА ПО НОМЕНКЛАТУРЕ");
	Сообщить("============================================");
	Сообщить("Всего комбинаций номенклатура+характеристика: " + Строка(Статистика.ВсегоКомбинаций));
	Сообщить("Всего номенклатур: " + Строка(Статистика.ВсегоНоменклатур));
	Сообщить("Всего характеристик: " + Строка(Статистика.ВсегоХарактеристик));
	Сообщить("============================================");
	
КонецПроцедуры

// Серверная процедура для получения статистики
&НаСервере
Функция ПолучитьСтатистикуНоменклатурыНаСервере()
	
	Возврат ПолучитьСтатистикуНоменклатуры();
	
КонецФункции

// Проверка соединения
&НаКлиенте
Процедура ПроверитьСоединение(Команда)
	
	Если ПроверитьСоединениеНаСервере() Тогда
		Сообщить("✓ Соединение с сервером установлено");
	Иначе
		Сообщить("✗ Ошибка соединения с сервером");
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПроверитьСоединениеНаСервере()
	
	Возврат ПроверитьСоединение();
	
КонецФункции

// Проверка привязки
&НаКлиенте
Процедура ПроверитьПривязку(Команда)
	
	Результат = ПроверитьПривязкуНаСервере();
	Сообщить(Результат);
	
КонецПроцедуры

&НаСервере
Функция ПроверитьПривязкуНаСервере()
	
	Возврат ПроверитьПривязкуБазыДанных();
	
КонецФункции

// Получение статуса выгрузки
&НаКлиенте
Процедура ПолучитьСтатусВыгрузки(Команда)
	
	Результат = ПолучитьСтатусВыгрузкиНаСервере();
	Сообщить(Результат);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьСтатусВыгрузкиНаСервере()
	
	Возврат ПолучитьСтатусВыгрузки();
	
КонецФункции

#КонецОбласти

#Область РаботаСПрогрессом

// Получение общего количества объектов для выгрузки
&НаСервере
Функция ПолучитьОбщееКоличествоОбъектов(ТипВыгрузки) Экспорт
	
	ОбщееКоличество = 0;
	
	Если ТипВыгрузки = "Все" Тогда
		// Подсчитываем константы
		КоллекцияКонстант = Метаданные.Константы;
		ОбщееКоличество = ОбщееКоличество + КоллекцияКонстант.Количество();
		
		// Подсчитываем справочники
		КоллекцияСправочников = Метаданные.Справочники;
		Для Каждого СправочникМетаданных Из КоллекцияСправочников Цикл
			Попытка
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоЭлементов ИЗ Справочник." + СправочникМетаданных.Имя + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
				Результат = Запрос.Выполнить();
				Выборка = Результат.Выбрать();
				Если Выборка.Следующий() Тогда
					ОбщееКоличество = ОбщееКоличество + Выборка.ВсегоЭлементов;
				КонецЕсли;
			Исключение
				// Пропускаем справочники, для которых не удалось выполнить запрос
			КонецПопытки;
		КонецЦикла;
		
	ИначеЕсли ТипВыгрузки = "Контрагенты" Тогда
		Попытка
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоЭлементов ИЗ Справочник.Контрагенты КАК Контрагенты ГДЕ НЕ Контрагенты.ПометкаУдаления";
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				ОбщееКоличество = Выборка.ВсегоЭлементов;
			КонецЕсли;
		Исключение
			ОбщееКоличество = 0;
		КонецПопытки;
		
	ИначеЕсли ТипВыгрузки = "Номенклатура" Тогда
		Попытка
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоКомбинаций ИЗ (" + ПолучитьУниверсальныйЗапросНоменклатуры() + ")";
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				ОбщееКоличество = Выборка.ВсегоКомбинаций;
			КонецЕсли;
		Исключение
			ОбщееКоличество = 0;
		КонецПопытки;
		
	ИначеЕсли ТипВыгрузки = "Справочники" Тогда
		КоллекцияСправочников = Метаданные.Справочники;
		Для Каждого СправочникМетаданных Из КоллекцияСправочников Цикл
			Попытка
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоЭлементов ИЗ Справочник." + СправочникМетаданных.Имя + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
				Результат = Запрос.Выполнить();
				Выборка = Результат.Выбрать();
				Если Выборка.Следующий() Тогда
					ОбщееКоличество = ОбщееКоличество + Выборка.ВсегоЭлементов;
				КонецЕсли;
			Исключение
				// Пропускаем справочники, для которых не удалось выполнить запрос
			КонецПопытки;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ОбщееКоличество;
	
КонецФункции

// Обработка пакета выгрузки
&НаСервере
Процедура ОбработатьПакетВыгрузки(Параметры, Результат) Экспорт
	
	ТипВыгрузки = Параметры.ТипВыгрузки;
	НачальнаяПозиция = Параметры.НачальнаяПозиция;
	РазмерПакета = Параметры.РазмерПакета;
	Этап = Параметры.Этап;
	
	ОбновитьНастройкиИзФормы();
	
	Результат.НоваяПозиция = НачальнаяПозиция;
	Результат.Обработано = 0;
	Результат.Завершено = Ложь;
	Результат.СледующийЭтап = Этап;
	Результат.ТекущийОбъект = "";
	
	Попытка
		Если Этап = "Рукопожатие" Тогда
			// Рукопожатие выполняется синхронно, не в пакетах
			Результат.Завершено = Истина;
			Результат.СледующийЭтап = "Метаинформация";
			
		ИначеЕсли Этап = "Метаинформация" Тогда
			// Метаинформация выполняется синхронно, не в пакетах
			Результат.Завершено = Истина;
			Результат.СледующийЭтап = "Константы";
			
		ИначеЕсли Этап = "Константы" Тогда
			Результат = ОбработатьПакетКонстант(НачальнаяПозиция, РазмерПакета);
			
		ИначеЕсли Этап = "Справочники" Тогда
			Результат = ОбработатьПакетСправочников(НачальнаяПозиция, РазмерПакета);
			
		ИначеЕсли Этап = "Завершение" Тогда
			// Завершение выполняется синхронно, не в пакетах
			ЗавершитьВыгрузку();
			Результат.Завершено = Истина;
			Результат.СледующийЭтап = "";
			Результат.ТекущийОбъект = "Завершено";
		КонецЕсли;
		
	Исключение
		Результат.Завершено = Истина;
		Результат.СледующийЭтап = "";
		Результат.ТекущийОбъект = "Ошибка: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецПроцедуры

// Обработка пакета констант
&НаСервере
Функция ОбработатьПакетКонстант(НачальнаяПозиция, РазмерПакета)
	
	Результат = Новый Структура;
	Результат.Вставить("НоваяПозиция", НачальнаяПозиция);
	Результат.Вставить("Обработано", 0);
	Результат.Вставить("Завершено", Ложь);
	Результат.Вставить("СледующийЭтап", "Константы");
	Результат.Вставить("ТекущийОбъект", "");
	
	КоллекцияКонстант = Метаданные.Константы;
	ВсегоКонстант = КоллекцияКонстант.Количество();
	
	Если НачальнаяПозиция >= ВсегоКонстант Тогда
		Результат.Завершено = Истина;
		Результат.СледующийЭтап = "Справочники";
		Возврат Результат;
	КонецЕсли;
	
	КонечнаяПозиция = НачальнаяПозиция + РазмерПакета;
	Если КонечнаяПозиция > ВсегоКонстант Тогда
		КонечнаяПозиция = ВсегоКонстант;
	КонецЕсли;
	
	Индекс = 0;
	Для Каждого КонстантаМетаданных Из КоллекцияКонстант Цикл
		Если Индекс >= НачальнаяПозиция И Индекс < КонечнаяПозиция Тогда
			Попытка
				ЗначениеКонстанты = Константы[КонстантаМетаданных.Имя].Получить();
				ТипЗначения = ТипЗнч(ЗначениеКонстанты);
				XMLЗначения = ПолучитьXMLПредставлениеЗначения(ЗначениеКонстанты, Строка(ТипЗначения));
				ОтправитьКонстанту(КонстантаМетаданных.Имя, КонстантаМетаданных.Синоним, Строка(ТипЗначения), XMLЗначения);
				Результат.Обработано = Результат.Обработано + 1;
				Результат.ТекущийОбъект = "Константа: " + КонстантаМетаданных.Имя;
			Исключение
				// Пропускаем константы, которые не удалось обработать
			КонецПопытки;
		КонецЕсли;
		Индекс = Индекс + 1;
	КонецЦикла;
	
	Результат.НоваяПозиция = КонечнаяПозиция;
	Результат.Завершено = (КонечнаяПозиция >= ВсегоКонстант);
	Если Результат.Завершено Тогда
		Результат.СледующийЭтап = "Справочники";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Обработка пакета справочников
&НаСервере
Функция ОбработатьПакетСправочников(НачальнаяПозиция, РазмерПакета)
	
	Результат = Новый Структура;
	Результат.Вставить("НоваяПозиция", НачальнаяПозиция);
	Результат.Вставить("Обработано", 0);
	Результат.Вставить("Завершено", Ложь);
	Результат.Вставить("СледующийЭтап", "Справочники");
	Результат.Вставить("ТекущийОбъект", "");
	
	КоллекцияСправочников = Метаданные.Справочники;
	ВсегоСправочников = КоллекцияСправочников.Количество();
	
	// НачальнаяПозиция здесь - это позиция в общем списке элементов (константы + элементы справочников)
	// Нужно определить, сколько констант уже обработано, чтобы понять, с какого элемента справочников начинать
	КоллекцияКонстант = Метаданные.Константы;
	ВсегоКонстант = КоллекцияКонстант.Количество();
	
	// Если начальная позиция меньше количества констант, значит мы еще обрабатываем константы
	// Это не должно происходить, так как константы обрабатываются отдельно
	// Но на всякий случай проверяем
	Если НачальнаяПозиция < ВсегоКонстант Тогда
		// Это ошибка в логике, но обработаем
		Результат.Завершено = Истина;
		Результат.СледующийЭтап = "Завершение";
		Возврат Результат;
	КонецЕсли;
	
	// Позиция в списке элементов справочников (начинаем с 0)
	ПозицияВЭлементахСправочников = НачальнаяПозиция - ВсегоКонстант;
	
	// Упрощенная логика: обрабатываем справочники по одному
	// НачальнаяПозиция указывает на позицию в общем списке элементов (константы + элементы справочников)
	// Для упрощения обрабатываем один справочник за раз, начиная с нужной позиции
	
	// Находим справочник, с которого нужно начать обработку
	ТекущаяПозицияВЭлементах = 0;
	Обработано = 0;
	НайденНачальныйСправочник = Ложь;
	
	Для Каждого СправочникМетаданных Из КоллекцияСправочников Цикл
		Если Обработано >= РазмерПакета Тогда
			Прервать;
		КонецЕсли;
		
		Попытка
			// Подсчитываем количество элементов в текущем справочнике
			ЗапросПодсчета = Новый Запрос;
			ЗапросПодсчета.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК ВсегоЭлементов ИЗ Справочник." + СправочникМетаданных.Имя + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
			РезультатПодсчета = ЗапросПодсчета.Выполнить();
			ВыборкаПодсчета = РезультатПодсчета.Выбрать();
			КоличествоЭлементов = 0;
			Если ВыборкаПодсчета.Следующий() Тогда
				КоличествоЭлементов = ВыборкаПодсчета.ВсегоЭлементов;
			КонецЕсли;
			
			// Если текущая позиция в элементах меньше позиции начала обработки, пропускаем этот справочник
			Если ТекущаяПозицияВЭлементах + КоличествоЭлементов <= ПозицияВЭлементахСправочников Тогда
				ТекущаяПозицияВЭлементах = ТекущаяПозицияВЭлементах + КоличествоЭлементов;
				Продолжить;
			КонецЕсли;
			
			// Если мы дошли до нужной позиции, начинаем обработку
			Если ТекущаяПозицияВЭлементах <= ПозицияВЭлементахСправочников И ТекущаяПозицияВЭлементах + КоличествоЭлементов > ПозицияВЭлементахСправочников Тогда
				// Отправляем метаданные справочника (только один раз для каждого справочника)
				Если Не НайденНачальныйСправочник Тогда
					ОтправитьМетаСправочника(СправочникМетаданных);
					НайденНачальныйСправочник = Истина;
				КонецЕсли;
				
				Результат.ТекущийОбъект = "Справочник: " + СправочникМетаданных.Имя;
				
				// Обрабатываем элементы справочника, начиная с нужной позиции
				СмещениеВСправочнике = ПозицияВЭлементахСправочников - ТекущаяПозицияВЭлементах;
				ОсталосьОбработать = РазмерПакета - Обработано;
				
				КоличествоОбработанныхВСправочнике = ОбработатьЭлементыСправочникаСоСмещением(СправочникМетаданных, СмещениеВСправочнике, ОсталосьОбработать);
				
				Обработано = Обработано + КоличествоОбработанныхВСправочнике;
				
				// Обновляем позицию: если обработали все элементы справочника, переходим к следующему
				Если КоличествоОбработанныхВСправочнике >= КоличествоЭлементов - СмещениеВСправочнике Тогда
					ТекущаяПозицияВЭлементах = ТекущаяПозицияВЭлементах + КоличествоЭлементов;
				Иначе
					ТекущаяПозицияВЭлементах = ТекущаяПозицияВЭлементах + КоличествоОбработанныхВСправочнике;
				КонецЕсли;
				
				// Если обработали достаточно элементов, выходим
				Если Обработано >= РазмерПакета Тогда
					Прервать;
				КонецЕсли;
				
				// Если обработали все элементы справочника, переходим к следующему
				Если КоличествоОбработанныхВСправочнике >= КоличествоЭлементов - СмещениеВСправочнике Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
			
		Исключение
			// Пропускаем справочники, которые не удалось обработать
			ТекущаяПозицияВЭлементах = ТекущаяПозицияВЭлементах + 1;
		КонецПопытки;
	КонецЦикла;
	
	Результат.Обработано = Обработано;
	Результат.НоваяПозиция = НачальнаяПозиция + Обработано;
	
	// Проверяем, обработаны ли все справочники
	// Для этого нужно подсчитать общее количество элементов во всех справочниках
	ОбщееКоличествоЭлементовСправочников = ПолучитьОбщееКоличествоОбъектов("Справочники");
	Если Результат.НоваяПозиция - ВсегоКонстант >= ОбщееКоличествоЭлементовСправочников Тогда
		Результат.Завершено = Истина;
		Результат.СледующийЭтап = "Завершение";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Обработка элементов справочника с указанным смещением
&НаСервере
Функция ОбработатьЭлементыСправочникаСоСмещением(СправочникМетаданных, Смещение, МаксимальноеКоличество)
	
	ИмяСправочникаВЗапросе = СправочникМетаданных.Имя;
	КоличествоОбработанных = 0;
	
	ОбновитьНастройкиИзФормы();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ Ссылка, Код, Наименование ИЗ Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Возврат 0;
	КонецПопытки;
	
	МассивЭлементов = Новый Массив;
	ТекущийИндекс = 0;
	
	Пока Выборка.Следующий() Цикл
		// Пропускаем элементы до смещения
		Если ТекущийИндекс < Смещение Тогда
			ТекущийИндекс = ТекущийИндекс + 1;
			Продолжить;
		КонецЕсли;
		
		// Если обработали максимальное количество, выходим
		Если КоличествоОбработанных >= МаксимальноеКоличество Тогда
			Прервать;
		КонецЕсли;
		
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, ИмяСправочникаВЗапросе);
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, ИмяСправочникаВЗапросе);
		
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", Строка(Выборка.Ссылка));
		Элемент.Вставить("Код", Строка(Выборка.Код));
		Элемент.Вставить("Наименование", Строка(Выборка.Наименование));
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", ТабличныеЧастиXML);
		
		МассивЭлементов.Добавить(Элемент);
		КоличествоОбработанных = КоличествоОбработанных + 1;
		ТекущийИндекс = ТекущийИндекс + 1;
		
		// Получаем размер пакета из настроек
		Попытка
			ТекущийРазмерПакета = Объект.РазмерПакета;
			Если ТекущийРазмерПакета = 0 Тогда
				ТекущийРазмерПакета = 50;
			КонецЕсли;
		Исключение
			ТекущийРазмерПакета = 50;
		КонецПопытки;
		
		Если ИспользоватьПакетнуюВыгрузку И МассивЭлементов.Количество() >= ТекущийРазмерПакета Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
			МассивЭлементов = Новый Массив;
		КонецЕсли;
	КонецЦикла;
	
	Если МассивЭлементов.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
		Иначе
			Для Каждого Элемент Из МассивЭлементов Цикл
				ОтправитьЭлементСправочника(
					СправочникМетаданных.Имя,
					Элемент.Ссылка,
					Элемент.Код,
					Элемент.Наименование,
					Элемент.РеквизитыXML,
					Элемент.ТабличныеЧастиXML
				);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат КоличествоОбработанных;
	
КонецФункции

// Обработка элементов справочника пакетами (вспомогательная функция)
// Возвращает количество обработанных элементов
&НаСервере
Функция ОбработатьЭлементыСправочникаПакетами(СправочникМетаданных)
	
	ИмяСправочникаВЗапросе = СправочникМетаданных.Имя;
	КоличествоОбработанных = 0;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ Ссылка, Код, Наименование ИЗ Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий ГДЕ НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Возврат 0;
	КонецПопытки;
	
	МассивЭлементов = Новый Массив;
	Счетчик = 0;
	
	Пока Выборка.Следующий() Цикл
		// Проверка прерывания (через глобальную переменную, которая передается через параметры)
		// В данном случае прерывание проверяется на клиенте, поэтому здесь просто обрабатываем
		
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, ИмяСправочникаВЗапросе);
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, ИмяСправочникаВЗапросе);
		
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", Строка(Выборка.Ссылка));
		Элемент.Вставить("Код", Строка(Выборка.Код));
		Элемент.Вставить("Наименование", Строка(Выборка.Наименование));
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", ТабличныеЧастиXML);
		
		МассивЭлементов.Добавить(Элемент);
		Счетчик = Счетчик + 1;
		КоличествоОбработанных = КоличествоОбработанных + 1;
		
		// Получаем размер пакета из настроек
		Попытка
			ТекущийРазмерПакета = Объект.РазмерПакета;
			Если ТекущийРазмерПакета = 0 Тогда
				ТекущийРазмерПакета = 50;
			КонецЕсли;
		Исключение
			ТекущийРазмерПакета = 50;
		КонецПопытки;
		
		Если ИспользоватьПакетнуюВыгрузку И МассивЭлементов.Количество() >= ТекущийРазмерПакета Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
			МассивЭлементов = Новый Массив;
		КонецЕсли;
	КонецЦикла;
	
	Если МассивЭлементов.Количество() > 0 Тогда
		Если ИспользоватьПакетнуюВыгрузку Тогда
			ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
		Иначе
			Для Каждого Элемент Из МассивЭлементов Цикл
				ОтправитьЭлементСправочника(
					СправочникМетаданных.Имя,
					Элемент.Ссылка,
					Элемент.Код,
					Элемент.Наименование,
					Элемент.РеквизитыXML,
					Элемент.ТабличныеЧастиXML
				);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат КоличествоОбработанных;
	
КонецФункции

// Обновление прогресса на форме
&НаКлиенте
Процедура ОбновитьПрогрессНаФорме()
	
	Если ОбщееКоличествоОбъектов > 0 Тогда
		Процент = ТекущаяПозиция / ОбщееКоличествоОбъектов * 100;
		Если Процент > 100 Тогда
			Процент = 100;
		КонецЕсли;
		
		Попытка
			ЭлементыФормы.ИндикаторПрогресса.Значение = Процент;
		Исключение
			// Элемент формы может отсутствовать
		КонецПопытки;
		
		Попытка
			ЭлементыФормы.ПолеСтатуса.Значение = "Обработано " + ТекущаяПозиция + " из " + ОбщееКоличествоОбъектов;
		Исключение
			// Элемент формы может отсутствовать
		КонецПопытки;
	Иначе
		Попытка
			ЭлементыФормы.ИндикаторПрогресса.Значение = 0;
			ЭлементыФормы.ПолеСтатуса.Значение = "";
		Исключение
			// Элемент формы может отсутствовать
		КонецПопытки;
	КонецЕсли;
	
	Попытка
		Если Объект.ТекущийЭтап <> "" Тогда
			ЭлементыФормы.ПолеЭтапа.Значение = Объект.ТекущийЭтап;
		КонецЕсли;
	Исключение
		// Элемент формы может отсутствовать
	КонецПопытки;
	
	Попытка
		Если Объект.ТекущийОбъект <> "" Тогда
			ЭлементыФормы.ПолеТекущегоОбъекта.Значение = Объект.ТекущийОбъект;
		КонецЕсли;
	Исключение
		// Элемент формы может отсутствовать
	КонецПопытки;
	
КонецПроцедуры

// Обработчик события таймера
&НаКлиенте
Процедура ТаймерОбновленияТик(Таймер)
	
	Если ВыполняетсяВыгрузка Тогда
		ОбновитьПрогрессНаФорме();
	КонецЕсли;
	
КонецПроцедуры

// Прерывание выгрузки
&НаКлиенте
Процедура ПрерватьВыгрузку(Команда)
	
	ТребуетсяПрервать = Истина;
	ВыполняетсяВыгрузка = Ложь;
	
	Попытка
		ЭлементыФормы.КнопкаПрервать.Доступность = Ложь;
		ЭлементыФормы.КнопкаВыгрузкаВсего.Доступность = Истина;
	Исключение
		// Элементы формы могут отсутствовать
	КонецПопытки;
	
	Попытка
		ЭлементыФормы.ТаймерОбновления.Enabled = Ложь;
	Исключение
		// Элемент формы может отсутствовать
	КонецПопытки;
	
	Сообщить("Выгрузка прервана пользователем");
	
КонецПроцедуры

// Обработка результата пакета (колбэк)
&НаКлиенте
Процедура ПослеОбработкиПакета(Результат, ДополнительныеПараметры) Экспорт
	
	Если ДополнительныеПараметры.ЕстьОшибка Тогда
		Сообщить("Ошибка при обработке пакета: " + ДополнительныеПараметры.ТекстОшибки);
		ЗавершитьВыгрузкуСОшибкой();
		Возврат;
	КонецЕсли;
	
	ТекущаяПозиция = Результат.НоваяПозиция;
	Объект.ТекущийЭтап = Результат.СледующийЭтап;
	Объект.ТекущийОбъект = Результат.ТекущийОбъект;
	
	ОбновитьПрогрессНаФорме();
	
	Если Не Результат.Завершено И Не ТребуетсяПрервать Тогда
		// Запускаем следующий пакет
		// Получаем размер пакета из формы
		Попытка
			РазмерПакета = Объект.РазмерПакета;
			Если РазмерПакета = 0 Тогда
				РазмерПакета = 50;
			КонецЕсли;
		Исключение
			РазмерПакета = 50;
		КонецПопытки;
		
		Параметры = Новый Структура;
		Параметры.Вставить("ТипВыгрузки", "Все");
		Параметры.Вставить("НачальнаяПозиция", ТекущаяПозиция);
		Параметры.Вставить("РазмерПакета", РазмерПакета);
		Параметры.Вставить("Этап", Результат.СледующийЭтап);
		
		ВыполнитьОбработкуНаСервереАсинхронно("ОбработатьПакетВыгрузки", Параметры, "ПослеОбработкиПакета");
	Иначе
		ЗавершитьВыгрузку();
	КонецЕсли;
	
КонецПроцедуры

// Завершение выгрузки
&НаКлиенте
Процедура ЗавершитьВыгрузку()
	
	ВыполняетсяВыгрузка = Ложь;
	ТребуетсяПрервать = Ложь;
	
	Попытка
		ЭлементыФормы.КнопкаПрервать.Доступность = Ложь;
		ЭлементыФормы.КнопкаВыгрузкаВсего.Доступность = Истина;
		ЭлементыФормы.ТаймерОбновления.Enabled = Ложь;
	Исключение
		// Элементы формы могут отсутствовать
	КонецПопытки;
	
	Если ТекущаяПозиция >= ОбщееКоличествоОбъектов Тогда
		Сообщить("Выгрузка завершена успешно");
		Объект.ТекущийЭтап = "Завершено";
		Объект.ТекущийОбъект = "";
	Иначе
		Сообщить("Выгрузка прервана");
		Объект.ТекущийЭтап = "Прервано";
		Объект.ТекущийОбъект = "";
	КонецЕсли;
	
	ОбновитьПрогрессНаФорме();
	
КонецПроцедуры

// Завершение выгрузки с ошибкой
&НаКлиенте
Процедура ЗавершитьВыгрузкуСОшибкой()
	
	ВыполняетсяВыгрузка = Ложь;
	ТребуетсяПрервать = Ложь;
	
	Попытка
		ЭлементыФормы.КнопкаПрервать.Доступность = Ложь;
		ЭлементыФормы.КнопкаВыгрузкаВсего.Доступность = Истина;
		ЭлементыФормы.ТаймерОбновления.Enabled = Ложь;
	Исключение
		// Элементы формы могут отсутствовать
	КонецПопытки;
	
	Объект.ТекущийЭтап = "Ошибка";
	Объект.ТекущийОбъект = "";
	
	ОбновитьПрогрессНаФорме();
	
КонецПроцедуры

#КонецОбласти

]]></text>
    </module>
    <forms>
      <form xsi:type="ManagedForm">
        <name>Форма</name>
        <synonym>
          <key>ru</key>
          <value>Форма</value>
        </synonym>
        <module>
          <text><![CDATA[&НаКлиенте
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Устанавливаем значения по умолчанию
	Если Объект.АдресСервера = "" Тогда
		Объект.АдресСервера = "http://localhost:9999";
	КонецЕсли;
	
	Если Объект.РазмерПакета = 0 Тогда
		Объект.РазмерПакета = 50;
	КонецЕсли;
	
	Если Объект.ИспользоватьПакетнуюВыгрузку = Неопределено Тогда
		Объект.ИспользоватьПакетнуюВыгрузку = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	// Код инициализации формы
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	// Обработка перед закрытием формы
КонецПроцедуры]]></text>
        </module>
      </form>
    </forms>
  </MetaDataObject>
</Configuration>