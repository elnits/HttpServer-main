# Нормализация данных номенклатуры

## Описание

Модуль нормализации предназначен для обработки данных справочника номенклатуры из 1С. Он выполняет следующие задачи:

1. **Очистка данных** - удаляет все записи из `catalog_items` кроме последних 15 973 записей (основной справочник номенклатуры)
2. **Нормализация имен** - приводит наименования к единому виду, удаляя размеры, технические коды и числа
3. **Категоризация** - автоматически определяет категорию товара на основе ключевых слов
4. **Группировка** - объединяет похожие товары в группы по категории и нормализованному имени
5. **Сохранение** - записывает нормализованные данные в таблицу `normalized_data`

## Структура данных

### Таблица `normalized_data`

- `id` - уникальный идентификатор
- `source_reference` - исходный reference (для отслеживания)
- `source_name` - исходное name (для отладки)
- `code` - код из 1С (неизменный, уникальный)
- `normalized_name` - нормализованное наименование
- `normalized_reference` - объединенный reference (равен normalized_name)
- `category` - категория товара
- `merged_count` - количество объединенных записей в группе
- `created_at` - время создания записи

## Алгоритм нормализации

### Нормализация имени

1. Приведение к нижнему регистру
2. Удаление технических кодов (например, "ER-00013004")
3. Удаление размеров (например, "100x100", "100х100")
4. Удаление чисел с единицами измерения (например, "10%", "20л", "5см")
5. Удаление отдельно стоящих чисел (например, "502" в "Клей 502")
6. Очистка лишних пробелов

**Примеры:**
- "Труба 100х100" → "труба"
- "Энрофлоксацин 10% + Колистин" → "энрофлоксацин + колистин"
- "Клей 502" → "клей"

### Категоризация

Система автоматически определяет категорию товара на основе ключевых слов в названии. Доступные категории:

- инструмент
- медикаменты
- стройматериалы
- электроника
- оборудование
- расходники
- автоаксессуары
- канцелярия
- средства очистки
- продукты
- сельское хозяйство
- связь
- сантехника
- мебель
- инструменты измерительные
- программное обеспечение
- упаковка
- другое

### Группировка

Записи группируются по комбинации (категория, normalized_name). Все записи в одной группе получают одинаковый `normalized_reference`, равный `normalized_name`.

## Использование

### Способ 1: HTTP API

Отправьте POST запрос на эндпоинт:

```bash
curl -X POST http://localhost:9999/api/normalize/start
```

Ответ:
```json
{
  "success": true,
  "message": "Нормализация данных запущена",
  "timestamp": "2024-01-01T12:00:00Z"
}
```

### Способ 2: Командная строка

Используйте утилиту из командной строки:

```bash
# Компиляция
go build -o normalize.exe cmd/normalize/main.go

# Запуск с базой данных по умолчанию (1c_data.db)
.\normalize.exe

# Запуск с указанием базы данных
.\normalize.exe -db path/to/database.db
```

### Способ 3: Batch скрипт (Windows)

Просто запустите:

```bash
.\normalize.bat
```

## Процесс выполнения

1. **Очистка** - удаление старых записей (если их больше 15 973)
2. **Загрузка** - получение всех записей из `catalog_items`
3. **Обработка** - для каждой записи:
   - Определение категории
   - Нормализация имени
   - Добавление в группу
4. **Сохранение** - вставка нормализованных данных в `normalized_data` пакетами по 1000 записей

## Логирование

Процесс нормализации выводит подробные логи:

```
Начало нормализации данных...
Очистка старых записей из catalog_items...
Очистка завершена
Получение всех записей из catalog_items...
Получено 15973 записей
Группировка записей...
Создано 1234 групп
Вставка нормализованных данных...
Вставлено 1000 записей (всего: 1000)
Вставлено 1000 записей (всего: 2000)
...
Нормализация завершена за 2m30s. Всего обработано: 15973 записей
```

## Производительность

- Используются транзакции для безопасности операций
- Пакетная вставка (1000 записей за раз) для оптимизации
- Индексы на ключевых полях для быстрого поиска

## Важные замечания

1. **Резервное копирование** - перед запуском нормализации рекомендуется создать резервную копию базы данных
2. **Исходные данные** - исходные `reference` и `name` сохраняются в полях `source_reference` и `source_name` для возможности отката
3. **Уникальность code** - поле `code` остается неизменным и уникальным, что позволяет отслеживать связь между исходными и нормализованными данными
4. **Группировка** - товары с одинаковым нормализованным именем в одной категории объединяются в одну группу

## Примеры запросов к нормализованным данным

```sql
-- Получить все нормализованные записи
SELECT * FROM normalized_data;

-- Найти все группы с более чем 1 записью
SELECT normalized_reference, category, merged_count 
FROM normalized_data 
WHERE merged_count > 1 
GROUP BY normalized_reference, category;

-- Найти все записи в категории "инструмент"
SELECT * FROM normalized_data WHERE category = 'инструмент';

-- Найти исходные записи для нормализованного товара
SELECT source_reference, source_name, code 
FROM normalized_data 
WHERE normalized_reference = 'труба';
```

