# Настройка классификатора КПВЭД для проекта АЙТАЗ

## Обзор

Система поддерживает хранение и использование классификаторов категорий (например, КПВЭД) для различных проектов и клиентов. Классификатор КПВЭД может быть загружен в базу данных и использован для нормализации НСИ на проекте АЙТАЗ.

## Структура базы данных

### Таблица `category_classifiers`

Классификаторы хранятся в таблице `category_classifiers` со следующими полями:
- `id` - уникальный идентификатор
- `name` - название классификатора (например, "КПВЭД")
- `description` - описание
- `max_depth` - максимальная глубина иерархии
- `tree_structure` - JSON структура дерева категорий
- `client_id` - ID клиента (NULL для глобальных классификаторов)
- `project_id` - ID проекта (NULL для глобальных классификаторов)
- `is_active` - активен ли классификатор
- `created_at`, `updated_at` - временные метки

### Привязка к клиентам и проектам

- Если `client_id` и `project_id` = NULL - классификатор доступен всем (глобальный)
- Если указан `client_id` - классификатор доступен только этому клиенту
- Если указаны `client_id` и `project_id` - классификатор доступен только для этого проекта

## Загрузка классификатора КПВЭД

### Использование скрипта загрузки

```bash
# Загрузка глобального классификатора (доступен всем)
go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db

# Загрузка классификатора для конкретного клиента
go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db 1

# Загрузка классификатора для конкретного проекта
go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db 1 1
```

### Параметры

- `КПВЭД.txt` - путь к файлу с классификатором КПВЭД
- `1c_data.db` - путь к базе данных
- `client_id` (опционально) - ID клиента
- `project_id` (опционально) - ID проекта

### Формат файла КПВЭД.txt

Файл должен содержать:
- Заголовки (первые 3 строки пропускаются)
- Строки в формате: `код\tнаименование` или `код наименование`
- Иерархия определяется по коду (количество точек)

Пример:
```
A	ПРОДУКЦИЯ СЕЛЬСКОГО, ЛЕСНОГО И РЫБНОГО ХОЗЯЙСТВА
01	ПРОДУКЦИЯ СЕЛЬСКОГО ХОЗЯЙСТВА, ОХОТЫ И СОПУТСТВУЮЩИЕ УСЛУГИ
01.1	Культуры сезонные
01.11	Культуры зерновые (за исключением риса), бобовые и семена масличные
01.11.1	Пшеница
01.11.11	Пшеница твердая
```

## Проверка наличия классификатора

### Использование скрипта проверки

```bash
# Проверка всех классификаторов
go run cmd/check_classifiers/main.go 1c_data.db

# Проверка классификаторов для клиента
go run cmd/check_classifiers/main.go 1c_data.db 1

# Проверка классификаторов для проекта
go run cmd/check_classifiers/main.go 1c_data.db 1 1
```

## Использование в API

### Получение классификаторов

```http
GET /api/classification/classifiers?client_id=1&project_id=1
```

### Использование в классификации

При классификации товара система автоматически использует классификатор, привязанный к клиенту/проекту, или глобальный классификатор, если специфический не найден.

## Для проекта АЙТАЗ

### Шаги настройки

1. **Определить ID клиента и проекта АЙТАЗ**
   - Если клиент/проект еще не созданы, их нужно создать в сервисной базе

2. **Загрузить классификатор КПВЭД**
   ```bash
   go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db <client_id> <project_id>
   ```

3. **Проверить загрузку**
   ```bash
   go run cmd/check_classifiers/main.go 1c_data.db <client_id> <project_id>
   ```

4. **Использовать в процессе нормализации**
   - Классификатор будет автоматически использован при классификации товаров
   - Можно указать стратегию свертки категорий для нужной глубины

### Пример использования

После загрузки классификатор будет доступен через API классификации:

```json
POST /api/classification/classify-item
{
  "item_name": "Пшеница твердая",
  "strategy_id": "top_priority"
}
```

Система автоматически найдет подходящий классификатор (для проекта АЙТАЗ или глобальный) и выполнит классификацию.

## Множественные классификаторы

Система поддерживает несколько классификаторов:
- Глобальные классификаторы (для всех)
- Классификаторы для конкретных клиентов
- Классификаторы для конкретных проектов

При поиске классификатора система использует приоритет:
1. Классификатор для проекта (client_id + project_id)
2. Классификатор для клиента (client_id)
3. Глобальный классификатор (client_id = NULL, project_id = NULL)

## Обновление классификатора

Для обновления классификатора:
1. Загрузите новую версию с тем же именем
2. Система создаст новую запись
3. Старую версию можно деактивировать (is_active = FALSE)

Или используйте метод обновления через API:
```http
PUT /api/classification/classifiers/{id}
```

## Структура дерева категорий

Классификатор хранится в формате JSON дерева:

```json
{
  "id": "root",
  "name": "КПВЭД",
  "path": "КПВЭД",
  "level": 0,
  "parent_id": "",
  "children": [
    {
      "id": "A",
      "name": "ПРОДУКЦИЯ СЕЛЬСКОГО, ЛЕСНОГО И РЫБНОГО ХОЗЯЙСТВА",
      "path": "КПВЭД / ПРОДУКЦИЯ СЕЛЬСКОГО, ЛЕСНОГО И РЫБНОГО ХОЗЯЙСТВА",
      "level": 1,
      "parent_id": "root",
      "children": [...]
    }
  ]
}
```

## Примечания

- Классификатор КПВЭД может быть очень большим (тысячи категорий)
- Рекомендуется загружать классификатор один раз и использовать для всех проектов клиента
- Для разных проектов можно использовать разные стратегии свертки категорий

