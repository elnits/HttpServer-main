# Руководство по использованию системы извлечения атрибутов

## Обзор

Система автоматически извлекает и сохраняет реквизиты товаров в процессе нормализации. Все атрибуты сохраняются в таблице `normalized_item_attributes` и отображаются на фронтенде.

## Что извлекается

### 1. Размеры (dimension)
- **Паттерн**: `100x100`, `100х100` (с русской х)
- **Извлекается**: width, height
- **Связанные реквизиты после размера**:
  - Толщина (thickness) - число с единицами длины (mm, см)
  - Материал (material) - сталь, металл, пластик, дерево и т.д.
  - Цвет (color) - белый, черный, серый и т.д.
  - Покрытие (coating) - оцинкован, покрашен, полирован и т.д.

### 2. Артикулы (article_code)
- **Паттерн**: `wbc00z0002`, `wb500z0002` (в начале строки)
- **Связанные реквизиты после артикула**:
  - Размеры (dimension)
  - Единицы измерения (numeric_value)
  - Тип товара (type) - панель, лист, профиль, труба и т.д.

### 3. Технические коды (technical_code)
- **Паттерн**: `ER-00013004`
- **Связанные реквизиты после кода**:
  - Параметры с единицами измерения (numeric_value)

### 4. Числовые значения с единицами (numeric_value)
- **Паттерны**: `120mm`, `50kg`, `220v`, `100w`
- **Типы атрибутов**:
  - `thickness` - толщина (mm, см, мм, cm, m, м)
  - `weight` - вес (kg, кг, g, г, мг)
  - `volume` - объем (l, л, ml, мл)
  - `power` - мощность (w, в, watt, kw, квт, вт)
  - `electrical` - напряжение/ток (v, в, a, а)
  - `duration` - время (h, ч, min, мин, sec, сек)
  - `quantity` - количество (шт)
  - `percentage` - процент (%)

### 5. Текстовые значения (text_value)
- Материал (material)
- Цвет (color)
- Покрытие (coating)
- Тип товара (type)

## Структура данных

### Таблица `normalized_item_attributes`
```sql
CREATE TABLE normalized_item_attributes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    normalized_item_id INTEGER NOT NULL,
    attribute_type TEXT NOT NULL,      -- dimension, numeric_value, text_value, article_code, technical_code
    attribute_name TEXT,                -- width, height, thickness, material, color и т.д.
    attribute_value TEXT NOT NULL,      -- значение атрибута
    unit TEXT,                          -- единица измерения (mm, kg, и т.д.)
    original_text TEXT,                 -- исходный текст, из которого извлечен атрибут
    confidence REAL DEFAULT 1.0,        -- уверенность в извлечении (0.0-1.0)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (normalized_item_id) REFERENCES normalized_data(id) ON DELETE CASCADE
);
```

## API Endpoints

### 1. Получение атрибутов товара
```
GET /api/normalization/item-attributes/{item_id}
```

**Ответ:**
```json
{
  "item_id": 123,
  "attributes": [
    {
      "id": 1,
      "attribute_type": "dimension",
      "attribute_name": "width",
      "attribute_value": "100",
      "unit": "",
      "original_text": "100x100",
      "confidence": 1.0,
      "created_at": "2024-01-01T12:00:00Z"
    }
  ],
  "count": 1
}
```

### 2. Получение элементов группы (с атрибутами)
```
GET /api/normalization/group-items?normalized_name={name}&category={cat}&include_ai=true
```

**Ответ включает атрибуты для каждого элемента:**
```json
{
  "normalized_name": "...",
  "items": [
    {
      "id": 123,
      "code": "...",
      "source_name": "...",
      "attributes": [
        {
          "id": 1,
          "attribute_type": "dimension",
          "attribute_name": "width",
          "attribute_value": "100",
          "unit": "",
          "original_text": "100x100",
          "confidence": 1.0
        }
      ]
    }
  ]
}
```

## Отображение на фронтенде

### Страница деталей группы
1. Откройте `/results`
2. Выберите любую группу
3. В таблице элементов нажмите на стрелку раскрытия (▼) рядом с элементом
4. В раскрывающейся секции вы увидите:
   - **AI обоснование** (если есть)
   - **Извлеченные реквизиты** - карточки с атрибутами

### Формат отображения атрибутов
Каждый атрибут отображается в виде карточки с:
- **Имя атрибута** (верхний регистр) - width, height, thickness и т.д.
- **Значение** с единицей измерения (если есть)
- **Исходный текст** - из какого фрагмента названия извлечен
- **Тип атрибута** - badge с типом (dimension, numeric_value и т.д.)
- **Уверенность** - процент (если < 100%)

## Запуск нормализации

### Через веб-интерфейс
1. Откройте страницу нормализации
2. Нажмите "Запустить нормализацию"
3. Дождитесь завершения процесса

### Через API
```bash
curl -X POST http://localhost:8080/api/normalize/start \
  -H "Content-Type: application/json" \
  -d '{"use_ai": false}'
```

## Проверка результатов

### После завершения нормализации
1. Откройте `/results`
2. Выберите группу с товарами
3. Раскройте элементы для просмотра атрибутов
4. Проверьте, что все реквизиты извлечены корректно

### Примеры извлечения

**Входное название:**
```
wbc00z0002 панель isowall box 100x100 120mm сталь белый
```

**Извлеченные атрибуты:**
- `article_code`: wbc00z0002
- `dimension` (width): 100
- `dimension` (height): 100
- `numeric_value` (thickness): 120 (mm)
- `text_value` (material): сталь
- `text_value` (color): белый
- `text_value` (type): панель

## Технические детали

### Алгоритм извлечения
1. Находит паттерны (размеры, артикулы, коды) с их позициями
2. Анализирует текст после найденного паттерна (до 100 символов)
3. Извлекает связанные реквизиты в зависимости от типа паттерна
4. Избегает дублирования атрибутов

### Уверенность извлечения
- **1.0 (100%)** - для паттернов, найденных напрямую (размеры, артикулы)
- **0.9-0.85** - для связанных реквизитов, найденных после паттернов
- **0.8-0.75** - для текстовых значений (материал, цвет)

## Отладка

### Проверка сохранения атрибутов
Если атрибуты не сохраняются, проверьте логи сервера:
```
Ошибка сохранения атрибутов для элемента {id} (код: {code}): {error}
```

### Проверка извлечения
Проверьте, что `ExtractAttributes` вызывается в процессе нормализации:
- В `normalization/normalizer.go` строка 160: `normalizedName, attributes := n.nameNormalizer.ExtractAttributes(item.Name)`

## Дальнейшее развитие

Возможные улучшения:
1. Расширение списка материалов и цветов
2. Добавление новых типов паттернов
3. Улучшение точности извлечения связанных реквизитов
4. Добавление фильтрации и поиска по атрибутам на фронтенде

