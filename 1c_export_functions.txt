#Область СлужебныеПеременные

Перем АдресСервера;

Перем ИдентификаторВыгрузки;

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Вспомогательная функция для экранирования специальных символов в XML
Функция ЭкранироватьXML(Строка)
	
	Результат = Строка;
	Результат = СтрЗаменить(Результат, "&", "&amp;");
	Результат = СтрЗаменить(Результат, "<", "&lt;");
	Результат = СтрЗаменить(Результат, ">", "&gt;");
	Результат = СтрЗаменить(Результат, """", "&quot;");
	Результат = СтрЗаменить(Результат, "'", "&apos;");
	
	Возврат Результат;
	
КонецФункции

// Получение версии 1С
Функция Версия1С()
	
	Попытка
		// Используем СистемнаяИнформация для получения версии платформы
		СистемнаяИнформация = Новый СистемнаяИнформация;
		Возврат Строка(СистемнаяИнформация.ВерсияПриложения);
	Исключение
		// Если не удалось получить версию, возвращаем базовую
		Возврат "8.3";
	КонецПопытки;
	
КонецФункции

// Получение имени конфигурации
Функция ИмяКонфигурации()
	
	Попытка
		// Правильный способ получения имени конфигурации
		Возврат Строка(Метаданные.Имя);
	Исключение
		// Если не удалось получить имя, возвращаем пустую строку
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Получение подстроки из середины строки
Функция Средняя(Строка, НачальнаяПозиция, Длина)
	
	Возврат Сред(Строка, НачальнаяПозиция, Длина);
	
КонецФункции

// Получение версии конфигурации
Функция ПолучитьВерсиюКонфигурации()
	
	Попытка
		Возврат Строка(Метаданные.Версия);
	Исключение
		Возврат "";
	КонецПопытки;
	
КонецФункции

// Извлечение значения из XML по тегу
Функция ИзвлечьЗначениеИзXML(XMLСтрока, ИмяТега)
	
	ПозицияНачала = СтрНайти(XMLСтрока, "<" + ИмяТега + ">");
	ПозицияКонца = СтрНайти(XMLСтрока, "</" + ИмяТега + ">");
	
	Если ПозицияНачала > 0 И ПозицияКонца > 0 Тогда
		Возврат Средняя(XMLСтрока, ПозицияНачала + СтрДлина("<" + ИмяТега + ">"), ПозицияКонца - ПозицияНачала - СтрДлина("<" + ИмяТега + ">"));
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

// Получение тела ответа HTTP (универсальное)
Функция ПолучитьТелоОтвета(Ответ)
	
	Попытка
		Возврат Ответ.ПолучитьТелоКакСтроку();
	Исключение
		Попытка
			Возврат Ответ.ТелоОтвета;
		Исключение
			Возврат "Не удалось получить тело ответа";
		КонецПопытки;
	КонецПопытки;
	
КонецФункции

// Получение XML представления значения константы
Функция ПолучитьXMLПредставлениеЗначения(Значение, ТипЗначения)
	
	Если Значение = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	ТипЗначенияОбъекта = ТипЗнч(Значение);
	СтрокаТипа = Строка(ТипЗначенияОбъекта);
	
	// Для ссылок используем полное представление в XML формате
	Если СтрНайти(СтрокаТипа, "Ссылка") > 0 Тогда
		СтрокаЗначения = Формат(Значение, "ДЛФ=DT");
		Возврат "<reference>" + ЭкранироватьXML(СтрокаЗначения) + "</reference>";
	КонецЕсли;
	
	// Для таблиц значений - сериализация в XML
	Если ТипЗначенияОбъекта = Тип("ТаблицаЗначений") Тогда
		Возврат СериализоватьТаблицуЗначенийВXML(Значение);
	КонецЕсли;
	
	// Для структур - сериализация в XML
	Если ТипЗначенияОбъекта = Тип("Структура") Тогда
		Возврат СериализоватьСтруктуруВXML(Значение);
	КонецЕсли;
	
	// Для массивов - сериализация в XML
	Если ТипЗначенияОбъекта = Тип("Массив") Тогда
		Возврат СериализоватьМассивВXML(Значение);
	КонецЕсли;
	
	// Для дат используем правильный формат в XML
	Если ТипЗначенияОбъекта = Тип("Дата") Тогда
		СтрокаЗначения = Формат(Значение, "ДФ=yyyy-MM-ddTHH:mm:ss");
		Возврат "<date>" + ЭкранироватьXML(СтрокаЗначения) + "</date>";
	КонецЕсли;
	
	// Для чисел - в XML теге
	Если ТипЗначенияОбъекта = Тип("Число") Тогда
		СтрокаЗначения = Строка(Значение);
		Возврат "<number>" + ЭкранироватьXML(СтрокаЗначения) + "</number>";
	КонецЕсли;
	
	// Для булевых - в XML теге
	Если ТипЗначенияОбъекта = Тип("Булево") Тогда
		СтрокаЗначения = Строка(Значение);
		Возврат "<boolean>" + ЭкранироватьXML(СтрокаЗначения) + "</boolean>";
	КонецЕсли;
	
	// Для строк - в XML теге
	Если ТипЗначенияОбъекта = Тип("Строка") Тогда
		Возврат "<string>" + ЭкранироватьXML(Значение) + "</string>";
	КонецЕсли;
	
	// Для остальных типов - стандартное преобразование в XML теге
	СтрокаЗначения = Строка(Значение);
	Возврат "<value>" + ЭкранироватьXML(СтрокаЗначения) + "</value>";
	
КонецФункции

// Сериализация таблицы значений в XML
Функция СериализоватьТаблицуЗначенийВXML(ТаблицаЗначений)
	
	XMLСтрока = "<table>";
	
	Для Каждого СтрокаТаблицы Из ТаблицаЗначений Цикл
		
		XMLСтрока = XMLСтрока + "<row>";
		
		Для Каждого Колонка Из ТаблицаЗначений.Колонки Цикл
			
			ЗначениеКолонки = СтрокаТаблицы[Колонка.Имя];
			СтрокаЗначения = "";
			
			Если ЗначениеКолонки <> Неопределено Тогда
				СтрокаЗначения = Строка(ЗначениеКолонки);
				СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
			КонецЕсли;
			
			XMLСтрока = XMLСтрока + "<" + Колонка.Имя + ">" + СтрокаЗначения + "</" + Колонка.Имя + ">";
			
		КонецЦикла;
		
		XMLСтрока = XMLСтрока + "</row>";
		
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</table>";
	
	Возврат XMLСтрока;
	
КонецФункции

// Сериализация структуры в XML
Функция СериализоватьСтруктуруВXML(Структура)
	
	XMLСтрока = "<structure>";
	
	Для Каждого КлючЗначение Из Структура Цикл
		
		Значение = КлючЗначение.Значение;
		СтрокаЗначения = "";
		
		Если Значение <> Неопределено Тогда
			СтрокаЗначения = Строка(Значение);
			СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
		КонецЕсли;
		
		XMLСтрока = XMLСтрока + "<" + КлючЗначение.Ключ + ">" + СтрокаЗначения + "</" + КлючЗначение.Ключ + ">";
		
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</structure>";
	
	Возврат XMLСтрока;
	
КонецФункции

// Сериализация массива в XML
Функция СериализоватьМассивВXML(Массив)
	
	XMLСтрока = "<array>";
	
	Для Индекс = 0 По Массив.ВГраница() Цикл
		
		Значение = Массив[Индекс];
		СтрокаЗначения = "";
		
		Если Значение <> Неопределено Тогда
			СтрокаЗначения = Строка(Значение);
			СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
		КонецЕсли;
		
		XMLСтрока = XMLСтрока + "<item>" + СтрокаЗначения + "</item>";
		
	КонецЦикла;
	
	XMLСтрока = XMLСтрока + "</array>";
	
	Возврат XMLСтрока;
	
КонецФункции

#КонецОбласти

#Область ПрограммныйИнтерфейс

// Процедура на клиенте для привязки к кнопке "ВыгрузкаВсего"
&НаКлиенте
Процедура ВыгрузкаВсего(Команда)
	
	// Инициализация переменных прогресса
	ОбщееКоличествоОбъектов = 0;
	ТекущаяПозиция = 0;
	ВыполняетсяВыгрузка = Истина;
	ТребуетсяПрервать = Ложь;
	ТекущийЭтап = "Инициализация";
	ТекущийОбъект = "";
	
	// Блокируем кнопку "Выполнить", разблокируем кнопку "Прервать"
	Попытка
		ЭлементыФормы.КнопкаВыгрузкаВсего.Доступность = Ложь;
		ЭлементыФормы.КнопкаПрервать.Доступность = Истина;
	Исключение
		// Элементы формы могут отсутствовать
	КонецПопытки;
	
	// Получаем общее количество объектов
	ОбщееКоличествоОбъектов = ПолучитьОбщееКоличествоОбъектовНаСервере("Все");
	
	Если ОбщееКоличествоОбъектов = 0 Тогда
		Сообщить("Нет данных для выгрузки");
		ВыполняетсяВыгрузка = Ложь;
		Попытка
			ЭлементыФормы.КнопкаВыгрузкаВсего.Доступность = Истина;
			ЭлементыФормы.КнопкаПрервать.Доступность = Ложь;
		Исключение
		КонецПопытки;
		Возврат;
	КонецЕсли;
	
	// Запускаем таймер обновления прогресса
	Попытка
		ЭлементыФормы.ТаймерОбновления.Enabled = Истина;
	Исключение
		// Элемент формы может отсутствовать
	КонецПопытки;
	
	// Инициализируем прогресс
	ОбновитьПрогрессНаФорме();
	
	// Выполняем рукопожатие и отправку метаинформации синхронно (быстрые операции)
	ТекущийЭтап = "Рукопожатие";
	Объект.ТекущийЭтап = ТекущийЭтап;
	ОбновитьПрогрессНаФорме();
	
	ИдентификаторВыгрузки = ВыполнитьРукопожатиеИМетаинформациюНаСервере();
	
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		ЗавершитьВыгрузкуСОшибкой();
		Возврат;
	КонецЕсли;
	
	// Запускаем первый пакет выгрузки асинхронно
	ТекущийЭтап = "Константы";
	Объект.ТекущийЭтап = ТекущийЭтап;
	ТекущаяПозиция = 0;
	
	// Получаем размер пакета из формы
	Попытка
		РазмерПакета = Объект.РазмерПакета;
		Если РазмерПакета = 0 Тогда
			РазмерПакета = 50;
		КонецЕсли;
	Исключение
		РазмерПакета = 50;
	КонецПопытки;
	
	Параметры = Новый Структура;
	Параметры.Вставить("ТипВыгрузки", "Все");
	Параметры.Вставить("НачальнаяПозиция", 0);
	Параметры.Вставить("РазмерПакета", РазмерПакета);
	Параметры.Вставить("Этап", "Константы");
	
	ВыполнитьОбработкуНаСервереАсинхронно("ОбработатьПакетВыгрузки", Параметры, "ПослеОбработкиПакета");
	
КонецПроцедуры

// Серверная процедура для выполнения рукопожатия и отправки метаинформации
&НаСервере
Функция ВыполнитьРукопожатиеИМетаинформациюНаСервере()
	
	ОбновитьНастройкиИзФормы();
	
	// Выполняем рукопожатие
	Если ИдентификаторБазыДанных <> "" Тогда
		ИдентификаторВыгрузки = ВыполнитьРукопожатиеСПривязкой();
	Иначе
		ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	КонецЕсли;
	
	Если ИдентификаторВыгрузки = "" Тогда
		Возврат "";
	КонецЕсли;
	
	// Отправляем метаинформацию
	ОтправитьМетаИнформацию();
	
	Возврат ИдентификаторВыгрузки;
	
КонецФункции

// Серверная процедура для получения общего количества объектов
&НаСервере
Функция ПолучитьОбщееКоличествоОбъектовНаСервере(ТипВыгрузки)
	
	Возврат ПолучитьОбщееКоличествоОбъектов(ТипВыгрузки);
	
КонецФункции

// Основная процедура для запуска выгрузки через HTTP
Процедура ВыполнитьВыгрузкуЧерезHTTP() Экспорт
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки данных через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера
	АдресСервера = "http://localhost:9999";
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем константы
	Сообщить("Этап 3: Выгрузка констант...");
	ВыгрузитьКонстантыЧерезHTTP();
	
	// Выгружаем справочники
	Сообщить("Этап 4: Выгрузка справочников...");
	ВыгрузитьСправочникиЧерезHTTP();
	
	// Завершаем выгрузку
	Сообщить("Этап 5: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Выполнение рукопожатия с сервером
Функция ВыполнитьРукопожатие()
	
	URL = АдресСервера + "/handshake";
	Сообщить("  → Отправка запроса на " + URL);
	
	// Создаем XML для рукопожатия
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<handshake>" +
		"<version_1c>" + Строка(Версия1С()) + "</version_1c>" +
		"<config_name>" + Строка(ИмяКонфигурации()) + "</config_name>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</handshake>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("  → Ответ от сервера: код " + Строка(КодСостояния));
		
		// Извлекаем UUID из XML ответа
		Попытка
			ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтвета = Ответ.ТелоОтвета;
			Исключение
				ТелоОтвета = "";
			КонецПопытки;
		КонецПопытки;
		
		// Ищем UUID в ответе
		ПозицияНачала = СтрНайти(ТелоОтвета, "<upload_uuid>");
		ПозицияКонца = СтрНайти(ТелоОтвета, "</upload_uuid>");
		
		Если ПозицияНачала > 0 И ПозицияКонца > 0 Тогда
			UUIDВыгрузки = Средняя(ТелоОтвета, ПозицияНачала + СтрДлина("<upload_uuid>"), ПозицияКонца - ПозицияНачала - СтрДлина("<upload_uuid>"));
			Сообщить("  → UUID получен: " + UUIDВыгрузки);
			Возврат UUIDВыгрузки;
		Иначе
			Сообщить("  → ОШИБКА: UUID не найден в ответе сервера");
		КонецЕсли;
	Иначе
		Сообщить("  → ОШИБКА: Код ответа " + Строка(КодСостояния));
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

// Отправка метаинформации
Процедура ОтправитьМетаИнформацию()
	
	Сообщить("  → Отправка метаинформации...");
	URL = АдресСервера + "/metadata";
	
	// Создаем XML для метаинформации
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<metadata>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<version_1c>" + Строка(Версия1С()) + "</version_1c>" +
		"<config_name>" + Строка(ИмяКонфигурации()) + "</config_name>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</metadata>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("  ✓ Метаинформация отправлена успешно");
	Иначе
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("  → ОШИБКА отправки метаинформации: " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Выгрузка констант через HTTP
Процедура ВыгрузитьКонстантыЧерезHTTP()
	
	Сообщить("  → Начинаем выгрузку констант...");
	
	// Получаем все константы (метаданные)
	КоллекцияКонстант = Метаданные.Константы;
	ВсегоКонстант = КоллекцияКонстант.Количество();
	
	Если ВсегоКонстант = 0 Тогда
		Сообщить("  → Константы не найдены. Пропускаем этап.");
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Найдено констант: " + Строка(ВсегоКонстант));
	ТекущаяКонстанта = 0;
	
	Для Каждого КонстантаМетаданных Из КоллекцияКонстант Цикл
		ТекущаяКонстанта = ТекущаяКонстанта + 1;
		
		// Получаем значение константы через глобальный объект Константы
		// Используем метод Получить() для получения реального значения константы
		ЗначениеКонстанты = Неопределено;
		Попытка
			// Сначала пробуем получить через метод Получить()
			ЗначениеКонстанты = Константы[КонстантаМетаданных.Имя].Получить();
			Сообщить("      → Значение константы '" + КонстантаМетаданных.Имя + "' получено через Получить()");
		Исключение
			// Если метод Получить() не работает, пробуем получить напрямую
			Попытка
				ЗначениеКонстанты = Константы[КонстантаМетаданных.Имя];
				Сообщить("      → Значение константы '" + КонстантаМетаданных.Имя + "' получено напрямую");
				
				// Проверяем, что это не строка-ссылка на константу
				Если ТипЗнч(ЗначениеКонстанты) = Тип("Строка") Тогда
					СтрокаЗначения = Строка(ЗначениеКонстанты);
					// Если строка содержит точку и начинается с "Константа", это скорее всего ссылка, а не значение
					Если СтрНайти(СтрокаЗначения, ".") > 0 И (СтрНачинаетсяС(СтрокаЗначения, "Константа") Или СтрНачинаетсяС(СтрокаЗначения, "Constants")) Тогда
						Сообщить("      → ОШИБКА: получена ссылка на константу вместо значения '" + КонстантаМетаданных.Имя + "': " + СтрокаЗначения);
						Сообщить("      → Пробуем альтернативные способы получения значения...");
						
						// Пробуем альтернативный способ - через запрос к константам
						Попытка
							Запрос = Новый Запрос;
							Запрос.Текст = "ВЫБРАТЬ
							|	Константы." + КонстантаМетаданных.Имя + " КАК Значение";
							РезультатЗапроса = Запрос.Выполнить();
							Выборка = РезультатЗапроса.Выбрать();
							Если Выборка.Следующий() Тогда
								ЗначениеКонстанты = Выборка.Значение;
								Сообщить("      → Значение получено через запрос");
							КонецЕсли;
						Исключение
							Сообщить("      → Не удалось получить значение через запрос: " + ОписаниеОшибки());
						КонецПопытки;
						
						// Если все еще ссылка, обнуляем
						Если ТипЗнч(ЗначениеКонстанты) = Тип("Строка") Тогда
							СтрокаЗначения = Строка(ЗначениеКонстанты);
							Если СтрНайти(СтрокаЗначения, ".") > 0 И (СтрНачинаетсяС(СтрокаЗначения, "Константа") Или СтрНачинаетсяС(СтрокаЗначения, "Constants")) Тогда
								ЗначениеКонстанты = Неопределено;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			Исключение
				ЗначениеКонстанты = Неопределено;
				Сообщить("      → ОШИБКА: не удалось получить значение константы '" + КонстантаМетаданных.Имя + "': " + ОписаниеОшибки());
			КонецПопытки;
		КонецПопытки;
		
		// Определяем тип значения
		ТипЗначения = "";
		ТипЗначенияОбъекта = ТипЗнч(ЗначениеКонстанты);
		СтрокаТипа = Строка(ТипЗначенияОбъекта);
		
		Если ЗначениеКонстанты = Неопределено Тогда
			ТипЗначения = "Неопределено";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Строка") Тогда
			ТипЗначения = "Строка";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Число") Тогда
			ТипЗначения = "Число";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Булево") Тогда
			ТипЗначения = "Булево";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Дата") Тогда
			ТипЗначения = "Дата";
		ИначеЕсли СтрНайти(СтрокаТипа, "Ссылка") > 0 Тогда
			ТипЗначения = "Ссылка";
		ИначеЕсли ТипЗначенияОбъекта = Тип("ТаблицаЗначений") Тогда
			ТипЗначения = "ТаблицаЗначений";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Структура") Тогда
			ТипЗначения = "Структура";
		ИначеЕсли ТипЗначенияОбъекта = Тип("Массив") Тогда
			ТипЗначения = "Массив";
		Иначе
			ТипЗначения = "Объект";
		КонецЕсли;
		
		// Получаем XML представление значения
		XMLЗначения = "";
		Если ЗначениеКонстанты <> Неопределено Тогда
			XMLЗначения = ПолучитьXMLПредставлениеЗначения(ЗначениеКонстанты, ТипЗначения);
		Иначе
			// Для неопределенного значения создаем пустой тег
			XMLЗначения = "<undefined></undefined>";
		КонецЕсли;
		
		// Логирование для отладки - показываем что получили
		Если ЗначениеКонстанты <> Неопределено Тогда
			КраткоеЗначение = "";
			ПолноеЗначение = "";
			Попытка
				ПолноеЗначение = Строка(ЗначениеКонстанты);
				Если ТипЗначения = "Строка" Тогда
					КраткоеЗначение = Лев(ПолноеЗначение, 100);
					Если СтрДлина(ПолноеЗначение) > 100 Тогда
						КраткоеЗначение = КраткоеЗначение + "...";
					КонецЕсли;
				Иначе
					КраткоеЗначение = ПолноеЗначение;
				КонецЕсли;
			Исключение
				КраткоеЗначение = "[не удалось преобразовать]";
				ПолноеЗначение = "[не удалось преобразовать]";
			КонецПопытки;
			Сообщить("    [" + Строка(ТекущаяКонстанта) + "/" + Строка(ВсегоКонстант) + "] Константа: " + КонстантаМетаданных.Имя);
			Сообщить("      → Тип: " + ТипЗначения + " (" + Строка(ТипЗначенияОбъекта) + ")");
			Сообщить("      → Значение (полное): " + ПолноеЗначение);
			Сообщить("      → Значение (краткое): " + КраткоеЗначение);
		Иначе
			Сообщить("    [" + Строка(ТекущаяКонстанта) + "/" + Строка(ВсегоКонстант) + "] Константа: " + КонстантаМетаданных.Имя + ", значение: Неопределено");
		КонецЕсли;
		
		// Отправляем константу
		ОтправитьКонстанту(КонстантаМетаданных.Имя, КонстантаМетаданных.Синоним, ТипЗначения, XMLЗначения);
		
	КонецЦикла;
	
	Сообщить("  ✓ Выгрузка констант завершена: отправлено " + Строка(ВсегоКонстант) + " констант");
	
КонецПроцедуры

// Отправка константы на сервер
Процедура ОтправитьКонстанту(Имя, Синоним, Тип, XMLЗначение)
	
	URL = АдресСервера + "/constant";
	
	// Экранируем специальные символы в XML для имени, синонима и типа (используем локальные переменные)
	ИмяЭкранированное = ЭкранироватьXML(Имя);
	СинонимЭкранированный = ЭкранироватьXML(Синоним);
	ТипЭкранированный = ЭкранироватьXML(Тип);
	
	// XMLЗначение уже содержит XML структуру (например, <string>...</string> или <number>...</number>)
	// Если значение пустое (не должно быть, но на всякий случай), создаем пустой тег
	Если XMLЗначение = "" Тогда
		XMLЗначение = "<undefined></undefined>";
	КонецЕсли;
	
	// Создаем XML для константы
	// Значение уже в XML формате, поэтому просто вставляем его в тег <value>
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<constant>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<name>" + ИмяЭкранированное + "</name>" +
		"<synonym>" + СинонимЭкранированный + "</synonym>" +
		"<type>" + ТипЭкранированный + "</type>" +
		"<value>" + XMLЗначение + "</value>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</constant>";
	
	// Отладочное сообщение - показываем что отправляем на сервер
	Если СтрДлина(XMLСтрока) > 500 Тогда
		Сообщить("      → Отправка XML (первые 500 символов): " + Лев(XMLСтрока, 500) + "...");
		Сообщить("      → Длина XML: " + Строка(СтрДлина(XMLСтрока)) + " символов");
	Иначе
		Сообщить("      → Отправка XML: " + XMLСтрока);
	КонецЕсли;
	Сообщить("      → XML значение (длина " + Строка(СтрДлина(XMLЗначение)) + "): " + XMLЗначение);
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("Ошибка отправки константы '" + Имя + "': " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Выгрузка справочников через HTTP
Процедура ВыгрузитьСправочникиЧерезHTTP()
	
	Сообщить("  → Начинаем выгрузку справочников...");
	
	// Получаем все справочники (метаданные)
	КоллекцияСправочников = Метаданные.Справочники;
	ВсегоСправочников = КоллекцияСправочников.Количество();
	
	Если ВсегоСправочников = 0 Тогда
		Сообщить("  → Справочники не найдены. Пропускаем этап.");
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Найдено справочников: " + Строка(ВсегоСправочников));
	ТекущийСправочник = 0;
	
	Для Каждого СправочникМетаданных Из КоллекцияСправочников Цикл
		ТекущийСправочник = ТекущийСправочник + 1;
		Сообщить("    [" + Строка(ТекущийСправочник) + "/" + Строка(ВсегоСправочников) + "] Обработка справочника: " + СправочникМетаданных.Имя);
		
		// Отправляем метаданные справочника
		ОтправитьМетаСправочника(СправочникМетаданных);
		
		// Если это справочник "Номенклатура", выгружаем с характеристиками
		Если СправочникМетаданных.Имя = "Номенклатура" Тогда
			ВыгрузитьНоменклатуруСХарактеристиками();
		Иначе
			// Выгружаем элементы справочника стандартным способом
			ВыгрузитьЭлементыСправочникаЧерезHTTP(СправочникМетаданных);
		КонецЕсли;
		
	КонецЦикла;
	
	Сообщить("  ✓ Выгрузка справочников завершена: обработано " + Строка(ВсегоСправочников) + " справочников");
	
КонецПроцедуры

// Отправка метаданных справочника
Процедура ОтправитьМетаСправочника(СправочникМетаданных)
	
	URL = АдресСервера + "/catalog/meta";
	
	// Экранируем специальные символы
	ИмяСправочника = ЭкранироватьXML(СправочникМетаданных.Имя);
	СинонимСправочника = ЭкранироватьXML(СправочникМетаданных.Синоним);
	
	// Создаем XML для метаданных справочника
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<catalog_meta>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<name>" + ИмяСправочника + "</name>" +
		"<synonym>" + СинонимСправочника + "</synonym>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</catalog_meta>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("      ✓ Метаданные справочника '" + СправочникМетаданных.Имя + "' отправлены успешно");
	Иначе
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("      → ОШИБКА отправки метаданных справочника '" + СправочникМетаданных.Имя + "': " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Выгрузка элементов справочника через HTTP (стандартная версия без характеристик)
Процедура ВыгрузитьЭлементыСправочникаЧерезHTTP(СправочникМетаданных)
	
	Сообщить("      → Выгружаем элементы справочника: " + СправочникМетаданных.Имя);
	
	ИмяСправочникаВЗапросе = СправочникМетаданных.Имя;
	
	// Сначала подсчитываем количество элементов
	ЗапросПодсчета = Новый Запрос;
	ЗапросПодсчета.Текст = "ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК ВсегоЭлементов
	|ИЗ
	|	Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий
	|ГДЕ
	|	НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатПодсчета = ЗапросПодсчета.Выполнить();
		ВыборкаПодсчета = РезультатПодсчета.Выбрать();
		ВсегоЭлементов = 0;
		Если ВыборкаПодсчета.Следующий() Тогда
			ВсегоЭлементов = ВыборкаПодсчета.ВсегоЭлементов;
		КонецЕсли;
	Исключение
		Сообщить("      → ОШИБКА подсчета элементов: " + ОписаниеОшибки());
		ВсегоЭлементов = 0;
	КонецПопытки;
	
	// Показываем сообщение о количестве элементов
	Если ВсегоЭлементов > 0 Тогда
		Сообщить("      → Найдено элементов справочника '" + СправочникМетаданных.Имя + "': " + Строка(ВсегоЭлементов));
		Сообщить("      → Начинаем выгрузку " + Строка(ВсегоЭлементов) + " элементов...");
	Иначе
		Сообщить("      → Элементы справочника '" + СправочникМетаданных.Имя + "' не найдены. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	// Стандартная обработка для всех справочников (включая номенклатуру без характеристик)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|	Ссылка,
	|	Код,
	|	Наименование
	|ИЗ
	|	Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий
	|ГДЕ
	|	НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса для справочника '" + СправочникМетаданных.Имя + "': " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	// Обрабатываем элементы
	КоличествоЭлементов = 0;
	
	Пока Выборка.Следующий() Цикл
		
		КоличествоЭлементов = КоличествоЭлементов + 1;
		
		// Выводим прогресс каждые 10 элементов
		Если КоличествоЭлементов % 10 = 0 Тогда
			Сообщить("        → [" + Строка(КоличествоЭлементов) + "] Отправка элементов...");
		КонецЕсли;
		
		// Получаем реквизиты элемента (передаем имя справочника)
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, СправочникМетаданных.Имя);
		
		// Получаем табличные части элемента (передаем имя справочника)
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, СправочникМетаданных.Имя);
		
		// Отправляем элемент справочника
		ОтправитьЭлементСправочника(
			СправочникМетаданных.Имя,
			Строка(Выборка.Ссылка),
			Строка(Выборка.Код),
			Строка(Выборка.Наименование),
			РеквизитыXML,
			ТабличныеЧастиXML
		);
		
	КонецЦикла;
	
	Если КоличествоЭлементов = 0 Тогда
		Сообщить("      → Элементы справочника не найдены. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	Сообщить("      ✓ Выгружено элементов справочника '" + СправочникМетаданных.Имя + "': " + Строка(КоличествоЭлементов));
	
КонецПроцедуры

// Выгрузка номенклатуры с характеристиками (оптимизированная версия с UNION ALL)
Процедура ВыгрузитьНоменклатуруСХарактеристиками()
	
	Сообщить("      → Выгружаем номенклатуру с характеристиками...");
	
	// Используем подход с циклами для надежности и производительности
	// Получаем все номенклатуры, затем для каждой получаем характеристики двумя запросами
	ЗапросНоменклатуры = Новый Запрос;
	ЗапросНоменклатуры.Текст = "ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка,
	|	Номенклатура.Код КАК Код,
	|	Номенклатура.Наименование КАК Наименование,
	|	Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	Номенклатура.Наименование";
	
	Попытка
		РезультатНоменклатуры = ЗапросНоменклатуры.Выполнить();
		ВыборкаНоменклатуры = РезультатНоменклатуры.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА получения номенклатуры: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	// Подсчитываем общее количество записей
	ВсегоЗаписей = 0;
	ВыборкаДляПодсчета = РезультатНоменклатуры.Выбрать();
	Пока ВыборкаДляПодсчета.Следующий() Цикл
		ВсегоЗаписей = ВсегоЗаписей + 1; // Считаем саму номенклатуру
		
		// Подсчитываем индивидуальные характеристики
		ЗапросПодсчета1 = Новый Запрос;
		ЗапросПодсчета1.Текст = "ВЫБРАТЬ
		|	КОЛИЧЕСТВО(*) КАК Количество
		|ИЗ
		|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|ГДЕ
		|	ХарактеристикиНоменклатуры.Владелец = &Владелец
		|	И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
		|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления";
		ЗапросПодсчета1.УстановитьПараметр("Владелец", ВыборкаДляПодсчета.Ссылка);
		
		Попытка
			РезультатПодсчета1 = ЗапросПодсчета1.Выполнить();
			ВыборкаПодсчета1 = РезультатПодсчета1.Выбрать();
			Если ВыборкаПодсчета1.Следующий() Тогда
				КоличествоИндивидуальных = ВыборкаПодсчета1.Количество;
				Если КоличествоИндивидуальных > 0 Тогда
					ВсегоЗаписей = ВсегоЗаписей - 1 + КоличествоИндивидуальных;
					Продолжить; // Если есть индивидуальные, пропускаем подсчет общих
				КонецЕсли;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		// Подсчитываем общие для вида характеристики
		Если ЗначениеЗаполнено(ВыборкаДляПодсчета.ВидНоменклатуры) Тогда
			ЗапросПодсчета2 = Новый Запрос;
			ЗапросПодсчета2.Текст = "ВЫБРАТЬ
			|	КОЛИЧЕСТВО(*) КАК Количество
			|ИЗ
			|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
			|ГДЕ
			|	ХарактеристикиНоменклатуры.Владелец = &ВидНоменклатуры
			|	И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры
			|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления";
			ЗапросПодсчета2.УстановитьПараметр("ВидНоменклатуры", ВыборкаДляПодсчета.ВидНоменклатуры);
			
			Попытка
				РезультатПодсчета2 = ЗапросПодсчета2.Выполнить();
				ВыборкаПодсчета2 = РезультатПодсчета2.Выбрать();
				Если ВыборкаПодсчета2.Следующий() Тогда
					КоличествоОбщих = ВыборкаПодсчета2.Количество;
					Если КоличествоОбщих > 0 Тогда
						ВсегоЗаписей = ВсегоЗаписей - 1 + КоличествоОбщих;
					КонецЕсли;
				КонецЕсли;
			Исключение
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Сообщить("      → Найдено " + Строка(ВсегоЗаписей) + " комбинаций номенклатуры + характеристик для выгрузки");
	Если ВсегоЗаписей > 0 Тогда
		Сообщить("      → Начинаем выгрузку " + Строка(ВсегоЗаписей) + " комбинаций...");
	Иначе
		Сообщить("      → Номенклатура не найдена. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	// Основной цикл выгрузки
	КоличествоОбработано = 0;
	ВыборкаНоменклатуры = РезультатНоменклатуры.Выбрать();
	
	Пока ВыборкаНоменклатуры.Следующий() Цикл
		
		СсылкаНоменклатуры = ВыборкаНоменклатуры.Ссылка;
		КодНоменклатуры = Строка(ВыборкаНоменклатуры.Код);
		НаименованиеНоменклатуры = Строка(ВыборкаНоменклатуры.Наименование);
		ВидНоменклатуры = ВыборкаНоменклатуры.ВидНоменклатуры;
		
		// Получаем реквизиты и табличные части номенклатуры один раз
		РеквизитыXMLНоменклатуры = ПолучитьРеквизитыЭлементаXML(СсылкаНоменклатуры, "Номенклатура");
		ТабличныеЧастиXMLНоменклатуры = ПолучитьТабличныеЧастиЭлементаXML(СсылкаНоменклатуры, "Номенклатура");
		
		ЕстьХарактеристики = Ложь;
		
		// Сначала получаем индивидуальные характеристики
		ЗапросХарактеристик1 = Новый Запрос;
		ЗапросХарактеристик1.Текст = "ВЫБРАТЬ
		|	ХарактеристикиНоменклатуры.Ссылка КАК Ссылка,
		|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеПолное
		|ИЗ
		|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|ГДЕ
		|	ХарактеристикиНоменклатуры.Владелец = &Владелец
		|	И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
		|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|УПОРЯДОЧИТЬ ПО
		|	ХарактеристикиНоменклатуры.НаименованиеПолное";
		ЗапросХарактеристик1.УстановитьПараметр("Владелец", СсылкаНоменклатуры);
		
		Попытка
			РезультатХарактеристик1 = ЗапросХарактеристик1.Выполнить();
			ВыборкаХарактеристик1 = РезультатХарактеристик1.Выбрать();
			
			Пока ВыборкаХарактеристик1.Следующий() Цикл
				ЕстьХарактеристики = Истина;
				КоличествоОбработано = КоличествоОбработано + 1;
				
				// Выводим прогресс каждые 50 элементов
				Если КоличествоОбработано % 50 = 0 Тогда
					Сообщить("        → [" + Строка(КоличествоОбработано) + "/" + Строка(ВсегоЗаписей) + "] Отправка элементов...");
				КонецЕсли;
				
				НаименованиеХарактеристики = Строка(ВыборкаХарактеристик1.НаименованиеПолное);
				СсылкаХарактеристики = ВыборкаХарактеристик1.Ссылка;
				СоставноеНаименование = НаименованиеНоменклатуры + " " + НаименованиеХарактеристики;
				СоставнаяСсылка = Строка(СсылкаНоменклатуры) + "|" + Строка(СсылкаХарактеристики);
				
				РеквизитыXML = РеквизитыXMLНоменклатуры;
				РеквизитыXML = РеквизитыXML + "<Характеристика>" + ЭкранироватьXML(НаименованиеХарактеристики) + "</Характеристика>";
				РеквизитыXML = РеквизитыXML + "<ХарактеристикаСсылка>" + ЭкранироватьXML(Строка(СсылкаХарактеристики)) + "</ХарактеристикаСсылка>";
				
				ОтправитьЭлементСправочника(
					"Номенклатура",
					СоставнаяСсылка,
					КодНоменклатуры,
					СоставноеНаименование,
					РеквизитыXML,
					ТабличныеЧастиXMLНоменклатуры
				);
			КонецЦикла;
		Исключение
			Сообщить("      → ОШИБКА получения индивидуальных характеристик для номенклатуры '" + НаименованиеНоменклатуры + "': " + ОписаниеОшибки());
		КонецПопытки;
		
		// Если нет индивидуальных, получаем общие для вида
		Если НЕ ЕстьХарактеристики И ЗначениеЗаполнено(ВидНоменклатуры) Тогда
			ЗапросХарактеристик2 = Новый Запрос;
			ЗапросХарактеристик2.Текст = "ВЫБРАТЬ
			|	ХарактеристикиНоменклатуры.Ссылка КАК Ссылка,
			|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеПолное
			|ИЗ
			|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
			|ГДЕ
			|	ХарактеристикиНоменклатуры.Владелец = &ВидНоменклатуры
			|	И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры
			|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
			|УПОРЯДОЧИТЬ ПО
			|	ХарактеристикиНоменклатуры.НаименованиеПолное";
			ЗапросХарактеристик2.УстановитьПараметр("ВидНоменклатуры", ВидНоменклатуры);
			
			Попытка
				РезультатХарактеристик2 = ЗапросХарактеристик2.Выполнить();
				ВыборкаХарактеристик2 = РезультатХарактеристик2.Выбрать();
				
				Пока ВыборкаХарактеристик2.Следующий() Цикл
					ЕстьХарактеристики = Истина;
					КоличествоОбработано = КоличествоОбработано + 1;
					
					// Выводим прогресс каждые 50 элементов
					Если КоличествоОбработано % 50 = 0 Тогда
						Сообщить("        → [" + Строка(КоличествоОбработано) + "/" + Строка(ВсегоЗаписей) + "] Отправка элементов...");
					КонецЕсли;
					
					НаименованиеХарактеристики = Строка(ВыборкаХарактеристик2.НаименованиеПолное);
					СсылкаХарактеристики = ВыборкаХарактеристик2.Ссылка;
					СоставноеНаименование = НаименованиеНоменклатуры + " " + НаименованиеХарактеристики;
					СоставнаяСсылка = Строка(СсылкаНоменклатуры) + "|" + Строка(СсылкаХарактеристики);
					
					РеквизитыXML = РеквизитыXMLНоменклатуры;
					РеквизитыXML = РеквизитыXML + "<Характеристика>" + ЭкранироватьXML(НаименованиеХарактеристики) + "</Характеристика>";
					РеквизитыXML = РеквизитыXML + "<ХарактеристикаСсылка>" + ЭкранироватьXML(Строка(СсылкаХарактеристики)) + "</ХарактеристикаСсылка>";
					
					ОтправитьЭлементСправочника(
						"Номенклатура",
						СоставнаяСсылка,
						КодНоменклатуры,
						СоставноеНаименование,
						РеквизитыXML,
						ТабличныеЧастиXMLНоменклатуры
					);
				КонецЦикла;
			Исключение
				Сообщить("      → ОШИБКА получения общих характеристик для номенклатуры '" + НаименованиеНоменклатуры + "': " + ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
		
		// Если нет характеристик вообще, выгружаем номенклатуру один раз
		Если НЕ ЕстьХарактеристики Тогда
			КоличествоОбработано = КоличествоОбработано + 1;
			
			// Выводим прогресс каждые 50 элементов
			Если КоличествоОбработано % 50 = 0 Тогда
				Сообщить("        → [" + Строка(КоличествоОбработано) + "/" + Строка(ВсегоЗаписей) + "] Отправка элементов...");
			КонецЕсли;
			
			ОтправитьЭлементСправочника(
				"Номенклатура",
				Строка(СсылкаНоменклатуры),
				КодНоменклатуры,
				НаименованиеНоменклатуры,
				РеквизитыXMLНоменклатуры,
				ТабличныеЧастиXMLНоменклатуры
			);
		КонецЕсли;
		
	КонецЦикла;
	
	Если КоличествоОбработано = 0 Тогда
		Сообщить("      → Элементы номенклатуры не найдены. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	Сообщить("      ✓ Выгружено элементов номенклатуры (с характеристиками): " + Строка(КоличествоОбработано));
	
КонецПроцедуры

// Получение реквизитов элемента в XML формате (исправленная версия)
// ИмяСправочника передается как параметр, чтобы не извлекать его из ссылки
Функция ПолучитьРеквизитыЭлементаXML(СсылкаЭлемента, ИмяСправочника)
	
	// Получаем метаданные справочника через индексатор
	Попытка
		СправочникМетаданных = Метаданные.Справочники[ИмяСправочника];
	Исключение
		Сообщить("      → ОШИБКА: Не удалось получить метаданные справочника '" + ИмяСправочника + "': " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("      → ОШИБКА: Метаданные справочника '" + ИмяСправочника + "' не найдены");
		Возврат "";
	КонецЕсли;
	
	XMLСтрока = "";
	
	// Обрабатываем реквизиты
	Для Каждого РеквизитМетаданных Из СправочникМетаданных.Реквизиты Цикл
		
		// Получаем значение реквизита
		ЗначениеРеквизита = Неопределено;
		Попытка
			ЗначениеРеквизита = СсылкаЭлемента[РеквизитМетаданных.Имя];
		Исключение
			// Если не удалось получить значение реквизита, пропускаем его
			Продолжить;
		КонецПопытки;
		
		// Преобразуем в строку
		СтрокаЗначения = "";
		Если ЗначениеРеквизита <> Неопределено Тогда
			СтрокаЗначения = Строка(ЗначениеРеквизита);
			// Экранируем специальные символы
			СтрокаЗначения = ЭкранироватьXML(СтрокаЗначения);
		КонецЕсли;
		
		// Добавляем в XML
		XMLСтрока = XMLСтрока + "<" + РеквизитМетаданных.Имя + ">" + СтрокаЗначения + "</" + РеквизитМетаданных.Имя + ">";
		
	КонецЦикла;
	
	Возврат XMLСтрока;
	
КонецФункции

// Получение табличных частей элемента в XML формате (исправленная версия)
// ИмяСправочника передается как параметр, чтобы не извлекать его из ссылки
Функция ПолучитьТабличныеЧастиЭлементаXML(СсылкаЭлемента, ИмяСправочника)
	
	// Получаем метаданные справочника через индексатор
	Попытка
		СправочникМетаданных = Метаданные.Справочники[ИмяСправочника];
	Исключение
		Сообщить("      → ОШИБКА: Не удалось получить метаданные справочника '" + ИмяСправочника + "': " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("      → ОШИБКА: Метаданные справочника '" + ИмяСправочника + "' не найдены");
		Возврат "";
	КонецЕсли;
	
	XMLСтрока = "";
	
	// Обрабатываем табличные части
	Для Каждого ТабличнаяЧастьМетаданных Из СправочникМетаданных.ТабличныеЧасти Цикл
		
		// Получаем табличную часть
		ТабличнаяЧасть = Неопределено;
		Попытка
			ТабличнаяЧасть = СсылкаЭлемента[ТабличнаяЧастьМетаданных.Имя];
		Исключение
			// Если не удалось получить табличную часть, пропускаем её
			Продолжить;
		КонецПопытки;
		
		Если ТабличнаяЧасть = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		XMLСтрокаТабличнойЧасти = "";
		
		// Обрабатываем строки табличной части
		Для Каждого СтрокаТабличнойЧасти Из ТабличнаяЧасть Цикл
			
			XMLСтрокаСтроки = "<row>";
			
			// Обрабатываем реквизиты (колонки) строки табличной части
			Для Каждого РеквизитТабличнойЧасти Из ТабличнаяЧастьМетаданных.Реквизиты Цикл
				
				ЗначениеКолонки = Неопределено;
				Попытка
					ЗначениеКолонки = СтрокаТабличнойЧасти[РеквизитТабличнойЧасти.Имя];
				Исключение
					// Если не удалось получить значение, пропускаем
					Продолжить;
				КонецПопытки;
				
				СтрокаЗначенияКолонки = "";
				Если ЗначениеКолонки <> Неопределено Тогда
					СтрокаЗначенияКолонки = Строка(ЗначениеКолонки);
					// Экранируем специальные символы
					СтрокаЗначенияКолонки = ЭкранироватьXML(СтрокаЗначенияКолонки);
				КонецЕсли;
				
				XMLСтрокаСтроки = XMLСтрокаСтроки + "<" + РеквизитТабличнойЧасти.Имя + ">" + СтрокаЗначенияКолонки + "</" + РеквизитТабличнойЧасти.Имя + ">";
				
			КонецЦикла;
			
			XMLСтрокаСтроки = XMLСтрокаСтроки + "</row>";
			XMLСтрокаТабличнойЧасти = XMLСтрокаТабличнойЧасти + XMLСтрокаСтроки;
			
		КонецЦикла;
		
		XMLСтрока = XMLСтрока + "<" + ТабличнаяЧастьМетаданных.Имя + ">" + XMLСтрокаТабличнойЧасти + "</" + ТабличнаяЧастьМетаданных.Имя + ">";
		
	КонецЦикла;
	
	Возврат XMLСтрока;
	
КонецФункции

// Отправка элемента справочника на сервер
Процедура ОтправитьЭлементСправочника(ИмяСправочника, Ссылка, Код, Наименование, РеквизитыXML, ТабличныеЧастиXML)
	
	URL = АдресСервера + "/catalog/item";
	
	// Экранируем специальные символы (используем локальные переменные)
	ИмяСправочникаЭкранированное = ЭкранироватьXML(ИмяСправочника);
	СсылкаЭкранированная = ЭкранироватьXML(Ссылка);
	КодЭкранированный = ЭкранироватьXML(Код);
	НаименованиеЭкранированное = ЭкранироватьXML(Наименование);
	
	// Создаем XML для элемента справочника
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<catalog_item>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<catalog_name>" + ИмяСправочникаЭкранированное + "</catalog_name>" +
		"<reference>" + СсылкаЭкранированная + "</reference>" +
		"<code>" + КодЭкранированный + "</code>" +
		"<name>" + НаименованиеЭкранированное + "</name>" +
		"<attributes>" + РеквизитыXML + "</attributes>" +
		"<table_parts>" + ТабличныеЧастиXML + "</table_parts>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</catalog_item>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния <> 200 Тогда
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("Ошибка отправки элемента справочника '" + Наименование + "': " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Завершение выгрузки
Процедура ЗавершитьВыгрузку()
	
	Сообщить("  → Отправка запроса на завершение выгрузки...");
	URL = АдресСервера + "/complete";
	
	// Создаем XML для завершения выгрузки
	XMLСтрока = "<?xml version=""1.0"" encoding=""UTF-8""?>" +
		"<complete>" +
		"<upload_uuid>" + ИдентификаторВыгрузки + "</upload_uuid>" +
		"<timestamp>" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss") + "</timestamp>" +
		"</complete>";
	
	Ответ = ОтправитьHTTPЗапрос("POST", URL, XMLСтрока);
	
	КодСостояния = ПолучитьКодСостояния(Ответ);
	Если КодСостояния = 200 Тогда
		Сообщить("  ✓ Выгрузка завершена успешно на сервере");
	Иначе
		ТелоОтветаОшибка = "";
		Попытка
			ТелоОтветаОшибка = Ответ.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ТелоОтветаОшибка = Ответ.ТелоОтвета;
			Исключение
				ТелоОтветаОшибка = "Не удалось получить тело ответа";
			КонецПопытки;
		КонецПопытки;
		Сообщить("  → ОШИБКА завершения выгрузки: " + ТелоОтветаОшибка);
	КонецЕсли;
	
КонецПроцедуры

// Универсальная функция для отправки HTTP запросов
Функция ОтправитьHTTPЗапрос(Метод, URL, ТелоЗапроса)
	
	Попытка
		
		// Парсим URL для получения базового адреса и пути
		ПозицияПротокола = СтрНайти(URL, "://");
		Если ПозицияПротокола > 0 Тогда
			URLБезПротокола = Прав(URL, СтрДлина(URL) - ПозицияПротокола - 2);
			ПозицияСлеша = СтрНайти(URLБезПротокола, "/");
			Если ПозицияСлеша > 0 Тогда
				// Для HTTPСоединение нужен адрес без протокола, только хост:порт
				БазовыйАдресСервера = Лев(URLБезПротокола, ПозицияСлеша - 1);
				ПутьЗапроса = Прав(URLБезПротокола, СтрДлина(URLБезПротокола) - ПозицияСлеша + 1);
			Иначе
				БазовыйАдресСервера = URLБезПротокола;
				ПутьЗапроса = "/";
			КонецЕсли;
		Иначе
			БазовыйАдресСервера = URL;
			ПутьЗапроса = "/";
		КонецЕсли;
		
		Соединение = Новый HTTPСоединение(БазовыйАдресСервера);
		Заголовки = СоздатьHTTPЗаголовки();
		
		// Создаем HTTPЗапрос с путем (не полным URL!)
		HTTPЗапрос = Новый HTTPЗапрос(ПутьЗапроса, Заголовки);
		
		// Устанавливаем тело запроса из строки
		HTTPЗапрос.УстановитьТелоИзСтроки(ТелоЗапроса, КодировкаТекста.UTF8);
		
		// Отправляем запрос - метод POST определяется автоматически при наличии тела
		Ответ = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
		
		Возврат Ответ;
		
	Исключение
		
		Сообщить("  → КРИТИЧЕСКАЯ ОШИБКА HTTP запроса [" + Метод + " " + URL + "]: " + ОписаниеОшибки());
		Возврат СоздатьПустойHTTPОтвет();
		
	КонецПопытки;
	
КонецФункции

// Создание HTTP соединения
Функция СоздатьHTTPСоединение(URL)
	
	// Эта функция больше не используется напрямую, но оставлена для совместимости
	Возврат Новый HTTPСоединение(URL);
	
КонецФункции

// Создание заголовков HTTP
Функция СоздатьHTTPЗаголовки()
	
	Заголовки = Новый Соответствие;
	Заголовки.Вставить("Content-Type", "application/xml; charset=utf-8");
	Заголовки.Вставить("Accept", "application/xml");
	
	Возврат Заголовки;
	
КонецФункции

// Создание пустого HTTP ответа
Функция СоздатьПустойHTTPОтвет()
	
	// Возвращаем структуру, которая имитирует HTTPОтвет
	Ответ = Новый Структура;
	Ответ.Вставить("КодСостояния", 0);
	Ответ.Вставить("ТелоОтвета", "Пустой ответ");
	
	Возврат Ответ;
	
КонецФункции

// Безопасное получение кода состояния из HTTP ответа
Функция ПолучитьКодСостояния(Ответ)
	
	КодСостояния = 0;
	Попытка
		КодСостояния = Число(Ответ.КодСостояния);
	Исключение
		Попытка
			КодСостояния = Ответ.КодСостояния;
		Исключение
			КодСостояния = 0;
		КонецПопытки;
	КонецПопытки;
	
	Возврат КодСостояния;
	
КонецФункции

// Процедура на клиенте для привязки к кнопке "ВыгрузкаНоменклатуры"
&НаКлиенте
Процедура ВыгрузкаНоменклатуры(Команда)
	
	ВыполнитьВыгрузкуНоменклатурыНаСервере();
	
КонецПроцедуры

// Процедура на клиенте для привязки к кнопке "ВыгрзукаНоменклатурыСХарактеристиками"
&НаКлиенте
Процедура ВыгрзукаНоменклатурыСХарактеристиками(Команда)
	
	ВыполнитьВыгрузкуНоменклатурыСХарактеристикамиНаСервере();
	
КонецПроцедуры

// Серверная процедура для вызова из клиента
&НаСервере
Процедура ВыполнитьВыгрузкуНоменклатурыСХарактеристикамиНаСервере()
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки номенклатуры с характеристиками через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера
	АдресСервера = "http://localhost:9999";
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Отправляем метаданные справочника Номенклатура
	Сообщить("Этап 3: Отправка метаданных справочника 'Номенклатура'...");
	Попытка
		СправочникМетаданных = Метаданные.Справочники["Номенклатура"];
		Если СправочникМетаданных <> Неопределено Тогда
			ОтправитьМетаСправочника(СправочникМетаданных);
		КонецЕсли;
	Исключение
		Сообщить("  → ОШИБКА: Справочник 'Номенклатура' не найден!");
	КонецПопытки;
	
	// Выгружаем номенклатуру с характеристиками
	Сообщить("Этап 4: Выгрузка номенклатуры с характеристиками...");
	ВыгрузитьНоменклатуруСХарактеристиками();
	
	// Завершаем выгрузку
	Сообщить("Этап 5: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка номенклатуры с характеристиками завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Серверная процедура для вызова из клиента
&НаСервере
Процедура ВыполнитьВыгрузкуНоменклатурыНаСервере()
	
	ВыполнитьВыгрузкуНоменклатурыЧерезHTTP();
	
КонецПроцедуры

// Основная процедура для выгрузки номенклатуры через HTTP
Процедура ВыполнитьВыгрузкуНоменклатурыЧерезHTTP() Экспорт
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки номенклатуры через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера
	АдресСервера = "http://localhost:9999";
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем справочник Номенклатура
	Сообщить("Этап 3: Выгрузка справочника 'Номенклатура'...");
	ВыгрузитьСправочникПоИмениЧерезHTTP("Номенклатура");
	
	// Завершаем выгрузку
	Сообщить("Этап 4: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка номенклатуры завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Процедура на клиенте для привязки к кнопке "ВыгрузкаКонтрагентов"
&НаКлиенте
Процедура ВыгрузкаКонтрагентов(Команда)
	
	ВыполнитьВыгрузкуКонтрагентовНаСервере();
	
КонецПроцедуры

// Серверная процедура для вызова из клиента
&НаСервере
Процедура ВыполнитьВыгрузкуКонтрагентовНаСервере()
	
	ВыполнитьВыгрузкуКонтрагентовЧерезHTTP();
	
КонецПроцедуры

// Основная процедура для выгрузки контрагентов через HTTP
Процедура ВыполнитьВыгрузкуКонтрагентовЧерезHTTP() Экспорт
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки контрагентов через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера
	АдресСервера = "http://localhost:9999";
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// Выполняем рукопожатие
	Сообщить("Этап 1: Выполнение рукопожатия с сервером...");
	ИдентификаторВыгрузки = ВыполнитьРукопожатие();
	Если ИдентификаторВыгрузки = "" Тогда
		Сообщить("ОШИБКА: Рукопожатие с сервером не выполнено!");
		Возврат;
	КонецЕсли;
	
	Сообщить("✓ Рукопожатие выполнено успешно. ID выгрузки: " + ИдентификаторВыгрузки);
	
	// Отправляем метаинформацию
	Сообщить("Этап 2: Отправка метаинформации...");
	ОтправитьМетаИнформацию();
	
	// Выгружаем справочник Контрагенты
	Сообщить("Этап 3: Выгрузка справочника 'Контрагенты'...");
	ВыгрузитьСправочникПоИмениЧерезHTTP("Контрагенты");
	
	// Завершаем выгрузку
	Сообщить("Этап 4: Завершение выгрузки...");
	ЗавершитьВыгрузку();
	
	Сообщить("============================================");
	Сообщить("✓ Выгрузка контрагентов завершена успешно!");
	Сообщить("============================================");
	
КонецПроцедуры

// Выгрузка справочника по имени через HTTP
Процедура ВыгрузитьСправочникПоИмениЧерезHTTP(ИмяСправочника)
	
	Сообщить("  → Начинаем выгрузку справочника: " + ИмяСправочника);
	
	// Получаем метаданные справочника
	Попытка
		СправочникМетаданных = Метаданные.Справочники[ИмяСправочника];
	Исключение
		Сообщить("  → ОШИБКА: Справочник '" + ИмяСправочника + "' не найден в метаданных!");
		Возврат;
	КонецПопытки;
	
	Если СправочникМетаданных = Неопределено Тогда
		Сообщить("  → ОШИБКА: Справочник '" + ИмяСправочника + "' не найден!");
		Возврат;
	КонецЕсли;
	
	Сообщить("  → Справочник '" + ИмяСправочника + "' найден. Начинаем выгрузку...");
	
	// Отправляем метаданные справочника
	ОтправитьМетаСправочника(СправочникМетаданных);
	
	// Выгружаем элементы справочника
	ВыгрузитьЭлементыСправочникаЧерезHTTP(СправочникМетаданных);
	
	Сообщить("  ✓ Выгрузка справочника '" + ИмяСправочника + "' завершена");
	
КонецПроцедуры

#КонецОбласти
