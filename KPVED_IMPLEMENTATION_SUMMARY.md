# Реализация поддержки классификатора КПВЭД

## Выполненные задачи

### 1. ✅ Расширение схемы базы данных
**Файл:** `database/schema_versions.go`

**Изменения:**
- Добавлены поля `client_id` и `project_id` в таблицу `category_classifiers`
- Добавлены индексы для оптимизации запросов по клиентам и проектам
- Добавлена миграция для существующих баз данных

**Результат:**
- Классификаторы могут быть привязаны к конкретным клиентам и проектам
- Поддержка глобальных классификаторов (client_id = NULL, project_id = NULL)

### 2. ✅ Обновление модели данных
**Файл:** `database/db_classification.go`

**Изменения:**
- Добавлены поля `ClientID` и `ProjectID` в структуру `CategoryClassifier`
- Обновлены методы:
  - `CreateCategoryClassifier` - поддержка client_id и project_id
  - `GetCategoryClassifier` - чтение client_id и project_id
  - `UpdateCategoryClassifier` - обновление client_id и project_id
- Добавлен метод `GetCategoryClassifiersByFilter` для фильтрации по клиентам/проектам

**Результат:**
- Полная поддержка привязки классификаторов к клиентам и проектам
- Гибкая фильтрация классификаторов

### 3. ✅ Парсер файла КПВЭД
**Файл:** `cmd/load_kpved/main.go`

**Функциональность:**
- Парсинг файла КПВЭД.txt с поддержкой табуляции и пробелов
- Построение иерархического дерева категорий из плоского списка
- Автоматическое определение глубины иерархии
- Построение полных путей категорий
- Сериализация в JSON для хранения в базе

**Особенности:**
- Поддержка формата: `код\tнаименование` или `код наименование`
- Автоматическое определение родительских категорий по коду
- Обработка многоуровневой иерархии (до 6 уровней)

### 4. ✅ Скрипт загрузки КПВЭД
**Файл:** `cmd/load_kpved/main.go`

**Использование:**
```bash
# Глобальный классификатор
go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db

# Для клиента
go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db 1

# Для проекта
go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db 1 1
```

**Функции:**
- Парсинг файла КПВЭД
- Построение дерева категорий
- Сохранение в базу данных с указанием client_id и project_id
- Вывод статистики загрузки

### 5. ✅ Скрипт проверки классификаторов
**Файл:** `cmd/check_classifiers/main.go`

**Использование:**
```bash
# Проверка всех классификаторов
go run cmd/check_classifiers/main.go 1c_data.db

# Проверка для клиента/проекта
go run cmd/check_classifiers/main.go 1c_data.db 1 1
```

**Функции:**
- Проверка наличия классификаторов в базе
- Фильтрация по клиентам и проектам
- Вывод подробной информации о каждом классификаторе
- Проверка наличия КПВЭД

## Структура данных

### Таблица category_classifiers

```sql
CREATE TABLE category_classifiers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    max_depth INTEGER DEFAULT 6,
    tree_structure TEXT NOT NULL,  -- JSON дерево категорий
    client_id INTEGER,              -- ID клиента (NULL = глобальный)
    project_id INTEGER,             -- ID проекта (NULL = глобальный)
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Приоритет поиска классификатора

При запросе классификатора система использует следующий приоритет:
1. Классификатор для проекта (client_id + project_id совпадают)
2. Классификатор для клиента (client_id совпадает, project_id = NULL)
3. Глобальный классификатор (client_id = NULL, project_id = NULL)

## Для проекта АЙТАЗ

### Рекомендуемые шаги

1. **Определить ID клиента и проекта АЙТАЗ**
   - Проверить в сервисной базе данных
   - Или создать новые записи если их нет

2. **Загрузить классификатор КПВЭД**
   ```bash
   go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db <client_id> <project_id>
   ```

3. **Проверить загрузку**
   ```bash
   go run cmd/check_classifiers/main.go 1c_data.db <client_id> <project_id>
   ```

4. **Использовать в нормализации**
   - Классификатор будет автоматически использован при классификации товаров
   - Можно настроить стратегию свертки категорий для нужной глубины

## API для работы с классификаторами

### Получение классификаторов

```http
GET /api/classification/classifiers?client_id=1&project_id=1
```

### Использование в классификации

Классификатор автоматически используется при вызове:
```http
POST /api/classification/classify-item
{
  "item_name": "Пшеница твердая",
  "strategy_id": "top_priority"
}
```

## Множественные классификаторы

Система поддерживает:
- **Глобальные классификаторы** - доступны всем клиентам и проектам
- **Классификаторы для клиентов** - доступны только конкретному клиенту
- **Классификаторы для проектов** - доступны только конкретному проекту

Это позволяет:
- Использовать разные классификаторы для разных проектов
- Иметь общий классификатор для всех проектов клиента
- Легко переключаться между классификаторами

## Файлы созданы/изменены

### Новые файлы
- `cmd/load_kpved/main.go` - скрипт загрузки КПВЭД
- `cmd/check_classifiers/main.go` - скрипт проверки классификаторов
- `KPVED_CLASSIFIER_SETUP.md` - документация по настройке
- `KPVED_IMPLEMENTATION_SUMMARY.md` - эта сводка

### Измененные файлы
- `database/schema_versions.go` - расширение схемы таблицы
- `database/db_classification.go` - обновление модели и методов

## Следующие шаги

1. Загрузить классификатор КПВЭД для проекта АЙТАЗ
2. Протестировать классификацию товаров с использованием КПВЭД
3. Настроить стратегии свертки категорий для проекта
4. Интегрировать в процесс нормализации НСИ

## Проверка готовности

Для проверки, что все готово к использованию:

```bash
# 1. Проверить компиляцию
go build ./cmd/load_kpved
go build ./cmd/check_classifiers

# 2. Проверить наличие классификаторов
go run cmd/check_classifiers/main.go 1c_data.db

# 3. Загрузить КПВЭД (если нужно)
go run cmd/load_kpved/main.go КПВЭД.txt 1c_data.db
```

Система готова к использованию классификатора КПВЭД для проекта АЙТАЗ!

