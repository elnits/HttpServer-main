# Инструкция по интеграции расширений в модуль обработки 1С

## Обзор

Этот документ описывает, как интегрировать новые функции пакетной выгрузки, расширенного рукопожатия, универсальных запросов и мониторинга в существующий модуль обработки.

## Новые возможности

1. **Расширенное рукопожатие** - привязка выгрузок к иерархии клиент-проект-БД
2. **Универсальные запросы** - работают в любой конфигурации 1С
3. **Пакетная выгрузка** - оптимизация для больших объемов данных
4. **Статистика и мониторинг** - контроль выгрузок и анализ данных
5. **Обратная совместимость** - поддержка старых версий сервера

## Шаги интеграции

### 1. Добавление новых переменных

В область `#Область СлужебныеПеременные` добавьте:

```bsl
Перем ИспользоватьПакетнуюВыгрузку;
Перем РазмерПакета;
Перем ИдентификаторБазыДанных;
```

### 2. Модификация процедуры ВыполнитьВыгрузкуЧерезHTTP

Измените начало процедуры `ВыполнитьВыгрузкуЧерезHTTP()`:

```bsl
// Основная процедура для запуска выгрузки через HTTP
Процедура ВыполнитьВыгрузкуЧерезHTTP() Экспорт
	
	// Обновляем настройки из формы перед началом выгрузки
	ОбновитьНастройкиИзФормы();
	
	Сообщить("============================================");
	Сообщить("Начало выгрузки данных через HTTP");
	Сообщить("============================================");
	
	// Адрес сервера теперь берется из формы
	// АдресСервера уже установлен в ОбновитьНастройкиИзФормы()
	Сообщить("Адрес сервера: " + АдресСервера);
	
	// ... остальной код без изменений
```

### 3. Модификация процедуры ВыгрузитьЭлементыСправочникаЧерезHTTP

Замените процедуру `ВыгрузитьЭлементыСправочникаЧерезHTTP` на версию с поддержкой пакетной выгрузки:

```bsl
// Выгрузка элементов справочника через HTTP (с поддержкой пакетной выгрузки)
Процедура ВыгрузитьЭлементыСправочникаЧерезHTTP(СправочникМетаданных)
	
	Сообщить("      → Выгружаем элементы справочника: " + СправочникМетаданных.Имя);
	
	ИмяСправочникаВЗапросе = СправочникМетаданных.Имя;
	
	// Сначала подсчитываем количество элементов
	ЗапросПодсчета = Новый Запрос;
	ЗапросПодсчета.Текст = "ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК ВсегоЭлементов
	|ИЗ
	|	Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий
	|ГДЕ
	|	НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатПодсчета = ЗапросПодсчета.Выполнить();
		ВыборкаПодсчета = РезультатПодсчета.Выбрать();
		ВсегоЭлементов = 0;
		Если ВыборкаПодсчета.Следующий() Тогда
			ВсегоЭлементов = ВыборкаПодсчета.ВсегоЭлементов;
		КонецЕсли;
	Исключение
		Сообщить("      → ОШИБКА подсчета элементов: " + ОписаниеОшибки());
		ВсегоЭлементов = 0;
	КонецПопытки;
	
	// Показываем сообщение о количестве элементов
	Если ВсегоЭлементов > 0 Тогда
		Сообщить("      → Найдено элементов справочника '" + СправочникМетаданных.Имя + "': " + Строка(ВсегоЭлементов));
		Сообщить("      → Начинаем выгрузку " + Строка(ВсегоЭлементов) + " элементов...");
	Иначе
		Сообщить("      → Элементы справочника '" + СправочникМетаданных.Имя + "' не найдены. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	// Стандартная обработка для всех справочников
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ 
	|	Ссылка,
	|	Код,
	|	Наименование
	|ИЗ
	|	Справочник." + ИмяСправочникаВЗапросе + " КАК СправочникТекущий
	|ГДЕ
	|	НЕ СправочникТекущий.ПометкаУдаления";
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
	Исключение
		Сообщить("      → ОШИБКА выполнения запроса для справочника '" + СправочникМетаданных.Имя + "': " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	// Буфер для пакетной выгрузки
	МассивЭлементов = Новый Массив;
	КоличествоЭлементов = 0;
	Счетчик = 0;
	
	Пока Выборка.Следующий() Цикл
		
		КоличествоЭлементов = КоличествоЭлементов + 1;
		Счетчик = Счетчик + 1;
		
		// Выводим прогресс каждые 10 элементов
		Если КоличествоЭлементов % 10 = 0 Тогда
			Сообщить("        → [" + Строка(КоличествоЭлементов) + "] Отправка элементов...");
		КонецЕсли;
		
		// Получаем реквизиты элемента (передаем имя справочника)
		РеквизитыXML = ПолучитьРеквизитыЭлементаXML(Выборка.Ссылка, СправочникМетаданных.Имя);
		
		// Получаем табличные части элемента (передаем имя справочника)
		ТабличныеЧастиXML = ПолучитьТабличныеЧастиЭлементаXML(Выборка.Ссылка, СправочникМетаданных.Имя);
		
		// Создаем структуру элемента
		Элемент = Новый Структура;
		Элемент.Вставить("Ссылка", Строка(Выборка.Ссылка));
		Элемент.Вставить("Код", Строка(Выборка.Код));
		Элемент.Вставить("Наименование", Строка(Выборка.Наименование));
		Элемент.Вставить("РеквизитыXML", РеквизитыXML);
		Элемент.Вставить("ТабличныеЧастиXML", ТабличныеЧастиXML);
		
		Если ИспользоватьПакетнуюВыгрузку Тогда
			МассивЭлементов.Добавить(Элемент);
			
			// Отправляем пакет при достижении размера
			Если МассивЭлементов.Количество() >= РазмерПакета Тогда
				ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
				Сообщить("        → Отправлен пакет: " + Строка(МассивЭлементов.Количество()) + " элементов");
				МассивЭлементов = Новый Массив;
			КонецЕсли;
		Иначе
			// Отправка по одному
			ОтправитьЭлементСправочника(
				СправочникМетаданных.Имя,
				Элемент.Ссылка,
				Элемент.Код,
				Элемент.Наименование,
				Элемент.РеквизитыXML,
				Элемент.ТабличныеЧастиXML
			);
		КонецЕсли;
		
	КонецЦикла;
	
	// Отправляем оставшиеся элементы в буфере
	Если ИспользоватьПакетнуюВыгрузку И МассивЭлементов.Количество() > 0 Тогда
		ОтправитьПакетЭлементовСправочника(СправочникМетаданных.Имя, МассивЭлементов);
		Сообщить("        → Отправлен последний пакет: " + Строка(МассивЭлементов.Количество()) + " элементов");
	КонецЕсли;
	
	Если КоличествоЭлементов = 0 Тогда
		Сообщить("      → Элементы справочника не найдены. Пропускаем.");
		Возврат;
	КонецЕсли;
	
	Сообщить("      ✓ Выгружено элементов справочника '" + СправочникМетаданных.Имя + "': " + Строка(КоличествоЭлементов));
	
КонецПроцедуры
```

### 4. Добавление новых процедур

Скопируйте все процедуры из файла `1c_module_extensions.bsl` в конец области `#Область ПрограммныйИнтерфейс` вашего модуля обработки.

### 5. Модификация процедуры ВыполнитьВыгрузкуКонтрагентовЧерезHTTP

Замените существующую процедуру `ВыполнитьВыгрузкуКонтрагентовЧерезHTTP` на версию, которая вызывает `ВыполнитьВыгрузкуКонтрагентовНаСервере()` из расширений.

Или просто замените вызов `ВыгрузитьСправочникПоИмениЧерезHTTP("Контрагенты")` на `ВыгрузитьСправочникКонтрагентовПакетами()`.

### 6. Обновление процедуры выгрузки номенклатуры

В процедуре `ВыполнитьВыгрузкуНоменклатурыСХарактеристикамиНаСервере()` замените вызов `ВыгрузитьНоменклатуруСХарактеристиками()` на `ВыгрузитьНоменклатуруСХарактеристикамиЧерезHTTP()` из расширений.

## Проверка интеграции

После интеграции проверьте:

1. Все новые процедуры добавлены в модуль
2. Переменные для пакетной выгрузки объявлены
3. Процедура `ОбновитьНастройкиИзФормы()` вызывается перед началом выгрузки
4. Процедура `ВыгрузитьЭлементыСправочникаЧерезHTTP` модифицирована для поддержки пакетов
5. Все клиентские процедуры привязаны к командам формы

## Новые функции и их использование

### Расширенное рукопожатие

Функция `ВыполнитьРукопожатиеСПривязкой()` автоматически определяет доступность нового API и использует fallback на старый API при необходимости.

**Использование:**
```bsl
// В процедуре ВыполнитьВыгрузкуЧерезHTTP замените:
ИдентификаторВыгрузки = ВыполнитьРукопожатие();

// На:
Если ИдентификаторБазыДанных <> "" Тогда
    ИдентификаторВыгрузки = ВыполнитьРукопожатиеСПривязкой();
Иначе
    ИдентификаторВыгрузки = ВыполнитьРукопожатие();
КонецЕсли;
```

### Универсальные запросы номенклатуры

Функция `ПолучитьУниверсальныйЗапросНоменклатуры()` возвращает запрос, который работает в любой конфигурации 1С.

**Использование:**
```bsl
Запрос = Новый Запрос;
Запрос.Текст = ПолучитьУниверсальныйЗапросНоменклатуры();
Результат = Запрос.Выполнить();
```

### Статистика и мониторинг

**Получение статистики:**
```bsl
Статистика = ПолучитьСтатистикуНоменклатуры();
// Возвращает структуру: ВсегоКомбинаций, ВсегоНоменклатур, ВсегоХарактеристик
```

**Проверка соединения:**
```bsl
Если ПроверитьСоединение() Тогда
    Сообщить("Соединение установлено");
КонецЕсли;
```

**Проверка привязки базы данных:**
```bsl
Результат = ПроверитьПривязкуБазыДанных();
// Возвращает строку с результатом проверки
```

**Получение статуса выгрузки:**
```bsl
Статус = ПолучитьСтатусВыгрузки();
// Возвращает строку со статусом и прогрессом
```

## Примечания

- Если справочник "Контрагенты" выгружается в процедуре `ВыгрузитьСправочникиЧерезHTTP`, убедитесь, что он использует пакетную выгрузку при включенной настройке
- Процедура `ВыгрузитьНоменклатуруСХарактеристиками` в существующем коде может быть заменена на новую версию с поддержкой пакетов
- Все процедуры из расширений должны быть добавлены в модуль обработки
- Расширенное рукопожатие автоматически определяет доступность нового API и использует fallback
- Универсальные запросы работают в любой конфигурации 1С без изменений
- Функции мониторинга поддерживают как новый, так и старый API сервера

