# Инструкция по настройке формы обработки 1С

## Описание

Эта инструкция описывает настройку формы обработки для выгрузки данных из 1С в сервис нормализации и анализа.

## Реквизиты формы

Добавьте следующие реквизиты в форму обработки:

1. **АдресСервера** (тип: Строка)
   - Значение по умолчанию: `http://localhost:9999`
   - Описание: Адрес HTTP сервера для выгрузки данных

2. **ИдентификаторБазыДанных** (тип: Строка)
   - Значение по умолчанию: пустая строка
   - Описание: ID базы данных на сервере для связи выгрузки с клиентом/проектом/БД (опционально, приоритет 1)

3. **ClientID** (тип: Строка)
   - Значение по умолчанию: пустая строка
   - Описание: ID клиента для автоматического поиска database_id на сервере (опционально, приоритет 2). Может быть предварительно настроен в форме.

4. **ProjectID** (тип: Строка)
   - Значение по умолчанию: пустая строка
   - Описание: ID проекта для автоматического поиска database_id на сервере (опционально, приоритет 2). Может быть предварительно настроен в форме.

5. **ИспользоватьПакетнуюВыгрузку** (тип: Булево)
   - Значение по умолчанию: `Истина`
   - Описание: Включить/выключить пакетную выгрузку элементов справочников

6. **РазмерПакета** (тип: Число)
   - Значение по умолчанию: `50`
   - Описание: Количество элементов в одном пакете при пакетной выгрузке

7. **ПутьКФайлу** (тип: Строка)
   - Значение по умолчанию: пустая строка
   - Описание: Путь к файлу для сохранения выгрузки номенклатуры в JSON

8. **ИмяКлиента** (тип: Строка, только чтение)
   - Значение по умолчанию: пустая строка
   - Описание: Имя клиента (заполняется автоматически при проверке привязки)

9. **ИмяПроекта** (тип: Строка, только чтение)
   - Значение по умолчанию: пустая строка
   - Описание: Имя проекта (заполняется автоматически при проверке привязки)

10. **ИмяБазыДанных** (тип: Строка, только чтение)
   - Значение по умолчанию: пустая строка
   - Описание: Имя базы данных (заполняется автоматически при проверке привязки)

11. **ОбщееКоличествоОбъектов** (тип: Число)
   - Значение по умолчанию: `0`
   - Описание: Общее количество объектов для выгрузки (используется для расчета прогресса)

12. **ТекущаяПозиция** (тип: Число)
    - Значение по умолчанию: `0`
    - Описание: Текущая позиция обработанных объектов (используется для расчета прогресса)

13. **ВыполняетсяВыгрузка** (тип: Булево)
    - Значение по умолчанию: `Ложь`
    - Описание: Флаг выполнения выгрузки (используется для управления состоянием формы)

14. **ТребуетсяПрервать** (тип: Булево)
    - Значение по умолчанию: `Ложь`
    - Описание: Флаг прерывания выгрузки (устанавливается при нажатии кнопки "Прервать")

15. **ТекущийЭтап** (тип: Строка)
    - Значение по умолчанию: пустая строка
    - Описание: Название текущего этапа выгрузки (отображается в поле этапа)

16. **ТекущийОбъект** (тип: Строка)
    - Значение по умолчанию: пустая строка
    - Описание: Название текущего обрабатываемого объекта (отображается в поле текущего объекта)

## Элементы формы

### Группа "Выгрузка через HTTP"

Создайте группу с названием "Выгрузка через HTTP" и добавьте следующие кнопки:

1. **ВыгрузкаВсего** (уже существует)
   - Команда формы: `ВыгрузкаВсего`
   - Описание: Выполняет полную выгрузку всех констант и справочников

2. **ВыгрузкаКонтрагентов**
   - Команда формы: `ВыгрузкаКонтрагентов`
   - Описание: Выполняет выгрузку только справочника "Контрагенты" (всегда и полностью)

3. **ВыгрузкаНоменклатуры**
   - Команда формы: `ВыгрузкаНоменклатуры`
   - Описание: Выполняет выгрузку номенклатуры с характеристиками через HTTP

### Группа "Настройки соединения"

Создайте группу с названием "Настройки соединения" и добавьте следующие элементы:

1. **Поле ввода "АдресСервера"**
   - Тип: ПолеВвода
   - Реквизит формы: `АдресСервера`
   - Заголовок: "Адрес сервера"
   - Подсказка: "Адрес HTTP сервера для выгрузки данных (например: http://localhost:9999)"

2. **Поле ввода "ИдентификаторБазыДанных"**
   - Тип: ПолеВвода
   - Реквизит формы: `ИдентификаторБазыДанных`
   - Заголовок: "Идентификатор базы данных"
   - Подсказка: "ID базы данных на сервере (приоритет 1 - используется напрямую, если указан)"

3. **Поле ввода "ClientID"** (опционально)
   - Тип: ПолеВвода
   - Реквизит формы: `ClientID`
   - Заголовок: "ID клиента"
   - Подсказка: "ID клиента для автоматического поиска database_id на сервере (приоритет 2 - используется вместе с ProjectID). Может быть предварительно настроен."

4. **Поле ввода "ProjectID"** (опционально)
   - Тип: ПолеВвода
   - Реквизит формы: `ProjectID`
   - Заголовок: "ID проекта"
   - Подсказка: "ID проекта для автоматического поиска database_id на сервере (приоритет 2 - используется вместе с ClientID). Может быть предварительно настроен."

5. **Флажок "ИспользоватьПакетнуюВыгрузку"**
   - Тип: Флажок
   - Реквизит формы: `ИспользоватьПакетнуюВыгрузку`
   - Заголовок: "Использовать пакетную выгрузку"
   - Подсказка: "Включить пакетную отправку элементов справочников для оптимизации работы через интернет"

6. **Поле ввода "РазмерПакета"**
   - Тип: ПолеВводаЧисла
   - Реквизит формы: `РазмерПакета`
   - Заголовок: "Размер пакета"
   - Подсказка: "Количество элементов в одном пакете (рекомендуется: 50-100)"

7. **Кнопка "ПроверитьСоединение"**
   - Команда формы: `ПроверитьСоединение`
   - Заголовок: "Проверить соединение"
   - Подсказка: "Проверить доступность сервера"

8. **Кнопка "ПроверитьПривязку"**
   - Команда формы: `ПроверитьПривязку`
   - Заголовок: "Проверить привязку"
   - Подсказка: "Проверить привязку базы данных и получить информацию о клиенте/проекте/БД"

### Группа "Идентификация базы данных"

**Важно:** Идентификация database_id происходит автоматически на сервере при выполнении рукопожатия. Пользователю не нужно нажимать никакие кнопки - система сама определит database_id по приоритетам:
1. Прямой database_id (если указан)
2. Поиск по client_id/project_id (если указаны)
3. Автоматическое создание новой базы данных

Создайте группу с названием "Идентификация базы данных" и добавьте следующие элементы:

1. **Поле ввода "ИдентификаторБазыДанных"** (уже описано выше в группе "Настройки соединения")
   - Можно продублировать здесь для удобства

2. **Поле ввода "ClientID"** (уже описано выше в группе "Настройки соединения")
   - Можно продублировать здесь для удобства

3. **Поле ввода "ProjectID"** (уже описано выше в группе "Настройки соединения")
   - Можно продублировать здесь для удобства

4. **Поле ввода "ИмяКлиента"** (только чтение)
   - Тип: ПолеВвода
   - Реквизит формы: `ИмяКлиента`
   - Заголовок: "Имя клиента"
   - Режим ввода: Только просмотр
   - Подсказка: "Имя клиента (заполняется автоматически)"

5. **Поле ввода "ИмяПроекта"** (только чтение)
   - Тип: ПолеВвода
   - Реквизит формы: `ИмяПроекта`
   - Заголовок: "Имя проекта"
   - Режим ввода: Только просмотр
   - Подсказка: "Имя проекта (заполняется автоматически)"

6. **Поле ввода "ИмяБазыДанных"** (только чтение)
   - Тип: ПолеВвода
   - Реквизит формы: `ИмяБазыДанных`
   - Заголовок: "Имя базы данных"
   - Режим ввода: Только просмотр
   - Подсказка: "Имя базы данных (заполняется автоматически)"

### Группа "Выгрузка в файл"

Создайте группу с названием "Выгрузка в файл" и добавьте следующие элементы:

1. **Поле ввода "ПутьКФайлу"**
   - Тип: ПолеВвода
   - Реквизит формы: `ПутьКФайлу`
   - Заголовок: "Путь к файлу"
   - Подсказка: "Путь к файлу для сохранения выгрузки номенклатуры в JSON"
   - Режим ввода: Только просмотр (чтобы пользователь не мог редактировать напрямую)

2. **Кнопка "ВыбратьКаталог"**
   - Команда формы: `ВыбратьКаталог`
   - Заголовок: "Выбрать каталог"
   - Подсказка: "Выбрать каталог для сохранения файла выгрузки"

3. **Кнопка "ВыгрузитьНоменклатуруВJSON"**
   - Команда формы: `ВыгрузитьНоменклатуруВJSON`
   - Заголовок: "Выгрузить номенклатуру в JSON"
   - Подсказка: "Выгрузить номенклатуру с характеристиками в JSON файл"

4. **Кнопка "ВыгрузитьНоменклатуруУниверсально"**
   - Команда формы: `ВыгрузитьНоменклатуруУниверсально`
   - Заголовок: "Выгрузить номенклатуру (универсально)"
   - Подсказка: "Выгрузить номенклатуру с характеристиками с использованием универсального запроса"

5. **Кнопка "ПолучитьСтатистику"**
   - Команда формы: `ПолучитьСтатистику`
   - Заголовок: "Получить статистику"
   - Подсказка: "Получить статистику по номенклатуре перед выгрузкой"

### Группа "Прогресс выгрузки"

Создайте группу с названием "Прогресс выгрузки" и добавьте следующие элементы:

1. **ИндикаторПрогресса** (ПрогрессБар)
   - Тип: ПрогрессБар
   - Реквизит формы: не требуется (значение устанавливается программно)
   - Заголовок: "Прогресс выгрузки"
   - Подсказка: "Индикатор прогресса выгрузки (0-100%)"
   - Минимум: 0
   - Максимум: 100
   - Значение: устанавливается программно через переменную модуля

2. **ПолеСтатуса** (ПолеФормы)
   - Тип: ПолеФормы
   - Реквизит формы: не требуется (значение устанавливается программно)
   - Заголовок: "Статус"
   - Подсказка: "Текущий статус выгрузки (Обработано X из Y)"
   - Режим ввода: Только просмотр

3. **ПолеЭтапа** (ПолеФормы)
   - Тип: ПолеФормы
   - Реквизит формы: `ТекущийЭтап`
   - Заголовок: "Текущий этап"
   - Подсказка: "Название текущего этапа выгрузки"
   - Режим ввода: Только просмотр

4. **ПолеТекущегоОбъекта** (ПолеФормы)
   - Тип: ПолеФормы
   - Реквизит формы: `ТекущийОбъект`
   - Заголовок: "Текущий объект"
   - Подсказка: "Название текущего обрабатываемого объекта"
   - Режим ввода: Только просмотр

5. **КнопкаПрервать** (Кнопка)
   - Тип: Кнопка
   - Команда формы: `ПрерватьВыгрузку`
   - Заголовок: "Прервать"
   - Подсказка: "Прервать выполнение выгрузки"
   - Доступность: по умолчанию `Ложь`, устанавливается в `Истина` при начале выгрузки

6. **ТаймерОбновления** (Таймер)
   - Тип: Таймер
   - Реквизит формы: не требуется
   - Интервал: 500 (миллисекунд)
   - Видимость: Ложь (невидимый элемент)
   - Событие: `Тик` → `ТаймерОбновленияТик()`
   - Подсказка: "Таймер для обновления прогресса выгрузки"

### Группа "Аналитика и мониторинг"

Создайте группу с названием "Аналитика и мониторинг" и добавьте следующие элементы:

1. **Поле документа "ЛогВыгрузки"**
   - Тип: ПолеДокумента
   - Реквизит формы: `ЛогВыгрузки`
   - Заголовок: "Лог выгрузки"
   - Подсказка: "Лог выполнения выгрузки"

2. **Кнопка "ПолучитьСтатусВыгрузки"**
   - Команда формы: `ПолучитьСтатусВыгрузки`
   - Заголовок: "Получить статус выгрузки"
   - Подсказка: "Получить текущий статус выгрузки с сервера"

## Привязки команд к процедурам

Убедитесь, что следующие команды формы привязаны к соответствующим процедурам:

- `ВыгрузкаВсего` → `ВыгрузкаВсего()` (клиентская процедура)
- `ВыгрузкаКонтрагентов` → `ВыгрузкаКонтрагентов()` (клиентская процедура)
- `ВыгрузкаНоменклатуры` → `ВыгрузкаНоменклатуры()` (клиентская процедура)
- `ВыбратьКаталог` → `ВыбратьКаталог()` (клиентская процедура)
- `ВыгрузитьНоменклатуруВJSON` → `ВыгрузитьНоменклатуруВJSON()` (клиентская процедура)
- `ВыгрузитьНоменклатуруУниверсально` → `ВыгрузитьНоменклатуруУниверсально()` (клиентская процедура)
- `ПолучитьСтатистику` → `ПолучитьСтатистику()` (клиентская процедура)
- `ПроверитьСоединение` → `ПроверитьСоединение()` (клиентская процедура)
- `ПроверитьПривязку` → `ПроверитьПривязку()` (клиентская процедура)
- `ПолучитьСтатусВыгрузки` → `ПолучитьСтатусВыгрузки()` (клиентская процедура)
- `ПрерватьВыгрузку` → `ПрерватьВыгрузку()` (клиентская процедура)
- `ТаймерОбновленияТик` → `ТаймерОбновленияТик()` (клиентская процедура, обработчик события таймера)

## Рекомендации по размещению элементов

1. Разместите группу "Выгрузка через HTTP" в верхней части формы
2. Разместите группу "Прогресс выгрузки" сразу после группы "Выгрузка через HTTP" для удобного отслеживания прогресса
3. Разместите группу "Настройки соединения" в средней части формы
4. Разместите группу "Выгрузка в файл" в нижней части формы
5. Разместите группу "Аналитика и мониторинг" в самом низу формы

## Инициализация значений по умолчанию

В процедуре `ПриСозданииНаСервере` формы установите значения по умолчанию:

```bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Устанавливаем значения по умолчанию
	Если Объект.АдресСервера = "" Тогда
		Объект.АдресСервера = "http://localhost:9999";
	КонецЕсли;
	
	Если Объект.РазмерПакета = 0 Тогда
		Объект.РазмерПакета = 50;
	КонецЕсли;
	
	Если Объект.ИспользоватьПакетнуюВыгрузку = Неопределено Тогда
		Объект.ИспользоватьПакетнуюВыгрузку = Истина;
	КонецЕсли;
	
	// Новые реквизиты для идентификации через client_id и project_id
	Попытка
		Если Объект.ClientID = Неопределено Тогда
			Объект.ClientID = "";
		КонецЕсли;
		Если Объект.ProjectID = Неопределено Тогда
			Объект.ProjectID = "";
		КонецЕсли;
	Исключение
		// Реквизиты могут отсутствовать в старых версиях формы
	КонецПопытки;
	
КонецПроцедуры
```

## Работа с прогрессом выгрузки

### Механизм работы

1. **Инициализация**: При нажатии кнопки "ВыгрузкаВсего" или других кнопок выгрузки:
   - Получается общее количество объектов для выгрузки
   - Сбрасываются переменные прогресса (ТекущаяПозиция = 0)
   - Запускается таймер обновления прогресса
   - Блокируется кнопка "Выполнить", разблокируется кнопка "Прервать"

2. **Обновление прогресса**: Таймер обновляет индикатор прогресса каждые 500 мс:
   - Рассчитывается процент выполнения: `(ТекущаяПозиция / ОбщееКоличествоОбъектов) * 100`
   - Обновляется индикатор прогресса
   - Обновляется поле статуса: "Обработано X из Y"
   - Обновляются поля этапа и текущего объекта

3. **Обработка пакетов**: Выгрузка выполняется пакетами:
   - Каждый пакет обрабатывается асинхронно на сервере
   - После обработки пакета вызывается колбэк `ПослеОбработкиПакета`
   - В колбэке обновляется текущая позиция и запускается следующий пакет

4. **Прерывание**: При нажатии кнопки "Прервать":
   - Устанавливается флаг `ТребуетсяПрервать = Истина`
   - Следующий пакет не запускается
   - Восстанавливается состояние формы

### Переменные модуля для отслеживания прогресса

В модуле обработки должны быть объявлены следующие переменные (на клиенте):

```bsl
Перем ОбщееКоличествоОбъектов;
Перем ТекущаяПозиция;
Перем ВыполняетсяВыгрузка;
Перем ТребуетсяПрервать;
Перем ТекущийЭтап;
Перем ТекущийОбъект;
```

## Примечания

- Все элементы формы должны быть доступны для редактирования пользователем
- Поле "ПутьКФайлу" рекомендуется сделать только для просмотра, чтобы пользователь выбирал путь через диалог
- Размер пакета рекомендуется устанавливать в диапазоне 50-100 элементов для оптимального баланса между производительностью и надежностью
- Индикатор прогресса и поля статуса обновляются автоматически через таймер, не требуют ручного обновления
- Кнопка "Прервать" доступна только во время выполнения выгрузки

