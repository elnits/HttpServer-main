#Область УниверсальныеЗапросы

// Универсальный запрос номенклатуры с характеристиками (работает в любой конфигурации 1С)
// Использует запрос из 1c_query_simple.txt
&НаСервере
Функция ПолучитьУниверсальныйЗапросНоменклатуры()
	
	Возврат 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ХарактеристикиНоменклатуры.Ссылка КАК СсылкаХарактеристики,
	|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
	|			И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ХарактеристикиНоменклатуры.Ссылка КАК СсылкаХарактеристики,
	|	ХарактеристикиНоменклатуры.НаименованиеПолное КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО Номенклатура.ВидНоменклатуры = ХарактеристикиНоменклатуры.Владелец
	|			И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК СсылкаНоменклатуры,
	|	Номенклатура.Код КАК КодНоменклатуры,
	|	Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК СсылкаХарактеристики,
	|	ВЫРАЗИТЬ(NULL КАК СТРОКА(1)) КАК НаименованиеХарактеристики
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
	|				И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.Номенклатура
	|			ИЛИ Номенклатура.ВидНоменклатуры = ХарактеристикиНоменклатуры.Владелец
	|				И ХарактеристикиНоменклатуры.Владелец ССЫЛКА Справочник.ВидыНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|
	|УПОРЯДОЧИТЬ ПО
	|	НаименованиеНоменклатуры,
	|	НаименованиеХарактеристики";
	
КонецФункции

// Получение статистики номенклатуры (использует запрос 2 из 1c_queries_nomenclature_with_characteristics.txt)
&НаСервере
Функция ПолучитьСтатистикуНоменклатурыУниверсальная()
	
	Сообщить("=== ПОЛУЧЕНИЕ СТАТИСТИКИ НОМЕНКЛАТУРЫ ===");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК ВсегоКомбинаций,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СсылкаНоменклатуры) КАК ВсегоНоменклатур,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СсылкаХарактеристики) КАК ВсегоХарактеристик
	|ИЗ
	|	(" + ПолучитьУниверсальныйЗапросНоменклатуры() + ")";
	
	Попытка
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Если Выборка.Следующий() Тогда
			Статистика = Новый Структура;
			Статистика.Вставить("ВсегоКомбинаций", Выборка.ВсегоКомбинаций);
			Статистика.Вставить("ВсегоНоменклатур", Выборка.ВсегоНоменклатур);
			Статистика.Вставить("ВсегоХарактеристик", Выборка.ВсегоХарактеристик);
			
			Сообщить("  Всего комбинаций: " + Строка(Выборка.ВсегоКомбинаций));
			Сообщить("  Всего номенклатур: " + Строка(Выборка.ВсегоНоменклатур));
			Сообщить("  Всего характеристик: " + Строка(Выборка.ВсегоХарактеристик));
			
			Возврат Статистика;
		КонецЕсли;
	Исключение
		Сообщить("ОШИБКА получения статистики: " + ОписаниеОшибки());
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

